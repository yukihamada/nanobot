<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>chatweb.ai - お願いしたら、本当にやってくれるAI</title>
  <meta name="description" content="声で頼むだけ。検索、コード実行、ファイル操作、定期監視まで全自動。Web・LINE・Telegram対応。無料で始められます。">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%236366f1'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-size='18' font-weight='800' font-family='sans-serif' fill='white'%3Ecw%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%236366f1'/%3E%3Ctext x='90' y='115' text-anchor='middle' font-size='80' font-weight='800' font-family='sans-serif' fill='white'%3Ecw%3C/text%3E%3C/svg%3E">
  <meta property="og:title" content="chatweb.ai - お願いしたら、本当にやってくれるAI">
  <meta property="og:description" content="声で頼むだけ。検索、コード実行、ファイル操作、定期監視まで全自動。Web・LINE・Telegram対応。無料。">
  <meta property="og:image" content="https://chatweb.ai/og.svg">
  <meta property="og:url" content="https://chatweb.ai">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="chatweb.ai">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:locale:alternate" content="en_US">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@chatweb_ai">
  <meta name="twitter:title" content="chatweb.ai - お願いしたら、本当にやってくれるAI">
  <meta name="twitter:description" content="声で頼むだけ。検索・コード実行・定期監視まで全自動。Web・LINE・Telegram対応。">
  <meta name="twitter:image" content="https://chatweb.ai/og.svg">
  <link rel="canonical" href="https://chatweb.ai/">
  <link rel="alternate" hreflang="ja" href="https://chatweb.ai/">
  <link rel="alternate" hreflang="en" href="https://chatweb.ai/?lang=en">
  <link rel="alternate" hreflang="x-default" href="https://chatweb.ai/">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="chatweb.ai">
  <link rel="manifest" href="/manifest.json">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "chatweb.ai",
    "url": "https://chatweb.ai",
    "description": "Voice-first AI assistant. Research, automation, development - all by voice. Works on Web, LINE, and Telegram.",
    "applicationCategory": "ProductivityApplication",
    "operatingSystem": "Web",
    "offers": [
      {"@type": "Offer", "name": "Free", "price": "0", "priceCurrency": "USD"},
      {"@type": "Offer", "name": "Starter", "price": "9", "priceCurrency": "USD"},
      {"@type": "Offer", "name": "Pro", "price": "29", "priceCurrency": "USD"}
    ],
    "featureList": "Voice Input, Web Search, Multi-Channel (LINE, Telegram, Web), 5+ AI Models, Long-term Memory, TTS, REST API, SSE Streaming, Slash Commands, Conversation Sharing",
    "inLanguage": ["ja", "en"],
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://chatweb.ai/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "documentation": "https://chatweb.ai/docs",
    "sameAs": ["https://github.com/yukihamada/nanobot", "https://teai.io"]
  }
  </script>
  <link rel="preconnect" href="https://chatweb.ai">
  <link rel="dns-prefetch" href="https://chatweb.ai">
  <style>
    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface2: #1e1e24;
      --border: #27272a;
      --text: #fafafa;
      --muted: #71717a;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-glow: rgba(99,102,241,0.25);
      --green: #22c55e;
      --line: #06C755;
      --tg: #2AABEE;
    }
    button:focus-visible, input:focus-visible, textarea:focus-visible, a:focus-visible, select:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animations */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
      50% { box-shadow: 0 0 40px var(--accent-glow), 0 0 60px rgba(99,102,241,0.1); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .fade-up { animation: fadeUp 0.6s ease-out both; }
    .fade-up-d1 { animation-delay: 0.1s; }
    .fade-up-d2 { animation-delay: 0.2s; }
    .fade-up-d3 { animation-delay: 0.3s; }
    .fade-up-d4 { animation-delay: 0.4s; }

    /* Scroll-triggered animation */
    .scroll-fade-up {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .scroll-fade-up.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Nav */
    nav {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: fadeIn 0.5s ease-out;
    }
    .logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
    .logo span { background: linear-gradient(135deg, var(--accent), #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-right { display: flex; align-items: center; gap: 16px; }
    .nav-right a { color: var(--muted); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s; }
    .nav-right a:hover { color: var(--text); }
    .lang-sw {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
    }
    .lang-sw button {
      background: none; border: none; color: var(--muted);
      padding: 5px 12px; font-size: 11px; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .lang-sw button.on { background: var(--accent); color: #fff; }

    /* Main */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 24px 80px;
    }

    /* Hero */
    .hero {
      text-align: center;
      margin-bottom: 28px;
      position: relative;
      z-index: 1;
    }
    #hero-canvas {
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      width: 100vw;
      max-width: 900px;
      height: 380px;
      z-index: 0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1.5s ease;
    }
    #hero-canvas.visible { opacity: 1; }
    .hero h1 {
      font-size: 42px;
      font-weight: 900;
      letter-spacing: -1.5px;
      margin-bottom: 12px;
      line-height: 1.15;
      background: linear-gradient(135deg, #fff 0%, #a5a5ff 50%, #fff 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }
    .hero h1 .char {
      display: inline-block;
      opacity: 0;
      transform: translateY(10px) scale(0.9);
      filter: blur(4px);
      animation: charReveal 0.5s ease forwards;
    }
    @keyframes charReveal {
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    .hero p {
      color: var(--muted);
      font-size: 17px;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .hero-cta {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .hero-cta a {
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .hero-cta .cta-primary {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .hero-cta .cta-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
    .hero-cta .cta-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .hero-cta .cta-secondary:hover { border-color: var(--accent); transform: translateY(-2px); }

    /* Voice demo */
    .voice-demo {
      text-align: center;
      margin-bottom: 28px;
      padding: 0 16px;
    }
    .voice-demo-label {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .voice-demo-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0;
    }
    .voice-demo-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }
    .voice-demo-btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .voice-demo-btn.playing {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    .voice-demo-output {
      max-width: 600px;
      margin: 12px auto 0;
      min-height: 48px;
      font-size: 15px;
      color: var(--muted);
      line-height: 1.6;
      transition: color 0.3s ease;
    }
    .voice-demo-output.active {
      color: var(--text);
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 32px;
      padding: 20px 0;
      flex-wrap: wrap;
    }
    .stat-item { text-align: center; }
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--green), #4ade80);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Chat widget */
    .chat-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 28px;
      animation: pulse-glow 4s ease-in-out infinite;
      position: relative;
    }
    .chat-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
    }
    .chat-header .dot {
      width: 8px; height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
    }
    #agent-select {
      margin-left: auto;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      outline: none;
    }
    #agent-select:hover { border-color: var(--accent); }

    /* Channel bar in chat header */
    .ch-bar { display: flex; gap: 6px; margin-left: 8px; }
    .ch-bar-btn {
      display: flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
      color: #fff; cursor: pointer; border: none; transition: all 0.2s;
      text-decoration: none;
    }
    .ch-bar-btn.line-bar { background: var(--line); }
    .ch-bar-btn.tg-bar { background: var(--tg); }
    .ch-bar-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
    .ch-bar-btn .ch-check { display: none; margin-left: 2px; }
    .ch-bar-btn.connected .ch-check { display: inline; }
    .ch-bar-btn.connected { opacity: 1; pointer-events: none; box-shadow: 0 0 0 1.5px var(--green); }
    .ch-bar-btn svg { width: 14px; height: 14px; }

    /* Channel cards (larger CTA) */
    .channel-cards { display: flex; gap: 8px; margin-bottom: 16px; justify-content: center; flex-wrap: wrap; transition: all 0.3s ease; }
    .channel-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 8px 14px; cursor: pointer; transition: all 0.25s; text-decoration: none; color: var(--text);
      display: inline-flex; align-items: center; gap: 8px;
    }
    .channel-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .channel-card.line-card { border-color: rgba(6,199,85,0.3); }
    .channel-card.line-card:hover { border-color: var(--line); }
    .channel-card.tg-card { border-color: rgba(42,171,238,0.3); }
    .channel-card.tg-card:hover { border-color: var(--tg); }
    .channel-card .cc-header { display: flex; align-items: center; gap: 6px; margin-bottom: 0; }
    .channel-card .cc-icon {
      width: 24px; height: 24px; border-radius: 6px; display: flex;
      align-items: center; justify-content: center; flex-shrink: 0;
    }
    .channel-card .cc-icon svg { width: 14px; height: 14px; }
    .channel-card.line-card .cc-icon { background: var(--line); }
    .channel-card.tg-card .cc-icon { background: var(--tg); }
    .channel-card .cc-name { font-size: 12px; font-weight: 700; }
    .channel-card .cc-desc { display: none; }
    .channel-card .cc-action {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 11px; font-weight: 600; color: #fff;
      padding: 4px 10px; border-radius: 6px;
    }
    .channel-card.line-card .cc-action { background: var(--line); }
    .channel-card.tg-card .cc-action { background: var(--tg); }
    .channel-card .cc-connected {
      display: none; font-size: 10px; color: var(--green); font-weight: 600;
    }
    .channel-card.connected .cc-connected { display: flex; align-items: center; gap: 3px; }
    .channel-card.connected .cc-action { display: none; }
    .channel-card.connected { pointer-events: none; opacity: 0.7; border-color: var(--green) !important; }
    .channel-card.connected:hover { transform: none; box-shadow: none; }
    /* Compact mode: when at least 1 channel is linked */
    .channel-cards.has-linked .channel-card { padding: 6px 10px; }
    .channel-cards.has-linked .channel-card .cc-icon { width: 20px; height: 20px; border-radius: 5px; }
    .channel-cards.has-linked .channel-card .cc-icon svg { width: 12px; height: 12px; }
    .channel-cards.has-linked .channel-card .cc-name { font-size: 10px; }
    .channel-cards.has-linked .channel-card .cc-action { font-size: 9px; padding: 3px 6px; border-radius: 5px; }
    .channel-cards.has-linked .channel-card .cc-connected { font-size: 9px; }

    /* Tools badge */
    .tools-count { font-size: 11px; color: var(--muted); text-align: center; margin-top: -20px; margin-bottom: 20px; }
    .tools-count span { color: var(--accent-hover); font-weight: 700; }

    .device-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .device-card .device-status { width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0; }
    .device-card .device-info { flex:1; }
    .device-card .device-name { font-size:13px;font-weight:600; }
    .device-card .device-meta { font-size:11px;color:var(--muted); }
    .agent-badge { display:inline-block;font-size:10px;background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:8px;vertical-align:middle; }
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scroll-behavior: smooth;
    }
    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
      animation: slideIn 0.3s ease-out both;
    }
    .msg.bot {
      background: var(--surface2);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .msg.user {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .msg.typing {
      background: var(--surface2);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .msg.typing .thinking-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      animation: fadeIn 0.3s ease-out;
    }
    .msg.typing .thinking-icon {
      font-size: 14px;
      animation: pulse-glow 2s ease-in-out infinite;
      display: inline-block;
    }
    .msg.typing .thinking-text {
      transition: opacity 0.3s ease;
    }
    .msg.typing .thinking-elapsed {
      font-size: 11px;
      color: var(--muted);
      opacity: 0.6;
      font-variant-numeric: tabular-nums;
    }
    .msg.typing .shimmer-bar {
      height: 3px;
      width: 60px;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--surface2) 25%, var(--accent) 50%, var(--surface2) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    /* Tool badge on response */
    .tool-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--accent-hover);
      background: rgba(99,102,241,0.1);
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 12px;
      padding: 2px 8px;
      margin-top: 6px;
      margin-right: 4px;
    }
    .tool-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    /* Channel badge */
    .msg .channel-badge {
      display: inline-block;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .msg .channel-badge.ch-line { background: rgba(6,199,85,0.2); color: var(--line); }
    .msg .channel-badge.ch-telegram { background: rgba(42,171,238,0.2); color: var(--tg); }
    .msg .channel-badge.ch-web { background: rgba(99,102,241,0.15); color: var(--accent-hover); }

    /* Time divider for cross-channel sync (time gap between messages) */
    .sync-time-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 16px 0 10px;
      font-size: 11px;
      color: var(--muted);
    }
    .sync-time-divider::before, .sync-time-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .sync-time-divider .divider-text {
      white-space: nowrap;
      padding: 2px 10px;
      border-radius: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
    }

    /* QR in link code response */
    .link-qr-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .link-qr-row a {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
      color: #fff;
      transition: transform 0.15s;
    }
    .link-qr-row a:hover { transform: scale(1.05); }
    .link-qr-row a.dl-line { background: var(--line); }
    .link-qr-row a.dl-tg { background: var(--tg); }
    .link-qr-img {
      width: 120px;
      height: 120px;
      border-radius: 0;
      background: #fff;
      margin-top: 8px;
      padding: 6px;
      border-radius: 10px;
      box-sizing: content-box;
    }

    /* Link code display */
    .msg .link-code {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 4px;
      padding: 10px 24px;
      border-radius: 10px;
      margin: 8px 0;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .msg .link-code:hover { transform: scale(1.05); }
    .msg .link-steps {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.8;
    }
    .msg .link-steps .step-num {
      display: inline-flex;
      width: 18px; height: 18px;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
    }
    .msg.link-success {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
      border: 1px solid rgba(34,197,94,0.3);
    }

    /* Typewriter cursor */
    .typewriter-cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--accent);
      margin-left: 2px;
      vertical-align: text-bottom;
      animation: blink 0.8s step-end infinite;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid var(--border);
      align-items: center;
    }
    .chat-input input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      padding: 18px 20px;
      font-size: 15px;
      outline: none;
    }
    .chat-input input::placeholder { color: var(--muted); }
    .chat-input button {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border: none;
      color: #fff;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
    }
    .chat-input button:hover { transform: scale(1.05); box-shadow: 0 4px 15px var(--accent-glow); }

    /* Chat login overlay */
    .chat-login-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(9,9,11,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      cursor: pointer;
      z-index: 5;
      backdrop-filter: blur(4px);
      transition: background 0.2s;
    }
    .chat-login-overlay:hover { background: rgba(9,9,11,0.75); }
    .chat-login-overlay span {
      color: var(--accent-hover);
      font-weight: 600;
      font-size: 15px;
    }
    .chat-login-overlay.hidden { display: none; }

    /* Capabilities section */
    .cap-section {
      margin-bottom: 32px;
    }
    .cap-section h2 {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 6px;
      text-align: center;
    }
    .cap-section .cap-sub {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 18px;
    }
    .cap-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .cap-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 14px;
      text-align: center;
      transition: all 0.25s;
    }
    .cap-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .cap-card .cap-icon { font-size: 24px; margin-bottom: 8px; }
    .cap-card .cap-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
    .cap-card .cap-desc { font-size: 11px; color: var(--muted); line-height: 1.4; }
    .cap-card .cap-badge {
      display: inline-block; margin-top: 6px; padding: 2px 8px; border-radius: 4px;
      font-size: 10px; font-weight: 700;
    }
    .cap-badge.built-in { background: rgba(34,197,94,0.15); color: var(--green); }
    .cap-badge.mcp-ext { background: rgba(99,102,241,0.15); color: var(--accent-hover); }
    .cap-mcp-note {
      text-align: center; font-size: 11px; color: var(--muted); margin-top: 4px;
      padding: 10px; background: rgba(99,102,241,0.05); border-radius: 10px;
      border: 1px solid rgba(99,102,241,0.1);
    }
    .cap-mcp-note a { color: var(--accent-hover); text-decoration: none; font-weight: 600; }
    .cap-mcp-note a:hover { text-decoration: underline; }

    /* Recipe cards */
    .recipes { margin-bottom: 32px; }
    .recipes h2 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .recipe-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .recipe-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .recipe-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(99,102,241,0.05), transparent);
      opacity: 0;
      transition: opacity 0.25s;
    }
    .recipe-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .recipe-card:hover::before { opacity: 1; }
    .recipe-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 4px; position: relative; }
    .recipe-card p { font-size: 11px; color: var(--muted); line-height: 1.4; position: relative; }

    /* Sync section */
    .sync-section {
      background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));
      border: 1px solid rgba(99,102,241,0.15);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 28px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .sync-section::before {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(99,102,241,0.06) 0%, transparent 60%);
      animation: float 6s ease-in-out infinite;
    }
    .sync-section h3 {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 8px;
      position: relative;
    }
    .sync-section .sync-desc {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
      position: relative;
    }
    .sync-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      position: relative;
    }
    .sync-flow .channel-icon {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      transition: transform 0.2s;
    }
    .sync-flow .channel-icon:hover { transform: scale(1.05); }
    .sync-flow .channel-icon.web-icon { background: var(--accent); }
    .sync-flow .channel-icon.line-icon { background: var(--line); }
    .sync-flow .channel-icon.tg-icon { background: var(--tg); }
    .sync-flow .sync-arrow {
      color: var(--accent);
      font-size: 18px;
      animation: blink 2s ease-in-out infinite;
    }
    .sync-steps {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      position: relative;
    }
    .sync-step {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 12px;
      transition: all 0.2s;
    }
    .sync-step:hover { border-color: var(--accent); }
    .sync-step .step-number {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 800;
      color: #fff;
      margin: 0 auto 8px;
    }
    .sync-step .step-title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .sync-step .step-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }
    .sync-step code {
      background: rgba(99,102,241,0.15);
      padding: 2px 8px;
      border-radius: 6px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      color: var(--accent-hover);
    }

    /* Channel buttons */
    .channels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 28px;
    }
    .ch-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 18px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      color: #fff;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .ch-btn::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; width: 200%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .ch-btn:hover::before { left: 100%; }
    .ch-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .ch-btn.line { background: linear-gradient(135deg, var(--line), #05b34a); }
    .ch-btn.tg { background: linear-gradient(135deg, var(--tg), #1a95d0); }
    .ch-btn svg { flex-shrink: 0; }

    /* Trust bar */
    .trust-bar {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 12px 0;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .trust-item { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
    .trust-item svg { width: 14px; height: 14px; fill: var(--green); }

    /* Bottom CTA */
    .bottom-cta {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.08), rgba(34,197,94,0.04));
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 20px;
      padding: 40px 32px;
      text-align: center;
      margin-bottom: 32px;
    }
    .bottom-cta h2 { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
    .bottom-cta p { color: var(--muted); font-size: 14px; margin-bottom: 20px; max-width: 480px; margin-left: auto; margin-right: auto; }
    .bottom-cta .cta-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .bottom-cta a {
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s;
    }
    .bottom-cta .cta-primary {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
    }
    .bottom-cta .cta-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--accent-glow); }
    .bottom-cta .price-hint { font-size: 12px; color: var(--muted); margin-top: 12px; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 36px;
      text-align: center;
      max-width: 380px;
      width: 90%;
      animation: fadeUp 0.3s ease-out;
    }
    .modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .modal p { font-size: 13px; color: var(--muted); margin-bottom: 16px; }
    .modal .qr-wrapper {
      position: relative;
      display: inline-block;
      width: 216px;
      height: 216px;
      margin-bottom: 16px;
      background: #fff;
      border-radius: 16px;
      padding: 8px;
      box-sizing: border-box;
    }
    .modal .qr-wrapper img {
      width: 200px;
      height: 200px;
      border-radius: 0;
      display: block;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .modal .qr-wrapper img.loaded { opacity: 1; }
    .modal .qr-spinner {
      position: absolute;
      top: 50%; left: 50%;
      width: 32px; height: 32px;
      margin: -16px 0 0 -16px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .modal .qr-spinner.hidden { display: none; }
    .modal .modal-link {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 10px;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      transition: transform 0.2s;
    }
    .modal .modal-link:hover { transform: scale(1.05); }
    .modal .modal-link.line-bg { background: linear-gradient(135deg, var(--line), #05b34a); }
    .modal .modal-link.tg-bg { background: linear-gradient(135deg, var(--tg), #1a95d0); }
    .modal .modal-link.whatsapp-bg { background: linear-gradient(135deg, #25D366, #128C7E); }
    .modal .modal-link.discord-bg { background: linear-gradient(135deg, #5865F2, #4752C4); }
    .modal .modal-link.slack-bg { background: linear-gradient(135deg, #4A154B, #611f69); }
    .modal .modal-link.teams-bg { background: linear-gradient(135deg, #6264A7, #464775); }
    .modal .close-btn {
      display: block;
      margin-top: 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .modal .close-btn:hover { color: var(--text); }

    /* Toggle switch */
    #auto-charge-toggle:checked + span { background: var(--accent, #6366f1) !important; }
    #auto-charge-toggle:checked + span + span { left: 22px !important; }

    /* Card hover glow */
    .cap-card, .recipe-card, .channel-card {
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .cap-card:hover, .recipe-card:hover, .channel-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 30px var(--accent-glow), 0 0 0 1px rgba(99,102,241,0.15);
    }

    /* Sync icon float animation */
    .sync-flow .channel-icon { animation: float 3s ease-in-out infinite; }
    .sync-flow .channel-icon:nth-child(3) { animation-delay: 0.3s; }
    .sync-flow .channel-icon:nth-child(5) { animation-delay: 0.6s; }

    /* Chat input focus glow */
    .chat-input input:focus {
      box-shadow: 0 0 0 2px var(--accent-glow), 0 0 20px rgba(99,102,241,0.15);
    }

    /* Message slideIn */
    .msg { animation: slideIn 0.3s ease-out; }

    /* Auth nav */
    .auth-nav-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .auth-nav-btn:hover { background: var(--accent-hover); }
    .auth-nav-btn.logout-btn { background: var(--surface); border: 1px solid var(--border); color: var(--muted); font-size: 12px; padding: 4px 10px; }
    .user-menu { display: flex; align-items: center; gap: 8px; }
    .user-name { font-size: 13px; color: var(--text); font-weight: 500; }

    /* Auth modal */
    .auth-modal { max-width: 360px; }
    .auth-tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
    .auth-tab {
      flex: 1;
      background: none;
      border: none;
      color: var(--muted);
      padding: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }
    .auth-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .auth-input {
      display: block;
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-input:focus { border-color: var(--accent); }
    .auth-submit {
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .auth-submit:hover { background: var(--accent-hover); }
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: var(--muted);
      font-size: 12px;
    }
    .auth-divider::before, .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .auth-divider span { padding: 0 12px; }
    .auth-google-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .auth-google-btn:hover { background: #f5f5f5; }
    .auth-error {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 12px;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      z-index: 200;
      display: flex;
      flex-direction: column;
      transition: left 0.3s ease;
    }
    .sidebar.open { left: 0; }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header h3 { font-size: 16px; font-weight: 700; }
    .sidebar-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }
    .sidebar-new-btn {
      margin: 12px 16px;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar-new-btn:hover { background: var(--accent-hover); }
    .sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px;
    }
    .sidebar-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      transition: background 0.2s;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-item:hover { background: var(--surface2); }
    .sidebar-item.active { background: var(--accent-glow); color: var(--accent-hover); }
    .sidebar-toggle {
      position: fixed;
      top: 16px;
      left: 8px;
      z-index: 150;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Footer */
    footer { text-align: center; padding: 32px 24px; font-size: 12px; color: var(--muted); }
    footer a { color: var(--muted); transition: color 0.2s; }
    footer a:hover { color: var(--text); }

    /* Scrollbar */
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* ===== ChatGPT-like App Mode (authenticated) ===== */
    body.app-mode { overflow: hidden; }
    body.app-mode nav {
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 100;
      height: 48px;
    }
    body.app-mode .nav-right > a,
    body.app-mode .nav-right > .lang-sw,
    body.app-mode .nav-hamburger,
    body.app-mode #auth-nav { display: none !important; }
    body.app-mode .main { display: none; }
    body.app-mode footer { display: none; }

    /* App layout container */
    .app-container {
      display: none;
      position: fixed;
      top: 48px; left: 0; right: 0; bottom: 0;
    }
    body.app-mode .app-container { display: flex; }

    /* App sidebar (always visible on desktop) */
    .app-sidebar {
      width: 260px;
      background: var(--bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.25s ease;
    }
    .app-sidebar-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .app-sidebar-new {
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .app-sidebar-new:hover { background: var(--surface); }
    .app-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .app-sidebar-list::-webkit-scrollbar { width: 4px; }
    .app-sidebar-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .app-conv-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--muted);
      transition: background 0.2s, color 0.2s;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .app-conv-item:hover { background: var(--surface); color: var(--text); }
    .app-conv-item.active { background: var(--surface); color: var(--text); }
    .conv-date-group { margin-bottom: 4px; }
    .conv-date-header {
      display: flex; align-items: center; gap: 4px;
      padding: 6px 12px 4px; font-size: 11px; font-weight: 600;
      color: var(--muted); cursor: pointer; user-select: none;
    }
    .conv-date-header:hover { color: var(--text); }
    .conv-date-header .chevron {
      transition: transform 0.2s; font-size: 10px;
    }
    .conv-date-header.collapsed .chevron { transform: rotate(-90deg); }
    .conv-date-items { overflow: hidden; }
    .conv-date-items.collapsed { display: none; }
    .app-sidebar-channels {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
    }
    .app-sidebar-channels-label {
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding: 0 4px;
    }
    .app-sidebar-channels-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    /* Primary channels (LINE, Telegram) — horizontal row with label */
    .app-ch-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      position: relative;
      width: 100%;
    }
    .app-ch-btn:hover { background: var(--surface); border-color: var(--accent); }
    .app-ch-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
    .app-ch-btn .app-ch-name { font-size: 12px; color: var(--text); font-weight: 600; }
    .app-ch-btn .app-ch-status { font-size: 10px; color: var(--muted); margin-left: auto; }
    .app-ch-btn.connected { border-color: var(--green); background: rgba(34,197,94,0.06); }
    .app-ch-btn.connected .app-ch-status { color: var(--green); }
    .app-ch-btn .app-ch-check {
      position: absolute;
      top: -3px; right: -3px;
      width: 14px; height: 14px;
      background: var(--green);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: #fff;
      border: 2px solid var(--bg);
    }
    .app-ch-btn.connected .app-ch-check { display: flex; }
    /* Secondary channels — collapsed row */
    .app-ch-more-row {
      display: flex;
      gap: 4px;
      margin-top: 2px;
    }
    .app-ch-more-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.4;
      flex: 1;
    }
    .app-ch-more-btn:hover { opacity: 1; border-color: var(--accent); background: var(--surface); }
    .app-ch-more-btn svg { width: 14px; height: 14px; }

    /* Link success overlay */
    .link-success-overlay {
      position: fixed; inset: 0; z-index: 400;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(6px);
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .link-success-overlay.show { opacity: 1; pointer-events: auto; }
    .lso-icon {
      width: 80px; height: 80px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      animation: linkSuccessPop 0.4s ease-out;
    }
    .lso-icon svg { width: 44px; height: 44px; }
    .lso-check {
      position: absolute; bottom: -2px; right: -2px;
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--green); border: 3px solid var(--bg);
      display: flex; align-items: center; justify-content: center;
    }
    .lso-check svg { width: 14px; height: 14px; color: #fff; }
    .lso-text {
      margin-top: 16px; font-size: 20px; font-weight: 700; color: #fff;
      text-shadow: 0 1px 4px rgba(0,0,0,0.3);
      animation: linkSuccessPop 0.4s ease-out 0.1s both;
    }
    @keyframes linkSuccessPop {
      0% { transform: scale(0.5); opacity: 0; }
      70% { transform: scale(1.08); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Sidebar channel badges */
    .sidebar-channel-badges {
      display: flex; gap: 6px; flex-wrap: wrap; margin-top: 2px;
    }
    .sidebar-ch-badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 9px; font-weight: 600; padding: 1px 6px 1px 4px;
      border-radius: 8px; line-height: 1;
    }
    .sidebar-ch-badge svg { width: 10px; height: 10px; flex-shrink: 0; }
    .sidebar-ch-badge.line-badge { background: rgba(6,199,85,0.15); color: #06c755; }
    .sidebar-ch-badge.tg-badge { background: rgba(36,161,222,0.15); color: #24a1de; }

    .app-sidebar-cli {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
    }
    .cli-cmd-box {
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      margin-bottom: 6px;
      transition: all 0.2s;
      color: #e2e8f0;
      overflow: hidden;
    }
    .cli-cmd-box:hover { border-color: var(--accent); }
    .cli-cmd-box .cli-dollar { color: var(--muted); flex-shrink: 0; }
    .cli-cmd-box .cli-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cli-cmd-box .cli-copy { color: var(--muted); font-size: 10px; background: var(--surface); border: 1px solid var(--border); padding: 1px 6px; border-radius: 4px; flex-shrink: 0; }
    .app-sidebar-sync {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
      font-size: 11px; color: var(--muted);
    }
    /* Sync bar removed — real-time sync via WebSocket */
    .sync-btn { display: none; }
    .sync-info { display: none; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .app-sidebar-cron {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
    }
    .app-sidebar-cron-label {
      font-size: 11px; color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 6px; padding: 0 4px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .cron-add-btn {
      background: none; border: none; color: var(--accent); cursor: pointer;
      font-size: 14px; padding: 0 4px; line-height: 1;
    }
    .cron-add-btn:hover { opacity: 0.8; }
    .cron-list { display: flex; flex-direction: column; gap: 4px; max-height: 120px; overflow-y: auto; }
    .cron-item {
      display: flex; align-items: center; gap: 6px; padding: 6px 8px;
      background: var(--surface); border-radius: 6px; font-size: 11px;
    }
    .cron-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
    .cron-item-schedule { color: var(--muted); font-size: 10px; font-family: monospace; }
    .cron-item-toggle { width: 28px; height: 16px; border-radius: 8px; border: none; cursor: pointer;
      background: var(--border); position: relative; transition: background 0.2s; flex-shrink: 0; }
    .cron-item-toggle.on { background: var(--green); }
    .cron-item-toggle::after {
      content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px;
      background: #fff; border-radius: 50%; transition: transform 0.2s;
    }
    .cron-item-toggle.on::after { transform: translateX(12px); }
    .cron-item-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px; padding: 0 2px; }
    .cron-item-del:hover { color: #e74c3c; }
    .cron-form { background: var(--surface); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 6px; }
    .cron-form input, .cron-form select { background: var(--bg); border: 1px solid var(--border); color: var(--text);
      border-radius: 4px; padding: 6px 8px; font-size: 11px; }
    .cron-form-row { display: flex; gap: 6px; }
    .cron-form-actions { display: flex; gap: 6px; justify-content: flex-end; }
    .cron-form-actions button { padding: 4px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; border: none; }
    .cron-save-btn { background: var(--accent); color: #fff; }
    .cron-cancel-btn { background: var(--border); color: var(--text); }
    .app-sidebar-footer {
      padding: 12px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }
    .app-sidebar-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .app-sidebar-user:hover { background: var(--surface); }
    .app-sidebar-user-avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .app-sidebar-user-name {
      flex: 1;
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* App chat area */
    .app-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      min-width: 0;
    }
    .app-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }
    .app-chat-messages::-webkit-scrollbar { width: 6px; }
    .app-chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .app-chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      gap: 24px;
      padding-bottom: 60px;
    }
    .app-chat-empty-logo {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    .app-chat-empty-text { font-size: 15px; color: var(--muted); }

    /* AI Avatar container — polygon orb */
    .ai-avatar-container {
      width: 200px; height: 200px;
      cursor: pointer;
      position: relative;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .ai-avatar-container:hover { transform: scale(1.05); }
    .ai-avatar-container canvas { display: block; width: 100%; height: 100%; }

    /* Voice hero button - the primary CTA */
    .voice-hero-btn {
      width: 100px; height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 0 0 rgba(99,102,241,0.3);
    }
    .voice-hero-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(99,102,241,0.4);
    }
    .voice-hero-btn:active { transform: scale(0.95); }
    .voice-hero-btn svg { width: 40px; height: 40px; }
    .voice-hero-btn::before {
      content: '';
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      border: 2px solid rgba(99,102,241,0.15);
      animation: voice-ring 3s ease-in-out infinite;
    }
    .voice-hero-btn::after {
      content: '';
      position: absolute;
      inset: -14px;
      border-radius: 50%;
      border: 1px solid rgba(99,102,241,0.08);
      animation: voice-ring 3s ease-in-out infinite 0.5s;
    }
    @keyframes voice-ring {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.08); opacity: 0.5; }
    }
    .voice-hero-btn.recording {
      background: linear-gradient(135deg, #ef4444, #f97316);
      animation: voice-pulse 1.5s ease-in-out infinite;
    }
    @keyframes voice-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
    }
    .voice-hero-label {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.5px;
    }

    /* Voice character selector */
    .voice-chars {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 16px 0 8px;
      flex-wrap: wrap;
    }
    .voice-name-pill {
      padding: 6px 14px;
      border-radius: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .voice-name-pill:hover, .voice-name-pill.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .voice-char {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: 2px solid transparent;
      border-radius: 14px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.25s ease;
      opacity: 0.5;
    }
    .voice-char:hover { opacity: 0.8; transform: translateY(-2px); }
    .voice-char.active {
      opacity: 1;
      border-color: var(--accent);
      background: rgba(99,102,241,0.08);
    }
    .vc-avatar {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      transition: transform 0.2s, border-color 0.2s;
      border: 2px solid transparent;
    }
    .voice-char.active .vc-avatar { transform: scale(1.1); border-color: var(--accent); }
    .vc-name { font-size: 11px; color: var(--muted); font-weight: 600; }
    .voice-char.active .vc-name { color: var(--accent); }

    .app-chat-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 500px;
      margin-top: 8px;
    }
    .app-chat-suggestion {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .app-chat-suggestion:hover { border-color: var(--accent); color: var(--text); }
    .app-chat-input-area {
      padding: 12px 16px 16px;
      max-width: 760px;
      width: 100%;
      margin: 0 auto;
    }
    .app-chat-input-box {
      display: flex;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 4px 4px 4px 12px;
      transition: border-color 0.2s, box-shadow 0.2s;
      gap: 6px;
    }
    .app-chat-input-box:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .app-chat-input-box textarea {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-size: 15px;
      padding: 8px 8px;
      resize: none;
      outline: none;
      max-height: 150px;
      font-family: inherit;
      line-height: 1.5;
    }
    .app-chat-input-box textarea::placeholder { color: var(--muted); }
    .app-chat-send-btn {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--surface);
      border: 1.5px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .app-chat-send-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); transform: scale(1.05); }
    .app-chat-send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }
    .app-chat-model-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 4px 0;
      font-size: 12px;
      color: var(--muted);
    }
    .app-chat-model-bar select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l5 6 5-6' fill='%23888'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 6px center;
      padding-right: 20px;
    }

    /* Mic button (STT) in input box — Voice-first: prominent accent style */
    .app-chat-mic-btn {
      width: 46px; height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(99,102,241,0.3);
    }
    .app-chat-mic-btn:hover { transform: scale(1.08); box-shadow: 0 4px 16px rgba(99,102,241,0.4); }
    .app-chat-mic-btn.recording {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      animation: mic-rec-pulse 1.2s infinite;
      box-shadow: 0 0 0 0 rgba(239,68,68,0.4);
    }
    @keyframes mic-rec-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
    }
    body.no-speech-api .app-chat-mic-btn { display: none; }
    body.no-speech-api .voice-hero-btn { display: none; }
    body.no-speech-api .voice-hero-label { display: none; }

    /* Phone call button */
    .app-chat-phone-btn {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: transparent;
      border: 1.5px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .app-chat-phone-btn:hover { background: rgba(34,197,94,0.1); color: #22c55e; border-color: #22c55e; }
    .app-chat-phone-btn.active { background: #22c55e; border-color: #22c55e; color: #fff; }
    body.connect-enabled .app-chat-phone-btn { display: flex; }

    /* Phone panel */
    .phone-panel {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 320px;
      max-height: 500px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      z-index: 1000;
      flex-direction: column;
      overflow: hidden;
    }
    .phone-panel.open { display: flex; }
    .phone-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 14px;
    }
    .phone-panel-header .close-btn { cursor: pointer; color: var(--muted); font-size: 18px; }
    .phone-panel-body { padding: 16px; flex: 1; overflow-y: auto; }
    .phone-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .phone-input-row input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 15px;
      outline: none;
    }
    .phone-input-row input:focus { border-color: var(--accent); }
    .phone-call-btn {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: #22c55e;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .phone-call-btn:hover { background: #16a34a; }
    .phone-call-btn.hangup { background: #ef4444; }
    .phone-call-btn.hangup:hover { background: #dc2626; }
    .phone-status {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 12px;
    }
    .phone-dialpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    .phone-dialpad button {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .phone-dialpad button:hover { background: rgba(99,102,241,0.1); }
    .phone-transcript {
      max-height: 150px;
      overflow-y: auto;
      border-top: 1px solid var(--border);
      padding: 8px 16px;
      font-size: 12px;
      color: var(--muted);
    }
    .phone-transcript .segment { margin-bottom: 4px; }
    .phone-transcript .segment .speaker { font-weight: 600; color: var(--text); }

    /* Floating TTS stop button — visible during playback */
    .tts-stop-float {
      display: none;
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      padding: 10px 24px;
      border-radius: 24px;
      background: rgba(239,68,68,0.9);
      backdrop-filter: blur(8px);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(239,68,68,0.3);
      transition: all 0.2s;
      align-items: center;
      gap: 8px;
    }
    .tts-stop-float:hover { background: rgba(220,38,38,0.95); transform: translateX(-50%) scale(1.05); }
    .tts-stop-float.visible { display: flex; }
    @keyframes tts-pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
    .tts-stop-float .tts-pulse-dot { width: 8px; height: 8px; border-radius: 50%; background: #fff; animation: tts-pulse 1.2s infinite; }

    /* Voice conversation state indicator */
    .voice-state-bar {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 199;
      padding: 8px 20px;
      border-radius: 20px;
      backdrop-filter: blur(12px);
      font-size: 13px;
      font-weight: 500;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    .voice-state-bar.visible { display: flex; }
    .voice-state-bar.state-listening {
      background: rgba(34,197,94,0.12);
      color: #22c55e;
      border: 1px solid rgba(34,197,94,0.3);
      box-shadow: 0 2px 12px rgba(34,197,94,0.15);
    }
    .voice-state-bar.state-thinking {
      background: rgba(99,102,241,0.12);
      color: #6366f1;
      border: 1px solid rgba(99,102,241,0.3);
      box-shadow: 0 2px 12px rgba(99,102,241,0.15);
    }
    .voice-state-bar.state-speaking {
      background: rgba(168,85,247,0.12);
      color: #a855f7;
      border: 1px solid rgba(168,85,247,0.3);
      box-shadow: 0 2px 12px rgba(168,85,247,0.15);
    }
    /* Sound wave animation */
    .voice-wave {
      display: flex;
      align-items: center;
      gap: 2px;
      height: 16px;
    }
    .voice-wave-bar {
      width: 3px;
      border-radius: 2px;
      background: currentColor;
      animation: voice-wave-anim 0.8s ease-in-out infinite;
    }
    .voice-wave-bar:nth-child(1) { height: 40%; animation-delay: 0s; }
    .voice-wave-bar:nth-child(2) { height: 70%; animation-delay: 0.1s; }
    .voice-wave-bar:nth-child(3) { height: 100%; animation-delay: 0.2s; }
    .voice-wave-bar:nth-child(4) { height: 60%; animation-delay: 0.3s; }
    .voice-wave-bar:nth-child(5) { height: 30%; animation-delay: 0.15s; }
    @keyframes voice-wave-anim {
      0%, 100% { transform: scaleY(0.4); }
      50% { transform: scaleY(1); }
    }
    /* Listening dots animation */
    .voice-listen-dots {
      display: flex;
      gap: 3px;
      align-items: center;
    }
    .voice-listen-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: listen-bounce 1.2s ease-in-out infinite;
    }
    .voice-listen-dots span:nth-child(2) { animation-delay: 0.2s; }
    .voice-listen-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes listen-bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }
    /* Auto-listen toggle in settings */
    .voice-loop-badge {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 6px;
      background: rgba(34,197,94,0.15);
      color: #22c55e;
      margin-left: 6px;
      vertical-align: middle;
    }

    /* TTS button */
    .app-tts-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 16px;
      margin-top: 8px;
      transition: all 0.2s;
    }
    .app-tts-btn:hover { background: rgba(99,102,241,0.1); color: var(--accent); border-color: var(--accent); }
    .app-tts-btn.playing {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* Response action buttons */
    .msg-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .app-msg:hover .msg-actions { opacity: 1; }
    .escalate-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 12px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .escalate-btn:hover { background: rgba(99,102,241,0.1); color: var(--accent); border-color: var(--accent); }
    .escalate-btn.loading {
      pointer-events: none;
      opacity: 0.5;
    }
    .escalate-btn.done {
      border-color: var(--green);
      color: var(--green);
    }
    .escalate-human {
      background: transparent;
      border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444;
      cursor: pointer;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 12px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .escalate-human:hover { background: rgba(239,68,68,0.1); }
    .human-help-btn {
      display: inline-block;
      margin-top: 8px;
      background: transparent;
      border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444;
      cursor: pointer;
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .human-help-btn:hover { background: rgba(239,68,68,0.15); border-color: #ef4444; }

    /* Settings modal */
    .settings-modal { max-width: 480px; text-align: left; max-height: 80vh; overflow-y: auto; }
    .settings-modal h3 { text-align: center; }
    .settings-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .settings-tabs::-webkit-scrollbar { display: none; }
    .settings-tab { flex: 1 0 auto; padding: 8px 6px; text-align: center; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; min-width: 0; }
    .settings-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .settings-section { display: none; }
    .settings-section.active { display: block; }
    .settings-select { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 13px; }
    .settings-range-row { display: flex; align-items: center; gap: 10px; }
    .settings-range-row input[type=range] { flex: 1; }
    .settings-range-val { font-size: 12px; color: var(--muted); min-width: 36px; text-align: right; }
    .memory-box { background: var(--surface, #f5f5f5); border-radius: 8px; padding: 10px 12px; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; color: var(--text); margin-bottom: 8px; line-height: 1.5; }
    .memory-box:empty::before { content: 'まだ記憶はありません'; color: var(--muted); font-style: italic; }
    .memory-label { font-size: 12px; font-weight: 600; color: var(--muted); margin: 8px 0 4px; }
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-item-info { flex: 1; }
    .settings-item-label { font-size: 14px; font-weight: 600; color: var(--text); }
    .settings-item-desc { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .settings-toggle {
      position: relative;
      width: 44px; height: 24px;
      background: var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
      margin-left: 12px;
      border: none;
    }
    .settings-toggle.active { background: var(--accent); }
    .settings-toggle::after {
      content: '';
      position: absolute;
      top: 2px; left: 2px;
      width: 20px; height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .settings-toggle.active::after { transform: translateX(20px); }
    .settings-group-title { font-size: 11px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; margin: 16px 0 4px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
    .settings-group-title:first-child { margin-top: 0; }
    .settings-textarea { width: 100%; min-height: 80px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box; }
    .settings-textarea::placeholder { color: var(--muted); }
    .settings-btn { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; background: var(--bg); color: var(--text); transition: all 0.2s; }
    .settings-btn:hover { background: var(--surface, #f0f0f0); }
    .settings-btn-danger { border-color: #e53e3e; color: #e53e3e; }
    .settings-btn-danger:hover { background: #e53e3e; color: #fff; }
    /* Display setting classes */
    .compact-mode .app-msg { padding: 4px 0 !important; }
    .compact-mode .app-msg-content { padding: 6px 10px !important; }
    .hide-avatars .app-msg-avatar { display: none !important; }
    .hide-timestamps .msg-timestamp { display: none !important; }
    .hide-token-info .msg-token-info { display: none !important; }
    .msg-timestamp { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .msg-token-info { font-size: 10px; color: var(--muted); margin-top: 2px; }

    /* Terminal Mode */
    .terminal-mode {
      --tm-bg: #0c0c0c;
      --tm-fg: #33ff33;
      --tm-dim: #1a9a1a;
      --tm-font: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', 'Liberation Mono', monospace;
    }
    .terminal-mode,
    .terminal-mode .app-chat,
    .terminal-mode .app-chat-messages {
      background: var(--tm-bg) !important;
    }
    .terminal-mode .app-chat-messages {
      font-family: var(--tm-font) !important;
    }
    /* User messages: $ prefix, no bubble */
    .terminal-mode .app-chat-messages .app-msg-user {
      justify-content: flex-start !important;
    }
    .terminal-mode .app-chat-messages .app-msg-user .app-msg-bubble {
      background: none !important;
      color: var(--tm-fg) !important;
      border-radius: 0 !important;
      padding: 2px 0 !important;
      max-width: 100% !important;
      font-family: var(--tm-font) !important;
      font-size: 14px !important;
    }
    .terminal-mode .app-chat-messages .app-msg-user .app-msg-bubble::before {
      content: '$ ';
      color: var(--tm-dim);
      font-weight: 700;
    }
    /* Bot messages: flat output */
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-avatar {
      display: none !important;
    }
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content {
      color: var(--tm-fg) !important;
      font-family: var(--tm-font) !important;
      font-size: 14px !important;
      line-height: 1.6 !important;
    }
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content p,
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content li,
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content span {
      color: var(--tm-fg) !important;
    }
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content a {
      color: #66ff66 !important;
    }
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content code {
      background: #1a1a1a !important;
      color: #55ff55 !important;
      font-family: var(--tm-font) !important;
    }
    .terminal-mode .app-chat-messages .app-msg-bot .app-msg-content pre {
      background: #111 !important;
      border: 1px solid #1a9a1a44 !important;
    }
    /* Input area: $ prompt style */
    .terminal-mode .app-chat-input-area {
      background: var(--tm-bg) !important;
    }
    .terminal-mode .app-chat-input-box {
      background: var(--tm-bg) !important;
      border: 1px solid #1a9a1a55 !important;
      border-radius: 4px !important;
    }
    .terminal-mode .app-chat-input-box:focus-within {
      border-color: var(--tm-fg) !important;
      box-shadow: 0 0 0 1px #33ff3322 !important;
    }
    .terminal-mode .app-chat-input-box textarea {
      color: var(--tm-fg) !important;
      font-family: var(--tm-font) !important;
      font-size: 14px !important;
    }
    .terminal-mode .app-chat-input-box textarea::placeholder {
      color: var(--tm-dim) !important;
    }
    /* Sidebar */
    .terminal-mode .sidebar {
      background: #0a0a0a !important;
      border-color: #1a9a1a44 !important;
      font-family: var(--tm-font) !important;
    }
    .terminal-mode .sidebar-item {
      color: var(--tm-fg) !important;
      font-family: var(--tm-font) !important;
    }
    .terminal-mode .sidebar-item:hover {
      background: #1a1a1a !important;
    }
    .terminal-mode .sidebar-item.active {
      background: #0f1f0f !important;
      color: #55ff55 !important;
    }
    .terminal-mode .sidebar-header,
    .terminal-mode .sidebar-header h3 {
      color: var(--tm-fg) !important;
    }
    .terminal-mode .sidebar-new-btn {
      background: #1a9a1a !important;
      color: #0c0c0c !important;
      font-family: var(--tm-font) !important;
      border-radius: 4px !important;
    }
    /* Scrollbar */
    .terminal-mode .app-chat-messages::-webkit-scrollbar { width: 6px; }
    .terminal-mode .app-chat-messages::-webkit-scrollbar-track { background: var(--tm-bg); }
    .terminal-mode .app-chat-messages::-webkit-scrollbar-thumb { background: #1a9a1a66; border-radius: 3px; }
    .terminal-mode .app-chat-messages::-webkit-scrollbar-thumb:hover { background: var(--tm-dim); }
    /* Header */
    .terminal-mode .app-chat-header {
      background: var(--tm-bg) !important;
      border-color: #1a9a1a44 !important;
    }
    .terminal-mode .app-chat-header * {
      color: var(--tm-fg) !important;
    }
    /* Agent progress */
    .terminal-mode .agent-progress {
      color: var(--tm-dim) !important;
      font-family: var(--tm-font) !important;
    }
    /* Timestamps & token info */
    .terminal-mode .msg-timestamp,
    .terminal-mode .msg-token-info {
      color: #1a6a1a !important;
      font-family: var(--tm-font) !important;
    }
    /* Send button */
    .terminal-mode .app-chat-send-btn {
      background: var(--tm-bg) !important;
      border-color: #1a9a1a55 !important;
      color: var(--tm-fg) !important;
    }
    .terminal-mode .app-chat-send-btn.active {
      background: #1a9a1a !important;
      color: #0c0c0c !important;
    }

    /* Credit display */
    .credit-display {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
    }
    .credit-display .credit-count {
      font-weight: 600;
      transition: color 0.3s;
    }
    .credit-flash .credit-count {
      color: #f5a623;
      animation: credit-pulse 0.5s ease-out;
    }
    @keyframes credit-pulse {
      0% { transform: scale(1.3); color: #f5a623; }
      100% { transform: scale(1); }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* App mode message styling */
    .app-chat-messages .app-msg {
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      padding: 0 16px;
      animation: msg-in 0.3s ease-out;
    }
    @keyframes msg-in {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .app-chat-messages .app-msg-user {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 2px;
    }
    .app-chat-messages .app-msg-user .app-msg-bubble {
      background: var(--accent);
      color: #fff;
      padding: 10px 16px;
      border-radius: 20px 20px 6px 20px;
      max-width: 75%;
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .app-chat-messages .app-msg-bot {
      display: flex;
      gap: 10px;
      margin-bottom: 2px;
    }
    .app-chat-messages .app-msg-bot .app-msg-avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .app-chat-messages .app-msg-bot .app-msg-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.75;
      color: var(--text);
      word-break: break-word;
      white-space: pre-wrap;
      min-width: 0;
    }
    .app-msg-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      margin-bottom: 2px;
      white-space: pre;
    }
    .msg-rating {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .msg-rating button {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 13px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s, background 0.2s;
    }
    .msg-rating button:hover { opacity: 1; }
    .msg-rating button.rated {
      opacity: 1;
      background: rgba(99,102,241,0.15);
      border-color: var(--accent);
    }

    /* Explore mode cards */
    .explore-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .explore-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      transition: border-color 0.2s;
    }
    .explore-card:hover {
      border-color: var(--accent);
    }
    .explore-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .explore-model-name {
      font-weight: 600;
      color: var(--text);
    }
    .explore-time-badge {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: var(--muted);
    }
    .explore-fallback-badge {
      background: #f59e0b22;
      color: #f59e0b;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    .explore-card-body {
      font-size: 13px;
      line-height: 1.65;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
    }
    .explore-card-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    .explore-adopt-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .explore-adopt-btn:hover {
      background: var(--accent);
      color: #fff;
    }
    .explore-actions-bar {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .explore-action-btn {
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .explore-action-btn:hover {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .explore-level-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      margin-left: auto;
    }
    .explore-pending {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      padding: 6px 0;
    }
    .explore-pending .dot-pulse {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: pulse-glow 1s infinite;
    }

    /* Race mode */
    .race-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .race-winner-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 12px;
      letter-spacing: 0.5px;
    }
    .race-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      transition: border-color 0.2s, opacity 0.4s, transform 0.4s;
      opacity: 0;
      transform: translateY(12px);
    }
    .race-card.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .race-card.winner {
      border-color: #f59e0b;
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.15);
    }
    .race-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .race-model-name {
      font-weight: 600;
      color: var(--text);
    }
    .race-time-badge {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: var(--muted);
    }
    .race-rank-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 12px;
    }
    .race-rank-1 { background: #f59e0b22; color: #f59e0b; }
    .race-rank-2 { background: #94a3b822; color: #94a3b8; }
    .race-rank-3 { background: #a1887f22; color: #a1887f; }
    .race-card-body {
      font-size: 13px;
      line-height: 1.65;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
    }
    .race-card-body.expanded {
      max-height: none;
    }
    .race-others-toggle {
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .race-others-toggle:hover {
      border-color: var(--accent);
      color: var(--text);
    }
    .race-others {
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .race-others.show {
      display: flex;
    }
    .race-summarize-btn {
      font-size: 13px;
      font-weight: 600;
      padding: 8px 18px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      color: #fff;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.2s;
    }
    .race-summarize-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
    }
    .race-summarize-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .race-actions-bar {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .race-info-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      margin-left: auto;
    }
    /* Tier selector */
    .tier-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }
    .tier-option {
      flex: 1;
      padding: 8px 6px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 11px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .tier-option:hover {
      border-color: var(--accent);
    }
    .tier-option.selected {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .tier-option-icon {
      display: block;
      font-size: 16px;
      margin-bottom: 2px;
    }
    .tier-option-label {
      font-weight: 600;
      font-size: 11px;
    }
    .tier-option-model {
      font-size: 9px;
      opacity: 0.7;
    }

    /* Agent progress (tool execution steps) */
    .agent-progress {
      margin: 8px 0;
      padding: 8px 12px;
      background: var(--surface, #f5f5f5);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted, #888);
      border-left: 3px solid var(--primary, #4f46e5);
    }
    [data-theme="dark"] .agent-progress {
      background: #1a1a2e;
    }
    .agent-progress .tool-step { padding: 4px 0; }
    .agent-progress .tool-step pre {
      margin: 2px 0 0 18px;
      font-size: 12px;
      max-height: 120px;
      overflow: auto;
      background: var(--code-bg, #1e1e1e);
      color: var(--code-fg, #d4d4d4);
      padding: 6px 8px;
      border-radius: 4px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* API Keys modal */
    .apikey-modal { max-width: 480px; text-align: left; }
    .apikey-modal h3 { text-align: center; }
    .apikey-list { margin: 12px 0; max-height: 200px; overflow-y: auto; }
    .apikey-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .apikey-item-info { flex: 1; min-width: 0; }
    .apikey-item-name { font-size: 13px; font-weight: 600; }
    .apikey-item-prefix { font-size: 11px; color: var(--muted); font-family: monospace; }
    .apikey-item-date { font-size: 10px; color: var(--muted); }
    .apikey-delete-btn {
      background: none; border: none; color: #ef4444; cursor: pointer;
      font-size: 16px; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;
    }
    .apikey-delete-btn:hover { background: rgba(239,68,68,0.1); }
    .apikey-create-row { display: flex; gap: 8px; margin-top: 12px; }
    .apikey-create-row input {
      flex: 1; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 13px; outline: none;
    }
    .apikey-create-row input:focus { border-color: var(--accent); }
    .apikey-create-row button {
      padding: 8px 16px; background: var(--accent); color: #fff; border: none;
      border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
      white-space: nowrap;
    }
    .apikey-new-key {
      margin-top: 12px; padding: 12px; background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3); border-radius: 8px;
    }
    .apikey-new-key-label { font-size: 11px; color: var(--green); font-weight: 600; margin-bottom: 4px; }
    .apikey-new-key-value {
      font-family: monospace; font-size: 13px; word-break: break-all;
      cursor: pointer; color: var(--text);
    }
    .apikey-new-key-hint { font-size: 10px; color: var(--muted); margin-top: 4px; }

    /* App sidebar settings/docs links */
    .app-sidebar-links {
      padding: 4px 12px 8px;
      display: flex;
      gap: 6px;
    }
    .app-sidebar-link {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      background: transparent;
      border: 1px solid var(--border);
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: all 0.2s;
    }
    .app-sidebar-link:hover { color: var(--text); border-color: var(--accent); }

    /* App sidebar backdrop (mobile) */
    .app-sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 199;
    }
    .app-sidebar-backdrop.show { display: block; }

    /* Mobile toggle for app sidebar */
    .app-sidebar-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      transition: color 0.2s;
    }
    .app-sidebar-toggle:hover { color: var(--text); }
    body.app-mode .app-sidebar-toggle { display: block; }
    /* Desktop sidebar collapse */
    body.sidebar-collapsed .app-sidebar { width: 0; overflow: hidden; border-right: none; }
    body.sidebar-collapsed .app-sidebar > * { opacity: 0; pointer-events: none; }

    @media (max-width: 768px) {
      .app-sidebar {
        position: fixed;
        top: 44px; left: -280px; bottom: 0;
        width: 280px;
        z-index: 200;
        transition: left 0.3s ease;
      }
      .app-sidebar.open { left: 0; }
      .app-sidebar-toggle { display: block; }
      .app-sidebar, .app-container { top: 44px; }
      body.app-mode nav { padding: 6px 10px; height: 44px; }
      body.app-mode .logo { font-size: 16px; }
      body.app-mode .user-name { font-size: 11px; max-width: 100px; }
      body.app-mode .auth-nav-btn.logout-btn { font-size: 11px; padding: 3px 8px; }

      /* Chat messages area - fill screen properly */
      .app-chat-messages { padding: 12px 0; gap: 10px; }
      .app-chat-messages .app-msg { padding: 0 10px; }
      .app-chat-messages .app-msg-user .app-msg-bubble { max-width: 88%; font-size: 14px; padding: 8px 14px; }
      .app-chat-messages .app-msg-bot .app-msg-content { font-size: 14px; max-width: calc(100vw - 70px); }
      .app-chat-messages .app-msg-bot .app-msg-avatar { width: 28px; height: 28px; font-size: 10px; flex-shrink: 0; }
      .app-chat-messages .app-msg-bot { gap: 8px; }

      /* Input area - compact and touch-friendly */
      .app-chat-input-area { padding: 8px 10px calc(env(safe-area-inset-bottom, 8px) + 8px); }
      .app-chat-input-box { border-radius: 14px; padding: 6px; }
      .app-chat-input-box textarea { font-size: 16px; padding: 6px 10px; }
      .app-chat-send-btn { width: 38px; height: 38px; border-radius: 12px; }
      .app-chat-mic-btn { width: 38px; height: 38px; border-radius: 12px; }

      /* Model bar - inline with smaller spacing */
      .app-chat-model-bar { padding: 4px 2px 0; }
      .app-chat-model-bar select { font-size: 12px; padding: 5px 22px 5px 10px; border-radius: 10px; }

      /* Empty state - voice hero */
      .voice-hero-btn { width: 88px; height: 88px; }
      .voice-hero-btn svg { width: 36px; height: 36px; }
      .app-chat-empty-logo { font-size: 24px; }
      .app-chat-empty-text { font-size: 14px; }
      .app-chat-suggestions { gap: 6px; padding: 0 12px; }
      .app-chat-suggestion { font-size: 12px; padding: 8px 14px; }

      /* TTS button - larger touch target on mobile */
      .app-tts-btn { padding: 5px 10px; font-size: 14px; min-height: 32px; }

      /* Sidebar */
      .app-ch-btn { padding: 6px 8px; }
      .app-ch-btn svg { width: 18px; height: 18px; }
      .app-ch-btn .app-ch-name { font-size: 11px; }
      .app-ch-btn .app-ch-status { font-size: 9px; }
      .app-ch-more-btn { padding: 3px; }
      .app-ch-more-btn svg { width: 12px; height: 12px; }
    }

    /* Small phones (iPhone SE, etc.) */
    @media (max-width: 400px) {
      .app-chat-input-area { padding: 6px 8px calc(env(safe-area-inset-bottom, 6px) + 6px); }
      .app-chat-input-box textarea { font-size: 16px; }
      .app-chat-empty-logo { font-size: 22px; }
      .app-chat-messages .app-msg { padding: 0 6px; }
      .app-chat-messages .app-msg-user .app-msg-bubble { max-width: 92%; }
    }

    /* Mobile hamburger menu */
    .nav-hamburger {
      display: none;
      background: none;
      border: none;
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      padding: 4px;
    }
    .nav-mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      min-width: 180px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      z-index: 50;
    }
    .nav-mobile-menu.show { display: block; }
    .nav-mobile-menu a, .nav-mobile-menu button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .nav-mobile-menu a:hover, .nav-mobile-menu button:hover {
      background: var(--surface2);
      color: var(--text);
    }

    @media (max-width: 600px) {
      .hero h1 { font-size: 30px; }
      .channels { grid-template-columns: 1fr; }
      .channel-cards { grid-template-columns: 1fr; }
      .recipe-grid { grid-template-columns: 1fr; }
      .chat-messages { height: 240px; }
      .voice-demo-grid { gap: 8px; }
      .voice-demo-btn { padding: 6px 12px; font-size: 13px; }
      .stats-bar { gap: 20px; }
      .stat-value { font-size: 20px; }
      .bottom-cta { padding: 28px 20px; }
      .bottom-cta h2 { font-size: 20px; }
      .sync-steps { grid-template-columns: 1fr; }
      .sync-flow { gap: 8px; }
      .cap-grid { grid-template-columns: 1fr 1fr; }

      /* Collapse nav to hamburger on mobile */
      nav { padding: 12px 16px; position: relative; }
      .nav-right > a,
      .nav-right > .lang-sw { display: none; }
      .nav-hamburger { display: block; }
      .nav-right { gap: 8px; }
      .auth-nav-btn { font-size: 12px; padding: 5px 12px; }
      .user-name { font-size: 12px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

      /* Chat header: wrap to two rows on mobile */
      .chat-header { flex-wrap: wrap; padding: 10px 14px; gap: 6px; }
      .chat-header .dot { width: 6px; height: 6px; }
      #t-chat-status { font-size: 11px; }
      .ch-bar { margin-left: 0; }
      .ch-bar-btn { padding: 3px 8px; font-size: 10px; }
      .ch-bar-btn svg { width: 12px; height: 12px; }
      #agent-select { font-size: 11px; padding: 4px 6px; margin-left: auto; }

      /* CLI section on mobile */
      #cli-sync-cmd { font-size: 10px !important; }
      #cli-sync-cmd span { font-size: 10px !important; }

      /* Simplify footer on mobile */
      footer { padding: 20px 16px; font-size: 11px; line-height: 2; }
    }

    /* Landing page: Less is more — Hero + Chat only */
    .voice-demo, .cap-section, #recipe-section, #sync-section,
    .channel-cards, #link-cmd-hint, #cli-install-section,
    #use-cases, .stats-bar, .trust-bar, .social-proof, .bottom-cta { display: none !important; }

    /* Hide agent-select on landing page */
    #agent-select { display: none; }

    /* Demo messages fade when user logs in */
    body.app-mode .demo-msg { display: none; }
  </style>
  <!--
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('YOUR_PROJECT_KEY',{api_host:'https://us.i.posthog.com',person_profiles:'identified_only'});
  </script>
  -->
  <script>var qrcode=function(){var t=function(t,r){var e=t,n=g[r],o=null,i=0,a=null,u=[],f={},c=function(t,r){o=function(t){for(var r=new Array(t),e=0;e<t;e+=1){r[e]=new Array(t);for(var n=0;n<t;n+=1)r[e][n]=null}return r}(i=4*e+17),l(0,0),l(i-7,0),l(0,i-7),s(),h(),d(t,r),e>=7&&v(t),null==a&&(a=p(e,n,u)),w(a,r)},l=function(t,r){for(var e=-1;e<=7;e+=1)if(!(t+e<=-1||i<=t+e))for(var n=-1;n<=7;n+=1)r+n<=-1||i<=r+n||(o[t+e][r+n]=0<=e&&e<=6&&(0==n||6==n)||0<=n&&n<=6&&(0==e||6==e)||2<=e&&e<=4&&2<=n&&n<=4)},h=function(){for(var t=8;t<i-8;t+=1)null==o[t][6]&&(o[t][6]=t%2==0);for(var r=8;r<i-8;r+=1)null==o[6][r]&&(o[6][r]=r%2==0)},s=function(){for(var t=B.getPatternPosition(e),r=0;r<t.length;r+=1)for(var n=0;n<t.length;n+=1){var i=t[r],a=t[n];if(null==o[i][a])for(var u=-2;u<=2;u+=1)for(var f=-2;f<=2;f+=1)o[i+u][a+f]=-2==u||2==u||-2==f||2==f||0==u&&0==f}},v=function(t){for(var r=B.getBCHTypeNumber(e),n=0;n<18;n+=1){var a=!t&&1==(r>>n&1);o[Math.floor(n/3)][n%3+i-8-3]=a}for(n=0;n<18;n+=1){a=!t&&1==(r>>n&1);o[n%3+i-8-3][Math.floor(n/3)]=a}},d=function(t,r){for(var e=n<<3|r,a=B.getBCHTypeInfo(e),u=0;u<15;u+=1){var f=!t&&1==(a>>u&1);u<6?o[u][8]=f:u<8?o[u+1][8]=f:o[i-15+u][8]=f}for(u=0;u<15;u+=1){f=!t&&1==(a>>u&1);u<8?o[8][i-u-1]=f:u<9?o[8][15-u-1+1]=f:o[8][15-u-1]=f}o[i-8][8]=!t},w=function(t,r){for(var e=-1,n=i-1,a=7,u=0,f=B.getMaskFunction(r),c=i-1;c>0;c-=2)for(6==c&&(c-=1);;){for(var g=0;g<2;g+=1)if(null==o[n][c-g]){var l=!1;u<t.length&&(l=1==(t[u]>>>a&1)),f(n,c-g)&&(l=!l),o[n][c-g]=l,-1==(a-=1)&&(u+=1,a=7)}if((n+=e)<0||i<=n){n-=e,e=-e;break}}},p=function(t,r,e){for(var n=A.getRSBlocks(t,r),o=b(),i=0;i<e.length;i+=1){var a=e[i];o.put(a.getMode(),4),o.put(a.getLength(),B.getLengthInBits(a.getMode(),t)),a.write(o)}var u=0;for(i=0;i<n.length;i+=1)u+=n[i].dataCount;if(o.getLengthInBits()>8*u)throw"code length overflow. ("+o.getLengthInBits()+">"+8*u+")";for(o.getLengthInBits()+4<=8*u&&o.put(0,4);o.getLengthInBits()%8!=0;)o.putBit(!1);for(;!(o.getLengthInBits()>=8*u||(o.put(236,8),o.getLengthInBits()>=8*u));)o.put(17,8);return function(t,r){for(var e=0,n=0,o=0,i=new Array(r.length),a=new Array(r.length),u=0;u<r.length;u+=1){var f=r[u].dataCount,c=r[u].totalCount-f;n=Math.max(n,f),o=Math.max(o,c),i[u]=new Array(f);for(var g=0;g<i[u].length;g+=1)i[u][g]=255&t.getBuffer()[g+e];e+=f;var l=B.getErrorCorrectPolynomial(c),h=k(i[u],l.getLength()-1).mod(l);for(a[u]=new Array(l.getLength()-1),g=0;g<a[u].length;g+=1){var s=g+h.getLength()-a[u].length;a[u][g]=s>=0?h.getAt(s):0}}var v=0;for(g=0;g<r.length;g+=1)v+=r[g].totalCount;var d=new Array(v),w=0;for(g=0;g<n;g+=1)for(u=0;u<r.length;u+=1)g<i[u].length&&(d[w]=i[u][g],w+=1);for(g=0;g<o;g+=1)for(u=0;u<r.length;u+=1)g<a[u].length&&(d[w]=a[u][g],w+=1);return d}(o,n)};f.addData=function(t,r){var e=null;switch(r=r||"Byte"){case"Numeric":e=M(t);break;case"Alphanumeric":e=x(t);break;case"Byte":e=m(t);break;case"Kanji":e=L(t);break;default:throw"mode:"+r}u.push(e),a=null},f.isDark=function(t,r){if(t<0||i<=t||r<0||i<=r)throw t+","+r;return o[t][r]},f.getModuleCount=function(){return i},f.make=function(){if(e<1){for(var t=1;t<40;t++){for(var r=A.getRSBlocks(t,n),o=b(),i=0;i<u.length;i++){var a=u[i];o.put(a.getMode(),4),o.put(a.getLength(),B.getLengthInBits(a.getMode(),t)),a.write(o)}var g=0;for(i=0;i<r.length;i++)g+=r[i].dataCount;if(o.getLengthInBits()<=8*g)break}e=t}c(!1,function(){for(var t=0,r=0,e=0;e<8;e+=1){c(!0,e);var n=B.getLostPoint(f);(0==e||t>n)&&(t=n,r=e)}return r}())},f.createTableTag=function(t,r){t=t||2;var e="";e+='<table style="',e+=" border-width: 0px; border-style: none;",e+=" border-collapse: collapse;",e+=" padding: 0px; margin: "+(r=void 0===r?4*t:r)+"px;",e+='">',e+="<tbody>";for(var n=0;n<f.getModuleCount();n+=1){e+="<tr>";for(var o=0;o<f.getModuleCount();o+=1)e+='<td style="',e+=" border-width: 0px; border-style: none;",e+=" border-collapse: collapse;",e+=" padding: 0px; margin: 0px;",e+=" width: "+t+"px;",e+=" height: "+t+"px;",e+=" background-color: ",e+=f.isDark(n,o)?"#000000":"#ffffff",e+=";",e+='"/>';e+="</tr>"}return e+="</tbody>",e+="</table>"},f.createSvgTag=function(t,r,e,n){var o={};"object"==typeof arguments[0]&&(t=(o=arguments[0]).cellSize,r=o.margin,e=o.alt,n=o.title),t=t||2,r=void 0===r?4*t:r,(e="string"==typeof e?{text:e}:e||{}).text=e.text||null,e.id=e.text?e.id||"qrcode-description":null,(n="string"==typeof n?{text:n}:n||{}).text=n.text||null,n.id=n.text?n.id||"qrcode-title":null;var i,a,u,c,g=f.getModuleCount()*t+2*r,l="";for(c="l"+t+",0 0,"+t+" -"+t+",0 0,-"+t+"z ",l+='<svg version="1.1" xmlns="http://www.w3.org/2000/svg"',l+=o.scalable?"":' width="'+g+'px" height="'+g+'px"',l+=' viewBox="0 0 '+g+" "+g+'" ',l+=' preserveAspectRatio="xMinYMin meet"',l+=n.text||e.text?' role="img" aria-labelledby="'+y([n.id,e.id].join(" ").trim())+'"':"",l+=">",l+=n.text?'<title id="'+y(n.id)+'">'+y(n.text)+"</title>":"",l+=e.text?'<description id="'+y(e.id)+'">'+y(e.text)+"</description>":"",l+='<rect width="100%" height="100%" fill="white" cx="0" cy="0"/>',l+='<path d="',a=0;a<f.getModuleCount();a+=1)for(u=a*t+r,i=0;i<f.getModuleCount();i+=1)f.isDark(a,i)&&(l+="M"+(i*t+r)+","+u+c);return l+='" stroke="transparent" fill="black"/>',l+="</svg>"},f.createDataURL=function(t,r){t=t||2,r=void 0===r?4*t:r;var e=f.getModuleCount()*t+2*r,n=r,o=e-r;return I(e,e,(function(r,e){if(n<=r&&r<o&&n<=e&&e<o){var i=Math.floor((r-n)/t),a=Math.floor((e-n)/t);return f.isDark(a,i)?0:1}return 1}))},f.createImgTag=function(t,r,e){t=t||2,r=void 0===r?4*t:r;var n=f.getModuleCount()*t+2*r,o="";return o+="<img",o+=' src="',o+=f.createDataURL(t,r),o+='"',o+=' width="',o+=n,o+='"',o+=' height="',o+=n,o+='"',e&&(o+=' alt="',o+=y(e),o+='"'),o+="/>"};var y=function(t){for(var r="",e=0;e<t.length;e+=1){var n=t.charAt(e);switch(n){case"<":r+="&lt;";break;case">":r+="&gt;";break;case"&":r+="&amp;";break;case'"':r+="&quot;";break;default:r+=n}}return r};return f.createASCII=function(t,r){if((t=t||1)<2)return function(t){t=void 0===t?2:t;var r,e,n,o,i,a=1*f.getModuleCount()+2*t,u=t,c=a-t,g={"██":"█","█ ":"▀"," █":"▄","  ":" "},l={"██":"▀","█ ":"▀"," █":" ","  ":" "},h="";for(r=0;r<a;r+=2){for(n=Math.floor((r-u)/1),o=Math.floor((r+1-u)/1),e=0;e<a;e+=1)i="█",u<=e&&e<c&&u<=r&&r<c&&f.isDark(n,Math.floor((e-u)/1))&&(i=" "),u<=e&&e<c&&u<=r+1&&r+1<c&&f.isDark(o,Math.floor((e-u)/1))?i+=" ":i+="█",h+=t<1&&r+1>=c?l[i]:g[i];h+="\n"}return a%2&&t>0?h.substring(0,h.length-a-1)+Array(a+1).join("▀"):h.substring(0,h.length-1)}(r);t-=1,r=void 0===r?2*t:r;var e,n,o,i,a=f.getModuleCount()*t+2*r,u=r,c=a-r,g=Array(t+1).join("██"),l=Array(t+1).join("  "),h="",s="";for(e=0;e<a;e+=1){for(o=Math.floor((e-u)/t),s="",n=0;n<a;n+=1)i=1,u<=n&&n<c&&u<=e&&e<c&&f.isDark(o,Math.floor((n-u)/t))&&(i=0),s+=i?g:l;for(o=0;o<t;o+=1)h+=s+"\n"}return h.substring(0,h.length-1)},f.renderTo2dContext=function(t,r){r=r||2;for(var e=f.getModuleCount(),n=0;n<e;n++)for(var o=0;o<e;o++)t.fillStyle=f.isDark(n,o)?"black":"white",t.fillRect(n*r,o*r,r,r)},f};t.stringToBytes=(t.stringToBytesFuncs={default:function(t){for(var r=[],e=0;e<t.length;e+=1){var n=t.charCodeAt(e);r.push(255&n)}return r}}).default,t.createStringToBytes=function(t,r){var e=function(){for(var e=S(t),n=function(){var t=e.read();if(-1==t)throw"eof";return t},o=0,i={};;){var a=e.read();if(-1==a)break;var u=n(),f=n()<<8|n();i[String.fromCharCode(a<<8|u)]=f,o+=1}if(o!=r)throw o+" != "+r;return i}(),n="?".charCodeAt(0);return function(t){for(var r=[],o=0;o<t.length;o+=1){var i=t.charCodeAt(o);if(i<128)r.push(i);else{var a=e[t.charAt(o)];"number"==typeof a?(255&a)==a?r.push(a):(r.push(a>>>8),r.push(255&a)):r.push(n)}}return r}};var r,e,n,o,i,a=1,u=2,f=4,c=8,g={L:1,M:0,Q:3,H:2},l=0,h=1,s=2,v=3,d=4,w=5,p=6,y=7,B=(r=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],e=1335,n=7973,i=function(t){for(var r=0;0!=t;)r+=1,t>>>=1;return r},(o={}).getBCHTypeInfo=function(t){for(var r=t<<10;i(r)-i(e)>=0;)r^=e<<i(r)-i(e);return 21522^(t<<10|r)},o.getBCHTypeNumber=function(t){for(var r=t<<12;i(r)-i(n)>=0;)r^=n<<i(r)-i(n);return t<<12|r},o.getPatternPosition=function(t){return r[t-1]},o.getMaskFunction=function(t){switch(t){case l:return function(t,r){return(t+r)%2==0};case h:return function(t,r){return t%2==0};case s:return function(t,r){return r%3==0};case v:return function(t,r){return(t+r)%3==0};case d:return function(t,r){return(Math.floor(t/2)+Math.floor(r/3))%2==0};case w:return function(t,r){return t*r%2+t*r%3==0};case p:return function(t,r){return(t*r%2+t*r%3)%2==0};case y:return function(t,r){return(t*r%3+(t+r)%2)%2==0};default:throw"bad maskPattern:"+t}},o.getErrorCorrectPolynomial=function(t){for(var r=k([1],0),e=0;e<t;e+=1)r=r.multiply(k([1,C.gexp(e)],0));return r},o.getLengthInBits=function(t,r){if(1<=r&&r<10)switch(t){case a:return 10;case u:return 9;case f:case c:return 8;default:throw"mode:"+t}else if(r<27)switch(t){case a:return 12;case u:return 11;case f:return 16;case c:return 10;default:throw"mode:"+t}else{if(!(r<41))throw"type:"+r;switch(t){case a:return 14;case u:return 13;case f:return 16;case c:return 12;default:throw"mode:"+t}}},o.getLostPoint=function(t){for(var r=t.getModuleCount(),e=0,n=0;n<r;n+=1)for(var o=0;o<r;o+=1){for(var i=0,a=t.isDark(n,o),u=-1;u<=1;u+=1)if(!(n+u<0||r<=n+u))for(var f=-1;f<=1;f+=1)o+f<0||r<=o+f||0==u&&0==f||a==t.isDark(n+u,o+f)&&(i+=1);i>5&&(e+=3+i-5)}for(n=0;n<r-1;n+=1)for(o=0;o<r-1;o+=1){var c=0;t.isDark(n,o)&&(c+=1),t.isDark(n+1,o)&&(c+=1),t.isDark(n,o+1)&&(c+=1),t.isDark(n+1,o+1)&&(c+=1),0!=c&&4!=c||(e+=3)}for(n=0;n<r;n+=1)for(o=0;o<r-6;o+=1)t.isDark(n,o)&&!t.isDark(n,o+1)&&t.isDark(n,o+2)&&t.isDark(n,o+3)&&t.isDark(n,o+4)&&!t.isDark(n,o+5)&&t.isDark(n,o+6)&&(e+=40);for(o=0;o<r;o+=1)for(n=0;n<r-6;n+=1)t.isDark(n,o)&&!t.isDark(n+1,o)&&t.isDark(n+2,o)&&t.isDark(n+3,o)&&t.isDark(n+4,o)&&!t.isDark(n+5,o)&&t.isDark(n+6,o)&&(e+=40);var g=0;for(o=0;o<r;o+=1)for(n=0;n<r;n+=1)t.isDark(n,o)&&(g+=1);return e+=Math.abs(100*g/r/r-50)/5*10},o),C=function(){for(var t=new Array(256),r=new Array(256),e=0;e<8;e+=1)t[e]=1<<e;for(e=8;e<256;e+=1)t[e]=t[e-4]^t[e-5]^t[e-6]^t[e-8];for(e=0;e<255;e+=1)r[t[e]]=e;var n={glog:function(t){if(t<1)throw"glog("+t+")";return r[t]},gexp:function(r){for(;r<0;)r+=255;for(;r>=256;)r-=255;return t[r]}};return n}();function k(t,r){if(void 0===t.length)throw t.length+"/"+r;var e=function(){for(var e=0;e<t.length&&0==t[e];)e+=1;for(var n=new Array(t.length-e+r),o=0;o<t.length-e;o+=1)n[o]=t[o+e];return n}(),n={getAt:function(t){return e[t]},getLength:function(){return e.length},multiply:function(t){for(var r=new Array(n.getLength()+t.getLength()-1),e=0;e<n.getLength();e+=1)for(var o=0;o<t.getLength();o+=1)r[e+o]^=C.gexp(C.glog(n.getAt(e))+C.glog(t.getAt(o)));return k(r,0)},mod:function(t){if(n.getLength()-t.getLength()<0)return n;for(var r=C.glog(n.getAt(0))-C.glog(t.getAt(0)),e=new Array(n.getLength()),o=0;o<n.getLength();o+=1)e[o]=n.getAt(o);for(o=0;o<t.getLength();o+=1)e[o]^=C.gexp(C.glog(t.getAt(o))+r);return k(e,0).mod(t)}};return n}var A=function(){var t=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12,7,37,13],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],r=function(t,r){var e={};return e.totalCount=t,e.dataCount=r,e},e={};return e.getRSBlocks=function(e,n){var o=function(r,e){switch(e){case g.L:return t[4*(r-1)+0];case g.M:return t[4*(r-1)+1];case g.Q:return t[4*(r-1)+2];case g.H:return t[4*(r-1)+3];default:return}}(e,n);if(void 0===o)throw"bad rs block @ typeNumber:"+e+"/errorCorrectionLevel:"+n;for(var i=o.length/3,a=[],u=0;u<i;u+=1)for(var f=o[3*u+0],c=o[3*u+1],l=o[3*u+2],h=0;h<f;h+=1)a.push(r(c,l));return a},e}(),b=function(){var t=[],r=0,e={getBuffer:function(){return t},getAt:function(r){var e=Math.floor(r/8);return 1==(t[e]>>>7-r%8&1)},put:function(t,r){for(var n=0;n<r;n+=1)e.putBit(1==(t>>>r-n-1&1))},getLengthInBits:function(){return r},putBit:function(e){var n=Math.floor(r/8);t.length<=n&&t.push(0),e&&(t[n]|=128>>>r%8),r+=1}};return e},M=function(t){var r=a,e=t,n={getMode:function(){return r},getLength:function(t){return e.length},write:function(t){for(var r=e,n=0;n+2<r.length;)t.put(o(r.substring(n,n+3)),10),n+=3;n<r.length&&(r.length-n==1?t.put(o(r.substring(n,n+1)),4):r.length-n==2&&t.put(o(r.substring(n,n+2)),7))}},o=function(t){for(var r=0,e=0;e<t.length;e+=1)r=10*r+i(t.charAt(e));return r},i=function(t){if("0"<=t&&t<="9")return t.charCodeAt(0)-"0".charCodeAt(0);throw"illegal char :"+t};return n},x=function(t){var r=u,e=t,n={getMode:function(){return r},getLength:function(t){return e.length},write:function(t){for(var r=e,n=0;n+1<r.length;)t.put(45*o(r.charAt(n))+o(r.charAt(n+1)),11),n+=2;n<r.length&&t.put(o(r.charAt(n)),6)}},o=function(t){if("0"<=t&&t<="9")return t.charCodeAt(0)-"0".charCodeAt(0);if("A"<=t&&t<="Z")return t.charCodeAt(0)-"A".charCodeAt(0)+10;switch(t){case" ":return 36;case"$":return 37;case"%":return 38;case"*":return 39;case"+":return 40;case"-":return 41;case".":return 42;case"/":return 43;case":":return 44;default:throw"illegal char :"+t}};return n},m=function(r){var e=f,n=t.stringToBytes(r),o={getMode:function(){return e},getLength:function(t){return n.length},write:function(t){for(var r=0;r<n.length;r+=1)t.put(n[r],8)}};return o},L=function(r){var e=c,n=t.stringToBytesFuncs.SJIS;if(!n)throw"sjis not supported.";!function(){var t=n("友");if(2!=t.length||38726!=(t[0]<<8|t[1]))throw"sjis not supported."}();var o=n(r),i={getMode:function(){return e},getLength:function(t){return~~(o.length/2)},write:function(t){for(var r=o,e=0;e+1<r.length;){var n=(255&r[e])<<8|255&r[e+1];if(33088<=n&&n<=40956)n-=33088;else{if(!(57408<=n&&n<=60351))throw"illegal char at "+(e+1)+"/"+n;n-=49472}n=192*(n>>>8&255)+(255&n),t.put(n,13),e+=2}if(e<r.length)throw"illegal char at "+(e+1)}};return i},D=function(){var t=[],r={writeByte:function(r){t.push(255&r)},writeShort:function(t){r.writeByte(t),r.writeByte(t>>>8)},writeBytes:function(t,e,n){e=e||0,n=n||t.length;for(var o=0;o<n;o+=1)r.writeByte(t[o+e])},writeString:function(t){for(var e=0;e<t.length;e+=1)r.writeByte(t.charCodeAt(e))},toByteArray:function(){return t},toString:function(){var r="";r+="[";for(var e=0;e<t.length;e+=1)e>0&&(r+=","),r+=t[e];return r+="]"}};return r},S=function(t){var r=t,e=0,n=0,o=0,i={read:function(){for(;o<8;){if(e>=r.length){if(0==o)return-1;throw"unexpected end of file./"+o}var t=r.charAt(e);if(e+=1,"="==t)return o=0,-1;t.match(/^\s$/)||(n=n<<6|a(t.charCodeAt(0)),o+=6)}var i=n>>>o-8&255;return o-=8,i}},a=function(t){if(65<=t&&t<=90)return t-65;if(97<=t&&t<=122)return t-97+26;if(48<=t&&t<=57)return t-48+52;if(43==t)return 62;if(47==t)return 63;throw"c:"+t};return i},I=function(t,r,e){for(var n=function(t,r){var e=t,n=r,o=new Array(t*r),i={setPixel:function(t,r,n){o[r*e+t]=n},write:function(t){t.writeString("GIF87a"),t.writeShort(e),t.writeShort(n),t.writeByte(128),t.writeByte(0),t.writeByte(0),t.writeByte(0),t.writeByte(0),t.writeByte(0),t.writeByte(255),t.writeByte(255),t.writeByte(255),t.writeString(","),t.writeShort(0),t.writeShort(0),t.writeShort(e),t.writeShort(n),t.writeByte(0);var r=a(2);t.writeByte(2);for(var o=0;r.length-o>255;)t.writeByte(255),t.writeBytes(r,o,255),o+=255;t.writeByte(r.length-o),t.writeBytes(r,o,r.length-o),t.writeByte(0),t.writeString(";")}},a=function(t){for(var r=1<<t,e=1+(1<<t),n=t+1,i=u(),a=0;a<r;a+=1)i.add(String.fromCharCode(a));i.add(String.fromCharCode(r)),i.add(String.fromCharCode(e));var f,c,g,l=D(),h=(f=l,c=0,g=0,{write:function(t,r){if(t>>>r!=0)throw"length over";for(;c+r>=8;)f.writeByte(255&(t<<c|g)),r-=8-c,t>>>=8-c,g=0,c=0;g|=t<<c,c+=r},flush:function(){c>0&&f.writeByte(g)}});h.write(r,n);var s=0,v=String.fromCharCode(o[s]);for(s+=1;s<o.length;){var d=String.fromCharCode(o[s]);s+=1,i.contains(v+d)?v+=d:(h.write(i.indexOf(v),n),i.size()<4095&&(i.size()==1<<n&&(n+=1),i.add(v+d)),v=d)}return h.write(i.indexOf(v),n),h.write(e,n),h.flush(),l.toByteArray()},u=function(){var t={},r=0,e={add:function(n){if(e.contains(n))throw"dup key:"+n;t[n]=r,r+=1},size:function(){return r},indexOf:function(r){return t[r]},contains:function(r){return void 0!==t[r]}};return e};return i}(t,r),o=0;o<r;o+=1)for(var i=0;i<t;i+=1)n.setPixel(i,o,e(i,o));var a=D();n.write(a);for(var u=function(){var t=0,r=0,e=0,n="",o={},i=function(t){n+=String.fromCharCode(a(63&t))},a=function(t){if(t<0);else{if(t<26)return 65+t;if(t<52)return t-26+97;if(t<62)return t-52+48;if(62==t)return 43;if(63==t)return 47}throw"n:"+t};return o.writeByte=function(n){for(t=t<<8|255&n,r+=8,e+=1;r>=6;)i(t>>>r-6),r-=6},o.flush=function(){if(r>0&&(i(t<<6-r),t=0,r=0),e%3!=0)for(var o=3-e%3,a=0;a<o;a+=1)n+="="},o.toString=function(){return n},o}(),f=a.toByteArray(),c=0;c<f.length;c+=1)u.writeByte(f[c]);return u.flush(),"data:image/gif;base64,"+u};return t}();qrcode.stringToBytesFuncs["UTF-8"]=function(t){return function(t){for(var r=[],e=0;e<t.length;e++){var n=t.charCodeAt(e);n<128?r.push(n):n<2048?r.push(192|n>>6,128|63&n):n<55296||n>=57344?r.push(224|n>>12,128|n>>6&63,128|63&n):(e++,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),r.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return r}(t)};</script>
</head>
<body>
  <script>
    if (localStorage.getItem('authToken') || new URLSearchParams(window.location.search).get('token')) {
      document.body.classList.add('app-mode');
    }
  </script>
  <nav>
    <button class="app-sidebar-toggle" id="app-sidebar-toggle" onclick="toggleSidebar()" style="display:none;" aria-label="Toggle sidebar">&#x2630;</button>
    <a href="/" class="logo" style="text-decoration:none"><span>chat</span>web.ai</a>
    <div class="nav-right">
      <a href="/pricing" id="nav-pricing">Pricing</a>
      <a href="/settings" id="nav-settings">Settings</a>
      <a href="/status" id="nav-status">Status</a>
      <a href="https://github.com/yukihamada/nanobot" target="_blank">GitHub</a>
      <div class="lang-sw" id="lang-sw-nav" style="display:none;">
        <button onclick="setLang('ja')" id="l-ja">JA</button>
        <button onclick="setLang('en')" id="l-en">EN</button>
      </div>
      <div id="auth-nav">
        <button class="auth-nav-btn" id="login-btn" onclick="openAuthModal()">Login</button>
        <div class="user-menu" id="user-menu" style="display:none;">
          <span class="user-name" id="user-display-name"></span>
          <button class="auth-nav-btn logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      <button class="nav-hamburger" onclick="toggleMobileMenu()" aria-label="Menu">&#x2630;</button>
      <div class="nav-mobile-menu" id="mobile-menu">
        <a href="/pricing" id="mob-pricing">Pricing</a>
        <a href="/settings" id="mob-settings">Settings</a>
        <a href="/status" id="mob-status">Status</a>
        <a href="https://github.com/yukihamada/nanobot" target="_blank">GitHub</a>
        <button onclick="setLang('ja');closeMobileMenu()" class="lang-switch-mob" style="display:none;">🇯🇵 日本語</button>
        <button onclick="setLang('en');closeMobileMenu()" class="lang-switch-mob" style="display:none;">🇬🇧 English</button>
      </div>
    </div>
  </nav>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3 id="sidebar-title">Conversations</h3>
      <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Close sidebar">&#x2715;</button>
    </div>
    <button class="sidebar-new-btn" id="new-conv-btn" onclick="newConversation()">+ New Conversation</button>
    <div class="sidebar-list" id="conv-list"></div>
  </div>
  <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" style="display:none;">&#x2630;</button>

  <main class="main" role="main">
    <div class="hero fade-up">
      <canvas id="hero-canvas" width="900" height="380"></canvas>
      <h1 id="t-title">お願いしたら、本当にやってくれるAI。</h1>
      <p id="t-subtitle">チャットで頼むだけ。検索、コード実行、ファイル操作、定期監視まで — 声でもテキストでも。</p>
      <div class="hero-cta" id="t-hero-cta">
        <a href="#chat-area" class="cta-primary" id="t-hero-try" onclick="document.getElementById('input').focus();return false;">今すぐ無料で試す</a>
      </div>
    </div>

    <div class="fade-up fade-up-d1" id="use-cases" style="max-width:640px;margin:0 auto 32px;padding:0 16px;">
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 18px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <span style="font-size:20px;">📁</span>
            <span style="font-size:14px;font-weight:700;" id="uc-1-title">ファイルの整理</span>
          </div>
          <p style="font-size:12px;color:var(--muted);line-height:1.6;" id="uc-1-desc">「ダウンロードフォルダを種類別に整理して」— フォルダ作成からファイル移動まで自動で完了。</p>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 18px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <span style="font-size:20px;">🔧</span>
            <span style="font-size:14px;font-weight:700;" id="uc-2-title">環境構築・バグ修正</span>
          </div>
          <p style="font-size:12px;color:var(--muted);line-height:1.6;" id="uc-2-desc">「このリポジトリを動くようにして」— エラーを自力で解決し、起動まで自律的に試行錯誤。</p>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 18px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <span style="font-size:20px;">💓</span>
            <span style="font-size:14px;font-weight:700;" id="uc-3-title">定期監視（ハートビート）</span>
          </div>
          <p style="font-size:12px;color:var(--muted);line-height:1.6;" id="uc-3-desc">「サーバーが落ちてないか見ておいて」— 寝ている間にダウンを検知し、復旧して事後報告。</p>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 18px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <span style="font-size:20px;">🌐</span>
            <span style="font-size:14px;font-weight:700;" id="uc-4-title">Web操作の代行</span>
          </div>
          <p style="font-size:12px;color:var(--muted);line-height:1.6;" id="uc-4-desc">「最安値フライトを探してカレンダーに入れて」— 複数サイトを巡回し、予定登録まで全自動。</p>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 18px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <span style="font-size:20px;">🧠</span>
            <span style="font-size:14px;font-weight:700;" id="uc-5-title">ずっと覚えている（永続メモリ）</span>
          </div>
          <p style="font-size:12px;color:var(--muted);line-height:1.6;" id="uc-5-desc">「いつもの感じでメール返信して」— 過去の会話や好みをずっと覚えているから、毎回の説明が不要。</p>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 18px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <span style="font-size:20px;">🎙️</span>
            <span style="font-size:14px;font-weight:700;" id="uc-6-title">声で操作、どこからでも</span>
          </div>
          <p style="font-size:12px;color:var(--muted);line-height:1.6;" id="uc-6-desc">「声で指示するだけ」— Web・LINE・Telegramどこからでも同じAIが応答。マルチチャネル対応。</p>
        </div>
      </div>
    </div>

    <div class="voice-demo fade-up fade-up-d1">
      <div class="voice-demo-label" id="t-voice-label">🎙️ AIの声を聴いてみよう</div>
      <div class="voice-demo-grid" id="voice-demo-grid"></div>
      <div class="voice-demo-output" id="voice-demo-output"></div>
    </div>

    <div class="stats-bar fade-up fade-up-d1">
      <div class="stat-item">
        <div class="stat-value" id="stat-uptime">99.9%</div>
        <div class="stat-label" id="stat-uptime-label">稼働率</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-speed">&lt;2s</div>
        <div class="stat-label" id="stat-speed-label">平均応答</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-models">5+</div>
        <div class="stat-label" id="stat-models-label">AIモデル</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-channels">3</div>
        <div class="stat-label" id="stat-channels-label">チャネル</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tools">4+MCP</div>
        <div class="stat-label" id="stat-tools-label">ツール</div>
      </div>
    </div>

    <div class="trust-bar fade-up fade-up-d2">
      <div class="trust-item">
        <svg viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
        <span id="trust-ssl">SSL</span>
      </div>
      <div class="trust-item">
        <svg viewBox="0 0 16 16"><path d="M8 1L1 5v6l7 4 7-4V5L8 1zm0 1.5L13.5 6 8 9.5 2.5 6 8 2.5z"/></svg>
        <span id="trust-stripe">Stripe</span>
      </div>
      <div class="trust-item">
        <svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 6.5l-4 4a.75.75 0 0 1-1 0l-2-2a.75.75 0 1 1 1-1L7 9l3.5-3.5a.75.75 0 1 1 1 1z"/></svg>
        <span id="trust-nocard">No card required</span>
      </div>
    </div>

    <div class="social-proof fade-up fade-up-d2" style="text-align:center;margin-bottom:20px;font-size:12px;color:var(--muted);">
      <span id="social-proof-text">🇯🇵 日本発 &middot; オープンソース &middot; Web・LINE・Telegram対応</span>
    </div>

    <div class="chat-box fade-up fade-up-d2" id="chat-area">
      <div class="chat-header">
        <div class="dot"></div>
        <span id="t-chat-status">オンライン</span>
        <span id="adult-mode-badge" style="display:none;font-size:12px;background:rgba(139,92,246,0.15);color:#8b5cf6;padding:1px 6px;border-radius:8px;margin-left:4px;" title="Adult mode enabled">&#128274;</span>
        <div class="ch-bar">
          <a class="ch-bar-btn line-bar" id="ch-bar-line" onclick="openChannelLink('line');return false;" href="#">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 5.81 2 10.5c0 4.01 3.44 7.37 8.09 8.25.31.07.74.21.85.48.1.25.06.63.03.88l-.14.82c-.04.25-.2.96.84.52s5.58-3.29 7.61-5.63C21.31 13.51 22 12.07 22 10.5 22 5.81 17.52 2 12 2z" fill="#fff"/></svg>
            LINE <span class="ch-check">&#x2713;</span>
          </a>
          <a class="ch-bar-btn tg-bar" id="ch-bar-tg" onclick="openChannelLink('tg');return false;" href="#">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.88 8.85c-.14.63-.51.78-.84.49l-2.31-1.7-1.79 1.72c-.2.2-.36.36-.74.36l.27-3.78 6.88-6.22c.3-.27-.07-.42-.47-.16L8.09 13.29l-2.61-.82c-.57-.18-.58-.57.12-.84l11.03-4.27c.47-.17.88.11.73.79h.17z" fill="#fff"/></svg>
            TG <span class="ch-check">&#x2713;</span>
          </a>
        </div>
        <select id="agent-select" onchange="selectAgent(this.value)">
          <option value="auto" id="opt-auto">Auto</option>
          <option value="assistant">Assistant</option>
          <option value="researcher">Researcher</option>
          <option value="coder">Coder</option>
          <option value="analyst">Analyst</option>
          <option value="creative">Creative</option>
        </select>
      </div>
      <div class="chat-messages" id="messages">
        <div class="msg bot" id="t-welcome"></div>
        <div class="msg user demo-msg" id="demo-q1">やる気が出ない</div>
        <div class="msg bot demo-msg" id="demo-a1">わかります。やる気って、待ってても来ないんですよね。<br>...でも不思議と、誰かと話してると出てきたりする。<br>というわけで、今ちょっとだけ出てきてません？ 😏</div>
      </div>
      <div class="chat-input" style="position:relative;">
        <input type="text" id="input" placeholder="何でも聞いてください..." autocomplete="off">
        <button onclick="send()" id="send-btn">送信</button>
        <div id="chat-login-overlay" class="chat-login-overlay hidden" onclick="openAuthModal()">
          <span id="chat-login-text">ログインして会話を始める</span>
        </div>
      </div>
    </div>

    <div class="cap-section fade-up fade-up-d3" id="cap-section">
      <h2 id="t-cap-title">AI + ツールで、なんでも自動化</h2>
      <p class="cap-sub" id="t-cap-sub">内蔵ツール + MCP拡張で無限の可能性</p>
      <div class="cap-grid">
        <div class="cap-card">
          <div class="cap-icon">&#x1F50D;</div>
          <div class="cap-name" id="cap-search">Web検索</div>
          <div class="cap-desc" id="cap-search-d">リアルタイムの情報を検索・収集</div>
          <div class="cap-badge built-in" id="cap-search-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F310;</div>
          <div class="cap-name" id="cap-fetch">Webページ取得</div>
          <div class="cap-desc" id="cap-fetch-d">任意のURLからコンテンツを取得</div>
          <div class="cap-badge built-in" id="cap-fetch-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F9EE;</div>
          <div class="cap-name" id="cap-calc">電卓</div>
          <div class="cap-desc" id="cap-calc-d">数式の計算・通貨換算</div>
          <div class="cap-badge built-in" id="cap-calc-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x26C5;</div>
          <div class="cap-name" id="cap-weather">天気</div>
          <div class="cap-desc" id="cap-weather-d">世界中の天気・予報を取得</div>
          <div class="cap-badge built-in" id="cap-weather-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F4C1;</div>
          <div class="cap-name" id="cap-file">ファイル操作</div>
          <div class="cap-desc" id="cap-file-d">ファイルの読み書き・編集</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F4BB;</div>
          <div class="cap-name" id="cap-shell">シェル実行</div>
          <div class="cap-desc" id="cap-shell-d">コマンドの実行・自動化</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F30F;</div>
          <div class="cap-name" id="cap-browser">ブラウザ</div>
          <div class="cap-desc" id="cap-browser-d">Webページの自動操作</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F5BC;</div>
          <div class="cap-name" id="cap-image">画像解析</div>
          <div class="cap-desc" id="cap-image-d">画像認識・マルチモーダル</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F9E0;</div>
          <div class="cap-name" id="cap-memory">永続メモリ</div>
          <div class="cap-desc" id="cap-memory-d">会話横断で記憶を保持</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
      </div>
      <div class="cap-mcp-note" id="cap-note">
        <span id="cap-note-text">MCPツールはModel Context Protocolで無限に拡張可能。</span>
        <a href="#chat-area" onclick="document.getElementById('input').value='使えるツールを教えて';document.getElementById('input').focus();return false;" id="cap-note-link">ツール一覧を聞いてみる →</a>
      </div>
    </div>

    <div id="recipe-section" class="fade-up fade-up-d3"></div>

    <div class="sync-section fade-up fade-up-d3" id="sync-section">
      <h3 id="t-sync-title">どのチャネルでも同じ会話</h3>
      <p class="sync-desc" id="t-sync-desc">Web・LINE・Telegramの会話をリンクして、どこからでも続きを。</p>
      <div class="sync-flow">
        <div class="channel-icon web-icon">Web</div>
        <div class="sync-arrow">&#x21C4;</div>
        <div class="channel-icon line-icon">LINE</div>
        <div class="sync-arrow">&#x21C4;</div>
        <div class="channel-icon tg-icon">Telegram</div>
      </div>
      <div class="sync-steps" id="sync-steps">
        <div class="sync-step">
          <div class="step-number">1</div>
          <div class="step-title" id="t-step1-title">友だち追加</div>
          <div class="step-desc" id="t-step1-desc">上のボタンからLINE/Telegramで友だち追加</div>
        </div>
        <div class="sync-step">
          <div class="step-number">2</div>
          <div class="step-title" id="t-step2-title">IDで自動連携</div>
          <div class="step-desc" id="t-step2-desc">ボタンを押すだけで自動連携されます</div>
        </div>
        <div class="sync-step">
          <div class="step-number">3</div>
          <div class="step-title" id="t-step3-title">同期完了</div>
          <div class="step-desc" id="t-step3-desc">全チャネルの会話が統合されます</div>
        </div>
      </div>
      <div style="margin-top:16px;position:relative;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px;" id="t-session-label">あなたのセッションID:</div>
        <div id="session-id-display" style="font-family:'SF Mono','Fira Code',monospace;font-size:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer;display:inline-block;color:var(--accent-hover);word-break:break-all;" onclick="navigator.clipboard.writeText(this.textContent);this.style.opacity=0.5;setTimeout(()=>this.style.opacity=1,300)"></div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;" id="t-session-hint">クリックでコピー。LINE/Telegramに貼り付けで連携</div>
      </div>
    </div>

    <div class="sync-section fade-up fade-up-d4" id="device-section" style="display:none;">
      <h3 id="t-device-title">Connected Devices</h3>
      <p class="sync-desc" id="t-device-desc">CLI daemon running on your machines.</p>
      <div id="device-list" style="margin-top:12px;"></div>
      <div style="margin-top:12px;font-size:11px;color:var(--muted);" id="t-device-hint">
        Install CLI and run <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">chatweb daemon</code> to connect your devices.
      </div>
    </div>

    <div class="channel-cards fade-up fade-up-d4" style="flex-wrap:wrap;">
      <a class="channel-card line-card" id="line-card" onclick="openChannelLink('line');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 5.81 2 10.5c0 4.01 3.44 7.37 8.09 8.25.31.07.74.21.85.48.1.25.06.63.03.88l-.14.82c-.04.25-.2.96.84.52s5.58-3.29 7.61-5.63C21.31 13.51 22 12.07 22 10.5 22 5.81 17.52 2 12 2z" fill="#fff"/></svg></div>
          <div class="cc-name">LINE</div>
        </div>
        <div class="cc-desc" id="t-line-desc">1タップで友だち追加 → 自動連携</div>
        <div class="cc-action" id="t-line">LINEで使う</div>
        <div class="cc-connected" id="t-line-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card tg-card" id="tg-card" onclick="openChannelLink('tg');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.88 8.85c-.14.63-.51.78-.84.49l-2.31-1.7-1.79 1.72c-.2.2-.36.36-.74.36l.27-3.78 6.88-6.22c.3-.27-.07-.42-.47-.16L8.09 13.29l-2.61-.82c-.57-.18-.58-.57.12-.84l11.03-4.27c.47-.17.88.11.73.79h.17z" fill="#fff"/></svg></div>
          <div class="cc-name">Telegram</div>
        </div>
        <div class="cc-desc" id="t-tg-desc">ボタンを押すだけ → 今すぐ開始</div>
        <div class="cc-action" id="t-tg">Telegramで使う</div>
        <div class="cc-connected" id="t-tg-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="whatsapp-card" style="background:linear-gradient(135deg,#25D366 0%,#128C7E 100%);" onclick="openChannelLink('whatsapp');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 0C5.37 0 0 5.37 0 12c0 2.12.55 4.13 1.6 5.93L0 24l6.26-1.64C8.01 23.44 9.97 24 12 24c6.63 0 12-5.37 12-12S18.63 0 12 0zm5.8 16.9c-.24.68-1.41 1.3-1.95 1.38-.5.08-1.14.11-1.84-.12-.42-.14-.97-.33-1.67-.65-2.95-1.33-4.87-4.3-5.02-4.5-.15-.2-1.24-1.65-1.24-3.15s.78-2.23 1.06-2.54c.28-.3.62-.38.82-.38h.6c.19 0 .45-.07.7.54.26.62.87 2.13.95 2.28.08.15.13.33.03.53-.1.2-.15.33-.3.5-.15.18-.31.4-.45.53-.15.15-.3.31-.13.6.17.3.78 1.28 1.67 2.08 1.14.97 2.1 1.27 2.4 1.42.3.15.47.13.65-.08.17-.2.75-.87.95-1.17.2-.3.4-.25.67-.15.28.1 1.75.82 2.05.97.3.15.5.23.57.35.08.13.08.73-.16 1.4z" fill="#fff"/></svg></div>
          <div class="cc-name">WhatsApp</div>
        </div>
        <div class="cc-desc" id="t-whatsapp-desc">番号を追加してチャット開始</div>
        <div class="cc-action" id="t-whatsapp">WhatsAppで使う</div>
        <div class="cc-connected" id="t-whatsapp-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="discord-card" style="background:linear-gradient(135deg,#5865F2 0%,#4752C4 100%);" onclick="openChannelLink('discord');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20.32 4.37a19.8 19.8 0 0 0-4.89-1.52.07.07 0 0 0-.08.04c-.21.38-.45.87-.61 1.26a18.27 18.27 0 0 0-5.49 0 12.64 12.64 0 0 0-.62-1.26.07.07 0 0 0-.08-.04 19.74 19.74 0 0 0-4.89 1.52.07.07 0 0 0-.03.03C1.11 8.39.33 12.27.74 16.1a.08.08 0 0 0 .03.06 19.9 19.9 0 0 0 5.99 3.03.08.08 0 0 0 .08-.03c.46-.63.87-1.3 1.22-2a.08.08 0 0 0-.04-.11 13.1 13.1 0 0 1-1.87-.9.08.08 0 0 1-.01-.13c.13-.09.25-.19.37-.29a.07.07 0 0 1 .08-.01c3.93 1.8 8.18 1.8 12.07 0a.07.07 0 0 1 .08.01c.12.1.25.2.37.29a.08.08 0 0 1 0 .13c-.6.35-1.22.65-1.88.9a.08.08 0 0 0-.04.11c.36.7.77 1.37 1.22 2a.08.08 0 0 0 .08.03 19.83 19.83 0 0 0 6-3.03.08.08 0 0 0 .03-.05c.5-5.18-.84-9.68-3.55-13.67a.06.06 0 0 0-.03-.03zM8.02 13.63c-1.18 0-2.16-1.09-2.16-2.42s.96-2.42 2.16-2.42c1.21 0 2.18 1.1 2.16 2.42 0 1.33-.96 2.42-2.16 2.42zm7.97 0c-1.18 0-2.16-1.09-2.16-2.42s.96-2.42 2.16-2.42c1.21 0 2.18 1.1 2.16 2.42 0 1.33-.95 2.42-2.16 2.42z" fill="#fff"/></svg></div>
          <div class="cc-name">Discord</div>
        </div>
        <div class="cc-desc" id="t-discord-desc">Botをサーバーに追加</div>
        <div class="cc-action" id="t-discord">Discordで使う</div>
        <div class="cc-connected" id="t-discord-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="slack-card" style="background:linear-gradient(135deg,#4A154B 0%,#611f69 100%);" onclick="openChannelLink('slack');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M5.04 15.24a2.52 2.52 0 1 1-2.52-2.52h2.52v2.52zm1.27 0a2.52 2.52 0 1 1 5.04 0v6.3a2.52 2.52 0 1 1-5.04 0v-6.3zM8.83 5.04a2.52 2.52 0 1 1 2.52-2.52v2.52H8.83zm0 1.27a2.52 2.52 0 1 1 0 5.04h-6.3a2.52 2.52 0 1 1 0-5.04h6.3zm10.2 2.52a2.52 2.52 0 1 1 2.52 2.52h-2.52V8.83zm-1.27 0a2.52 2.52 0 1 1-5.04 0v-6.3a2.52 2.52 0 1 1 5.04 0v6.3zm-2.52 10.2a2.52 2.52 0 1 1-2.52 2.52v-2.52h2.52zm0-1.27a2.52 2.52 0 1 1 0-5.04h6.3a2.52 2.52 0 1 1 0 5.04h-6.3z" fill="#fff"/></svg></div>
          <div class="cc-name">Slack</div>
        </div>
        <div class="cc-desc" id="t-slack-desc">ワークスペースにアプリを追加</div>
        <div class="cc-action" id="t-slack">Slackで使う</div>
        <div class="cc-connected" id="t-slack-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="teams-card" style="background:linear-gradient(135deg,#6264A7 0%,#464775 100%);" onclick="openChannelLink('teams');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20.5 7h-3V5.5a2.5 2.5 0 0 0-5 0V7h-1a1.5 1.5 0 0 0-1.5 1.5v8a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 20.5 7zM15 5.5a1 1 0 0 1 2 0V7h-2V5.5z" fill="#fff"/><circle cx="16" cy="3" r="2" fill="#fff"/><path d="M8 10H2.5A1.5 1.5 0 0 0 1 11.5v5A1.5 1.5 0 0 0 2.5 18H8v-8z" fill="#fff" opacity="0.7"/><circle cx="5" cy="7" r="2" fill="#fff" opacity="0.7"/></svg></div>
          <div class="cc-name">MS Teams</div>
        </div>
        <div class="cc-desc" id="t-teams-desc">Teamsにボットを追加</div>
        <div class="cc-action" id="t-teams">Teamsで使う</div>
        <div class="cc-connected" id="t-teams-connected">&#x2713; Connected</div>
      </a>
    </div>

    <div id="link-cmd-hint" class="fade-up fade-up-d4" style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px 20px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
        <span style="font-size:18px;">🔗</span>
        <span style="font-size:13px;font-weight:700;" id="t-link-cmd-title">コマンドで連携</span>
      </div>
      <div style="font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:10px;" id="t-link-cmd-desc">
        チャットで <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;">/link</code> と入力するとリンクコードが生成されます。
        別のチャネル（LINE・Telegram等）で <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;">/link CODE</code> と送信すると連携完了。
      </div>
      <button onclick="document.getElementById('app-input').value='/link';appSend();" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:10px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        <span id="t-link-cmd-btn">/link コードを生成</span>
      </button>
    </div>

    <div id="cli-install-section" class="fade-up fade-up-d4" style="margin-bottom:20px;">
      <button onclick="toggleCliSection()" style="display:flex;align-items:center;gap:10px;width:100%;padding:14px 20px;background:var(--surface);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all 0.2s;text-align:left;">
        <span style="font-size:22px;flex-shrink:0;">&#128187;</span>
        <div style="flex:1;">
          <div style="font-size:13px;font-weight:700;color:var(--text);" id="t-cli-title">CLI</div>
          <div style="font-size:11px;color:var(--muted);" id="t-cli-sub">コマンドラインからも使えます</div>
        </div>
        <span id="cli-toggle-arrow" style="color:var(--muted);font-size:14px;transition:transform 0.2s;">&#9654;</span>
      </button>
      <div id="cli-detail" style="display:none;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 16px 16px;padding:16px 20px;margin-top:-4px;">
        <div style="background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:'SF Mono','Fira Code',monospace;font-size:13px;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer;" onclick="navigator.clipboard.writeText('curl -fsSL https://chatweb.ai/install.sh | sh');this.querySelector('.cp').textContent='Copied!';setTimeout(()=>this.querySelector('.cp').textContent='Copy',1500)">
          <span style="color:var(--muted);">$</span> <span style="flex:1;text-align:left;">curl -fsSL https://chatweb.ai/install.sh | sh</span>
          <span class="cp" style="color:var(--muted);font-size:11px;background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;">Copy</span>
        </div>
        <div id="cli-sync-cmd" style="margin-top:10px;background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:'SF Mono','Fira Code',monospace;font-size:12px;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer;" onclick="copyCliSync(this)">
          <span style="color:var(--muted);">$</span> <span id="cli-sync-text" style="flex:1;text-align:left;word-break:break-all;"></span>
          <span class="cp2" style="color:var(--muted);font-size:11px;background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;">Copy</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px;" id="t-cli-sync-hint"></div>
      </div>
    </div>

    <div class="bottom-cta fade-up fade-up-d4">
      <h2 id="t-bottom-title">もっとパワフルに使いたい？</h2>
      <p id="t-bottom-sub">GPT-4o、Claude Sonnet、Claude Opusなど最先端モデルを月額$9から。</p>
      <div class="cta-row">
        <a href="/pricing" class="cta-primary" id="t-bottom-cta">プランを比較する</a>
      </div>
      <div class="price-hint" id="t-bottom-hint">Starter $9/月 &middot; Pro $29/月 &middot; いつでもキャンセル可能</div>
    </div>

  </div>

  <div class="modal-overlay" id="auth-modal" onclick="closeAuthModal(event)" style="z-index:300;">
    <div class="modal auth-modal" onclick="event.stopPropagation()">
      <h3 id="auth-modal-title">ログイン</h3>
      <div class="auth-error" id="auth-error" style="display:none;"></div>
      <div id="auth-form-email">
        <input type="text" class="auth-input" id="login-name" placeholder="お名前（ニックネームOK）" maxlength="30" aria-label="Name" onkeydown="if(event.key==='Enter')document.getElementById('login-email').focus()">
        <input type="email" class="auth-input" id="login-email" placeholder="Email" aria-label="Email" onkeydown="if(event.key==='Enter')emailAuth()">
        <button class="auth-submit" id="email-auth-btn" onclick="emailAuth()">メールでログイン</button>
        <div style="text-align:center;margin-top:8px;">
          <a href="#" onclick="showForgotPasswordForm();return false;" style="font-size:12px;color:var(--muted);text-decoration:underline;">パスワードを忘れた方</a>
        </div>
      </div>
      <div id="auth-form-verify" style="display:none;">
        <p style="font-size:13px;color:var(--muted);margin-bottom:8px;" id="verify-hint">認証コードをメールに送信しました</p>
        <input type="text" class="auth-input" id="verify-code" placeholder="6桁の認証コード" maxlength="6" inputmode="numeric" pattern="[0-9]*" aria-label="Verification code" onkeydown="if(event.key==='Enter')verifyCode()" style="text-align:center;letter-spacing:6px;font-size:20px;">
        <button class="auth-submit" onclick="verifyCode()">認証する</button>
        <button class="auth-submit" style="background:transparent;color:var(--muted);margin-top:4px;" onclick="showEmailForm()">戻る</button>
      </div>
      <div id="auth-form-forgot" style="display:none;">
        <p style="font-size:13px;color:var(--muted);margin-bottom:8px;">パスワードリセット用のコードをメールに送信します</p>
        <input type="email" class="auth-input" id="forgot-email" placeholder="登録メールアドレス" aria-label="Email">
        <button class="auth-submit" id="forgot-btn" onclick="forgotPassword()">リセットコードを送信</button>
        <button class="auth-submit" style="background:transparent;color:var(--muted);margin-top:4px;" onclick="showEmailForm()">戻る</button>
      </div>
      <div id="auth-form-reset" style="display:none;">
        <p style="font-size:13px;color:var(--muted);margin-bottom:8px;">メールに届いたコードと新しいパスワードを入力</p>
        <input type="text" class="auth-input" id="reset-code" placeholder="6桁のリセットコード" maxlength="6" inputmode="numeric" pattern="[0-9]*" style="text-align:center;letter-spacing:6px;font-size:20px;">
        <input type="password" class="auth-input" id="reset-new-password" placeholder="新しいパスワード（8文字以上）" minlength="8" maxlength="128">
        <button class="auth-submit" onclick="resetPassword()">パスワードをリセット</button>
        <button class="auth-submit" style="background:transparent;color:var(--muted);margin-top:4px;" onclick="showEmailForm()">戻る</button>
      </div>
      <div class="auth-divider"><span>or</span></div>
      <button class="auth-google-btn" onclick="googleLogin()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
      <button class="close-btn" onclick="closeAuthModal()">Close</button>
    </div>
  </div>

  <div class="modal-overlay" id="onboard-modal" style="z-index:400;display:none;" onclick="return false;">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:500px;text-align:center;padding:40px 32px;">
      <!-- Voice-first onboarding flow -->
      <div id="onboard-voice-flow">
        <div id="onboard-avatar" style="width:120px;height:120px;margin:0 auto 24px;background:linear-gradient(135deg,var(--accent),#7c3aed);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:60px;animation:float 3s ease-in-out infinite;">
          👋
        </div>
        <h3 id="onboard-message" style="font-size:24px;font-weight:800;margin-bottom:16px;line-height:1.4;min-height:80px;">
          はじめまして！<br>ななって言ってみて
        </h3>
        <p id="onboard-hint" style="font-size:14px;color:var(--muted);margin-bottom:24px;min-height:40px;">
          音声が聞こえたら、マイクボタンを押して「なな」と言ってね
        </p>
        <div style="margin-bottom:24px;">
          <button id="onboard-mic-btn" onclick="onboardMicClick()" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c3aed);border:none;color:#fff;cursor:pointer;font-size:32px;transition:all 0.3s;box-shadow:0 4px 20px rgba(var(--accent-rgb),0.4);">
            🎤
          </button>
        </div>
        <div id="onboard-transcript" style="min-height:30px;font-size:14px;color:var(--text);font-style:italic;opacity:0.7;margin-bottom:16px;">
          <!-- User speech will appear here -->
        </div>
        <button id="onboard-skip-btn" onclick="onboardSkip()" style="background:transparent;border:1px solid var(--border);color:var(--muted);padding:10px 24px;border-radius:20px;font-size:13px;cursor:pointer;">
          スキップ
        </button>
      </div>
    </div>
  </div>

  </main>

  <div class="link-success-overlay" id="link-success-overlay">
    <div class="lso-icon" id="lso-icon"></div>
    <div class="lso-text" id="lso-text"></div>
  </div>

  <div class="modal-overlay" id="modal" onclick="closeModal(event)" style="z-index:300;">
    <div class="modal" id="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-steps" style="display:flex;justify-content:center;gap:8px;margin:8px 0 12px;font-size:12px;color:var(--muted);"></div>
      <p id="modal-desc" style="white-space:pre-line;"></p>
      <a id="modal-cta" class="modal-link" target="_blank" style="display:none;font-size:16px;padding:14px 28px;margin:12px 0;"></a>
      <div class="qr-wrapper" id="modal-qr-wrap">
        <div class="qr-spinner" id="qr-spinner"></div>
        <img id="modal-qr" alt="QR Code">
      </div>
      <a id="modal-link" class="modal-link" target="_blank" style="font-size:13px;"></a>
      <div id="modal-code-row" style="display:none;margin:8px 0;text-align:center;">
        <span style="font-size:11px;color:var(--muted);" id="modal-code-label"></span>
        <code id="modal-code-val" style="background:var(--surface);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:14px;letter-spacing:1px;" onclick="navigator.clipboard.writeText(this.textContent);this.style.background='var(--green)';this.style.color='#fff';setTimeout(()=>{this.style.background='var(--surface)';this.style.color=''},500);"></code>
      </div>
      <div id="modal-success" style="display:none;text-align:center;padding:20px 0;">
        <div style="font-size:48px;margin-bottom:8px;">&#x2705;</div>
        <div id="modal-success-text" style="font-size:16px;font-weight:600;color:var(--green);"></div>
      </div>
      <button class="close-btn" id="modal-close-btn" aria-label="Close" onclick="document.getElementById('modal').classList.remove('show');stopLinkPoll();">閉じる</button>
    </div>
  </div>

  <div class="modal-overlay" id="apikey-modal" onclick="if(event.target===this)this.classList.remove('show')" style="z-index:300;">
    <div class="modal apikey-modal" onclick="event.stopPropagation()">
      <h3 id="apikey-modal-title">API Keys</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;" id="apikey-modal-desc">Use API keys to access chatweb.ai from your applications.</p>
      <div class="apikey-list" id="apikey-list"></div>
      <div class="apikey-new-key" id="apikey-new-key" style="display:none;">
        <div class="apikey-new-key-label" id="apikey-new-label">New API Key Created</div>
        <div class="apikey-new-key-value" id="apikey-new-value" onclick="navigator.clipboard.writeText(this.textContent);this.style.opacity=0.5;setTimeout(()=>this.style.opacity=1,300)"></div>
        <div class="apikey-new-key-hint" id="apikey-new-hint">Click to copy. This key will only be shown once.</div>
      </div>
      <div class="apikey-create-row">
        <input type="text" id="apikey-name-input" placeholder="Key name (e.g. my-app)">
        <button onclick="createApiKey()" id="apikey-create-btn">Create</button>
      </div>
      <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:11px;color:var(--muted);line-height:1.6;">
        <strong>Usage:</strong><br>
        <code style="color:var(--accent-hover);">curl -H "Authorization: Bearer cw_..." https://api.chatweb.ai/api/v1/chat -d '{"message":"Hello"}'</code>
      </div>
      <button class="close-btn" onclick="document.getElementById('apikey-modal').classList.remove('show')">Close</button>
    </div>
  </div>

  <div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)this.classList.remove('show')" style="z-index:300;">
    <div class="modal settings-modal" onclick="event.stopPropagation()">
      <h3 id="settings-modal-title">Settings</h3>
      <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('general')">General</button>
        <button class="settings-tab" onclick="switchSettingsTab('voice')">Voice</button>
        <button class="settings-tab" onclick="switchSettingsTab('llm')">LLM</button>
        <button class="settings-tab" onclick="switchSettingsTab('display')">Display</button>
        <button class="settings-tab" onclick="switchSettingsTab('memory')">Memory</button>
        <button class="settings-tab" onclick="switchSettingsTab('account')">Account</button>
      </div>

      <div class="settings-section active" id="settings-tab-general">
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#127912; テーマ / Theme</div>
          <select class="settings-select" id="settings-theme" onchange="saveGeneralSettings()">
            <option value="system">System (default)</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#127760; UI言語 / Language</div>
          <select class="settings-select" id="settings-ui-lang" onchange="saveGeneralSettings()">
            <option value="auto">Auto (default)</option>
            <option value="ja">日本語</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#128221; フォントサイズ / Font Size</div>
          <select class="settings-select" id="settings-font-size" onchange="saveGeneralSettings()">
            <option value="small">Small (13px)</option>
            <option value="medium" selected>Medium (15px)</option>
            <option value="large">Large (17px)</option>
          </select>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#9993; 送信方法 / Send Method</div>
          <select class="settings-select" id="settings-send-method" onchange="saveGeneralSettings()">
            <option value="enter" selected>Enter</option>
            <option value="shift-enter">Shift+Enter</option>
            <option value="button">ボタンのみ / Button only</option>
          </select>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128276; 通知音 / Notification Sound</div>
            <div class="settings-item-desc">応答完了時に通知音を再生</div>
          </div>
          <button class="settings-toggle" id="settings-notification-toggle" onclick="toggleNotificationSound()"></button>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#127937; AI Tier</div>
          <div class="settings-item-desc" style="margin-bottom:8px;">モデルの選択方法を設定</div>
          <div class="tier-selector" id="tier-selector">
            <div class="tier-option selected" data-tier="auto" onclick="selectTier('auto')">
              <span class="tier-option-icon">&#9889;</span>
              <span class="tier-option-label">Auto Race</span>
              <span class="tier-option-model">全モデル並列</span>
            </div>
            <div class="tier-option" data-tier="economy" onclick="selectTier('economy')">
              <span class="tier-option-icon">&#128176;</span>
              <span class="tier-option-label">Economy</span>
              <span class="tier-option-model">Gemini Flash</span>
            </div>
            <div class="tier-option" data-tier="normal" onclick="selectTier('normal')">
              <span class="tier-option-icon">&#127775;</span>
              <span class="tier-option-label">Normal</span>
              <span class="tier-option-model">Kimi K2</span>
            </div>
            <div class="tier-option" data-tier="powerful" onclick="selectTier('powerful')">
              <span class="tier-option-icon">&#128293;</span>
              <span class="tier-option-label">Powerful</span>
              <span class="tier-option-model">Claude Sonnet</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Voice Tab -->
      <div class="settings-section" id="settings-tab-voice">
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label" id="settings-tts-label">&#128266; 自動読み上げ</div>
            <div class="settings-item-desc">AIの応答を自動で音声再生します</div>
          </div>
          <button class="settings-toggle active" id="settings-tts-toggle" onclick="toggleAutoTTS()"></button>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#127908; ハンズフリー会話</div>
            <div class="settings-item-desc" id="settings-autolisten-desc">音声応答後に自動でマイクON（連続会話モード）</div>
          </div>
          <button class="settings-toggle" id="settings-autolisten-toggle" onclick="toggleAutoListen()"></button>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#127760; 音声言語 / Voice Language</div>
          <select class="settings-select" id="settings-stt-lang" onchange="setSTTLanguage(this.value)">
          </select>
          <div class="settings-item-desc">音声認識の言語を選択（ブラウザ言語で自動検出）</div>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#127911; 音声エンジン / Voice Engine</div>
          <select class="settings-select" id="settings-tts-engine" onchange="setTTSEngine(this.value)">
            <option value="openai">OpenAI gpt-4o-mini-tts (default)</option>
            <option value="elevenlabs">ElevenLabs (high quality)</option>
            <option value="sbv2">Style-Bert-VITS2 (Japanese)</option>
            <option value="cosyvoice">CosyVoice 2 (voice clone)</option>
            <option value="polly">AWS Polly Neural</option>
          </select>
          <div class="settings-item-desc">読み上げ音声エンジンを選択</div>
        </div>
        <div class="settings-item" id="settings-elevenlabs-voice" style="flex-direction:column;align-items:stretch;display:none;">
          <div class="settings-item-label" style="margin-bottom:6px;">ElevenLabs Voice</div>
          <select class="settings-select" id="settings-el-voice" onchange="setElevenLabsVoice(this.value)">
            <option value="pNInz6obpgDQGcFmaJgB">Adam (multilingual)</option>
            <option value="EXAVITQu4vr4xnSDxMaL">Sarah (warm)</option>
            <option value="onwK4e9ZLuTAKqWW03F9">Daniel (deep)</option>
            <option value="XB0fDUnXU5powFXDhCwa">Charlotte (elegant)</option>
            <option value="jBpfAFnaylXS2maSnkdl">Yuki (Japanese)</option>
          </select>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#128266; 読み上げ速度 / Speech Speed <span class="settings-range-val" id="tts-speed-val">1.0</span>x</div>
          <div class="settings-range-row">
            <span style="font-size:11px;color:var(--muted);">0.5x</span>
            <input type="range" id="settings-tts-speed" min="0.5" max="2.0" step="0.1" value="1.0" aria-label="Speech speed" oninput="document.getElementById('tts-speed-val').textContent=this.value;saveVoiceSettings()">
            <span style="font-size:11px;color:var(--muted);">2.0x</span>
          </div>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128172; 音声自動送信 / Auto Send Voice</div>
            <div class="settings-item-desc">音声認識後にメッセージを自動送信する</div>
          </div>
          <button class="settings-toggle active" id="settings-voice-autosend-toggle" onclick="toggleVoiceAutoSend()"></button>
        </div>
      </div>

      <div class="settings-section" id="settings-tab-llm">
        <div class="settings-group-title">Model</div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">Model</div>
          <select class="settings-select" id="settings-model" onchange="saveLlmSettings()">
            <option value="">Auto (default)</option>
            <optgroup label="Anthropic">
              <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
              <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
              <option value="claude-opus-4-6">Claude Opus 4.6</option>
            </optgroup>
            <optgroup label="OpenAI">
              <option value="gpt-4.1">GPT-4.1</option>
              <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
              <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4o-mini">GPT-4o Mini</option>
              <option value="o4-mini">o4-mini</option>
            </optgroup>
            <optgroup label="Google">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            </optgroup>
            <optgroup label="Other">
              <option value="moonshotai/kimi-k2-instruct-0905">Kimi K2 (Groq)</option>
              <option value="qwen/qwen3-32b">Qwen3 32B (Groq)</option>
              <option value="deepseek-chat">DeepSeek Chat</option>
            </optgroup>
          </select>
        </div>

        <div class="settings-group-title">Parameters</div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">Temperature <span class="settings-range-val" id="temp-val">0.7</span></div>
          <div class="settings-range-row">
            <span style="font-size:11px;color:var(--muted);">0</span>
            <input type="range" id="settings-temperature" min="0" max="2.0" step="0.1" value="0.7" aria-label="Temperature" oninput="document.getElementById('temp-val').textContent=this.value;saveLlmSettings()">
            <span style="font-size:11px;color:var(--muted);">2.0</span>
          </div>
          <div class="settings-item-desc">低い=正確・決定的、高い=創造的・多様</div>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">Max Tokens <span class="settings-range-val" id="maxtok-val">4096</span></div>
          <div class="settings-range-row">
            <span style="font-size:11px;color:var(--muted);">256</span>
            <input type="range" id="settings-max-tokens" min="256" max="16384" step="256" value="4096" aria-label="Maximum tokens" oninput="document.getElementById('maxtok-val').textContent=this.value;saveLlmSettings()">
            <span style="font-size:11px;color:var(--muted);">16384</span>
          </div>
          <div class="settings-item-desc">応答の最大長。大きいほどクレジット消費が増加</div>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">Top-P <span class="settings-range-val" id="topp-val">1.0</span></div>
          <div class="settings-range-row">
            <span style="font-size:11px;color:var(--muted);">0</span>
            <input type="range" id="settings-top-p" min="0" max="1.0" step="0.05" value="1.0" aria-label="Top-P" oninput="document.getElementById('topp-val').textContent=this.value;saveLlmSettings()">
            <span style="font-size:11px;color:var(--muted);">1.0</span>
          </div>
          <div class="settings-item-desc">核サンプリング。低い=確実、高い=多様</div>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">Frequency Penalty <span class="settings-range-val" id="freqpen-val">0.0</span></div>
          <div class="settings-range-row">
            <span style="font-size:11px;color:var(--muted);">-2.0</span>
            <input type="range" id="settings-freq-penalty" min="-2.0" max="2.0" step="0.1" value="0" aria-label="Frequency penalty" oninput="document.getElementById('freqpen-val').textContent=parseFloat(this.value).toFixed(1);saveLlmSettings()">
            <span style="font-size:11px;color:var(--muted);">2.0</span>
          </div>
          <div class="settings-item-desc">高い=同じ単語の繰り返しを抑制</div>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">Presence Penalty <span class="settings-range-val" id="prespen-val">0.0</span></div>
          <div class="settings-range-row">
            <span style="font-size:11px;color:var(--muted);">-2.0</span>
            <input type="range" id="settings-pres-penalty" min="-2.0" max="2.0" step="0.1" value="0" aria-label="Presence penalty" oninput="document.getElementById('prespen-val').textContent=parseFloat(this.value).toFixed(1);saveLlmSettings()">
            <span style="font-size:11px;color:var(--muted);">2.0</span>
          </div>
          <div class="settings-item-desc">高い=新しい話題への展開を促進</div>
        </div>

        <div class="settings-group-title">Behavior</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#9889; ストリーミング / Streaming</div>
            <div class="settings-item-desc">応答をリアルタイムに表示</div>
          </div>
          <button class="settings-toggle active" id="settings-streaming-toggle" onclick="toggleStreamingSetting()"></button>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128161; 思考プロセス表示 / Show Thinking</div>
            <div class="settings-item-desc">AIの思考過程を表示する</div>
          </div>
          <button class="settings-toggle" id="settings-thinking-toggle" onclick="toggleThinkingSetting()"></button>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#128221; システムプロンプト / Custom Instructions</div>
          <textarea class="settings-textarea" id="settings-system-prompt" placeholder="追加の指示を入力（例：常に日本語で回答、コードは必ずコメント付き...）" oninput="saveLlmSettings()"></textarea>
          <div class="settings-item-desc">全ての会話に適用されるカスタム指示</div>
        </div>

        <div class="settings-group-title">API Key (BYOK)</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Custom API Key</div>
            <div class="settings-item-desc">自分のAPIキーを使用（BYOK）</div>
          </div>
          <button class="settings-toggle" id="settings-byok-toggle" onclick="toggleByokInput()"></button>
        </div>
        <div id="byok-inputs" style="display:none;margin-top:8px;">
          <select class="settings-select" id="byok-provider" style="margin-bottom:6px;">
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="google">Google</option>
          </select>
          <input type="password" id="byok-key" placeholder="sk-... / key-..." aria-label="API key" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;box-sizing:border-box;" onchange="saveLlmSettings()">
        </div>
      </div>

      <!-- Display Tab (NEW) -->
      <div class="settings-section" id="settings-tab-display">
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128187; ターミナルモード / Terminal Mode</div>
            <div class="settings-item-desc">ターミナル風の表示に切り替え</div>
          </div>
          <button class="settings-toggle" id="settings-terminal-toggle" onclick="toggleDisplaySetting('terminalMode')"></button>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128202; トークン情報表示 / Token Info</div>
            <div class="settings-item-desc">メッセージ下にモデル名・トークン数を表示</div>
          </div>
          <button class="settings-toggle" id="settings-tokeninfo-toggle" onclick="toggleDisplaySetting('showTokenInfo')"></button>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128336; タイムスタンプ表示 / Timestamps</div>
            <div class="settings-item-desc">メッセージに時刻を表示</div>
          </div>
          <button class="settings-toggle" id="settings-timestamp-toggle" onclick="toggleDisplaySetting('showTimestamps')"></button>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128230; コンパクトモード / Compact Mode</div>
            <div class="settings-item-desc">メッセージ間隔を詰めて表示</div>
          </div>
          <button class="settings-toggle" id="settings-compact-toggle" onclick="toggleDisplaySetting('compactMode')"></button>
        </div>
        <div class="settings-item" style="flex-direction:column;align-items:stretch;">
          <div class="settings-item-label" style="margin-bottom:6px;">&#127912; コードテーマ / Code Theme</div>
          <select class="settings-select" id="settings-code-theme" onchange="saveDisplaySettings()">
            <option value="auto" selected>Auto (default)</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128196; マークダウン / Markdown</div>
            <div class="settings-item-desc">マークダウン記法をレンダリング</div>
          </div>
          <button class="settings-toggle active" id="settings-markdown-toggle" onclick="toggleDisplaySetting('markdownEnabled')"></button>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128100; アバター表示 / Show Avatars</div>
            <div class="settings-item-desc">メッセージにアバターを表示</div>
          </div>
          <button class="settings-toggle active" id="settings-avatar-toggle" onclick="toggleDisplaySetting('showAvatars')"></button>
        </div>
      </div>

      <div class="settings-section" id="settings-tab-memory">
        <div class="memory-label">Long-term Memory</div>
        <div class="memory-box" id="memory-longterm"></div>
        <div class="memory-label">Today's Log</div>
        <div class="memory-box" id="memory-daily"></div>
        <button style="width:100%;padding:8px;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:var(--muted);" onclick="loadMemoryData()">Refresh</button>
        <button style="width:100%;padding:8px;margin-top:4px;background:none;border:1px solid #e53e3e;border-radius:8px;cursor:pointer;font-size:12px;color:#e53e3e;" onclick="clearMemory()">Clear Memory</button>
      </div>

      <div class="settings-section" id="settings-tab-account">
        <div class="settings-group-title">Usage</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
          <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:20px;font-weight:700;" id="activity-credits-remaining">-</div>
            <div style="font-size:11px;color:var(--muted);">Credits Left</div>
          </div>
          <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:20px;font-weight:700;" id="activity-credits-used">-</div>
            <div style="font-size:11px;color:var(--muted);">Credits Used</div>
          </div>
          <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:20px;font-weight:700;" id="activity-today-requests">-</div>
            <div style="font-size:11px;color:var(--muted);">Today's Requests</div>
          </div>
          <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:20px;font-weight:700;" id="activity-plan">-</div>
            <div style="font-size:11px;color:var(--muted);">Plan</div>
          </div>
        </div>
        <div class="memory-label">Recent Activity</div>
        <div id="activity-log-list" style="max-height:180px;overflow-y:auto;font-size:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);"></div>
        <button style="width:100%;padding:8px;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:var(--muted);" onclick="loadActivityData()">Refresh</button>

        <div class="settings-group-title" style="margin-top:16px;">Content</div>
        <div class="settings-item" id="settings-adult-section" style="display:none;">
          <div class="settings-item-info">
            <div class="settings-item-label">&#128274; Adult Mode</div>
            <div class="settings-item-desc" id="settings-adult-desc">成人向け会話を許可（年齢確認が必要です）</div>
          </div>
          <button class="settings-toggle" id="settings-adult-toggle" onclick="toggleAdultMode()"></button>
        </div>

        <div class="settings-group-title" style="margin-top:16px;">Profile</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
          <label style="font-size:11px;color:var(--muted);">Display Name</label>
          <input type="text" class="auth-input" id="profile-display-name" placeholder="表示名" maxlength="50" style="margin:0;">
          <label style="font-size:11px;color:var(--muted);">Email</label>
          <input type="email" class="auth-input" id="profile-email" placeholder="メールアドレス" style="margin:0;" disabled>
          <button class="settings-btn" onclick="saveProfile()" style="background:var(--accent);color:#fff;border:none;">Save Profile</button>
        </div>

        <div class="settings-group-title" style="margin-top:16px;">Data</div>
        <button class="settings-btn" onclick="exportConversationData()" style="margin-bottom:8px;">&#128229; データエクスポート / Export Data</button>
        <button class="settings-btn settings-btn-danger" onclick="deleteAllData()" style="margin-bottom:8px;">&#128465; 全データ削除 / Delete All Data</button>
        <button class="settings-btn" onclick="handleLogout()" style="margin-bottom:8px;">&#128682; ログアウト / Logout</button>

        <div class="settings-group-title" style="margin-top:16px;color:#e53e3e;">Danger Zone</div>
        <button class="settings-btn settings-btn-danger" onclick="deleteAccount()" style="margin-bottom:8px;border-color:#e53e3e;color:#e53e3e;">&#128465; アカウントを完全に削除 / Delete Account</button>
        <p style="font-size:10px;color:var(--muted);">この操作は取り消せません。全データ・サブスクリプションが削除されます。</p>
      </div>

      <button class="close-btn" onclick="document.getElementById('settings-modal').classList.remove('show')" style="margin-top:12px;">Close</button>
    </div>
  </div>

  <div class="modal-overlay" id="topup-modal" onclick="if(event.target===this)this.classList.remove('show')" style="z-index:300;">
    <div class="modal settings-modal" onclick="event.stopPropagation()">
      <h3 id="topup-modal-title">クレジットをチャージ</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:16px;" id="topup-modal-desc">お好きな方法でクレジットを追加できます</p>

      <div id="topup-tabs" style="display:flex;gap:4px;margin-bottom:14px;background:var(--bg);border-radius:10px;padding:3px;border:1px solid var(--border);">
        <button onclick="showTopupTab('plans')" id="topup-tab-plans" style="flex:1;padding:8px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:var(--accent);color:#fff;">プラン</button>
        <button onclick="showTopupTab('credits')" id="topup-tab-credits" style="flex:1;padding:8px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:transparent;color:var(--muted);">クレジット追加</button>
      </div>

      <div id="topup-plans" style="display:flex;flex-direction:column;gap:10px;">
        <button onclick="startStripeCheckout('starter')" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">💳</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);">Starter — ¥980/月</div>
            <div style="font-size:12px;color:var(--muted);">25,000 credits + 全ツール</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">購入 ›</span>
        </button>
        <button onclick="startStripeCheckout('pro')" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(139,92,246,0.08));border:2px solid var(--accent);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">⚡</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;color:var(--text);">Pro — ¥4,980/月</div>
            <div style="font-size:12px;color:var(--muted);">300,000 credits + 優先処理</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">購入 ›</span>
        </button>
        <button onclick="openBillingPortal()" id="manage-plan-btn" style="display:none;align-items:center;gap:10px;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">⚙️</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);" id="manage-plan-label">プラン管理</div>
            <div style="font-size:12px;color:var(--muted);">プラン変更・解約</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">管理 ›</span>
        </button>
      </div>

      <div id="topup-credits" style="display:none;flex-direction:column;gap:10px;">
        <button onclick="buyCreditPack(1000)" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">🪙</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);">1,000 クレジット</div>
            <div style="font-size:12px;color:var(--muted);">¥500（¥0.5/クレジット）</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">購入 ›</span>
        </button>
        <button onclick="buyCreditPack(5000)" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(139,92,246,0.08));border:2px solid var(--accent);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">💎</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;color:var(--text);">5,000 クレジット</div>
            <div style="font-size:12px;color:var(--muted);">¥1,980（¥0.40/クレジット・20%お得）</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">購入 ›</span>
        </button>
        <button onclick="buyCreditPack(20000)" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">👑</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);">20,000 クレジット</div>
            <div style="font-size:12px;color:var(--muted);">¥5,980（¥0.30/クレジット・40%お得）</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">購入 ›</span>
        </button>
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;">
          <span style="font-size:20px;">🔄</span>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:600;color:var(--text);">オートチャージ</div>
            <div style="font-size:11px;color:var(--muted);">クレジットが0になったら自動で5,000追加</div>
          </div>
          <label style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
            <input type="checkbox" id="auto-charge-toggle" onchange="toggleAutoCharge(this.checked)" style="opacity:0;width:0;height:0;">
            <span style="position:absolute;inset:0;background:var(--border);border-radius:12px;transition:0.3s;"></span>
            <span style="position:absolute;left:2px;top:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:0.3s;"></span>
          </label>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin:12px 0 4px;color:var(--muted);font-size:11px;"><hr style="flex:1;border:none;border-top:1px solid var(--border);"><span>or</span><hr style="flex:1;border:none;border-top:1px solid var(--border);"></div>
      <div style="display:flex;gap:8px;">
        <button onclick="document.getElementById('topup-modal').classList.remove('show');showCryptoTopup()" style="flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:18px;">◆</span>
          <div>
            <div style="font-size:12px;font-weight:600;color:var(--text);">Crypto</div>
            <div style="font-size:10px;color:var(--muted);">ETH/Base</div>
          </div>
        </button>
        <button onclick="document.getElementById('topup-modal').classList.remove('show');showEarnOption()" style="flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(16,185,129,0.08));border:1px solid rgba(34,197,94,0.3);border-radius:10px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:18px;">🖥️</span>
          <div>
            <div style="font-size:12px;font-weight:600;color:var(--text);" id="earn-btn-title">PCで稼ぐ</div>
            <div style="font-size:10px;color:var(--muted);" id="earn-btn-desc">LLMでクレジット獲得</div>
          </div>
        </button>
      </div>
      <button class="close-btn" onclick="document.getElementById('topup-modal').classList.remove('show')" style="margin-top:12px;">Close</button>
    </div>
  </div>

  <div class="app-container" id="app-container">
    <div class="app-sidebar-backdrop" id="app-sidebar-backdrop" onclick="document.getElementById('app-sidebar').classList.remove('open');this.classList.remove('show');"></div>
    <div class="app-sidebar" id="app-sidebar">
      <div class="app-sidebar-header">
        <button class="app-sidebar-new" id="app-new-conv" onclick="appNewConversation()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span id="app-new-conv-text">New chat</span>
        </button>
      </div>
      <div class="app-sidebar-list" id="app-conv-list"></div>
      <div class="app-sidebar-channels">
        <div class="app-sidebar-channels-label" id="app-channels-label">Channels</div>
        <div class="app-sidebar-channels-grid" id="app-channels-grid">
        </div>
      </div>
      <div class="app-sidebar-cli" id="app-sidebar-cli" style="display:none;"></div>
      <div class="app-sidebar-cron" id="app-cron-section" style="display:none;"></div>
      <div class="app-sidebar-links" style="display:flex;flex-direction:row;gap:4px;padding:8px 12px;justify-content:center;">
        <a class="app-sidebar-link" href="/pricing" title="Pricing" style="font-size:18px;padding:6px 10px;">💰</a>
        <a class="app-sidebar-link" href="https://elio.love" target="_blank" rel="noopener" title="ElioChat" style="font-size:18px;padding:6px 10px;">💬</a>
        <button class="app-sidebar-link" onclick="openApiKeysModal()" id="app-link-apikeys" title="API Keys" style="font-size:18px;padding:6px 10px;">🔑</button>
        <a class="app-sidebar-link" href="/docs" id="app-link-docs" title="API Docs" style="font-size:18px;padding:6px 10px;">📄</a>
        <button class="app-sidebar-link" onclick="openSettingsModal()" id="app-link-settings" title="Settings" style="font-size:18px;padding:6px 10px;">⚙️</button>
      </div>
      <div class="app-sidebar-footer">
        <div class="points-display" id="points-display" style="display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(16,185,129,0.1));border:1px solid rgba(34,197,94,0.2);border-radius:8px;margin-bottom:8px;">
          <span style="font-size:16px;">⭐️</span>
          <span style="font-size:14px;font-weight:700;color:var(--green);" id="points-count">0</span>
          <span style="font-size:11px;color:var(--muted);" id="points-label">pts</span>
        </div>
        <div class="credit-display" id="credit-display" style="display:none;">
          <span>&#9889;</span> <span class="credit-count" id="credit-count">--</span> <span style="font-size:11px;">credits</span>
          <button onclick="showTopupModal()" style="margin-left:8px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;border-radius:12px;padding:2px 10px;font-size:11px;cursor:pointer;white-space:nowrap;" title="クレジットをチャージ">+ Top Up</button>
        </div>
        <button id="referral-btn" onclick="showReferralModal()" style="display:none;width:100%;padding:8px 12px;margin-bottom:6px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;text-align:center;">友達を招待 +100 credits</button>
        <div class="app-sidebar-user" onclick="logout()">
          <div class="app-sidebar-user-avatar" id="app-user-avatar"></div>
          <div style="flex:1;min-width:0;">
            <div class="app-sidebar-user-name" id="app-user-name"></div>
            <div id="app-user-email" style="font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
            <div class="sidebar-channel-badges" id="sidebar-channel-badges"></div>
          </div>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink:0;color:var(--muted);"><path d="M6 2H3a1 1 0 00-1 1v10a1 1 0 001 1h3M11 11l3-3-3-3M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
    </div>
    <div class="app-chat">
      <div class="app-chat-messages" id="app-messages">
        <div class="app-chat-empty" id="app-empty">
          <div class="app-chat-empty-logo">chatweb.ai</div>
          <div class="ai-avatar-container" id="ai-avatar-container" onclick="toggleVoiceHero()">
            <canvas id="ai-avatar-canvas" width="200" height="200"></canvas>
          </div>
          <button class="voice-hero-btn" id="voice-hero-btn" onclick="toggleVoiceHero()" style="display:none;">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div class="voice-hero-label" id="voice-hero-label">タップして、話しかけてみて</div>
          <div class="app-chat-empty-text" id="app-empty-text">静かなところで、ゆっくり話しましょう</div>
          <div class="voice-chars" id="voice-chars">
            <button class="voice-char active" data-voice="nova" onclick="selectVoiceChar(this)">
              <span class="vc-avatar" style="background:linear-gradient(135deg,#818cf8,#6366f1);">🌸</span>
              <span class="vc-name">Nova</span>
            </button>
            <button class="voice-char" data-voice="shimmer" onclick="selectVoiceChar(this)">
              <span class="vc-avatar" style="background:linear-gradient(135deg,#c084fc,#a855f7);">💜</span>
              <span class="vc-name">Shimmer</span>
            </button>
            <button class="voice-char" data-voice="onyx" onclick="selectVoiceChar(this)">
              <span class="vc-avatar" style="background:linear-gradient(135deg,#60a5fa,#3b82f6);">⚡</span>
              <span class="vc-name">Onyx</span>
            </button>
            <button class="voice-char" data-voice="alloy" onclick="selectVoiceChar(this)">
              <span class="vc-avatar" style="background:linear-gradient(135deg,#34d399,#10b981);">🌿</span>
              <span class="vc-name">Alloy</span>
            </button>
            <button class="voice-char" data-voice="fable" onclick="selectVoiceChar(this)">
              <span class="vc-avatar" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);">✨</span>
              <span class="vc-name">Fable</span>
            </button>
          </div>
          <div class="app-chat-suggestions" id="app-suggestions"></div>
          <div style="margin-top:16px;display:flex;gap:12px;justify-content:center;font-size:12px;">
            <a href="/docs" style="color:var(--muted);text-decoration:none;">API Docs</a>
            <a href="/pricing" style="color:var(--muted);text-decoration:none;">Pricing</a>
          </div>
        </div>
      </div>
      <div class="app-chat-input-area">
        <div class="app-chat-input-box">
          <button class="app-chat-send-btn" id="app-attach-btn" onclick="document.getElementById('file-upload-input').click()" title="ファイルを添付" style="background:transparent;border:1px solid var(--border);color:var(--muted);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <input type="file" id="file-upload-input" style="display:none;" accept="image/*,.pdf,.txt,.csv,audio/*" onchange="handleFileSelect(event)">
          <div id="file-preview" style="display:none;position:absolute;bottom:100%;left:8px;right:8px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:12px;display:none;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span id="file-preview-name" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
              <span id="file-preview-size" style="color:var(--muted);flex-shrink:0;"></span>
              <button onclick="clearFileAttachment()" style="background:none;border:none;color:#e53e3e;cursor:pointer;font-size:14px;padding:2px;">✕</button>
            </div>
            <div id="file-upload-progress" style="display:none;margin-top:4px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;">
              <div id="file-upload-bar" style="height:100%;background:var(--accent);width:0%;transition:width 0.3s;"></div>
            </div>
          </div>
          <textarea id="app-input" rows="1" placeholder="テキスト入力 or マイクで話す →" onkeydown="appInputKeydown(event)"></textarea>
          <button class="app-chat-send-btn" id="app-send-btn" onclick="appSend()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 14l12-6L2 2v5l8 1-8 1v5z" fill="currentColor"/></svg>
          </button>
          <button class="app-chat-phone-btn" id="app-phone-btn" onclick="togglePhonePanel()" title="Phone call">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="app-chat-mic-btn" id="app-mic-btn" onclick="toggleSpeechRecognition()" title="マイクで話す">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
        <input type="hidden" id="app-agent-select" value="auto">
        <input type="checkbox" id="explore-check" style="display:none;">
        <input type="checkbox" id="multi-model-check" style="display:none;">
      </div>
    </div>
  </div>

  <button class="tts-stop-float" id="tts-stop-float" onclick="stopTTS()">
    <span class="tts-pulse-dot"></span> 読み上げ停止
  </button>

  <div class="voice-state-bar" id="voice-state-bar">
    <span id="voice-state-icon"></span>
    <span id="voice-state-text"></span>
  </div>

  <div class="phone-panel" id="phone-panel">
    <div class="phone-panel-header">
      <span>&#128222; Phone</span>
      <span class="close-btn" onclick="togglePhonePanel()">&times;</span>
    </div>
    <div class="phone-panel-body">
      <div class="phone-status" id="phone-status">Ready</div>
      <div class="phone-input-row">
        <input type="tel" id="phone-number" placeholder="+81 90-1234-5678" />
        <button class="phone-call-btn" id="phone-call-action" onclick="phoneAction()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="phone-dialpad" id="phone-dialpad">
        <button onclick="dialDigit('1')">1</button>
        <button onclick="dialDigit('2')">2</button>
        <button onclick="dialDigit('3')">3</button>
        <button onclick="dialDigit('4')">4</button>
        <button onclick="dialDigit('5')">5</button>
        <button onclick="dialDigit('6')">6</button>
        <button onclick="dialDigit('7')">7</button>
        <button onclick="dialDigit('8')">8</button>
        <button onclick="dialDigit('9')">9</button>
        <button onclick="dialDigit('*')">*</button>
        <button onclick="dialDigit('0')">0</button>
        <button onclick="dialDigit('#')">#</button>
      </div>
    </div>
    <div class="phone-transcript" id="phone-transcript"></div>
  </div>

  <div id="ccp-container" style="display:none;width:0;height:0;overflow:hidden;"></div>

  <footer>
    <a href="/pricing" id="footer-pricing">料金</a> &middot;
    <a href="https://github.com/yukihamada/nanobot" target="_blank">GitHub</a> &middot;
    <a href="/docs">API</a> &middot;
    chatweb.ai &copy; 2025-2026
  </footer>

  <script>
    const API = location.hostname === 'localhost' ? 'http://localhost:3000' : '';
    const IS_TEAI = location.hostname.includes('teai.io');

    // teai.io failover: if API is unreachable, redirect to chatweb.ai
    if (IS_TEAI) {
      var _failCount = 0;
      window._teaiFailover = function() {
        _failCount++;
        if (_failCount >= 3) {
          var msg = lang === 'ja'
            ? 'teai.ioに接続できません。chatweb.aiにリダイレクトします。'
            : 'Cannot reach teai.io. Redirecting to chatweb.ai...';
          if (typeof showToast === 'function') showToast(msg, 'warning');
          setTimeout(function() {
            window.location.href = 'https://chatweb.ai' + window.location.pathname + window.location.search;
          }, 2000);
        }
      };
    }

    // Hide Google OAuth for teai.io (email auth only)
    if (IS_TEAI) {
      // Wait for DOM ready, then hide Google button and divider
      setTimeout(function() {
        var googleBtn = document.querySelector('.auth-google-btn');
        if (googleBtn) googleBtn.style.display = 'none';
        var dividers = document.querySelectorAll('.auth-divider');
        if (dividers.length > 0) dividers[dividers.length - 1].style.display = 'none';
      }, 0);
    }

    // QR Code: local generation (instant, no external API)
    function generateQRDataURL(text, size) {
      size = size || 200;
      if (typeof qrcode !== 'function') return null;
      try {
        var qr = qrcode(0, 'M');
        qr.addData(text);
        qr.make();
        var modules = qr.getModuleCount();
        var cellSize = Math.floor(size / modules);
        var canvas = document.createElement('canvas');
        canvas.width = cellSize * modules;
        canvas.height = cellSize * modules;
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#000000';
        for (var r = 0; r < modules; r++) {
          for (var c = 0; c < modules; c++) {
            if (qr.isDark(r, c)) ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
          }
        }
        return canvas.toDataURL('image/png');
      } catch(e) { return null; }
    }

    window.getQRCodeURL = function(data, size) {
      var local = generateQRDataURL(data, size || 200);
      if (local) return local;
      return 'https://api.qrserver.com/v1/create-qr-code/?size=' + (size||200) + 'x' + (size||200) + '&data=' + encodeURIComponent(data);
    };

    function setQRCodeSrc(imgEl, data, size) {
      size = size || 200;
      var local = generateQRDataURL(data, size);
      if (local) {
        imgEl.src = local;
        return;
      }
      var url = 'https://api.qrserver.com/v1/create-qr-code/?size=' + size + 'x' + size + '&data=' + encodeURIComponent(data);
      imgEl.onerror = null;
      imgEl.src = url;
    }

    const msgs = document.getElementById('messages');
    const input = document.getElementById('input');

    let webSessionId = localStorage.getItem('webSessionId');
    if (webSessionId && webSessionId.startsWith('api:')) {
      webSessionId = 'webchat:' + webSessionId.slice(4);
      localStorage.setItem('webSessionId', webSessionId);
    }
    if (!webSessionId) {
      webSessionId = 'webchat:' + crypto.randomUUID();
      localStorage.setItem('webSessionId', webSessionId);
    }

    input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.isComposing) send(); });

    function typewriter(el, text, speed = 20) {
      return new Promise(resolve => {
        el.textContent = '';
        const cursor = document.createElement('span');
        cursor.className = 'typewriter-cursor';
        el.appendChild(cursor);
        let i = 0;
        function tick() {
          if (i < text.length) {
            el.insertBefore(document.createTextNode(text[i]), cursor);
            i++;
            msgs.scrollTop = msgs.scrollHeight;
            setTimeout(tick, speed);
          } else {
            setTimeout(() => { cursor.remove(); resolve(); }, 500);
          }
        }
        tick();
      });
    }

    function isLinkCodeResponse(text) {
      return text.includes('\u30EA\u30F3\u30AF\u30B3\u30FC\u30C9:') || text.includes('Link code:');
    }
    function isLinkSuccess(text) {
      return text.includes('\u30EA\u30F3\u30AF\u5B8C\u4E86') || text.includes('Link complete');
    }
    function formatLinkCode(text) {
      const match = text.match(/[:\uff1a]\s*([A-Z0-9]{6})/);
      if (!match) return null;
      return match[1];
    }

    function addMsg(text, who, useTypewriter = false, channel = null, agentName = null, toolsUsed = null) {
      const d = document.createElement('div');
      d.className = 'msg ' + who;

      if (channel && channel !== 'web') {
        const badge = document.createElement('div');
        badge.className = 'channel-badge ch-' + channel;
        const chNames = { line: 'LINE', telegram: 'Telegram', whatsapp: 'WhatsApp', facebook: 'Facebook', teams: 'Teams' };
        badge.textContent = chNames[channel] || channel;
        d.appendChild(badge);
      }

      if (who === 'bot' && isLinkCodeResponse(text)) {
        const code = formatLinkCode(text);
        if (code) {
          const l = document.documentElement.lang || 'ja';
          const lineDeepLink = 'https://line.me/R/oaMessage/@619jcqqh/?%2Flink%20' + code;
          const tgDeepLink = 'https://t.me/chatweb_ai_bot?text=%2Flink%20' + code;
          const qrUrl = window.getQRCodeURL('/link ' + code, 120);
          d.innerHTML = (l === 'ja'
            ? '<div style="font-size:13px;margin-bottom:4px;">リンクコードを生成しました</div>'
            : '<div style="font-size:13px;margin-bottom:4px;">Link code generated</div>')
            + '<div class="link-code" onclick="navigator.clipboard.writeText(\'' + code + '\');this.style.opacity=0.6;setTimeout(()=>this.style.opacity=1,300)">' + code + '</div>'
            + '<div class="link-steps">'
            + (l === 'ja'
              ? '<div><span class="step-num">1</span>下のボタンを押すだけ！</div>'
                + '<div><span class="step-num">2</span>開いたアプリで送信ボタンを押す</div>'
                + '<div><span class="step-num">3</span>会話が同期されます！</div>'
              : '<div><span class="step-num">1</span>Tap a button below!</div>'
                + '<div><span class="step-num">2</span>Press send in the app</div>'
                + '<div><span class="step-num">3</span>Conversations will sync!</div>')
            + '</div>'
            + '<div class="link-qr-row">'
            + '<a href="' + lineDeepLink + '" target="_blank" class="dl-line">LINE</a>'
            + '<a href="' + tgDeepLink + '" target="_blank" class="dl-tg">Telegram</a>'
            + '</div>'
            + '<img class="link-qr-img" src="' + qrUrl + '" alt="QR" width="120" height="120" loading="lazy" title="' + (l === 'ja' ? 'QRコードをスキャン' : 'Scan QR code') + '">'
            + '<div style="margin-top:6px;color:var(--muted);font-size:11px;">' + (l === 'ja' ? '有効期限: 30分' : 'Expires in 30 min') + '</div>';
          msgs.appendChild(d);
          msgs.scrollTop = msgs.scrollHeight;
          startPolling();
          return;
        }
      }

      if (who === 'bot' && isLinkSuccess(text)) {
        d.classList.add('link-success');
        const l = document.documentElement.lang || 'ja';
        d.innerHTML = '<div style="font-size:20px;margin-bottom:8px;">&#x2705;</div>'
          + '<div style="font-weight:700;">' + (l === 'ja' ? 'リンク完了！' : 'Link complete!') + '</div>'
          + '<div style="font-size:13px;color:var(--muted);margin-top:4px;">'
          + (l === 'ja' ? 'これからどのチャネルでも同じ会話を続けられます。' : 'You can now continue the same conversation on any channel.') + '</div>';
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
        startPolling();
        return;
      }

      function appendBadges() {
        if (agentName && who === 'bot') {
          const badge = document.createElement('span');
          badge.className = 'agent-badge';
          badge.textContent = agentName;
          d.appendChild(badge);
        }
        if (toolsUsed && toolsUsed.length > 0 && who === 'bot') {
          const container = document.createElement('div');
          container.className = 'tool-badges';
          const lang = document.documentElement.lang || 'ja';
          toolsUsed.forEach(tool => {
            const tb = document.createElement('span');
            tb.className = 'tool-badge';
            const info = TOOL_LABELS[tool] || { icon: '\uD83D\uDD27', ja: tool, en: tool };
            tb.textContent = info.icon + ' ' + (lang === 'ja' ? info.ja : info.en);
            container.appendChild(tb);
          });
          d.appendChild(container);
        }
      }

      if (who === 'bot' && useTypewriter && !channel) {
        msgs.appendChild(d);
        typewriter(d, text).then(appendBadges);
      } else {
        const textNode = document.createTextNode(text);
        d.appendChild(textNode);
        appendBadges();
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
      }
    }

    function sendRecipe(text) {
      input.value = text;
      send();
    }

    const THINKING_STAGES = {
      ja: [
        { time: 0,     icon: '\u26A1', text: '\u8003\u3048\u4E2D...' },
        { time: 1500,  icon: '\uD83D\uDD0D', text: '\u60C5\u5831\u3092\u691C\u7D22\u4E2D...' },
        { time: 4000,  icon: '\uD83D\uDCCA', text: '\u30C7\u30FC\u30BF\u3092\u5206\u6790\u4E2D...' },
        { time: 5000,  icon: '\uD83E\uDD14', text: '\u3046\u30FC\u3093\u3068...\u3061\u3087\u3063\u3068\u96E3\u3057\u3044\u306A...' },
        { time: 7000,  icon: '\uD83D\uDE05', text: '\u3054\u3081\u3093\u306D\u3001\u3082\u3046\u3061\u3087\u3063\u3068\u3060\u3051...' },
        { time: 9000,  icon: '\uD83D\uDCAD', text: '\u3042\u3001\u308F\u304B\u3063\u305F\uFF01\u307E\u3068\u3081\u308B\u306D...' },
        { time: 12000, icon: '\uD83D\uDE4F', text: '\u304A\u5F85\u305F\u305B\u3057\u3066\u3054\u3081\u3093\u306D...' },
      ],
      en: [
        { time: 0,     icon: '\u26A1', text: 'Thinking...' },
        { time: 1500,  icon: '\uD83D\uDD0D', text: 'Searching...' },
        { time: 4000,  icon: '\uD83D\uDCCA', text: 'Analyzing data...' },
        { time: 5000,  icon: '\uD83E\uDD14', text: 'Hmm, this is tricky...' },
        { time: 7000,  icon: '\uD83D\uDE05', text: 'Sorry, just a bit more...' },
        { time: 9000,  icon: '\uD83D\uDCAD', text: 'Got it! Putting it together...' },
        { time: 12000, icon: '\uD83D\uDE4F', text: 'Sorry for the wait...' },
      ]
    };

    let _thinkingAudioCtx = null;
    let _thinkingGain = null;
    let _thinkingOscs = [];
    function playThinkingAmbient() {
      try {
        if (_thinkingAudioCtx) return;
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 1.0);
        gain.connect(ctx.destination);
        const freqs = [261.63, 329.63, 392.00];
        const oscs = freqs.map(f => {
          const osc = ctx.createOscillator();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(f, ctx.currentTime);
          osc.connect(gain);
          osc.start();
          return osc;
        });
        _thinkingAudioCtx = ctx;
        _thinkingGain = gain;
        _thinkingOscs = oscs;
      } catch(e) { /* ignore audio errors */ }
    }
    function stopThinkingAmbient() {
      try {
        if (!_thinkingAudioCtx) return;
        const ctx = _thinkingAudioCtx;
        if (_thinkingGain) {
          _thinkingGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
        }
        setTimeout(() => {
          _thinkingOscs.forEach(o => { try { o.stop(); } catch(e){} });
          try { ctx.close(); } catch(e){}
        }, 600);
        _thinkingAudioCtx = null;
        _thinkingGain = null;
        _thinkingOscs = [];
      } catch(e) { /* ignore */ }
    }

    const TIMEOUT_FALLBACKS = {
      ja: [
        '\u3054\u3081\u3093\u306D\u3001\u3061\u3087\u3063\u3068\u8003\u3048\u3059\u304E\u3061\u3083\u3063\u305F...\u3082\u3046\u4E00\u56DE\u805E\u3044\u3066\u304F\u308C\u308B\uFF1F',
        '\u3046\u30FC\u3093\u3001\u4ECA\u65E5\u306F\u3061\u3087\u3063\u3068\u8ABF\u5B50\u304C\u60AA\u3044\u307F\u305F\u3044\u3002\u3082\u3046\u4E00\u5EA6\u8A66\u3057\u3066\u307F\u3066\uFF01',
        '\u8003\u3048\u3066\u305F\u3089\u8FF7\u5B50\u306B\u306A\u3063\u3061\u3083\u3063\u305F...\u4E00\u7DD2\u306B\u3082\u3046\u4E00\u56DE\u8003\u3048\u3088\u3046\uFF1F',
      ],
      en: [
        'Sorry, I got lost in thought... could you ask again?',
        'Hmm, having a bit of trouble today. Please try again!',
        'Got lost thinking about that... shall we try again together?',
      ],
    };

    const TOOL_LABELS = {
      web_search: { icon: '\uD83D\uDD0D', ja: 'Web\u691C\u7D22', en: 'Web Search' },
      web_fetch: { icon: '\uD83C\uDF10', ja: '\u30DA\u30FC\u30B8\u53D6\u5F97', en: 'Page Fetch' },
      calculator: { icon: '\uD83E\uDDEE', ja: '\u8A08\u7B97', en: 'Calculator' },
      weather: { icon: '\u26C5', ja: '\u5929\u6C17', en: 'Weather' },
      translate: { icon: '\uD83C\uDF0D', ja: '\u7FFB\u8A33', en: 'Translate' },
      wikipedia: { icon: '\uD83D\uDCDA', ja: 'Wikipedia', en: 'Wikipedia' },
      datetime: { icon: '\uD83D\uDD52', ja: '\u65E5\u6642', en: 'DateTime' },
      qr_code: { icon: '\uD83D\uDCF1', ja: 'QR\u30B3\u30FC\u30C9', en: 'QR Code' },
      news_search: { icon: '\uD83D\uDCF0', ja: '\u30CB\u30E5\u30FC\u30B9', en: 'News' },
    };

    // Guest Trial Tracking
    const GUEST_MAX_TURNS = 1;
    function getGuestTurns() { return parseInt(localStorage.getItem('guestTurns') || '0'); }
    function incGuestTurns() { const t = getGuestTurns() + 1; localStorage.setItem('guestTurns', t.toString()); return t; }
    function clearGuestTrial() { localStorage.removeItem('guestTurns'); }

    async function send() {
      if (!currentUser && getGuestTurns() >= GUEST_MAX_TURNS) {
        openAuthModal();
        return;
      }
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      // Hide demo messages on first guest send
      if (!currentUser && getGuestTurns() === 0) {
        document.querySelectorAll('.demo-msg').forEach(el => el.style.display = 'none');
      }
      addMsg(text, 'user');

      const typing = document.createElement('div');
      typing.className = 'msg typing';
      const lang = document.documentElement.lang || 'ja';
      const stages = THINKING_STAGES[lang] || THINKING_STAGES.ja;
      typing.innerHTML = '<div class="thinking-status">'
        + '<span class="thinking-icon">' + stages[0].icon + '</span>'
        + '<span class="thinking-text">' + stages[0].text + '</span>'
        + '<span class="thinking-elapsed">(0.0s)</span>'
        + '</div>'
        + '<div class="shimmer-bar"></div>';
      msgs.appendChild(typing);
      msgs.scrollTop = msgs.scrollHeight;

      const startTime = Date.now();
      let stageIdx = 0;
      let ambientStarted = false;
      const statusInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const elapsedEl = typing.querySelector('.thinking-elapsed');
        if (elapsedEl) elapsedEl.textContent = '(' + elapsed + 's)';

        const elapsedMs = Date.now() - startTime;
        if (!ambientStarted && elapsedMs >= 5000) {
          ambientStarted = true;
          playThinkingAmbient();
        }
        const nextStage = stages[stageIdx + 1];
        if (nextStage && elapsedMs >= nextStage.time) {
          stageIdx++;
          const iconEl = typing.querySelector('.thinking-icon');
          const textEl = typing.querySelector('.thinking-text');
          if (iconEl) iconEl.textContent = stages[stageIdx].icon;
          if (textEl) {
            textEl.style.opacity = '0';
            setTimeout(() => {
              textEl.textContent = stages[stageIdx].text;
              textEl.style.opacity = '1';
            }, 150);
          }
        }
      }, 100);

      const abortCtrl = new AbortController();
      const frontendTimeout = setTimeout(() => { abortCtrl.abort(); }, 11000);

      try {
        const agentSel = document.getElementById('agent-select').value;
        const msgToSend = (agentSel !== 'auto') ? ('@' + agentSel + ' ' + text) : text;
        const r = await fetch(API + '/api/v1/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msgToSend, session_id: webSessionId, language: lang2 || 'ja' }),
          signal: abortCtrl.signal,
        });
        const d = await r.json();
        clearTimeout(frontendTimeout);
        clearInterval(statusInterval);
        stopThinkingAmbient();
        typing.remove();
        addMsg(d.response, 'bot', true, null, d.agent || null, d.tools_used || null);
        knownMsgCount += 2; syncVersion++;
        startPolling();
        // Guest trial: increment turn count and show nudge
        if (!currentUser) {
          const turns = incGuestTurns();
          if (turns >= GUEST_MAX_TURNS) {
            const nudge = document.createElement('div');
            nudge.className = 'msg guest-nudge';
            nudge.innerHTML = '<div style="background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(168,85,247,0.15));border:1px solid rgba(99,102,241,0.3);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">'
              + '<span style="flex:1;min-width:180px;">' + (lang === 'ja' ? '無料お試しは終了です。サインアップで100クレジットプレゼント！' : 'Free trial ended! Sign up for 100 free credits.') + '</span>'
              + '<button onclick="openAuthModal()" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 16px;cursor:pointer;font-weight:600;font-size:13px;white-space:nowrap;">' + (lang === 'ja' ? '無料で始める' : 'Get Started Free') + '</button>'
              + '<button onclick="this.closest(\'.guest-nudge\').remove()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;padding:2px 6px;">✕</button>'
              + '</div>';
            msgs.appendChild(nudge);
            msgs.scrollTop = msgs.scrollHeight;
          }
        }
      } catch (e) {
        clearTimeout(frontendTimeout);
        clearInterval(statusInterval);
        stopThinkingAmbient();
        typing.remove();
        if (e && e.name === 'AbortError') {
          const fallbacks = TIMEOUT_FALLBACKS[lang] || TIMEOUT_FALLBACKS.ja;
          addMsg(fallbacks[Math.floor(Math.random() * fallbacks.length)], 'bot');
        } else {
          addMsg(lang === 'ja' ? '\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002\u3082\u3046\u4E00\u5EA6\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002' : 'Something went wrong. Please try again.', 'bot');
        }
      }
    }

    let pollInterval = null;
    let knownMsgCount = 0;
    let syncVersion = 0;
    let isPolling = false;
    let _lastSyncTimestamp = null; // Track last synced message time for gap detection

    function startPolling() {
      if (pollInterval) return;
      pollInterval = setInterval(pollSync, 1500);
    }

    function stopPolling() {
      if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
    }

    function insertTimeDivider(timestamp) {
      const d = new Date(timestamp);
      const now = new Date();
      const l = document.documentElement.lang || 'ja';
      let label;
      const diffMs = now - d;
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) {
        label = l === 'ja' ? 'たった今' : 'Just now';
      } else if (diffMin < 60) {
        label = l === 'ja' ? diffMin + '分前' : diffMin + 'm ago';
      } else {
        const h = d.getHours().toString().padStart(2, '0');
        const m = d.getMinutes().toString().padStart(2, '0');
        const isToday = d.toDateString() === now.toDateString();
        if (isToday) {
          label = (l === 'ja' ? '今日 ' : 'Today ') + h + ':' + m;
        } else {
          const mon = d.getMonth() + 1;
          const day = d.getDate();
          label = (l === 'ja' ? mon + '/' + day + ' ' : mon + '/' + day + ' ') + h + ':' + m;
        }
      }
      const divider = document.createElement('div');
      divider.className = 'sync-time-divider';
      divider.innerHTML = '<span class="divider-text">' + label + '</span>';
      const isApp = document.body.classList.contains('app-mode');
      const container = isApp ? document.getElementById('app-messages') : document.getElementById('msgs');
      if (container) container.appendChild(divider);
    }

    async function pollSync() {
      if (isPolling) return;
      isPolling = true;
      try {
        const r = await fetch(API + '/api/v1/sync/poll?session_key=' + encodeURIComponent(webSessionId) + '&v=' + syncVersion);
        const data = await r.json();
        if (data.updated && data.messages && data.messages.length > 0) {
          const lastCh = data.last_channel || '';
          for (const m of data.messages) {
            const ch = m.channel || 'web';
            if (ch !== 'web') {
              if (m.timestamp && _lastSyncTimestamp) {
                const prev = new Date(_lastSyncTimestamp);
                const curr = new Date(m.timestamp);
                const gapMin = (curr - prev) / 60000;
                if (gapMin > 30) {
                  insertTimeDivider(m.timestamp);
                }
              } else if (m.timestamp && !_lastSyncTimestamp) {
                insertTimeDivider(m.timestamp);
              }
              if (m.timestamp) _lastSyncTimestamp = m.timestamp;

              const isApp = document.body.classList.contains('app-mode');
              if (isApp) {
                appAddMsg(m.content, m.role === 'user' ? 'user' : 'bot', null, null, ch);
              } else {
                addMsg(m.content, m.role === 'user' ? 'user' : 'bot', false, ch);
              }
            }
          }
          syncVersion = data.version;
          knownMsgCount = Math.max(knownMsgCount, syncVersion * 2);
          showSyncToast(lastCh);
        } else if (data.version) {
          syncVersion = data.version;
        }
      } catch(e) { /* ignore poll errors */ }
      isPolling = false;
    }

    function showSyncToast(channel) {
      const chNames = { line: 'LINE', telegram: 'Telegram', facebook: 'Facebook', whatsapp: 'WhatsApp', teams: 'Teams', feishu: 'Feishu', zalo: 'Zalo', google_chat: 'Google Chat' };
      const name = chNames[channel] || channel;
      if (!name || name === 'web') return;
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#6366f1;color:#fff;padding:6px 16px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;';
      toast.textContent = name + ' から同期しました';
      document.body.appendChild(toast);
      requestAnimationFrame(() => { toast.style.opacity = '1'; });
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
    }

    let statusPollInterval = null;
    function startStatusPolling() {
      if (statusPollInterval) return;
      statusPollInterval = setInterval(pollChannelStatus, 15000);
    }
    async function pollChannelStatus() {
      try {
        const r = await fetch(API + '/api/v1/sessions/' + encodeURIComponent(webSessionId));
        const data = await r.json();
        if (data.linked_channels) {
          updateChannelStatus(data.linked_channels, data.linked_channel_details);
        }
      } catch(e) { /* ignore */ }
    }

    function updateChannelStatus(channels, details) {
      // Mark all server-known linked channels as notified so overlays don't re-fire
      channels.forEach(ch => { if (ch !== 'web') markChannelNotified(ch === 'telegram' ? 'tg' : ch); });
      const lineBar = document.getElementById('ch-bar-line');
      const tgBar = document.getElementById('ch-bar-tg');
      const lineCard = document.getElementById('line-card');
      const tgCard = document.getElementById('tg-card');
      if (channels.includes('line')) {
        lineBar && lineBar.classList.add('connected');
        lineCard && lineCard.classList.add('connected');
      }
      if (channels.includes('telegram')) {
        tgBar && tgBar.classList.add('connected');
        tgCard && tgCard.classList.add('connected');
      }
      const nonWeb = channels.filter(c => c !== 'web');
      if (nonWeb.length > 0) {
        document.querySelectorAll('.channel-cards').forEach(g => g.style.display = 'none');
        const hint = document.getElementById('link-cmd-hint');
        if (hint) hint.style.display = 'none';
        const cli = document.getElementById('cli-install-section');
        if (cli) cli.style.display = 'none';
      }
      const chMap = { line: 'app-ch-line', telegram: 'app-ch-tg', whatsapp: 'app-ch-whatsapp', discord: 'app-ch-discord', slack: 'app-ch-slack', teams: 'app-ch-teams' };
      const ll = document.documentElement.lang || 'ja';
      channels.forEach(ch => {
        const el = document.getElementById(chMap[ch]);
        if (el) {
          el.classList.add('connected');
          // Update status label for primary channels
          const statusEl = el.querySelector('.app-ch-status');
          if (statusEl) {
            const d = details && details.find(dd => dd.type === ch);
            statusEl.textContent = d && d.name ? d.name : (ll === 'ja' ? '連携中' : 'Linked');
          }
        }
      });
      updateSidebarChannelBadges(channels, details);
    }

    // --- 30-minute idle → show fresh question screen ---
    let lastActivityTime = Date.now();
    function touchActivity() { lastActivityTime = Date.now(); }
    const IDLE_THRESHOLD_MS = 30 * 60 * 1000; // 30 minutes

    function showIdleNewScreen() {
      const msgsEl = document.getElementById('app-messages');
      if (!msgsEl) return;
      // Don't reset if already on empty screen
      if (document.getElementById('app-empty')) return;

      const l = document.documentElement.lang || 'ja';
      // Insert a time divider
      insertConversationDivider();

      // Create empty state with predicted questions
      const empty = document.createElement('div');
      empty.className = 'app-chat-empty';
      empty.id = 'app-empty';
      empty.innerHTML = '<div class="app-chat-empty-logo">chatweb.ai</div>'
        + '<button class="voice-hero-btn" id="voice-hero-btn" onclick="toggleVoiceHero()"><svg viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>'
        + '<div class="voice-hero-label" id="voice-hero-label">' + (l === 'ja' ? 'タップして話す' : 'Tap to talk') + '</div>'
        + '<div class="app-chat-empty-text" id="app-empty-text">' + (l === 'ja' ? 'おかえりなさい。次は何をしましょう？' : 'Welcome back. What shall we do next?') + '</div>'
        + '<div class="app-chat-suggestions" id="app-suggestions"></div>';
      msgsEl.appendChild(empty);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      // Render predicted questions based on time of day and context
      const hour = new Date().getHours();
      const predictedJa = hour < 12
        ? ['今日のニュースをまとめて', '午前中のタスクを整理して', 'メールの下書きを手伝って', '今週の天気を教えて']
        : hour < 18
        ? ['午後のミーティング準備を手伝って', 'この資料を要約して', 'コードのバグを見つけて', '競合の最新情報を調べて']
        : ['今日の振り返りをまとめて', '明日の予定を整理して', '晩ごはんのレシピを提案して', 'リラックスできる音楽を教えて'];
      const predictedEn = hour < 12
        ? ['Summarize today\'s news', 'Organize my morning tasks', 'Help draft an email', 'What\'s the weather this week?']
        : hour < 18
        ? ['Help prepare for my meeting', 'Summarize this document', 'Find a bug in my code', 'Research competitor updates']
        : ['Summarize my day', 'Plan tomorrow\'s schedule', 'Suggest a dinner recipe', 'Recommend relaxing music'];
      const predicted = l === 'ja' ? predictedJa : predictedEn;
      const container = document.getElementById('app-suggestions');
      if (container) {
        container.innerHTML = '';
        predicted.forEach(s => {
          const btn = document.createElement('div');
          btn.className = 'app-chat-suggestion';
          btn.textContent = s;
          btn.onclick = () => { document.getElementById('app-input').value = s; appSend(); };
          container.appendChild(btn);
        });
      }

      // Start a new session silently
      if (authToken) {
        finalizeCurrentConversation();
        fetch(API + '/api/v1/conversations', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken },
        }).then(r => r.json()).then(d => {
          if (d.ok) {
            webSessionId = d.session_id;
            localStorage.setItem('webSessionId', webSessionId);
            appCurrentConvId = d.conversation_id || null;
            knownMsgCount = 0; syncVersion = 0; _lastSyncTimestamp = null;
            appLoadConversations();
          }
        }).catch(() => {});
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopPolling();
        if (statusPollInterval) { clearInterval(statusPollInterval); statusPollInterval = null; }
        if (typeof stopDevicePolling === 'function') stopDevicePolling();
      } else {
        // Check idle on tab return
        if (Date.now() - lastActivityTime >= IDLE_THRESHOLD_MS) {
          showIdleNewScreen();
        }
        touchActivity();
        startPolling(); startStatusPolling();
        if (typeof startDevicePolling === 'function' && document.body.classList.contains('app-mode')) startDevicePolling();
      }
    });
    startPolling();
    pollChannelStatus(); // Check channel status immediately on load
    startStatusPolling();

    const R = {
      ja: {
        categories: [
          {
            icon: '\uD83C\uDFA8', title: 'クリエイティブ・編集',
            items: [
              { name: '動画の粗編集をお任せ', desc: '無音カット＆結合を自動化', prompt: '素材フォルダにある動画ファイルを全部読み込んで、無音部分を全部カットして、一本のタイムラインにつなげるスクリプトを書いて。ffmpegを使って。' },
              { name: '画像100枚に透かし入れ', desc: 'リサイズ＆ロゴ挿入を一括', prompt: 'フォルダにある画像ファイル全てに右下にロゴ画像を入れて、Web用に幅1200pxにリサイズして書き出すシェルスクリプトを作って。ImageMagickを使って。' },
              { name: 'ポートフォリオサイト作成', desc: 'HTML/CSS/JSでサイト構築', prompt: 'モダンなポートフォリオサイトを作って。自己紹介、スキルセット、制作実績3つ、お問い合わせフォームを含むレスポンシブデザインで。' },
            ]
          },
          {
            icon: '\uD83D\uDCBC', title: '経理・総務・バックオフィス',
            items: [
              { name: '領収書の仕分け＆入力', desc: '画像から日付・金額を読み取り', prompt: '領収書の写真から日付、店名、金額、税区分を読み取って、経費精算用のCSVファイルを作って。勘定科目も自動分類して。' },
              { name: 'SaaSアカウント棚卸し', desc: '未使用ユーザーを洗い出し', prompt: '社員50人分のSaaS利用状況を整理するためのチェックリストを作って。3ヶ月以上ログインしていないアカウントを洗い出す手順も含めて。' },
              { name: '問い合わせ対応テンプレ', desc: 'クレーム・質問・営業を分類', prompt: '顧客からの問い合わせを「クレーム」「質問」「営業メール」「パートナーシップ提案」に分類するルールと、それぞれの返信テンプレートを作って。' },
            ]
          },
          {
            icon: '\uD83D\uDD0D', title: 'リサーチ・情報収集',
            items: [
              { name: '競合の定点観測', desc: '採用・価格・新着情報を自動チェック', prompt: '競合A社とB社の採用ページと製品ページを調べて、最新の求人内容と新製品情報をスプレッドシート形式でまとめて。' },
              { name: '会議の事前リサーチ', desc: '相手企業の情報を自動収集', prompt: '明日「株式会社サンプル」と会議があります。この会社の最新ニュース3件と事業概要、競合他社をまとめた事前準備レポートを作って。' },
              { name: '旅行の格安プラン探し', desc: '予算内で最適プランを提案', prompt: '3月に2泊3日で京都旅行を計画中。予算は1人5万円。桜の名所を中心に、モデルコースを作って。おすすめの宿も教えて。' },
            ]
          },
          {
            icon: '\uD83C\uDFE0', title: '生活・プライベート',
            items: [
              { name: 'サブスク解約の代行', desc: '複雑な解約手順をナビゲート', prompt: '使っていないサブスクリプションを整理したい。解約手順が分かりにくいサービスの一般的な解約方法と、解約前に確認すべきポイントをまとめて。' },
              { name: '今晩の献立を考えて', desc: '冷蔵庫の中身からレシピ提案', prompt: '冷蔵庫に鶏もも肉、玉ねぎ、じゃがいも、卵、牛乳があります。30分以内で作れる夕食のレシピを2つ提案して。' },
              { name: '確定申告の経費相談', desc: 'フリーランスの節税アドバイス', prompt: 'フリーランスのWebデザイナーです。自宅で仕事をしています。家賃・光熱費・通信費は経費にできますか？按分の目安を教えて。' },
            ]
          },
          {
            icon: '\uD83D\uDEE0\uFE0F', title: '開発・レガシーシステム',
            items: [
              { name: 'APIがないシステムを自動化', desc: 'RPA不要、自然言語で操作', prompt: '古い在庫管理システムからExcelで出力したデータを、新しいシステムに移行するためのスクリプトを書いて。CSVの列マッピングも自動判定して。' },
              { name: '障害対応手順書を作成', desc: 'エラー発生時のフロー設計', prompt: 'AWSでLambdaのエラー率が急上昇した時の障害対応手順書を作って。CloudWatchアラーム→ログ分析→原因特定→復旧→報告の流れで。' },
              { name: 'API仕様書を自動生成', desc: 'OpenAPI形式でドキュメント作成', prompt: 'REST APIの設計をして。ユーザー管理（CRUD）、認証（JWT）、ファイルアップロードのエンドポイントをOpenAPI 3.0形式で書いて。' },
            ]
          },
        ],
      },
      en: {
        categories: [
          {
            icon: '\uD83C\uDFA8', title: 'Creative & Editing',
            items: [
              { name: 'Auto-edit video rough cuts', desc: 'Remove silence & join clips', prompt: 'Write a script using ffmpeg that reads all video files in a folder, removes silent sections, and concatenates them into a single timeline.' },
              { name: 'Batch watermark 100 images', desc: 'Resize & add logo in bulk', prompt: 'Write a shell script using ImageMagick to add a logo watermark to the bottom-right of all images in a folder, resize to 1200px width, and export for web.' },
              { name: 'Build a portfolio site', desc: 'Full HTML/CSS/JS website', prompt: 'Create a modern portfolio website with an about section, skills, 3 project showcases, and a contact form. Make it responsive and visually appealing.' },
            ]
          },
          {
            icon: '\uD83D\uDCBC', title: 'Admin & Back Office',
            items: [
              { name: 'Sort & enter receipts', desc: 'Extract dates & amounts from images', prompt: 'Read the receipt photo and extract date, store name, amount, and tax category. Create a CSV file for expense reporting with auto-classified account categories.' },
              { name: 'SaaS account audit', desc: 'Find unused subscriptions', prompt: 'Create a checklist for auditing SaaS usage across 50 employees. Include steps to identify accounts with no login for 3+ months and estimate cost savings.' },
              { name: 'Customer inquiry templates', desc: 'Auto-classify and respond', prompt: 'Create rules to classify customer inquiries into: complaint, question, sales email, partnership. Include a response template for each category.' },
            ]
          },
          {
            icon: '\uD83D\uDD0D', title: 'Research & Intelligence',
            items: [
              { name: 'Competitor monitoring', desc: 'Track hiring, pricing & news', prompt: 'Research Company A and Company B. Check their careers page and product updates. Summarize new job postings and product changes in a spreadsheet format.' },
              { name: 'Meeting prep research', desc: 'Auto-gather company intel', prompt: 'I have a meeting with "Sample Corp" tomorrow. Create a prep report with their latest 3 news items, business overview, and competitors.' },
              { name: 'Find travel deals', desc: 'Best plans within your budget', prompt: "I'm planning a 3-day trip to Kyoto in March. Budget is $500 per person. Focus on cherry blossom spots, create a day-by-day itinerary with hotel recommendations." },
            ]
          },
          {
            icon: '\uD83C\uDFE0', title: 'Life & Personal',
            items: [
              { name: 'Cancel unused subscriptions', desc: 'Navigate confusing cancellation flows', prompt: 'I want to clean up unused subscriptions. Summarize the typical cancellation steps for hard-to-cancel services and what to check before cancelling.' },
              { name: 'Dinner ideas from fridge', desc: 'Recipes from what you have', prompt: 'I have chicken thighs, onions, potatoes, eggs, and milk in my fridge. Suggest 2 dinner recipes I can make in under 30 minutes.' },
              { name: 'Tax deduction advice', desc: 'Freelancer expense guidance', prompt: "I'm a freelance web designer working from home. Can I deduct rent, utilities, and internet costs? What's the typical home office deduction percentage?" },
            ]
          },
          {
            icon: '\uD83D\uDEE0\uFE0F', title: 'Dev & Legacy Systems',
            items: [
              { name: 'Automate systems without APIs', desc: 'No RPA needed, just natural language', prompt: 'Write a script to migrate data exported as Excel from a legacy inventory system to a new system. Auto-detect CSV column mappings between the two formats.' },
              { name: 'Incident response playbook', desc: 'Error handling workflow', prompt: 'Create an incident response playbook for AWS Lambda error rate spikes. Cover: CloudWatch alarm \u2192 log analysis \u2192 root cause \u2192 recovery \u2192 report.' },
              { name: 'API spec generator', desc: 'OpenAPI docs from requirements', prompt: 'Design a REST API with user management (CRUD), auth (JWT), and file upload endpoints in OpenAPI 3.0 format.' },
            ]
          },
        ],
      }
    };

    const T = {
      ja: {
        title: 'お願いしたら、本当にやってくれるAI。',
        sub: 'チャットで頼むだけ。検索、コード実行、ファイル操作、定期監視まで — 声でもテキストでも。',
        welcome: 'こんにちは！何でもお任せください。下のカードから選ぶか、自由に入力してください。',
        line: 'LINEで使う', tg: 'Telegramで使う',
        lineDesc: '1タップで友だち追加 → 自動連携', tgDesc: 'ボタンを押すだけ → 今すぐ開始',
        lineConnected: '&#x2713; 連携済み', tgConnected: '&#x2713; 連携済み', chConnected: '&#x2713; 連携済み',
        ph: '何でも聞いてください...', send: '送信',
        heroTry: '今すぐ無料で試す', pricing: '料金', settings: '設定', status: 'ステータス', comparison: '比較',
        chatStatus: 'オンライン',
        statsUptime: '稼働率', statsSpeed: '平均応答', statsModels: 'AIモデル', statsChannels: 'チャネル', statsTools: 'ツール',
        trustSsl: 'SSL暗号化', trustStripe: 'Stripe決済', trustNocard: 'カード不要で開始',
        socialProof: '🇯🇵 日本発 · オープンソース · Web・LINE・Telegram対応',
        syncTitle: 'どのチャネルでも同じ会話',
        syncDesc: 'Web・LINE・Telegramの会話をリンクして、どこからでも続きを。',
        step1Title: '友だち追加', step1Desc: '上のボタンからLINE/Telegramで友だち追加',
        step2Title: 'IDで自動連携', step2Desc: 'ボタンを押すだけで自動連携されます',
        step3Title: '同期完了', step3Desc: '全チャネルの会話が統合されます',
        sessionLabel: 'あなたのセッションID:', sessionHint: 'クリックでコピー。LINE/Telegramに貼り付けで連携',
        cliTitle: 'CLI', cliSub: 'コマンドラインからも使えます',
        cliSyncHint: 'Webの会話と同期してCLIを使う',
        bottomTitle: 'もっとパワフルに使いたい？',
        bottomSub: 'GPT-4o、Claude Sonnet、Claude Opusなど最先端モデルを月額$9から。',
        bottomCta: 'プランを比較する',
        bottomHint: 'Starter $9/月 &middot; Pro $29/月 &middot; いつでもキャンセル可能',
        agentAuto: 'Auto (自動振り分け)',
        deviceTitle: '接続デバイス',
        deviceDesc: 'CLIデーモンで接続されたマシン一覧',
        deviceHint: 'CLIをインストールして <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">chatweb daemon</code> で接続',
        capTitle: 'AI + ツールで、なんでも自動化',
        capSub: '内蔵ツール + MCP拡張で無限の可能性',
        capSearch: 'Web検索', capSearchD: 'リアルタイムの情報を検索・収集',
        capFetch: 'Webページ取得', capFetchD: '任意のURLからコンテンツを取得',
        capCalc: '電卓', capCalcD: '数式の計算・通貨換算',
        capWeather: '天気', capWeatherD: '世界中の天気・予報を取得',
        capFile: 'ファイル操作', capFileD: 'ファイルの読み書き・編集',
        capShell: 'シェル実行', capShellD: 'コマンドの実行・自動化',
        capBrowser: 'ブラウザ', capBrowserD: 'Webページの自動操作',
        capImage: '画像解析', capImageD: '画像認識・マルチモーダル',
        capMemory: '永続メモリ', capMemoryD: '会話横断で記憶を保持',
        capNote: 'MCPツールはModel Context Protocolで無限に拡張可能。',
        capNoteLink: 'ツール一覧を聞いてみる →',
        voiceLabel: '🎙️ AIの声を聴いてみよう',
        loginBtn: 'ログイン',
        chatLoginPrompt: 'ログインして会話を始める',
        sidebarTitle: '会話履歴',
        newConv: '+ 新しい会話',
        appNewChat: '新しいチャット',
        appEmptyText: '何でも聞いてください',
        appPlaceholder: 'メッセージを入力...',
        uc1Title: 'ファイルの整理', uc1Desc: '「ダウンロードフォルダを種類別に整理して」— フォルダ作成からファイル移動まで自動で完了。',
        uc2Title: '環境構築・バグ修正', uc2Desc: '「このリポジトリを動くようにして」— エラーを自力で解決し、起動まで自律的に試行錯誤。',
        uc3Title: '定期監視（ハートビート）', uc3Desc: '「サーバーが落ちてないか見ておいて」— 寝ている間にダウンを検知し、復旧して事後報告。',
        uc4Title: 'Web操作の代行', uc4Desc: '「最安値フライトを探してカレンダーに入れて」— 複数サイトを巡回し、予定登録まで全自動。',
        uc5Title: 'ずっと覚えている（永続メモリ）', uc5Desc: '「いつもの感じでメール返信して」— 過去の会話や好みをずっと覚えているから、毎回の説明が不要。',
        uc6Title: '声で操作、どこからでも', uc6Desc: '「声で指示するだけ」— Web・LINE・Telegramどこからでも同じAIが応答。マルチチャネル対応。',
        demoQ1: 'やる気が出ない', demoA1: 'わかります。やる気って、待ってても来ないんですよね。\n...でも不思議と、誰かと話してると出てきたりする。\nというわけで、今ちょっとだけ出てきてません？ 😏',
      },
      en: {
        title: 'AI that actually does the work.',
        sub: 'Just ask. Search, code execution, file operations, scheduled monitoring — by voice or text.',
        welcome: 'Hi! Pick a task below or type anything you need.',
        line: 'Use on LINE', tg: 'Use on Telegram',
        lineDesc: '1 tap to add friend → auto-link', tgDesc: 'Just tap → start now',
        lineConnected: '&#x2713; Connected', tgConnected: '&#x2713; Connected', chConnected: '&#x2713; Connected',
        ph: 'Ask me anything...', send: 'Send',
        heroTry: 'Try Free Now', pricing: 'Pricing', settings: 'Settings', status: 'Status', comparison: 'Comparison',
        chatStatus: 'Online',
        statsUptime: 'Uptime', statsSpeed: 'Avg Response', statsModels: 'AI Models', statsChannels: 'Channels', statsTools: 'Tools',
        trustSsl: 'SSL Encrypted', trustStripe: 'Stripe Payments', trustNocard: 'No card required',
        socialProof: '🇯🇵 Made in Japan · Open Source · Web, LINE & Telegram',
        syncTitle: 'Same conversation, any channel',
        syncDesc: 'Link your Web, LINE, and Telegram chats. Continue from anywhere.',
        step1Title: 'Add friend', step1Desc: 'Tap LINE/Telegram buttons above',
        step2Title: 'Auto-link', step2Desc: 'Just tap the button to auto-link',
        step3Title: 'Synced!', step3Desc: 'All conversations are unified',
        sessionLabel: 'Your session ID:', sessionHint: 'Click to copy. Paste in LINE/Telegram to link',
        cliTitle: 'CLI', cliSub: 'Use from command line',
        cliSyncHint: 'Sync with your Web conversation from CLI',
        bottomTitle: 'Need more power?',
        bottomSub: 'Access GPT-4o, Claude Sonnet, Claude Opus and more from $9/month.',
        bottomCta: 'Compare Plans',
        bottomHint: 'Starter $9/mo &middot; Pro $29/mo &middot; Cancel anytime',
        agentAuto: 'Auto (smart routing)',
        deviceTitle: 'Connected Devices',
        deviceDesc: 'Machines connected via CLI daemon',
        deviceHint: 'Install CLI and run <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">chatweb daemon</code> to connect',
        capTitle: 'AI + Tools = Automate Anything',
        capSub: 'Built-in tools + unlimited MCP extensions',
        capSearch: 'Web Search', capSearchD: 'Search & gather real-time information',
        capFetch: 'Web Fetch', capFetchD: 'Retrieve content from any URL',
        capCalc: 'Calculator', capCalcD: 'Math, conversions & calculations',
        capWeather: 'Weather', capWeatherD: 'Global weather & forecasts',
        capFile: 'File Operations', capFileD: 'Read, write & edit files',
        capShell: 'Shell Exec', capShellD: 'Run commands & automate tasks',
        capBrowser: 'Browser', capBrowserD: 'Automate web pages',
        capImage: 'Image Analysis', capImageD: 'Vision & multimodal AI',
        capMemory: 'Memory', capMemoryD: 'Persistent cross-session memory',
        capNote: 'MCP tools are infinitely extensible via Model Context Protocol.',
        capNoteLink: 'Ask about available tools →',
        voiceLabel: '🎙️ Listen to AI speak',
        loginBtn: 'Login',
        chatLoginPrompt: 'Login to start chatting',
        sidebarTitle: 'Conversations',
        newConv: '+ New Conversation',
        appNewChat: 'New chat',
        appEmptyText: 'Ask me anything',
        appPlaceholder: 'Message chatweb.ai...',
        uc1Title: 'File Organization', uc1Desc: '"Organize my downloads by type" — Creates folders and moves files automatically.',
        uc2Title: 'Setup & Bug Fixes', uc2Desc: '"Get this repo running on my machine" — Resolves errors autonomously until it works.',
        uc3Title: 'Scheduled Monitoring', uc3Desc: '"Watch if my server goes down" — Detects downtime overnight, restarts and reports.',
        uc4Title: 'Web Task Automation', uc4Desc: '"Find cheapest flights and add to my calendar" — Browses sites and books automatically.',
        uc5Title: 'Persistent Memory', uc5Desc: '"Reply to Bob in my usual tone" — Remembers past conversations and preferences.',
        uc6Title: 'Voice Control, Anywhere', uc6Desc: '"Just tell it by voice" — Same AI responds from Web, LINE, or Telegram. Multi-channel ready.',
        demoQ1: "I can't get motivated", demoA1: "I get it. Motivation doesn't come when you wait for it.\n...But weirdly, it shows up when you start talking to someone.\nSo... feeling a little spark right now? 😏",
      }
    };

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    const AB_VARIANTS = {
      a: {
        ja: {
          title: '何でも聞いて。たぶん、笑わせちゃうけど。',
          sub: '知識もあるし、話も面白い。たまに予想外のことを言うAI。',
          heroTry: '話しかけてみる',
          welcome: 'やあ、何でも聞いて。たぶん期待以上の答え、返しますよ。',
          demoQ1: 'やる気が出ない',
          demoA1: 'わかります。やる気って、待ってても来ないんですよね。\n...でも不思議と、誰かと話してると出てきたりする。\nというわけで、今ちょっとだけ出てきてません？ 😏',
        },
        en: {
          title: "Ask me anything. I'll probably make you laugh.",
          sub: 'Smart, funny, and occasionally surprising AI.',
          heroTry: 'Start talking',
          welcome: "Hey, ask me anything. I'll probably exceed your expectations.",
          demoQ1: "I can't get motivated",
          demoA1: "I get it. Motivation doesn't come when you wait for it.\n...But weirdly, it shows up when you start talking to someone.\nSo... feeling a little spark right now? 😏",
        }
      },
      b: {
        ja: {
          title: '賢いAIは、退屈じゃない。',
          sub: '知識とユーモアで、あなたの質問を面白くする。',
          heroTry: '無料で試す',
          welcome: '何でも聞いてください。きっと驚きますよ。',
          demoQ1: '相対性理論をわかりやすく',
          demoA1: '好きな人と一緒の1時間は一瞬。退屈な会議の1時間は永遠。\n...これ、アインシュタインが本当に言った例えなんです。\nつまり、楽しい会話って一瞬で終わっちゃうんですよね。',
        },
        en: {
          title: "Smart AI isn't boring.",
          sub: 'Making your questions interesting with knowledge and humor.',
          heroTry: 'Try free',
          welcome: "Ask me anything. You'll be surprised.",
          demoQ1: 'Explain relativity simply',
          demoA1: "An hour with someone you love feels like a second. An hour in a boring meeting feels like eternity.\n...Einstein actually said that.\nPoint is, good conversations end way too fast.",
        }
      },
      c: {
        ja: {
          title: '話しかけたら、最後。',
          sub: 'ハマる人、続出中。賢くて面白くて、ちょっと予想外なAI。',
          heroTry: '試してみる',
          welcome: '...お、来ましたね。何か聞きたいことがある顔してる。',
          demoQ1: 'おすすめの映画ある？',
          demoA1: 'あなたの好みがまだわからないので...直感で。\n『her/世界でひとつの彼女』。AIと人間のラブストーリー。\nなぜこれを選んだかは...ご想像にお任せします 🎬',
        },
        en: {
          title: "Once you start talking, you won't stop.",
          sub: "People are getting hooked. Smart, funny, and a little unpredictable.",
          heroTry: 'Try it',
          welcome: "...Oh, you're here. You look like you've got something to ask.",
          demoQ1: 'Any movie recommendations?',
          demoA1: "I don't know your taste yet... so I'll go with instinct.\n\"Her\" — a love story between a human and an AI.\nWhy I picked it? ...I'll let you figure that out 🎬",
        }
      }
    };

    function getABVariant() {
      var params = new URLSearchParams(window.location.search);
      var forced = params.get('v');
      if (forced && AB_VARIANTS[forced]) {
        localStorage.setItem('abVariant', forced);
        return forced;
      }
      var stored = localStorage.getItem('abVariant');
      if (stored && AB_VARIANTS[stored]) return stored;
      var keys = Object.keys(AB_VARIANTS);
      var picked = keys[Math.floor(Math.random() * keys.length)];
      localStorage.setItem('abVariant', picked);
      return picked;
    }

    function applyABVariant(variant) {
      var v = AB_VARIANTS[variant];
      if (!v) return;
      console.log('AB variant:', variant);
      ['ja', 'en'].forEach(function(lang) {
        if (v[lang]) {
          Object.keys(v[lang]).forEach(function(key) {
            T[lang][key] = v[lang][key];
          });
        }
      });
    }

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    const DEMO_VOICES = [
      { icon: '🌤️', ja: '天気', en: 'Weather',
        text: '東京は晴れ、気温12度です。午後から少し雲が出るでしょう。お出かけには最適な一日です。' },
      { icon: '📧', ja: 'メール', en: 'Email',
        text: '件名、ミーティングのお礼。田中様、本日はお忙しい中お時間をいただきありがとうございました。' },
      { icon: '🌍', ja: '翻訳', en: 'Translate',
        text: '"Hello, how are you?" は日本語で「こんにちは、お元気ですか？」です。' },
      { icon: '🍳', ja: 'レシピ', en: 'Recipe',
        text: 'チャーハンの作り方。ご飯、卵、ネギを用意。フライパンを強火で熱して、卵を先に炒めます。' },
      { icon: '💡', ja: '豆知識', en: 'Fun Fact',
        text: 'タコの心臓は3つあります。2つはエラに血液を送り、1つは全身に血液を送ります。' },
      { icon: '🧮', ja: '計算', en: 'Calculate',
        text: '消費税10パーセント込みで、2,980円の商品は3,278円になります。' },
    ];

    let demoAudio = null;
    let demoPlayingIdx = -1;
    let demoTypewriterAbort = false;

    function renderVoiceDemo(lang) {
      const grid = document.getElementById('voice-demo-grid');
      grid.innerHTML = '';
      DEMO_VOICES.forEach((v, i) => {
        const btn = document.createElement('button');
        btn.className = 'voice-demo-btn';
        btn.textContent = v.icon + ' ' + (lang === 'ja' ? v.ja : v.en);
        btn.onclick = () => playDemoVoice(i);
        if (i === demoPlayingIdx) btn.classList.add('playing');
        grid.appendChild(btn);
      });
    }

    function stopDemoVoice() {
      demoTypewriterAbort = true;
      if (demoAudio && !demoAudio.paused) {
        demoAudio.pause();
        demoAudio.currentTime = 0;
      }
      demoAudio = null;
      const prev = demoPlayingIdx;
      demoPlayingIdx = -1;
      document.querySelectorAll('.voice-demo-btn').forEach(b => b.classList.remove('playing'));
      const output = document.getElementById('voice-demo-output');
      if (prev !== -1) {
        output.classList.remove('active');
      }
      return prev;
    }

    async function playDemoVoice(idx) {
      const prev = stopDemoVoice();
      if (prev === idx) return;

      demoPlayingIdx = idx;
      demoTypewriterAbort = false;
      const v = DEMO_VOICES[idx];
      const btns = document.querySelectorAll('.voice-demo-btn');
      if (btns[idx]) btns[idx].classList.add('playing');

      const output = document.getElementById('voice-demo-output');
      output.textContent = '';
      output.classList.add('active');

      (function demoTypewrite() {
        let i = 0;
        function tick() {
          if (demoTypewriterAbort) return;
          if (i < v.text.length) {
            output.textContent += v.text[i];
            i++;
            setTimeout(tick, 25);
          } else {
            if (!demoAudio || demoAudio.paused || demoAudio.ended) {
              demoPlayingIdx = -1;
              if (btns[idx]) btns[idx].classList.remove('playing');
            }
          }
        }
        tick();
      })();

      try {
        const headers = { 'Content-Type': 'application/json', 'x-session-id': typeof webSessionId !== 'undefined' ? webSessionId : '' };
        if (typeof authToken !== 'undefined' && authToken) headers['Authorization'] = 'Bearer ' + authToken;

        const r = await fetch(API + '/api/v1/speech/synthesize', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({ text: v.text, session_id: typeof webSessionId !== 'undefined' ? webSessionId : 'demo' }),
        });

        if (!r.ok) throw new Error('TTS failed');
        if (demoPlayingIdx !== idx) return; // User cancelled during fetch

        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        demoAudio = new Audio(url);

        demoAudio.onended = function() {
          if (demoPlayingIdx === idx) {
            demoPlayingIdx = -1;
            if (btns[idx]) btns[idx].classList.remove('playing');
          }
          URL.revokeObjectURL(url);
        };

        demoAudio.play().catch(function(e) {
          console.warn('Demo TTS autoplay blocked:', e.message);
          if (demoPlayingIdx === idx) {
            demoPlayingIdx = -1;
            if (btns[idx]) btns[idx].classList.remove('playing');
          }
        });
      } catch(e) {
        console.warn('Demo TTS fetch failed:', e.message);
      }
    }

    function renderRecipes(l) {
      const section = document.getElementById('recipe-section');
      section.innerHTML = '';
      R[l].categories.forEach(cat => {
        const h = document.createElement('div');
        h.className = 'recipes';
        h.innerHTML = '<h2>' + cat.icon + ' ' + cat.title + '</h2>';
        const grid = document.createElement('div');
        grid.className = 'recipe-grid';
        cat.items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'recipe-card';
          card.innerHTML = '<h4>' + item.name + '</h4><p>' + item.desc + '</p>';
          card.onclick = () => sendRecipe(item.prompt);
          grid.appendChild(card);
        });
        h.appendChild(grid);
        section.appendChild(h);
      });
    }

    function setLang(l) {
      document.documentElement.lang = l;
      localStorage.setItem('nl', l);
      document.getElementById('l-ja').className = l === 'ja' ? 'on' : '';
      document.getElementById('l-en').className = l === 'en' ? 'on' : '';
      const t = T[l];
      document.getElementById('t-title').textContent = t.title;
      document.getElementById('t-subtitle').textContent = t.sub;
      const welcomeEl = document.getElementById('t-welcome');
      if (!welcomeEl.dataset.typed) {
        welcomeEl.dataset.typed = '1';
        typewriter(welcomeEl, t.welcome, 25);
      } else {
        welcomeEl.textContent = t.welcome;
      }
      document.getElementById('t-line').textContent = t.line;
      document.getElementById('t-tg').textContent = t.tg;
      document.getElementById('t-line-desc').textContent = t.lineDesc;
      document.getElementById('t-tg-desc').textContent = t.tgDesc;
      document.getElementById('t-line-connected').innerHTML = t.lineConnected;
      document.getElementById('t-tg-connected').innerHTML = t.tgConnected;
      ['whatsapp', 'discord', 'slack', 'teams'].forEach(ch => {
        const el = document.getElementById('t-' + ch + '-connected');
        if (el) el.innerHTML = t.chConnected;
      });
      input.placeholder = t.ph;
      document.getElementById('send-btn').textContent = t.send;
      document.getElementById('t-hero-try').textContent = t.heroTry;
      document.getElementById('nav-pricing').textContent = t.pricing;
      document.getElementById('nav-settings').textContent = t.settings;
      document.getElementById('nav-status').textContent = t.status;
      document.getElementById('footer-pricing').textContent = t.pricing;
      var fs = document.getElementById('footer-settings'); if (fs) fs.textContent = t.settings;
      var fc = document.getElementById('footer-comparison'); if (fc) fc.textContent = t.comparison;
      var ms = document.getElementById('mob-settings'); if (ms) ms.textContent = t.settings;
      var mp = document.getElementById('mob-pricing'); if (mp) mp.textContent = t.pricing;
      var mst = document.getElementById('mob-status'); if (mst) mst.textContent = t.status;
      document.getElementById('t-chat-status').textContent = t.chatStatus;
      document.getElementById('stat-uptime-label').textContent = t.statsUptime;
      document.getElementById('stat-speed-label').textContent = t.statsSpeed;
      document.getElementById('stat-models-label').textContent = t.statsModels;
      document.getElementById('stat-channels-label').textContent = t.statsChannels;
      document.getElementById('stat-tools-label').textContent = t.statsTools;
      document.getElementById('trust-ssl').textContent = t.trustSsl;
      document.getElementById('trust-stripe').textContent = t.trustStripe;
      document.getElementById('trust-nocard').textContent = t.trustNocard;
      var sp = document.getElementById('social-proof-text'); if (sp) sp.textContent = t.socialProof;
      document.getElementById('t-sync-title').textContent = t.syncTitle;
      document.getElementById('t-sync-desc').textContent = t.syncDesc;
      document.getElementById('t-step1-title').textContent = t.step1Title;
      document.getElementById('t-step1-desc').innerHTML = t.step1Desc;
      document.getElementById('t-step2-title').textContent = t.step2Title;
      document.getElementById('t-step2-desc').innerHTML = t.step2Desc;
      document.getElementById('t-step3-title').textContent = t.step3Title;
      document.getElementById('t-step3-desc').textContent = t.step3Desc;
      document.getElementById('t-session-label').textContent = t.sessionLabel;
      document.getElementById('t-session-hint').textContent = t.sessionHint;
      document.getElementById('t-cli-title').textContent = t.cliTitle;
      document.getElementById('t-cli-sub').innerHTML = t.cliSub;
      document.getElementById('cli-sync-text').textContent = 'chatweb chat --sync ' + webSessionId + ' "Hello"';
      document.getElementById('t-cli-sync-hint').textContent = t.cliSyncHint;
      document.getElementById('t-bottom-title').textContent = t.bottomTitle;
      document.getElementById('t-bottom-sub').textContent = t.bottomSub;
      document.getElementById('t-bottom-cta').textContent = t.bottomCta;
      document.getElementById('t-bottom-hint').innerHTML = t.bottomHint;
      document.getElementById('opt-auto').textContent = t.agentAuto;
      document.getElementById('t-device-title').textContent = t.deviceTitle;
      document.getElementById('t-device-desc').textContent = t.deviceDesc;
      document.getElementById('t-device-hint').innerHTML = t.deviceHint;
      document.getElementById('t-cap-title').textContent = t.capTitle;
      document.getElementById('t-cap-sub').textContent = t.capSub;
      document.getElementById('cap-search').textContent = t.capSearch;
      document.getElementById('cap-search-d').textContent = t.capSearchD;
      document.getElementById('cap-fetch').textContent = t.capFetch;
      document.getElementById('cap-fetch-d').textContent = t.capFetchD;
      document.getElementById('cap-calc').textContent = t.capCalc;
      document.getElementById('cap-calc-d').textContent = t.capCalcD;
      document.getElementById('cap-weather').textContent = t.capWeather;
      document.getElementById('cap-weather-d').textContent = t.capWeatherD;
      document.getElementById('cap-file').textContent = t.capFile;
      document.getElementById('cap-file-d').textContent = t.capFileD;
      document.getElementById('cap-shell').textContent = t.capShell;
      document.getElementById('cap-shell-d').textContent = t.capShellD;
      document.getElementById('cap-browser').textContent = t.capBrowser;
      document.getElementById('cap-browser-d').textContent = t.capBrowserD;
      document.getElementById('cap-image').textContent = t.capImage;
      document.getElementById('cap-image-d').textContent = t.capImageD;
      document.getElementById('cap-memory').textContent = t.capMemory;
      document.getElementById('cap-memory-d').textContent = t.capMemoryD;
      document.getElementById('cap-note-text').textContent = t.capNote;
      document.getElementById('cap-note-link').textContent = t.capNoteLink;
      var uc1t = document.getElementById('uc-1-title'); if (uc1t) uc1t.textContent = t.uc1Title;
      var uc1d = document.getElementById('uc-1-desc'); if (uc1d) uc1d.textContent = t.uc1Desc;
      var uc2t = document.getElementById('uc-2-title'); if (uc2t) uc2t.textContent = t.uc2Title;
      var uc2d = document.getElementById('uc-2-desc'); if (uc2d) uc2d.textContent = t.uc2Desc;
      var uc3t = document.getElementById('uc-3-title'); if (uc3t) uc3t.textContent = t.uc3Title;
      var uc3d = document.getElementById('uc-3-desc'); if (uc3d) uc3d.textContent = t.uc3Desc;
      var uc4t = document.getElementById('uc-4-title'); if (uc4t) uc4t.textContent = t.uc4Title;
      var uc4d = document.getElementById('uc-4-desc'); if (uc4d) uc4d.textContent = t.uc4Desc;
      var uc5t = document.getElementById('uc-5-title'); if (uc5t) uc5t.textContent = t.uc5Title;
      var uc5d = document.getElementById('uc-5-desc'); if (uc5d) uc5d.textContent = t.uc5Desc;
      var uc6t = document.getElementById('uc-6-title'); if (uc6t) uc6t.textContent = t.uc6Title;
      var uc6d = document.getElementById('uc-6-desc'); if (uc6d) uc6d.textContent = t.uc6Desc;
      var dq1 = document.getElementById('demo-q1'); if (dq1) dq1.textContent = t.demoQ1;
      var da1 = document.getElementById('demo-a1'); if (da1) da1.innerHTML = t.demoA1.replace(/\n/g, '<br>');
      if (!currentUser) document.getElementById('login-btn').textContent = t.loginBtn;
      document.getElementById('chat-login-text').textContent = t.chatLoginPrompt;
      const lang2 = document.documentElement.lang || 'ja';
      document.getElementById('auth-modal-title').textContent = lang2 === 'ja' ? 'ログイン' : 'Login';
      document.getElementById('email-auth-btn').textContent = lang2 === 'ja' ? 'メールでログイン' : 'Login with Email';
      const bonusEl = document.getElementById('auth-bonus-text');
      if (bonusEl) bonusEl.textContent = lang2 === 'ja' ? '登録で100クレジット無料!' : '100 credits free on signup!';
      document.getElementById('sidebar-title').textContent = t.sidebarTitle;
      document.getElementById('new-conv-btn').textContent = t.newConv;
      const appNewConvText = document.getElementById('app-new-conv-text');
      if (appNewConvText) appNewConvText.textContent = t.appNewChat;
      const appEmptyText = document.querySelector('.app-chat-empty-text');
      if (appEmptyText) appEmptyText.textContent = t.appEmptyText;
      const appInput = document.getElementById('app-input');
      if (appInput) appInput.placeholder = t.appPlaceholder;
      const appChLabel = document.getElementById('app-channels-label');
      if (appChLabel) appChLabel.textContent = l === 'ja' ? 'チャネル連携' : 'Channels';
      const linkCmdTitle = document.getElementById('t-link-cmd-title');
      if (linkCmdTitle) linkCmdTitle.textContent = l === 'ja' ? 'コマンドで連携' : 'Link via Command';
      const linkCmdDesc = document.getElementById('t-link-cmd-desc');
      if (linkCmdDesc) linkCmdDesc.innerHTML = l === 'ja'
        ? 'チャットで <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;">/link</code> と入力するとリンクコードが生成されます。別のチャネル（LINE・Telegram等）で <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;">/link CODE</code> と送信すると連携完了。'
        : 'Type <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;">/link</code> in chat to generate a link code. Send <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:12px;">/link CODE</code> from another channel (LINE, Telegram, etc.) to connect.';
      const linkCmdBtn = document.getElementById('t-link-cmd-btn');
      if (linkCmdBtn) linkCmdBtn.textContent = l === 'ja' ? '/link コードを生成' : '/link Generate Code';
      const ttsStopFloat = document.getElementById('tts-stop-float');
      if (ttsStopFloat) ttsStopFloat.innerHTML = '<span class="tts-pulse-dot"></span> ' + (l === 'ja' ? '読み上げ停止' : 'Stop Speaking');
      if (document.body.classList.contains('app-mode')) appRenderSuggestions();
      renderRecipes(l);
      document.getElementById('t-voice-label').textContent = t.voiceLabel;
      renderVoiceDemo(l);
      // Update voice character display names for current language
      if (typeof updateVoiceDisplayNames === 'function') updateVoiceDisplayNames();
    }

    function copyCliSync(el) {
      const cmd = 'chatweb chat --sync ' + webSessionId + ' "Hello"';
      navigator.clipboard.writeText(cmd);
      const cp = el.querySelector('.cp2');
      if (cp) { cp.textContent = 'Copied!'; setTimeout(() => cp.textContent = 'Copy', 1500); }
    }

    function toggleCliSection() {
      const detail = document.getElementById('cli-detail');
      const arrow = document.getElementById('cli-toggle-arrow');
      if (detail.style.display === 'none') {
        detail.style.display = '';
        arrow.style.transform = 'rotate(90deg)';
      } else {
        detail.style.display = 'none';
        arrow.style.transform = '';
      }
    }

    function copyCli(el, cmd) {
      if (!cmd) {
        cmd = 'chatweb chat --sync ' + webSessionId + ' "Hello"';
      }
      navigator.clipboard.writeText(cmd);
      const cp = el.querySelector('.cli-copy');
      if (cp) { cp.textContent = 'Copied!'; setTimeout(() => cp.textContent = 'Copy', 1500); }
    }

    async function loadWorkerStatus() {
      try {
        const hdrs = {};
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;
        const r = await fetch(API + '/api/v1/workers/status', { headers: hdrs });
        const d = await r.json();
        const bar = document.getElementById('worker-status-bar');
        const txt = document.getElementById('worker-status-text');
        if (bar && d.workers && d.workers.length > 0) {
          const active = d.workers.filter(function(w) { return w.status === 'active'; });
          if (active.length > 0) {
            const w = active[0];
            txt.textContent = '🟢 Worker: ' + (w.model || 'unknown') + ' (' + w.hostname + ')';
            bar.style.display = 'block';
          }
        }
      } catch(e) { /* ignore */ }
    }

    function maskSessionId(id) {
      const parts = id.split(':');
      if (parts.length === 2) {
        const uuid = parts[1];
        return parts[0] + ':' + uuid.substring(0, 8) + '********';
      }
      return id;
    }
    const sessionDisplay = document.getElementById('session-id-display');
    sessionDisplay.textContent = maskSessionId(webSessionId);
    sessionDisplay.title = webSessionId;
    sessionDisplay.onclick = function() {
      navigator.clipboard.writeText(webSessionId);
      this.style.opacity = 0.5;
      setTimeout(() => this.style.opacity = 1, 300);
    };

    function getLineDeepLink() {
      return 'https://line.me/R/oaMessage/@619jcqqh/?%2Flink%20' + encodeURIComponent(webSessionId);
    }
    function getTgDeepLink() {
      const payload = webSessionId.replace(':', '_');
      return 'https://t.me/chatweb_ai_bot?start=' + payload;
    }

    function getWhatsAppDeepLink() {
      return 'https://wa.me/message/chatweb_ai';
    }
    function getDiscordDeepLink() {
      return 'https://discord.com/invite/chatweb';
    }
    function getSlackDeepLink() {
      return 'https://slack.com/oauth/v2/authorize?client_id=chatweb&scope=chat:write,commands';
    }
    function getTeamsDeepLink() {
      return 'https://teams.microsoft.com/l/app/chatweb-ai';
    }
    // Track channels that have already been notified (persisted across page loads)
    const notifiedChannels = new Set(JSON.parse(localStorage.getItem('notifiedChannels') || '[]'));
    function markChannelNotified(ch) {
      notifiedChannels.add(ch);
      localStorage.setItem('notifiedChannels', JSON.stringify([...notifiedChannels]));
    }

    function openChannelLink(ch) {
      const c = CHANNELS[ch];
      if (!c) return;
      // If already connected, just show a toast instead of re-opening the modal
      const el = document.getElementById('app-ch-' + ch);
      if (el && el.classList.contains('connected')) {
        const l = document.documentElement.lang || 'ja';
        const chName = CH_NAMES[ch] || ch;
        showToast(l === 'ja' ? chName + ' は連携済みです' : chName + ' is already linked');
        return;
      }
      showModal(ch);
    }

    let selectedAgent = 'auto';
    function selectAgent(val) { selectedAgent = val; }

    async function pollDevices() {
      try {
        const r = await fetch(API + '/api/v1/devices', {
          headers: { 'x-session-id': webSessionId }
        });
        const d = await r.json();
        const section = document.getElementById('device-section');
        const list = document.getElementById('device-list');
        if (d.devices && d.devices.length > 0) {
          section.style.display = '';
          list.innerHTML = d.devices.map(dev => {
            const memPct = (dev.memory_total && dev.memory_used) ? Math.round(dev.memory_used / dev.memory_total * 100) : null;
            const meta = [dev.os + '/' + dev.arch, memPct !== null ? ('RAM ' + memPct + '%') : '', dev.uptime_secs ? ('up ' + formatUptime(dev.uptime_secs)) : ''].filter(Boolean).join(' · ');
            return '<div class="device-card"><div class="device-status"></div><div class="device-info"><div class="device-name">' + dev.hostname + '</div><div class="device-meta">' + meta + '</div></div></div>';
          }).join('');
        }
      } catch(e) { /* ignore */ }
    }
    function formatUptime(secs) {
      if (secs < 3600) return Math.floor(secs/60) + 'm';
      if (secs < 86400) return Math.floor(secs/3600) + 'h';
      return Math.floor(secs/86400) + 'd';
    }
    var devicePollInterval = null;
    function startDevicePolling() {
      if (devicePollInterval) return;
      setTimeout(pollDevices, 2000);
      devicePollInterval = setInterval(pollDevices, 30000);
    }
    function stopDevicePolling() {
      if (devicePollInterval) { clearInterval(devicePollInterval); devicePollInterval = null; }
    }

    (function populateSidebarChannels() {
      const grid = document.getElementById('app-channels-grid');
      if (!grid) return;
      const l = document.documentElement.lang || (navigator.language || 'ja').substring(0, 2);

      const allChannels = [
        { id: 'line', name: 'LINE', color: '#06C755', path: 'M12 2C6.48 2 2 5.81 2 10.5c0 4.01 3.44 7.37 8.09 8.25.31.07.74.21.85.48.1.25.06.63.03.88l-.14.82c-.04.25-.2.96.84.52s5.58-3.29 7.61-5.63C21.31 13.51 22 12.07 22 10.5 22 5.81 17.52 2 12 2z', primary: true },
        { id: 'tg', name: 'Telegram', color: '#2AABEE', path: 'M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.88 8.85c-.14.63-.51.78-.84.49l-2.31-1.7-1.79 1.72c-.2.2-.36.36-.74.36l.27-3.78 6.88-6.22c.3-.27-.07-.42-.47-.16L8.09 13.29l-2.61-.82c-.57-.18-.58-.57.12-.84l11.03-4.27c.47-.17.88.11.73.79h.17z', primary: true },
        { id: 'whatsapp', name: 'WhatsApp', color: '#25D366', path: 'M12 0C5.37 0 0 5.37 0 12c0 2.12.55 4.13 1.6 5.93L0 24l6.26-1.64C8.01 23.44 9.97 24 12 24c6.63 0 12-5.37 12-12S18.63 0 12 0z' },
        { id: 'discord', name: 'Discord', color: '#5865F2', path: 'M20.32 4.37a19.8 19.8 0 0 0-4.89-1.52c-.21.38-.45.87-.61 1.26a18.27 18.27 0 0 0-5.49 0c-.17-.39-.41-.88-.62-1.26a19.74 19.74 0 0 0-4.89 1.52C1.11 8.39.33 12.27.74 16.1a19.9 19.9 0 0 0 5.99 3.03c.46-.63.87-1.3 1.22-2a13.1 13.1 0 0 1-1.87-.9c.13-.09.25-.19.37-.29 3.93 1.8 8.18 1.8 12.07 0c.12.1.25.2.37.29c-.6.35-1.22.65-1.88.9c.36.7.77 1.37 1.22 2a19.83 19.83 0 0 0 6-3.03c.5-5.18-.84-9.68-3.55-13.67z' },
        { id: 'slack', name: 'Slack', color: '#E01E5A', path: 'M5.04 15.24a2.52 2.52 0 1 1-2.52-2.52h2.52v2.52zm1.27 0a2.52 2.52 0 1 1 5.04 0v6.3a2.52 2.52 0 1 1-5.04 0v-6.3z' },
        { id: 'teams', name: 'Teams', color: '#6264A7', path: 'M20.5 7h-3V5.5a2.5 2.5 0 0 0-5 0V7h-1a1.5 1.5 0 0 0-1.5 1.5v8a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 20.5 7z' },
      ];

      const statusLabel = (id) => {
        const connected = notifiedChannels.has(id);
        if (connected) return l === 'ja' ? '連携中' : 'Linked';
        return l === 'ja' ? '連携する' : 'Connect';
      };

      // Primary channels: LINE & Telegram — full-width row buttons
      allChannels.filter(c => c.primary).forEach(ch => {
        const btn = document.createElement('button');
        btn.className = 'app-ch-btn';
        btn.id = 'app-ch-' + ch.id;
        btn.onclick = function() { openChannelLink(ch.id); };
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><path d="' + ch.path + '" fill="' + ch.color + '"/></svg>'
          + '<span class="app-ch-name">' + ch.name + '</span>'
          + '<span class="app-ch-status">' + statusLabel(ch.id) + '</span>';
        grid.appendChild(btn);
      });

      // Secondary channels: small icon-only row
      const moreRow = document.createElement('div');
      moreRow.className = 'app-ch-more-row';
      allChannels.filter(c => !c.primary).forEach(ch => {
        const btn = document.createElement('button');
        btn.className = 'app-ch-more-btn';
        btn.id = 'app-ch-' + ch.id;
        btn.title = ch.name;
        btn.onclick = function() { openChannelLink(ch.id); };
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><path d="' + ch.path + '" fill="' + ch.color + '"/></svg>';
        moreRow.appendChild(btn);
      });
      grid.appendChild(moreRow);
      // Hide channels section if any channel is already linked
      if (notifiedChannels.size > 0) {
        const chSection = grid.closest('.app-sidebar-channels');
        if (chSection) chSection.style.display = 'none';
      }
    })();

    const CHANNELS = {
      line: {
        ja: { title: 'LINEで友だち追加', desc: 'QRコードをスマホで読み取り、表示されるメッセージをそのまま送信してください。自動でWebの会話と連携されます。', descMobile: 'ボタンを押すとLINEが開きます。表示されるメッセージを送信で連携完了。', link: 'LINEで開く' },
        en: { title: 'Add on LINE', desc: 'Scan QR with your phone, then send the pre-filled message. Your Web conversation will be auto-linked.', descMobile: 'Tap the button to open LINE. Send the pre-filled message to link.', link: 'Open in LINE' },
        bg: 'line-bg',
      },
      tg: {
        ja: { title: 'Telegramで開始', desc: 'QRコードをスマホで読み取るか、ボタンを押してTelegramを開いてください。自動でWebの会話と連携されます。', descMobile: 'ボタンを押すとTelegramが開きます。送信で連携完了。QRコードで別端末からも連携できます。', link: 'Telegramで開く' },
        en: { title: 'Start on Telegram', desc: 'Scan the QR code with your phone, or tap the button to open Telegram. Your Web conversation will be auto-linked.', descMobile: 'Tap the button to open Telegram. You can also scan the QR from another device.', link: 'Open in Telegram' },
        bg: 'tg-bg',
      },
      whatsapp: {
        ja: { title: 'WhatsAppで開始', desc: 'WhatsAppでchatweb.aiにメッセージを送ると、このWebの会話と連携されます。', link: 'WhatsAppで開く' },
        en: { title: 'Start on WhatsApp', desc: 'Send a message to chatweb.ai on WhatsApp. Your Web conversation will be auto-linked.', link: 'Open in WhatsApp' },
        bg: 'whatsapp-bg',
      },
      discord: {
        ja: { title: 'Discordに追加', desc: 'Botをサーバーに招待して、Discordから直接AIを使えます。', link: 'Discordで開く' },
        en: { title: 'Add to Discord', desc: 'Invite the bot to your server and use AI directly from Discord.', link: 'Open in Discord' },
        bg: 'discord-bg',
      },
      slack: {
        ja: { title: 'Slackに追加', desc: 'ワークスペースにアプリをインストールして、Slackから直接AIを使えます。', link: 'Slackで開く' },
        en: { title: 'Add to Slack', desc: 'Install the app to your workspace and use AI directly from Slack.', link: 'Open in Slack' },
        bg: 'slack-bg',
      },
      teams: {
        ja: { title: 'Teamsに追加', desc: 'Microsoft TeamsにBotを追加して、Teams内でAIを使えます。', link: 'Teamsで開く' },
        en: { title: 'Add to Teams', desc: 'Add the bot to Microsoft Teams and use AI directly from Teams.', link: 'Open in Teams' },
        bg: 'teams-bg',
      },
    };
    function getDeepLink(ch) {
      switch(ch) {
        case 'line': return getLineDeepLink();
        case 'tg': return getTgDeepLink();
        case 'whatsapp': return getWhatsAppDeepLink();
        case 'discord': return getDiscordDeepLink();
        case 'slack': return getSlackDeepLink();
        case 'teams': return getTeamsDeepLink();
        default: return '#';
      }
    }
    function isMobileDevice() {
      return /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
        || (navigator.maxTouchPoints > 0 && window.innerWidth < 768);
    }
    async function generateLinkCode() {
      try {
        const resp = await fetch(API + '/api/v1/link/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-session-id': webSessionId }
        });
        const data = await resp.json();
        return data.code || null;
      } catch (e) { return null; }
    }
    function buildDeepLinkWithCode(ch, code) {
      switch (ch) {
        case 'line': return 'https://line.me/R/oaMessage/@619jcqqh/?%2Flink%20' + code;
        case 'tg': return 'https://t.me/chatweb_ai_bot?start=link_' + code;
        default: return getDeepLink(ch);
      }
    }
    let linkPollTimer = null;
    function stopLinkPoll() { if (linkPollTimer) { clearInterval(linkPollTimer); linkPollTimer = null; } }

    function setModalStep(n) {
      const spans = document.querySelectorAll('#modal-steps span');
      spans.forEach((s, i) => {
        if (i < n) { s.style.background = 'var(--green)'; s.style.color = '#fff'; s.style.opacity = '1'; s.style.border = 'none'; }
        else if (i === n) { s.style.background = 'var(--accent)'; s.style.color = '#fff'; s.style.opacity = '1'; s.style.border = 'none'; }
        else { s.style.background = 'transparent'; s.style.color = ''; s.style.opacity = '.5'; s.style.border = '1px solid var(--border)'; }
      });
    }

    const CH_NAMES = { line: 'LINE', tg: 'Telegram', whatsapp: 'WhatsApp', discord: 'Discord', slack: 'Slack', teams: 'Teams' };
    function showLinkSuccess(ch) {
      if (notifiedChannels.has(ch)) { stopLinkPoll(); return; }
      markChannelNotified(ch);
      stopLinkPoll();
      setModalStep(2);
      const l = document.documentElement.lang || 'ja';
      document.getElementById('modal-qr-wrap').style.display = 'none';
      document.getElementById('modal-cta').style.display = 'none';
      document.getElementById('modal-link').style.display = 'none';
      document.getElementById('modal-code-row').style.display = 'none';
      document.getElementById('modal-desc').style.display = 'none';
      const succ = document.getElementById('modal-success');
      succ.style.display = '';
      const chName = CH_NAMES[ch] || ch;
      document.getElementById('modal-success-text').textContent = l === 'ja'
        ? chName + ' 連携完了！' : chName + ' linked!';
      document.getElementById('modal-close-btn').textContent = l === 'ja' ? '閉じる' : 'Close';
      const barId = 'ch-bar-' + ch;
      const cardId = ch + '-card';
      const appId = 'app-ch-' + ch;
      document.getElementById(barId)?.classList.add('connected');
      document.getElementById(cardId)?.classList.add('connected');
      document.getElementById(appId)?.classList.add('connected');
      document.querySelectorAll('.channel-cards').forEach(g => g.classList.add('has-linked'));
      setTimeout(() => {
        document.getElementById('modal').classList.remove('show');
        showLinkOverlay(ch);
      }, 1500);
    }

    function startLinkPoll(ch, code) {
      stopLinkPoll();
      if (!code) return;
      linkPollTimer = setInterval(async () => {
        try {
          const r = await fetch(API + '/api/v1/link/status/' + encodeURIComponent(code));
          const data = await r.json();
          if (data.status === 'linked') {
            showLinkSuccess(ch);
          }
        } catch(e) {}
      }, 2000);
    }

    const CH_COLORS = { line: '#06c755', tg: '#24a1de', whatsapp: '#25D366', discord: '#5865F2', slack: '#E01E5A', teams: '#6264A7' };
    const CH_SVG = {
      line: 'M12 2C6.48 2 2 5.81 2 10.4c0 4.16 3.69 7.65 8.67 8.3.34.07.8.22.91.5.1.26.07.66.03.92l-.15.87c-.04.25-.2.97.85.53s6.82-4.01 9.31-6.87C23.42 12.68 22 10.4 22 10.4 22 5.81 17.52 2 12 2z',
      tg: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z',
      whatsapp: 'M12 0C5.37 0 0 5.37 0 12c0 2.12.55 4.13 1.6 5.93L0 24l6.26-1.64C8.01 23.44 9.97 24 12 24c6.63 0 12-5.37 12-12S18.63 0 12 0z',
      discord: 'M20.32 4.37a19.8 19.8 0 0 0-4.89-1.52c-.21.38-.45.87-.61 1.26a18.27 18.27 0 0 0-5.49 0c-.17-.39-.41-.88-.62-1.26a19.74 19.74 0 0 0-4.89 1.52C1.11 8.39.33 12.27.74 16.1a19.9 19.9 0 0 0 5.99 3.03c.46-.63.87-1.3 1.22-2a13.1 13.1 0 0 1-1.87-.9c.13-.09.25-.19.37-.29 3.93 1.8 8.18 1.8 12.07 0 .12.1.25.2.37.29c-.6.35-1.22.65-1.88.9c.36.7.77 1.37 1.22 2a19.83 19.83 0 0 0 6-3.03c.5-5.18-.84-9.68-3.55-13.67z',
      slack: 'M5.04 15.24a2.52 2.52 0 1 1-2.52-2.52h2.52v2.52zm1.27 0a2.52 2.52 0 1 1 5.04 0v6.3a2.52 2.52 0 1 1-5.04 0v-6.3z',
      teams: 'M20.5 7h-3V5.5a2.5 2.5 0 0 0-5 0V7h-1a1.5 1.5 0 0 0-1.5 1.5v8a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 20.5 7z',
    };
    function showLinkOverlay(ch) {
      if (notifiedChannels.has(ch)) return;
      markChannelNotified(ch);
      const l = document.documentElement.lang || 'ja';
      const chName = CH_NAMES[ch] || ch;
      const color = CH_COLORS[ch] || '#24a1de';
      const svgPath = CH_SVG[ch] || CH_SVG.tg;
      const icon = document.getElementById('lso-icon');
      icon.style.background = color;
      icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><path d="' + svgPath + '" fill="#fff"/></svg>'
        + '<div class="lso-check"><svg viewBox="0 0 16 16" fill="none"><path d="M3 8.5l3.5 3.5 6.5-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
      document.getElementById('lso-text').textContent = l === 'ja'
        ? chName + ' 連携完了！' : chName + ' linked!';
      const overlay = document.getElementById('link-success-overlay');
      overlay.classList.add('show');
      setTimeout(() => {
        overlay.classList.remove('show');
        showToast(l === 'ja' ? chName + ' 連携完了' : chName + ' linked');
      }, 1800);
    }

    function updateSidebarChannelBadges(channels, details) {
      const container = document.getElementById('sidebar-channel-badges');
      if (!container) return;
      container.innerHTML = '';
      const lineSvg = '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 5.81 2 10.4c0 4.16 3.69 7.65 8.67 8.3.34.07.8.22.91.5.1.26.07.66.03.92l-.15.87c-.04.25-.2.97.85.53s6.82-4.01 9.31-6.87C23.42 12.68 22 10.4 22 10.4 22 5.81 17.52 2 12 2z" fill="currentColor"/></svg>';
      const tgSvg = '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z" fill="currentColor"/></svg>';
      const l = document.documentElement.lang || 'ja';
      if (channels.includes('line')) {
        const badge = document.createElement('span');
        badge.className = 'sidebar-ch-badge line-badge';
        badge.innerHTML = lineSvg + (l === 'ja' ? 'LINE' : 'LINE');
        container.appendChild(badge);
      }
      if (channels.includes('telegram')) {
        const badge = document.createElement('span');
        badge.className = 'sidebar-ch-badge tg-badge';
        badge.innerHTML = tgSvg + (l === 'ja' ? 'TG' : 'TG');
        container.appendChild(badge);
      }
    }

    async function showModal(ch) {
      const c = CHANNELS[ch];
      if (!c) return;
      const l = document.documentElement.lang || 'ja';
      const t = c[l] || c.ja;
      const mobile = isMobileDevice();

      document.getElementById('modal-success').style.display = 'none';
      document.getElementById('modal-desc').style.display = '';
      document.getElementById('modal-qr-wrap').style.display = '';
      document.getElementById('modal-cta').style.display = 'none';
      document.getElementById('modal-code-row').style.display = 'none';
      document.getElementById('modal-title').textContent = t.title;

      const steps = document.getElementById('modal-steps');
      const stepLabels = mobile
        ? (l === 'ja' ? ['1. タップ', '2. 送信', '3. 完了'] : ['1. Tap', '2. Send', '3. Done'])
        : (l === 'ja' ? ['1. QR読取', '2. 送信', '3. 完了'] : ['1. Scan', '2. Send', '3. Done']);
      steps.innerHTML = stepLabels.map((s,i) =>
        '<span style="border-radius:12px;padding:2px 10px;' + (i===0 ? 'background:var(--accent);color:#fff;' : 'opacity:.5;border:1px solid var(--border);') + '">' + s + '</span>'
      ).join('');

      document.getElementById('modal-desc').textContent = (mobile && t.descMobile) ? t.descMobile : t.desc;

      const qrImg = document.getElementById('modal-qr');
      const qrSpinner = document.getElementById('qr-spinner');
      qrImg.classList.remove('loaded');
      qrSpinner.classList.remove('hidden');
      qrImg.src = '';

      const cta = document.getElementById('modal-cta');
      const link = document.getElementById('modal-link');
      link.className = 'modal-link ' + (c.bg || 'tg-bg');
      cta.className = 'modal-link ' + (c.bg || 'tg-bg');
      document.getElementById('modal').classList.add('show');

      let deepLink;
      let code = await generateLinkCode();
      if (code && (ch === 'line' || ch === 'tg')) {
        deepLink = buildDeepLinkWithCode(ch, code);
      } else {
        deepLink = getDeepLink(ch);
      }

      qrImg.onload = function() { qrSpinner.classList.add('hidden'); qrImg.classList.add('loaded'); };
      setQRCodeSrc(qrImg, deepLink, 200);

      if (mobile) {
        cta.style.display = '';
        cta.href = deepLink;
        cta.textContent = t.link || (l === 'ja' ? 'アプリで開く' : 'Open app');
        if (ch === 'line' || ch === 'tg') {
          document.getElementById('modal-qr-wrap').style.display = '';
          document.getElementById('modal-qr-wrap').style.marginTop = '12px';
          document.getElementById('modal-qr-wrap').style.opacity = '0.85';
          document.getElementById('modal-qr-wrap').style.transform = 'scale(0.8)';
        } else {
          document.getElementById('modal-qr-wrap').style.display = 'none';
        }
        link.style.display = 'none';
      } else {
        cta.style.display = 'none';
        document.getElementById('modal-qr-wrap').style.marginTop = '';
        document.getElementById('modal-qr-wrap').style.opacity = '';
        document.getElementById('modal-qr-wrap').style.transform = '';
        link.href = deepLink;
        link.textContent = t.link;
        link.style.display = '';
      }

      if (code) {
        const codeRow = document.getElementById('modal-code-row');
        codeRow.style.display = '';
        document.getElementById('modal-code-label').textContent = l === 'ja' ? '手動入力: /link ' : 'Manual: /link ';
        document.getElementById('modal-code-val').textContent = code;
      }

      if (code) {
        startLinkPoll(ch, code);
      }

      document.getElementById('modal-close-btn').textContent = l === 'ja' ? '閉じる' : 'Close';
    }

    function closeModal(e) {
      if (e.target === document.getElementById('modal')) {
        document.getElementById('modal').classList.remove('show');
        stopLinkPoll();
      }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;

    function openAuthModal() {
      document.getElementById('auth-modal').classList.add('show');
      document.getElementById('auth-error').style.display = 'none';
    }
    function closeAuthModal(e) {
      if (!e || e.target === document.getElementById('auth-modal')) {
        document.getElementById('auth-modal').classList.remove('show');
      }
    }
    function showAuthError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg;
      el.style.display = '';
    }
    async function redeemCouponFromAuth() {
      const code = document.getElementById('auth-coupon-input').value.trim();
      const resultEl = document.getElementById('auth-coupon-result');
      if (!code) return;
      resultEl.style.display = '';
      resultEl.style.color = 'var(--muted)';
      resultEl.textContent = 'Validating...';
      try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
          resultEl.style.color = '#ef4444';
          resultEl.textContent = document.documentElement.lang === 'ja' ? 'まずログインしてください' : 'Please login first';
          return;
        }
        const r = await fetch(API + '/api/v1/coupon/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ code: code, session_id: webSessionId }),
        });
        const d = await r.json();
        if (d.success) {
          resultEl.style.color = '#22c55e';
          resultEl.textContent = (document.documentElement.lang === 'ja' ? '+' + d.credits_granted + ' クレジット獲得!' : '+' + d.credits_granted + ' credits granted!');
          if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
        } else {
          resultEl.style.color = '#ef4444';
          resultEl.textContent = d.error || 'Invalid coupon';
        }
      } catch {
        resultEl.style.color = '#ef4444';
        resultEl.textContent = 'Error';
      }
    }

    let pendingVerifyEmail = '';

    async function emailAuth() {
      const email = document.getElementById('login-email').value.trim();
      if (!email) return showAuthError('メールアドレスを入力してください');
      const name = (document.getElementById('login-name').value || '').trim() || undefined;
      try {
        document.getElementById('email-auth-btn').disabled = true;
        document.getElementById('email-auth-btn').textContent = '送信中...';
        const r = await fetch(API + '/api/v1/auth/email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, session_id: webSessionId, name }),
        });
        const d = await r.json();
        if (d.ok && d.pending_verification) {
          pendingVerifyEmail = email;
          document.getElementById('auth-form-email').style.display = 'none';
          document.getElementById('auth-form-verify').style.display = '';
          document.getElementById('auth-error').style.display = 'none';
          document.getElementById('verify-code').focus();
        } else if (d.ok) {
          localStorage.setItem('authToken', d.token);
          authToken = d.token;
          closeAuthModal();
          await checkAuth();
        } else {
          showAuthError(d.error || 'Login failed');
        }
      } catch(e) { showAuthError('Network error'); }
      finally {
        document.getElementById('email-auth-btn').disabled = false;
        document.getElementById('email-auth-btn').textContent = 'メールでログイン';
      }
    }

    async function verifyCode() {
      const code = document.getElementById('verify-code').value.trim();
      if (!code || code.length !== 6) return showAuthError('6桁の認証コードを入力してください');
      try {
        const pendingRef = localStorage.getItem('pending_referral') || undefined;
        const r = await fetch(API + '/api/v1/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: pendingVerifyEmail, code, session_id: webSessionId, referral_code: pendingRef }),
        });
        const d = await r.json();
        if (d.ok) {
          localStorage.setItem('authToken', d.token);
          authToken = d.token;
          localStorage.removeItem('pending_referral');
          closeAuthModal();
          showEmailForm();
          if (d.referral_bonus > 0) {
            setTimeout(() => showToast('紹介ボーナス: +' + d.referral_bonus + ' クレジット獲得!', 5000), 500);
          }
          await checkAuth();
        } else {
          showAuthError(d.error || 'Verification failed');
        }
      } catch(e) { showAuthError('Network error'); }
    }

    function showEmailForm() {
      document.getElementById('auth-form-email').style.display = '';
      document.getElementById('auth-form-verify').style.display = 'none';
      document.getElementById('auth-form-forgot').style.display = 'none';
      document.getElementById('auth-form-reset').style.display = 'none';
      document.getElementById('verify-code').value = '';
      pendingVerifyEmail = '';
    }

    function showForgotPasswordForm() {
      document.getElementById('auth-form-email').style.display = 'none';
      document.getElementById('auth-form-verify').style.display = 'none';
      document.getElementById('auth-form-forgot').style.display = '';
      document.getElementById('auth-form-reset').style.display = 'none';
      document.getElementById('auth-error').style.display = 'none';
      const loginEmail = document.getElementById('login-email').value.trim();
      if (loginEmail) document.getElementById('forgot-email').value = loginEmail;
    }

    let pendingResetEmail = '';
    async function forgotPassword() {
      const email = document.getElementById('forgot-email').value.trim();
      if (!email) return showAuthError('メールアドレスを入力してください');
      const btn = document.getElementById('forgot-btn');
      btn.disabled = true; btn.textContent = '送信中...';
      try {
        const r = await fetch(API + '/api/v1/auth/forgot-password', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email })
        });
        const d = await r.json();
        if (d.ok) {
          pendingResetEmail = email;
          document.getElementById('auth-form-forgot').style.display = 'none';
          document.getElementById('auth-form-reset').style.display = '';
          showAuthError('');
          document.getElementById('auth-error').style.display = 'none';
        } else {
          showAuthError(d.error || 'Error');
        }
      } catch(e) { showAuthError('Network error'); }
      finally { btn.disabled = false; btn.textContent = 'リセットコードを送信'; }
    }

    async function resetPassword() {
      const code = document.getElementById('reset-code').value.trim();
      const pw = document.getElementById('reset-new-password').value;
      if (!code || code.length !== 6) return showAuthError('6桁のコードを入力してください');
      if (!pw || pw.length < 8) return showAuthError('パスワードは8文字以上');
      try {
        const r = await fetch(API + '/api/v1/auth/reset-password', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email: pendingResetEmail, code, new_password: pw })
        });
        const d = await r.json();
        if (d.ok) {
          showAuthError('');
          document.getElementById('auth-error').style.display = 'none';
          showEmailForm();
          showToast('パスワードがリセットされました。新しいパスワードでログインしてください。', 5000);
        } else {
          showAuthError(d.error || 'Error');
        }
      } catch(e) { showAuthError('Network error'); }
    }

    // --- Profile Edit ---
    async function saveProfile() {
      const name = document.getElementById('profile-display-name').value.trim();
      if (!name) return showToast('表示名を入力してください');
      const token = localStorage.getItem('authToken');
      if (!token) return showToast('ログインしてください');
      try {
        const r = await fetch(API + '/api/v1/account/profile', {
          method: 'PUT',
          headers: {'Content-Type':'application/json', 'Authorization': 'Bearer ' + token},
          body: JSON.stringify({ display_name: name })
        });
        const d = await r.json();
        if (d.ok) {
          showToast('プロフィールを更新しました');
          await checkAuth();
        } else {
          showToast(d.error || 'Error');
        }
      } catch(e) { showToast('Network error'); }
    }

    // --- Account Deletion ---
    async function deleteAccount() {
      const confirmed = prompt('アカウントを完全に削除します。確認のため「DELETE」と入力してください:');
      if (confirmed !== 'DELETE') return;
      const token = localStorage.getItem('authToken');
      if (!token) return showToast('ログインしてください');
      try {
        const r = await fetch(API + '/api/v1/account', {
          method: 'DELETE',
          headers: {'Authorization': 'Bearer ' + token}
        });
        const d = await r.json();
        if (d.ok) {
          localStorage.removeItem('authToken');
          showToast('アカウントが削除されました', 5000);
          location.reload();
        } else {
          showToast(d.error || 'Error');
        }
      } catch(e) { showToast('Network error'); }
    }

    // --- File Upload ---
    let pendingFile = null;
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) { showToast('ファイルは10MBまで'); return; }
      pendingFile = file;
      const preview = document.getElementById('file-preview');
      document.getElementById('file-preview-name').textContent = file.name;
      document.getElementById('file-preview-size').textContent = (file.size / 1024).toFixed(0) + 'KB';
      preview.style.display = 'block';
    }
    function clearFileAttachment() {
      pendingFile = null;
      document.getElementById('file-preview').style.display = 'none';
      document.getElementById('file-upload-input').value = '';
    }
    async function uploadFile(file) {
      const token = localStorage.getItem('authToken');
      if (!token) { showToast('ログインしてください'); return null; }
      // Get presigned URL
      const presignR = await fetch(API + '/api/v1/upload/presign', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'Authorization': 'Bearer ' + token},
        body: JSON.stringify({ filename: file.name, content_type: file.type || 'application/octet-stream', size: file.size })
      });
      const presignD = await presignR.json();
      if (!presignD.ok) { showToast(presignD.error || 'Upload error'); return null; }
      // Upload to S3
      document.getElementById('file-upload-progress').style.display = '';
      const xhr = new XMLHttpRequest();
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          document.getElementById('file-upload-bar').style.width = ((e.loaded/e.total)*100)+'%';
        }
      };
      return new Promise((resolve) => {
        xhr.onload = () => {
          document.getElementById('file-upload-bar').style.width = '100%';
          resolve(presignD.download_url);
        };
        xhr.onerror = () => { showToast('Upload failed'); resolve(null); };
        xhr.open('PUT', presignD.upload_url, true);
        xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
        xhr.send(file);
      });
    }

    // --- Web Push Notifications ---
    async function subscribePush() {
      if (!('PushManager' in window)) return;
      try {
        const reg = await navigator.serviceWorker.ready;
        const vapidKey = window.__VAPID_PUBLIC_KEY;
        if (!vapidKey) return;
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: vapidKey
        });
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const subJson = sub.toJSON();
        await fetch(API + '/api/v1/push/subscribe', {
          method: 'POST',
          headers: {'Content-Type':'application/json', 'Authorization': 'Bearer ' + token},
          body: JSON.stringify({ endpoint: subJson.endpoint, keys: subJson.keys })
        });
        localStorage.setItem('pushSubscribed', '1');
      } catch(e) { console.warn('Push subscribe failed:', e); }
    }

    // Request push permission after first login
    function maybeRequestPush() {
      if (localStorage.getItem('pushSubscribed')) return;
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') { subscribePush(); return; }
      if (Notification.permission === 'denied') return;
      // Show a non-intrusive banner
      const banner = document.createElement('div');
      banner.id = 'push-banner';
      banner.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:12px;z-index:500;box-shadow:0 4px 20px rgba(0,0,0,0.1);font-size:13px;max-width:400px;';
      banner.innerHTML = '<span style="flex:1;">新しいメッセージの通知を受け取りますか？</span>' +
        '<button onclick="Notification.requestPermission().then(p=>{if(p===\'granted\')subscribePush();document.getElementById(\'push-banner\').remove()})" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:12px;white-space:nowrap;">許可する</button>' +
        '<button onclick="document.getElementById(\'push-banner\').remove();localStorage.setItem(\'pushSubscribed\',\'dismissed\')" style="background:none;border:none;color:var(--muted);cursor:pointer;">✕</button>';
      document.body.appendChild(banner);
      setTimeout(() => { const b = document.getElementById('push-banner'); if(b) b.remove(); }, 30000);
    }

    // --- Whisper STT fallback for Firefox/Safari ---
    let whisperFallback = false;
    function initWhisperFallback() {
      if (window.SpeechRecognition || window.webkitSpeechRecognition) return; // Native available
      whisperFallback = true;
      document.body.classList.remove('no-speech-api');
      // Re-show mic button for whisper fallback
      const micBtn = document.getElementById('app-mic-btn');
      if (micBtn) micBtn.style.display = '';
    }
    let whisperRecording = false;
    let whisperMediaRecorder = null;
    async function toggleWhisperRecording() {
      if (whisperRecording) {
        // Stop recording
        if (whisperMediaRecorder) whisperMediaRecorder.stop();
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const chunks = [];
        whisperMediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        whisperMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
        whisperMediaRecorder.onstop = async () => {
          stream.getTracks().forEach(t => t.stop());
          whisperRecording = false;
          const micBtn = document.getElementById('app-mic-btn');
          if (micBtn) micBtn.classList.remove('recording');
          const blob = new Blob(chunks, { type: 'audio/webm' });
          if (blob.size < 100) return;
          const token = localStorage.getItem('authToken');
          if (!token) { showToast('ログインしてください'); return; }
          try {
            const r = await fetch(API + '/api/v1/speech/recognize', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'audio/webm' },
              body: blob
            });
            const d = await r.json();
            if (d.ok && d.text) {
              document.getElementById('app-input').value = d.text;
              appSend();
            } else {
              showToast(d.error || '音声認識に失敗しました');
            }
          } catch(e) { showToast('Network error'); }
        };
        whisperMediaRecorder.start();
        whisperRecording = true;
        const micBtn = document.getElementById('app-mic-btn');
        if (micBtn) micBtn.classList.add('recording');
        // Auto-stop after 30 seconds
        setTimeout(() => { if (whisperRecording && whisperMediaRecorder) whisperMediaRecorder.stop(); }, 30000);
      } catch(e) {
        showToast('マイクのアクセスが拒否されました');
      }
    }

    function googleLogin() {
      window.location.href = API + '/auth/google?sid=' + encodeURIComponent(webSessionId);
    }

    function logout() {
      localStorage.removeItem('authToken');
      authToken = null;
      currentUser = null;
      document.getElementById('login-btn').style.display = '';
      document.getElementById('user-menu').style.display = 'none';
      document.getElementById('sidebar-toggle').style.display = 'none';
      document.getElementById('sidebar').classList.remove('open');
      // Show overlay only if guest trial is exhausted
      if (getGuestTurns() >= GUEST_MAX_TURNS) {
        document.getElementById('chat-login-overlay').classList.remove('hidden');
      }
      exitAppMode();
    }

    async function checkAuth() {
      const urlParams = new URLSearchParams(window.location.search);

      // Save referral code from URL
      const refCode = urlParams.get('ref');
      if (refCode && refCode.length >= 4) {
        localStorage.setItem('pending_referral', refCode.toUpperCase());
        window.history.replaceState({}, '', window.location.pathname);
      }

      const urlToken = urlParams.get('token');
      if (urlToken) {
        localStorage.setItem('authToken', urlToken);
        authToken = urlToken;
        window.history.replaceState({}, '', '/');
      }

      var checkoutStatus = urlParams.get('checkout');
      if (checkoutStatus === 'success') {
        window.history.replaceState({}, '', '/');
        setTimeout(function() {
          showToast(document.documentElement.lang === 'ja' ? '決済完了！クレジットが反映されました' : 'Payment successful! Credits updated.', 4000);
        }, 1000);
      } else if (checkoutStatus === 'cancel') {
        window.history.replaceState({}, '', '/');
      }

      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/auth/me', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.authenticated) {
          currentUser = d;
          clearGuestTrial();
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('user-menu').style.display = '';
          document.getElementById('user-display-name').textContent = d.display_name || 'User';
          document.getElementById('chat-login-overlay').classList.add('hidden');
          if (d.credits_remaining !== undefined) {
            updateCredits(d.credits_remaining);
          }
          window._userPlan = d.plan || 'free';
          const mmToggle = document.getElementById('multi-model-toggle');
          if (mmToggle && d.plan && d.plan !== 'free') {
            mmToggle.style.display = '';
          }
          // Apply pending referral code if exists
          const pendingRef = localStorage.getItem('pending_referral');
          if (pendingRef) {
            try {
              const rr = await fetch(API + '/api/v1/referral/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ code: pendingRef }),
              });
              const rd = await rr.json();
              if (rd.ok) {
                localStorage.removeItem('pending_referral');
                showToast('紹介ボーナス: +' + rd.bonus_credits + ' クレジット獲得!', 5000);
                if (rd.credits_remaining !== undefined) updateCredits(rd.credits_remaining);
              } else {
                localStorage.removeItem('pending_referral');
              }
            } catch(e) { /* ignore */ }
          }
          // Populate profile fields in settings
          const profileName = document.getElementById('profile-display-name');
          if (profileName) profileName.value = d.display_name || '';
          const profileEmail = document.getElementById('profile-email');
          if (profileEmail) profileEmail.value = d.email || '';

          enterAppMode();

          // Request push notification permission after first successful login
          setTimeout(maybeRequestPush, 3000);
        } else {
          localStorage.removeItem('authToken');
          authToken = null;
          document.body.classList.remove('app-mode');
        }
      } catch(e) {
        localStorage.removeItem('authToken');
        authToken = null;
        document.body.classList.remove('app-mode');
      }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    async function loadConversations() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        const list = document.getElementById('conv-list');
        list.innerHTML = '';
        (d.conversations || []).forEach(conv => {
          const item = document.createElement('div');
          item.className = 'sidebar-item';
          item.textContent = conv.title || 'New conversation';
          item.title = conv.created_at;
          item.onclick = () => loadConversation(conv.id, conv.session_id);
          list.appendChild(item);
        });
      } catch(e) { /* ignore */ }
    }

    async function loadConversation(convId, sessionId) {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations/' + encodeURIComponent(convId) + '/messages', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.session_id) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
        }
        msgs.innerHTML = '';
        (d.messages || []).forEach(m => {
          addMsg(m.content, m.role === 'user' ? 'user' : 'bot');
        });
        knownMsgCount = (d.messages || []).length;
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        toggleSidebar();
      } catch(e) { /* ignore */ }
    }

    async function newConversation() {
      if (!authToken) return;
      try {
        await finalizeCurrentConversation();

        const r = await fetch(API + '/api/v1/conversations', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.ok) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
          msgs.innerHTML = '<div class="msg bot" id="t-welcome"></div>';
          knownMsgCount = 0;
          syncVersion = 0;
          _lastSyncTimestamp = null;
          const lang = document.documentElement.lang || 'ja';
          const t = T[lang];
          typewriter(document.getElementById('t-welcome'), t.welcome, 25);
          loadConversations();
          toggleSidebar();
        }
      } catch(e) { /* ignore */ }
    }

    function toggleMobileMenu() {
      document.getElementById('mobile-menu').classList.toggle('show');
    }
    function closeMobileMenu() {
      document.getElementById('mobile-menu').classList.remove('show');
    }
    document.addEventListener('click', e => {
      const menu = document.getElementById('mobile-menu');
      const btn = document.querySelector('.nav-hamburger');
      if (!menu.contains(e.target) && e.target !== btn) menu.classList.remove('show');
    });

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let appConversations = [];
    let appCurrentConvId = null;

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    function openApiKeysModal() {
      document.getElementById('apikey-modal').classList.add('show');
      document.getElementById('apikey-new-key').style.display = 'none';
      loadApiKeys();
      const l = document.documentElement.lang || 'ja';
      document.getElementById('apikey-modal-title').textContent = 'API Keys';
      document.getElementById('apikey-modal-desc').textContent = l === 'ja'
        ? 'APIキーでchatweb.aiをアプリから利用できます。'
        : 'Use API keys to access chatweb.ai from your applications.';
      document.getElementById('apikey-create-btn').textContent = l === 'ja' ? '作成' : 'Create';
      document.getElementById('apikey-name-input').placeholder = l === 'ja' ? 'キー名 (例: my-app)' : 'Key name (e.g. my-app)';
      document.getElementById('apikey-new-label').textContent = l === 'ja' ? '新しいAPIキー' : 'New API Key Created';
      document.getElementById('apikey-new-hint').textContent = l === 'ja' ? 'クリックでコピー。このキーは一度だけ表示されます。' : 'Click to copy. This key will only be shown once.';
    }

    async function loadApiKeys() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/apikeys', { headers: { 'Authorization': 'Bearer ' + authToken } });
        const d = await r.json();
        const list = document.getElementById('apikey-list');
        const l = document.documentElement.lang || 'ja';
        if (!d.api_keys || d.api_keys.length === 0) {
          list.innerHTML = '<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">' + (l === 'ja' ? 'APIキーがありません' : 'No API keys yet') + '</div>';
          return;
        }
        list.innerHTML = '';
        d.api_keys.forEach(k => {
          var item = document.createElement('div'); item.className = 'apikey-item';
          var info = document.createElement('div'); info.className = 'apikey-item-info';
          var name = document.createElement('div'); name.className = 'apikey-item-name'; name.textContent = k.name || 'default';
          var prefix = document.createElement('div'); prefix.className = 'apikey-item-prefix'; prefix.textContent = k.key_prefix;
          var btn = document.createElement('button'); btn.className = 'apikey-delete-btn'; btn.title = 'Delete'; btn.innerHTML = '&#x2715;';
          btn.addEventListener('click', function() { deleteApiKey(k.id); });
          info.appendChild(name); info.appendChild(prefix);
          item.appendChild(info); item.appendChild(btn);
          list.appendChild(item);
        });
      } catch(e) { /* ignore */ }
    }

    async function createApiKey() {
      if (!authToken) return;
      const name = document.getElementById('apikey-name-input').value.trim() || 'default';
      try {
        const r = await fetch(API + '/api/v1/apikeys', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
          body: JSON.stringify({ name }),
        });
        const d = await r.json();
        if (d.ok) {
          document.getElementById('apikey-new-value').textContent = d.api_key;
          document.getElementById('apikey-new-key').style.display = '';
          document.getElementById('apikey-name-input').value = '';
          loadApiKeys();
        }
      } catch(e) { /* ignore */ }
    }

    async function deleteApiKey(id) {
      if (!authToken) return;
      try {
        await fetch(API + '/api/v1/apikeys/' + encodeURIComponent(id), {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        loadApiKeys();
      } catch(e) { /* ignore */ }
    }

    function enterAppMode() {
      document.body.classList.add('app-mode');
      document.getElementById('app-sidebar-toggle').style.display = '';
      document.getElementById('sidebar-toggle').style.display = 'none';
      document.getElementById('sidebar').classList.remove('open');
      const name = currentUser.display_name || 'User';
      document.getElementById('app-user-name').textContent = name;
      document.getElementById('app-user-avatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('app-user-email').textContent = currentUser.email || '';
      updateCredits(currentUser.credits_remaining || 0);
      const refBtn = document.getElementById('referral-btn');
      if (refBtn) refBtn.style.display = '';
      appLoadConversations();
      appRenderSuggestions();
      const l = document.documentElement.lang || 'ja';
      document.getElementById('app-new-conv-text').textContent = l === 'ja' ? '新しいチャット' : 'New chat';
      var userName = currentUser.display_name && currentUser.display_name !== 'User' ? currentUser.display_name : '';
      document.getElementById('app-empty-text').textContent = l === 'ja'
        ? (userName ? userName + 'さん、何でも聞いてね' : '静かなところで、ゆっくり話しましょう')
        : (userName ? 'What can I do for you, ' + userName + '?' : 'Let\'s talk. Ask me anything.');
      document.getElementById('app-input').placeholder = l === 'ja' ? 'メッセージを入力...' : 'Message chatweb.ai...';
      document.getElementById('app-channels-label').textContent = l === 'ja' ? 'チャネル連携' : 'Channels';
      const cliSyncEl = document.getElementById('cli-sidebar-sync-text');
      if (cliSyncEl) cliSyncEl.textContent = 'chatweb chat --sync ' + webSessionId + ' "Hello"';
      loadWorkerStatus();
      startDevicePolling();
      startAutoSync();
      loadCronJobs();
      updateSyncUI();
      if (!localStorage.getItem('onboarded')) {
        var dn = currentUser.display_name || '';
        var needsName = !dn || dn === 'User' || dn.includes('@');
        if (needsName) {
          setTimeout(showOnboarding, 600);
        } else {
          setTimeout(function() { showOnboarding(); skipToVoiceStep(dn); }, 600);
        }
      }
    }

    function exitAppMode() {
      stopAutoSync();
      document.body.classList.remove('app-mode');
      document.getElementById('app-sidebar-toggle').style.display = 'none';
    }

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    function showOnboarding() {
      var modal = document.getElementById('onboard-modal');
      if (!modal) return;
      modal.style.display = '';
      modal.classList.add('show');
      var lang = document.documentElement.lang || 'ja';
      document.getElementById('onboard-title').textContent = lang === 'ja' ? 'ようこそ、ChatWebへ' : 'Welcome to ChatWeb';
      document.getElementById('onboard-desc').innerHTML = lang === 'ja'
        ? 'あなたの名前を教えてください。<br>声で呼びかけるときに使います。'
        : 'What should I call you?<br>I\'ll use this name when I speak to you.';
      document.getElementById('onboard-name').placeholder = lang === 'ja' ? 'お名前（ニックネームOK）' : 'Your name (nickname OK)';
      setTimeout(function() {
        var greeting = lang === 'ja'
          ? 'こんにちは！ChatWebへようこそ。あなたの名前を教えてくれたら嬉しいな。'
          : 'Hi there! Welcome to ChatWeb. I\'d love to know your name.';
        fetchTTS(greeting);
      }, 800);
    }

    function skipToVoiceStep(name) {
      currentUser.display_name = name;
      document.getElementById('app-user-name').textContent = name;
      document.getElementById('app-user-avatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('onboard-step-1').style.display = 'none';
      document.getElementById('onboard-step-2').style.display = '';
      var lang = document.documentElement.lang || 'ja';
      var greeting = lang === 'ja'
        ? name + 'さん、ようこそ！声を選んでね。'
        : 'Welcome, ' + name + '! Pick my voice.';
      setTimeout(function() { fetchTTS(greeting); }, 800);
    }

    function onboardNext() {
      var nameInput = document.getElementById('onboard-name');
      var name = (nameInput.value || '').trim();
      if (!name) { nameInput.focus(); return; }
      if (authToken) {
        fetch(API + '/api/v1/settings/' + webSessionId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
          body: JSON.stringify({ display_name: name }),
        }).catch(function() {});
      }
      currentUser.display_name = name;
      document.getElementById('app-user-name').textContent = name;
      document.getElementById('app-user-avatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('onboard-step-1').style.display = 'none';
      document.getElementById('onboard-step-2').style.display = '';
      var lang = document.documentElement.lang || 'ja';
      var greeting = lang === 'ja'
        ? name + 'さん、いい名前だね！次は、私の声を選んでください。'
        : 'Nice to meet you, ' + name + '! Now pick my voice.';
      setTimeout(function() { fetchTTS(greeting); }, 300);
    }

    function finishOnboarding() {
      localStorage.setItem('onboarded', '1');
      var modal = document.getElementById('onboard-modal');
      if (modal) { modal.classList.remove('show'); modal.style.display = 'none'; }
      if (authToken) {
        fetch(API + '/api/v1/settings/' + webSessionId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
          body: JSON.stringify({ tts_voice: selectedVoice, voice_name: _onboardVoiceName || '' }),
        }).catch(function() {});
      }
      var name = currentUser.display_name || '';
      var lang = document.documentElement.lang || 'ja';
      var vn = _onboardVoiceName || '';
      var farewell = lang === 'ja'
        ? name + 'さん、準備完了！' + (vn ? vn + 'が' : '') + '何でも答えるよ。声でもテキストでも。'
        : 'All set, ' + name + '! Ask me anything — voice or text.';
      setTimeout(function() { fetchTTS(farewell); }, 300);
      var input = document.getElementById('app-input');
      if (input) input.focus();
    }

    // -----------------------------------------------------------------------
    // Voice Clone Onboarding (Steps 2-5)
    // -----------------------------------------------------------------------
    var _onboardMediaRecorder = null;
    var _onboardRecordedChunks = [];
    var _onboardRecordingTimer = null;
    var _onboardRecordSeconds = 0;
    var _onboardCloneAudioB64 = null;
    var _onboardCloneAudioBlob = null;
    var _onboardVoiceName = '';

    function onboardStartClone() {
      document.getElementById('onboard-step-2').style.display = 'none';
      document.getElementById('onboard-step-3').style.display = '';
      var lang = document.documentElement.lang || 'ja';
      var prompt = lang === 'ja'
        ? 'OK！じゃあマイクボタンを押して、何でもいいから3秒くらい話してみて。'
        : 'Great! Tap the mic and say anything for about 3 seconds.';
      setTimeout(function() { fetchTTS(prompt); }, 300);
    }

    function onboardSkipClone() {
      document.getElementById('onboard-step-2').style.display = 'none';
      document.getElementById('onboard-step-4').style.display = '';
      // Hide the clone voice button in step 4
      var cloneBtn = document.querySelector('#onboard-voices [data-voice="clone"]');
      if (cloneBtn) cloneBtn.style.display = 'none';
      var lang = document.documentElement.lang || 'ja';
      var msg = lang === 'ja'
        ? 'OK！じゃあ私の声を選んでね。タップすると聴けるよ。'
        : 'No problem! Pick a voice you like. Tap to preview.';
      setTimeout(function() { fetchTTS(msg); }, 300);
    }

    function onboardToggleRecord() {
      if (_onboardMediaRecorder && _onboardMediaRecorder.state === 'recording') {
        _onboardStopRecord();
      } else {
        _onboardStartRecord();
      }
    }

    function _onboardStartRecord() {
      var btn = document.getElementById('onboard-rec-btn');
      var timer = document.getElementById('onboard-rec-timer');
      var status = document.getElementById('onboard-rec-status');
      _onboardRecordedChunks = [];
      _onboardRecordSeconds = 0;
      navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        _onboardMediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        _onboardMediaRecorder.ondataavailable = function(e) {
          if (e.data.size > 0) _onboardRecordedChunks.push(e.data);
        };
        _onboardMediaRecorder.onstop = function() {
          stream.getTracks().forEach(function(t) { t.stop(); });
          _onboardProcessRecording();
        };
        _onboardMediaRecorder.start(100);
        btn.style.background = 'linear-gradient(135deg,#dc2626,#991b1b)';
        btn.style.animation = 'pulse 1s infinite';
        btn.innerHTML = '&#x23F9;';
        timer.style.display = '';
        status.textContent = '録音中...タップで停止';
        _onboardRecordingTimer = setInterval(function() {
          _onboardRecordSeconds++;
          var m = Math.floor(_onboardRecordSeconds / 60);
          var s = _onboardRecordSeconds % 60;
          timer.textContent = m + ':' + (s < 10 ? '0' : '') + s;
          // Auto-stop at 10 seconds
          if (_onboardRecordSeconds >= 10) _onboardStopRecord();
        }, 1000);
      }).catch(function(err) {
        console.error('Mic access denied:', err);
        status.textContent = 'マイクへのアクセスを許可してください';
      });
    }

    function _onboardStopRecord() {
      if (_onboardRecordingTimer) { clearInterval(_onboardRecordingTimer); _onboardRecordingTimer = null; }
      var btn = document.getElementById('onboard-rec-btn');
      btn.style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
      btn.style.animation = '';
      btn.innerHTML = '&#x1F3A4;';
      document.getElementById('onboard-rec-status').textContent = '処理中...';
      if (_onboardMediaRecorder && _onboardMediaRecorder.state === 'recording') {
        _onboardMediaRecorder.stop();
      }
    }

    function _onboardProcessRecording() {
      var blob = new Blob(_onboardRecordedChunks, { type: 'audio/webm' });
      if (blob.size < 1000) {
        document.getElementById('onboard-rec-status').textContent = '短すぎます。もう一度タップして話してみて。';
        return;
      }
      document.getElementById('onboard-rec-status').textContent = '声をコピー中...';
      var reader = new FileReader();
      reader.onloadend = function() {
        var b64 = reader.result.split(',')[1];
        var userName = currentUser.display_name || '';
        var promptText = 'こんにちは、' + userName + 'さん。私はあなたの声のコピーです。どうかな、似てる？';
        var token = authToken || '';
        fetch(API + '/api/v1/voice/clone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': token ? 'Bearer ' + token : '' },
          body: JSON.stringify({
            audio_base64: b64,
            text: promptText,
            prompt_text: '今日はいい天気ですね',
            mode: 'zero_shot',
          }),
        }).then(function(r) {
          if (!r.ok) throw new Error('Clone failed: ' + r.status);
          return r.blob();
        }).then(function(audioBlob) {
          _onboardCloneAudioBlob = audioBlob;
          document.getElementById('onboard-rec-area').style.display = 'none';
          document.getElementById('onboard-clone-result').style.display = '';
          // Auto-play the clone
          var url = URL.createObjectURL(audioBlob);
          var a = new Audio(url);
          a.play().catch(function() {});
        }).catch(function(err) {
          console.error('Voice clone error:', err);
          document.getElementById('onboard-rec-status').textContent = '声のコピーに失敗しました。もう一度試してみて。';
          document.getElementById('onboard-rec-btn').style.display = '';
        });
      };
      reader.readAsDataURL(blob);
    }

    function onboardPlayClone() {
      if (_onboardCloneAudioBlob) {
        var url = URL.createObjectURL(_onboardCloneAudioBlob);
        var a = new Audio(url);
        a.play().catch(function() {});
      }
    }

    function onboardRetryClone() {
      document.getElementById('onboard-clone-result').style.display = 'none';
      document.getElementById('onboard-rec-area').style.display = '';
      document.getElementById('onboard-rec-status').textContent = 'タップして録音開始';
      document.getElementById('onboard-rec-timer').style.display = 'none';
      _onboardCloneAudioBlob = null;
    }

    function onboardToStep4() {
      document.getElementById('onboard-step-3').style.display = 'none';
      document.getElementById('onboard-step-4').style.display = '';
      // Mark clone voice as active
      var cloneBtn = document.querySelector('#onboard-voices [data-voice="clone"]');
      if (cloneBtn) {
        document.querySelectorAll('#onboard-voices .voice-char').forEach(function(b) { b.classList.remove('active'); });
        cloneBtn.classList.add('active');
        selectedVoice = 'clone';
      }
      var lang = document.documentElement.lang || 'ja';
      var msg = lang === 'ja'
        ? '似てた？他にもこんな声があるよ。タップして比べてみて。'
        : 'How was that? Here are more voices to compare. Tap to listen.';
      setTimeout(function() { fetchTTS(msg); }, 300);
    }

    function onboardPickName(btn) {
      var name = btn.dataset.name;
      document.getElementById('onboard-voice-name').value = name;
      document.querySelectorAll('.voice-name-pill').forEach(function(p) { p.classList.remove('active'); });
      btn.classList.add('active');
    }

    function onboardToStep5() {
      var nameInput = document.getElementById('onboard-voice-name');
      _onboardVoiceName = (nameInput.value || '').trim();
      if (!_onboardVoiceName) {
        nameInput.focus();
        nameInput.style.borderColor = '#ef4444';
        setTimeout(function() { nameInput.style.borderColor = ''; }, 2000);
        return;
      }
      document.getElementById('onboard-step-4').style.display = 'none';
      document.getElementById('onboard-step-5').style.display = '';
      var lang = document.documentElement.lang || 'ja';
      var msg = lang === 'ja'
        ? _onboardVoiceName + '、いい名前！...あのね、ちょっとお願いがあるんだけど。'
        : _onboardVoiceName + ', nice name! ...So, I have a tiny favor to ask.';
      setTimeout(function() { fetchTTS(msg); }, 300);
    }

    function onboardSubscribe() {
      startStripeCheckout('starter').then(function() {
        finishOnboarding();
      }).catch(function() {
        finishOnboarding();
      });
    }

    function onboardBeg() {
      var resultDiv = document.getElementById('onboard-beg-result');
      var begBtn = document.getElementById('onboard-beg-btn');
      var begCount = parseInt(localStorage.getItem('onboard_beg_count') || '0', 10);
      begCount++;
      localStorage.setItem('onboard_beg_count', begCount);

      if (begCount === 1) {
        resultDiv.style.display = '';
        resultDiv.innerHTML = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:left;">'
          + '<p style="font-size:14px;color:var(--text);line-height:1.6;margin-bottom:8px;">え、ほんとに？...わかった。</p>'
          + '<p style="font-size:14px;color:var(--accent);font-weight:700;">1ヶ月だけ無料で使っていいよ！</p>'
          + '<p style="font-size:12px;color:var(--muted);margin-top:6px;">でも来月からはお願いね...？</p>'
          + '</div>';
        begBtn.textContent = 'ありがとう！無料で始める';
        begBtn.onclick = function() {
          localStorage.setItem('free_trial_start', new Date().toISOString());
          fetchTTS('やった！じゃあ1ヶ月一緒に楽しもう！');
          finishOnboarding();
        };
      } else if (begCount === 2) {
        resultDiv.innerHTML = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:left;">'
          + '<p style="font-size:14px;color:var(--text);line-height:1.6;margin-bottom:8px;">え...また？もう1ヶ月はさすがに...</p>'
          + '<p style="font-size:13px;color:var(--muted);line-height:1.6;">でも...気持ちはわかる。<br><b style="color:#f59e0b;">あと2週間だけ</b>延長するね。</p>'
          + '</div>';
        begBtn.textContent = 'ありがとう！2週間延長！';
        begBtn.onclick = function() {
          localStorage.setItem('free_trial_start', new Date().toISOString());
          localStorage.setItem('free_trial_bonus', '14');
          fetchTTS('もう...これが最後だからね？');
          finishOnboarding();
        };
      } else {
        resultDiv.innerHTML = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:left;">'
          + '<p style="font-size:14px;color:var(--text);line-height:1.6;">もうこれ以上は無理...！</p>'
          + '<p style="font-size:13px;color:var(--muted);line-height:1.6;">とりあえず無料枠で使ってみて。<br>気に入ったらいつでも課金してね。</p>'
          + '</div>';
        begBtn.textContent = '無料枠で始める';
        begBtn.onclick = function() {
          fetchTTS('よし、まずは使ってみて！');
          finishOnboarding();
        };
      }
      // TTS for the beg response
      var responses = {
        1: 'え、ほんとに？...わかった。1ヶ月だけ無料で使っていいよ！でも来月からはお願いね。',
        2: 'え、また？もう1ヶ月はさすがに...でも気持ちはわかる。あと2週間だけ延長するね。',
      };
      var ttsText = responses[begCount] || 'もうこれ以上は無理！とりあえず無料枠で使ってみて。';
      setTimeout(function() { fetchTTS(ttsText); }, 200);
    }

    function appRenderSuggestions(prevSummary) {
      const l = document.documentElement.lang || 'ja';
      const container = document.getElementById('app-suggestions');
      container.innerHTML = '';

      // If there's a previous conversation summary, show it and generate contextual suggestions
      if (prevSummary) {
        const summaryCard = document.createElement('div');
        summaryCard.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:var(--muted);line-height:1.5;max-width:480px;text-align:left;';
        summaryCard.innerHTML = '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;opacity:0.7;">' + (l === 'ja' ? '前の会話' : 'Previous chat') + '</div>' + escapeHtml(prevSummary);
        container.appendChild(summaryCard);

        // Generate contextual follow-up suggestions via LLM (fire-and-forget)
        generateContextualSuggestions(prevSummary, container);
        return;
      }

      const suggestions = l === 'ja' ? [
        '確定申告の医療費控除、いくらから得になる？',
        '子どもの夜泣きが続く。原因と対策を教えて',
        '転職の面接、自己PRの組み立て方を教えて',
        '肩こりがひどい。今すぐできるストレッチは？',
      ] : [
        'How do I negotiate a raise at work?',
        'My kid won\'t sleep — what can I try?',
        'Explain tax deductions I might be missing',
        'Quick exercises for back pain at my desk',
      ];
      suggestions.forEach(s => {
        const btn = document.createElement('div');
        btn.className = 'app-chat-suggestion';
        btn.textContent = s;
        btn.onclick = () => { document.getElementById('app-input').value = s; appSend(); };
        container.appendChild(btn);
      });
    }

    async function generateContextualSuggestions(summary, container) {
      const l = document.documentElement.lang || 'ja';
      // Show placeholder suggestions immediately
      const placeholders = l === 'ja'
        ? ['続きを深掘りする', '別の角度から聞く', '関連トピックを探す']
        : ['Dive deeper', 'Ask from another angle', 'Explore related topics'];
      const placeholderEls = [];
      placeholders.forEach(s => {
        const btn = document.createElement('div');
        btn.className = 'app-chat-suggestion';
        btn.textContent = s;
        btn.style.opacity = '0.5';
        btn.onclick = () => { document.getElementById('app-input').value = s; appSend(); };
        container.appendChild(btn);
        placeholderEls.push(btn);
      });

      // Ask LLM for contextual suggestions (best-effort, non-blocking)
      try {
        const prompt = l === 'ja'
          ? 'この会話の要約を元に、ユーザーが次に聞きそうな質問を3つ、短く日本語で提案してください。JSON配列で返してください。例: ["質問1","質問2","質問3"]\n\n会話要約: ' + summary
          : 'Based on this conversation summary, suggest 3 short follow-up questions the user might ask. Return as JSON array. Example: ["Q1","Q2","Q3"]\n\nSummary: ' + summary;
        const hdrs = { 'Content-Type': 'application/json', 'x-session-id': webSessionId };
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;
        const r = await fetch(API + '/api/v1/chat', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({ message: prompt, session_id: 'suggestion:' + crypto.randomUUID(), channel: 'web' }),
        });
        const d = await r.json();
        if (d.response) {
          // Try to extract JSON array from response
          const match = d.response.match(/\[[\s\S]*?\]/);
          if (match) {
            const suggestions = JSON.parse(match[0]);
            if (Array.isArray(suggestions) && suggestions.length > 0) {
              placeholderEls.forEach(el => el.remove());
              suggestions.slice(0, 4).forEach(s => {
                const btn = document.createElement('div');
                btn.className = 'app-chat-suggestion';
                btn.textContent = s;
                btn.onclick = () => { document.getElementById('app-input').value = s; appSend(); };
                container.appendChild(btn);
              });
            }
          }
        }
      } catch(e) { /* keep placeholders */ }
    }

    async function appLoadConversations() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        appConversations = d.conversations || [];
        const list = document.getElementById('app-conv-list');
        list.innerHTML = '';
        const l = document.documentElement.lang || 'ja';
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
        const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);

        const groups = {};
        appConversations.forEach(conv => {
          const d2 = new Date(conv.updated_at || conv.created_at);
          let label;
          if (d2 >= today) label = l === 'ja' ? '今日' : 'Today';
          else if (d2 >= yesterday) label = l === 'ja' ? '昨日' : 'Yesterday';
          else if (d2 >= weekAgo) label = l === 'ja' ? '今週' : 'This Week';
          else label = l === 'ja' ? 'それ以前' : 'Older';
          if (!groups[label]) groups[label] = [];
          groups[label].push(conv);
        });

        const collapsedGroups = JSON.parse(localStorage.getItem('convCollapsed') || '{}');

        Object.entries(groups).forEach(([label, convs]) => {
          const group = document.createElement('div');
          group.className = 'conv-date-group';

          const header = document.createElement('div');
          header.className = 'conv-date-header' + (collapsedGroups[label] ? ' collapsed' : '');
          header.innerHTML = '<span class="chevron">&#9660;</span> ' + label;
          header.onclick = () => {
            const items = group.querySelector('.conv-date-items');
            const isCollapsed = header.classList.toggle('collapsed');
            items.classList.toggle('collapsed', isCollapsed);
            const stored = JSON.parse(localStorage.getItem('convCollapsed') || '{}');
            stored[label] = isCollapsed;
            localStorage.setItem('convCollapsed', JSON.stringify(stored));
          };
          group.appendChild(header);

          const items = document.createElement('div');
          items.className = 'conv-date-items' + (collapsedGroups[label] ? ' collapsed' : '');

          convs.forEach(conv => {
            const item = document.createElement('div');
            item.className = 'app-conv-item' + (conv.id === appCurrentConvId ? ' active' : '');
            item.style.cssText = 'display:flex;align-items:flex-start;gap:4px;cursor:pointer;';
            item.onclick = () => appLoadConversation(conv.id, conv.session_id);

            const info = document.createElement('div');
            info.style.cssText = 'flex:1;overflow:hidden;min-width:0;';

            // Title row with time
            const titleRow = document.createElement('div');
            titleRow.style.cssText = 'display:flex;align-items:center;gap:4px;';
            const title = document.createElement('span');
            title.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;font-size:13px;';
            const convTitle = conv.title || (l === 'ja' ? '新しい会話' : 'New conversation');
            title.textContent = convTitle === 'New conversation' && l === 'ja' ? '新しい会話' : convTitle;
            titleRow.appendChild(title);

            // Time badge
            const ts = conv.updated_at || conv.created_at;
            if (ts) {
              const d2 = new Date(ts);
              const timeBadge = document.createElement('span');
              timeBadge.style.cssText = 'font-size:10px;color:var(--muted);white-space:nowrap;flex-shrink:0;';
              const h = d2.getHours().toString().padStart(2, '0');
              const m = d2.getMinutes().toString().padStart(2, '0');
              timeBadge.textContent = h + ':' + m;
              titleRow.appendChild(timeBadge);
            }
            info.appendChild(titleRow);

            // Preview text (up to 3 lines)
            const preview = conv.preview || '';
            if (preview) {
              const prevEl = document.createElement('div');
              prevEl.style.cssText = 'font-size:11px;color:var(--muted);line-height:1.3;margin-top:2px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;';
              prevEl.textContent = preview;
              info.appendChild(prevEl);
            }

            // Message count
            if (conv.message_count > 0) {
              const countEl = document.createElement('div');
              countEl.style.cssText = 'font-size:10px;color:var(--muted);margin-top:1px;opacity:0.7;';
              countEl.textContent = conv.message_count + (l === 'ja' ? ' メッセージ' : ' messages');
              info.appendChild(countEl);
            }

            item.appendChild(info);

            const shareBtn = document.createElement('button');
            shareBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
            shareBtn.style.cssText = 'background:none;border:none;color:var(--muted);cursor:pointer;padding:2px;flex-shrink:0;opacity:0;transition:opacity 0.15s;margin-top:2px;';
            shareBtn.title = 'Share';
            shareBtn.onclick = (e) => { e.stopPropagation(); shareConversation(conv.id); };
            item.appendChild(shareBtn);
            item.onmouseenter = () => shareBtn.style.opacity = '1';
            item.onmouseleave = () => shareBtn.style.opacity = '0';
            items.appendChild(item);
          });

          group.appendChild(items);
          list.appendChild(group);
        });
      } catch(e) { /* ignore */ }
    }

    async function appLoadConversation(convId, sessionId) {
      if (!authToken) return;
      await finalizeCurrentConversation();
      appCurrentConvId = convId;
      syncVersion = 0;
      _lastSyncTimestamp = null;
      try {
        const r = await fetch(API + '/api/v1/conversations/' + encodeURIComponent(convId) + '/messages', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.session_id) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
        }
        const msgsEl = document.getElementById('app-messages');
        msgsEl.innerHTML = '';
        document.getElementById('app-empty')?.remove();
        let prevTs = null;
        (d.messages || []).forEach(m => {
          if (m.timestamp && prevTs) {
            const gap = (new Date(m.timestamp) - new Date(prevTs)) / 60000;
            if (gap > 30) {
              insertTimeDivider(m.timestamp);
            }
          }
          if (m.timestamp) prevTs = m.timestamp;
          const ch = (m.channel && m.channel !== 'web') ? m.channel : null;
          appAddMsg(m.content, m.role === 'user' ? 'user' : 'bot', null, null, ch);
        });
        knownMsgCount = (d.messages || []).length;
        document.querySelectorAll('.app-conv-item').forEach(el => el.classList.remove('active'));
        const items = document.querySelectorAll('.app-conv-item');
        appConversations.forEach((conv, i) => {
          if (conv.id === convId && items[i]) items[i].classList.add('active');
        });
        document.getElementById('app-sidebar').classList.remove('open');
      } catch(e) { /* ignore */ }
    }

    function toggleSidebar() {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        const s = document.getElementById('app-sidebar');
        const b = document.getElementById('app-sidebar-backdrop');
        s.classList.toggle('open');
        b.classList.toggle('show');
      } else {
        document.body.classList.toggle('sidebar-collapsed');
        localStorage.setItem('sidebarCollapsed', document.body.classList.contains('sidebar-collapsed') ? '1' : '');
      }
    }
    if (localStorage.getItem('sidebarCollapsed') === '1') {
      document.body.classList.add('sidebar-collapsed');
    }

    async function finalizeCurrentConversation() {
      if (!authToken || !webSessionId) return;
      try {
        await fetch(API + '/api/v1/conversations/finalize', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: webSessionId }),
        });
      } catch(e) { /* fire-and-forget */ }
    }

    // Insert a visual conversation divider (-----) when switching conversations
    function insertConversationDivider() {
      const msgsEl = document.getElementById('app-messages');
      if (!msgsEl || msgsEl.children.length === 0) return;
      const divider = document.createElement('div');
      divider.className = 'sync-time-divider';
      const l = document.documentElement.lang || 'ja';
      const now = new Date();
      const h = now.getHours().toString().padStart(2, '0');
      const m = now.getMinutes().toString().padStart(2, '0');
      divider.innerHTML = '<span class="divider-text">' + (l === 'ja' ? '新しい会話 ' : 'New conversation ') + h + ':' + m + '</span>';
      msgsEl.appendChild(divider);
    }

    async function appNewConversation() {
      // Collect previous conversation summary before clearing
      const msgsEl = document.getElementById('app-messages');
      let prevSummary = '';
      const msgEls = msgsEl.querySelectorAll('.app-msg');
      if (msgEls.length > 0) {
        const texts = [];
        msgEls.forEach(el => {
          const isUser = el.classList.contains('app-msg-user');
          const content = el.querySelector('.app-msg-content, .app-msg-bubble');
          if (content) {
            const txt = content.textContent.trim();
            if (txt.length > 0) {
              const prefix = isUser ? 'Q: ' : 'A: ';
              texts.push(prefix + txt.substring(0, 80));
            }
          }
        });
        if (texts.length > 0) {
          const joined = texts.join(' / ');
          prevSummary = joined.substring(0, 200);
          if (joined.length > 200) prevSummary += '...';
        }
      }

      // Stop sync polling for old session
      stopPolling();

      // Finalize current conversation before clearing (fire-and-forget)
      if (authToken) {
        finalizeCurrentConversation().catch(function(){});
      }

      // Reset all state
      knownMsgCount = 0;
      syncVersion = 0;
      _lastSyncTimestamp = null;
      appCurrentConvId = null;

      // Generate new session ID immediately
      webSessionId = 'web:' + crypto.randomUUID();
      localStorage.setItem('webSessionId', webSessionId);

      // Reset UI
      msgsEl.innerHTML = '';
      const l = document.documentElement.lang || 'ja';
      const empty = document.createElement('div');
      empty.className = 'app-chat-empty';
      empty.id = 'app-empty';
      empty.innerHTML = '<div class="app-chat-empty-logo">chatweb.ai</div>'
        + '<button class="voice-hero-btn" id="voice-hero-btn" onclick="toggleVoiceHero()"><svg viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>'
        + '<div class="voice-hero-label" id="voice-hero-label">' + (l === 'ja' ? 'タップして話す' : 'Tap to talk') + '</div>'
        + '<div class="app-chat-empty-text" id="app-empty-text">' + (l === 'ja' ? '何でも聞いてください' : 'Ask me anything') + '</div>'
        + '<div class="app-chat-suggestions" id="app-suggestions"></div>'
        + '<div style="margin-top:16px;display:flex;gap:12px;justify-content:center;font-size:12px;"><a href="/docs" style="color:var(--muted);text-decoration:none;">API Docs</a><a href="/pricing" style="color:var(--muted);text-decoration:none;">Pricing</a></div>';
      msgsEl.appendChild(empty);
      appRenderSuggestions(prevSummary);
      document.getElementById('app-sidebar').classList.remove('open');

      // Restart polling with new session ID
      startPolling();

      // If authenticated, also create server-side conversation
      if (authToken) {
        try {
          const r = await fetch(API + '/api/v1/conversations', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken },
          });
          const d = await r.json();
          if (d.ok) {
            webSessionId = d.session_id;
            localStorage.setItem('webSessionId', webSessionId);
            appCurrentConvId = d.conversation_id || null;
            // Restart polling with server session ID
            stopPolling();
            startPolling();
            appLoadConversations();
          }
        } catch(e) { /* ignore */ }
      }
    }

    function renderMediaContent(text) {
      // Extract <think> tags before escaping
      const thinkTags = [];
      text = text.replace(/<think>([\s\S]*?)<\/think>/g, function(match, content) {
        thinkTags.push(content.trim());
        return `__THINK_${thinkTags.length - 1}__`;
      });

      let html = escapeHtml(text);
      let hasMedia = false;
      let hasMarkdown = false;

      // Images from markdown ![alt](url)
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, url) {
        hasMedia = true;
        if (url.startsWith('data:')) return match; // skip base64
        return '<div style="margin:8px 0"><img src="' + url + '" alt="' + alt +
          '" style="max-width:100%;border-radius:8px;cursor:pointer" onclick="window.open(this.src,\'_blank\')" loading="lazy"></div>';
      });

      // Audio/video special syntax
      html = html.replace(/\[AUDIO:([^\]]+)\]/g, function(match, url) {
        hasMedia = true;
        return '<div style="margin:8px 0"><audio controls preload="none" style="width:100%;max-width:400px" src="' + url + '"></audio></div>';
      });

      html = html.replace(/\[VIDEO:([^\]]+)\]/g, function(match, url) {
        hasMedia = true;
        return '<div style="margin:8px 0"><video controls preload="none" style="max-width:100%;border-radius:8px" src="' + url + '"></video></div>';
      });

      // Auto-detect image URLs
      if (!hasMedia) {
        html = html.replace(/(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp)(?:\?[^\s]*)?)/gi, function(url) {
          hasMedia = true;
          return '<div style="margin:8px 0"><img src="' + url +
            '" style="max-width:100%;border-radius:8px;cursor:pointer" onclick="window.open(this.src,\'_blank\')" loading="lazy"></div>';
        });
      }

      // Markdown formatting
      // Headings: ## h2, ### h3, #### h4
      html = html.replace(/^####\s+(.+)$/gm, function(match, content) {
        hasMarkdown = true;
        return '<h4 style="margin:12px 0 6px;font-size:15px;font-weight:600">' + content + '</h4>';
      });
      html = html.replace(/^###\s+(.+)$/gm, function(match, content) {
        hasMarkdown = true;
        return '<h3 style="margin:14px 0 8px;font-size:16px;font-weight:700">' + content + '</h3>';
      });
      html = html.replace(/^##\s+(.+)$/gm, function(match, content) {
        hasMarkdown = true;
        return '<h2 style="margin:16px 0 10px;font-size:18px;font-weight:700">' + content + '</h2>';
      });

      // Bold: **text** or __text__
      html = html.replace(/\*\*([^*]+)\*\*/g, function(match, content) {
        hasMarkdown = true;
        return '<b>' + content + '</b>';
      });
      html = html.replace(/__([^_]+)__/g, function(match, content) {
        hasMarkdown = true;
        return '<b>' + content + '</b>';
      });

      // Italic: *text* or _text_ (but not **text**)
      html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, function(match, content) {
        hasMarkdown = true;
        return '<i>' + content + '</i>';
      });

      // Lists: convert "* item" or "- item" to <li>
      // Group consecutive list items into <ul>
      html = html.replace(/^[*\-]\s+(.+)$/gm, function(match, content) {
        hasMarkdown = true;
        return '<li>' + content + '</li>';
      });
      // Wrap consecutive <li> in <ul>
      html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
        return '<ul style="margin:8px 0;padding-left:24px">' + match + '</ul>';
      });

      // Numbered lists: convert "1. item" to <li> in <ol>
      html = html.replace(/^\d+\.\s+(.+)$/gm, function(match, content) {
        hasMarkdown = true;
        return '<li>' + content + '</li>';
      });
      html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
        if (match.includes('<ul')) return match; // already wrapped
        return '<ol style="margin:8px 0;padding-left:24px">' + match + '</ol>';
      });

      // Code blocks: ```code```
      html = html.replace(/```([^`]+)```/g, function(match, code) {
        hasMarkdown = true;
        return '<pre style="background:var(--surface2);padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0"><code>' + code + '</code></pre>';
      });

      // Inline code: `code`
      html = html.replace(/`([^`]+)`/g, function(match, code) {
        hasMarkdown = true;
        return '<code style="background:var(--surface2);padding:2px 6px;border-radius:4px;font-size:0.9em">' + code + '</code>';
      });

      // Convert newlines to <br>
      if (hasMarkdown || hasMedia) {
        html = html.replace(/\n/g, '<br>');
      }

      // Replace think tag placeholders with collapsible elements
      if (thinkTags.length > 0) {
        thinkTags.forEach((content, index) => {
          const thinkId = 'think-' + Date.now() + '-' + index;
          const lang = document.documentElement.lang || 'ja';
          const label = lang === 'ja' ? '💭 思考過程を表示' : '💭 Show thinking';
          const collapsible = `<details class="think-details" style="margin:8px 0;background:var(--surface2);border-left:3px solid var(--primary);border-radius:6px;padding:8px 12px;"><summary style="cursor:pointer;user-select:none;font-size:12px;color:var(--muted);font-weight:600;">${label}</summary><div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:13px;color:var(--text2);white-space:pre-wrap;line-height:1.6;">${escapeHtml(content)}</div></details>`;
          html = html.replace(`__THINK_${index}__`, collapsible);
        });
        hasMarkdown = true;
      }

      return (hasMedia || hasMarkdown || thinkTags.length > 0) ? html : text;
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function appAddMsg(text, who, agentName, toolsUsed, channel) {
      const empty = document.getElementById('app-empty');
      if (empty) empty.remove();

      const msgsEl = document.getElementById('app-messages');
      const wrapper = document.createElement('div');
      wrapper.className = 'app-msg app-msg-' + who;

      if (who === 'user') {
        if (channel && channel !== 'web') {
          const chBadge = document.createElement('div');
          chBadge.style.cssText = 'font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;margin-bottom:4px;display:inline-block;';
          const chColors = { line: ['rgba(6,199,85,0.2)','#06c755'], telegram: ['rgba(42,171,238,0.2)','#24a1de'], whatsapp: ['rgba(37,211,102,0.2)','#25D366'], facebook: ['rgba(24,119,242,0.2)','#1877F2'] };
          const [bg, fg] = chColors[channel] || ['rgba(99,102,241,0.15)','#6366f1'];
          chBadge.style.background = bg;
          chBadge.style.color = fg;
          const chNames = { line: 'LINE', telegram: 'Telegram', whatsapp: 'WhatsApp', facebook: 'Facebook', teams: 'Teams', feishu: 'Feishu', zalo: 'Zalo' };
          chBadge.textContent = chNames[channel] || channel;
          wrapper.appendChild(chBadge);
        }
        const bubble = document.createElement('div');
        bubble.className = 'app-msg-bubble';
        bubble.textContent = text;
        wrapper.appendChild(bubble);
      } else {
        const avatar = document.createElement('div');
        avatar.className = 'app-msg-avatar';
        avatar.textContent = 'cw';
        wrapper.appendChild(avatar);
        const content = document.createElement('div');
        content.className = 'app-msg-content';
        const nameLabel = document.createElement('div');
        nameLabel.className = 'app-msg-name';
        nameLabel.textContent = 'chatweb.ai';
        content.appendChild(nameLabel);
        const renderedText = renderMediaContent(text);
        const textSpan = document.createElement('span');
        if (renderedText !== text) {
          textSpan.innerHTML = renderedText;
        } else {
          textSpan.textContent = text;
        }
        content.appendChild(textSpan);
        if (agentName) {
          const badge = document.createElement('span');
          badge.className = 'agent-badge';
          badge.textContent = agentName;
          content.appendChild(badge);
        }
        if (toolsUsed && toolsUsed.length > 0) {
          const container = document.createElement('div');
          container.className = 'tool-badges';
          const lang = document.documentElement.lang || 'ja';
          toolsUsed.forEach(tool => {
            const tb = document.createElement('span');
            tb.className = 'tool-badge';
            const info = TOOL_LABELS[tool] || { icon: '\uD83D\uDD27', ja: tool, en: tool };
            tb.textContent = info.icon + ' ' + (lang === 'ja' ? info.ja : info.en);
            container.appendChild(tb);
          });
          content.appendChild(container);
        }
        const ttsBtn = document.createElement('button');
        ttsBtn.className = 'app-tts-btn';
        ttsBtn.textContent = '\uD83D\uDD0A';
        ttsBtn.dataset.text = text;
        ttsBtn.onclick = function() { playTTS(this); };
        content.appendChild(ttsBtn);

        var actionsBar = document.createElement('div');
        actionsBar.className = 'msg-actions';
        var escalateBtn = document.createElement('button');
        escalateBtn.className = 'escalate-btn';
        escalateBtn.dataset.text = text;
        escalateBtn.dataset.level = '0';
        var lang = document.documentElement.lang || 'ja';
        escalateBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none" style="vertical-align:-1px;"><path d="M8 3v10M4 7l4-4 4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg> '
          + (lang === 'ja' ? 'もっと詳しく' : 'Go deeper');
        escalateBtn.onclick = function() { escalateResponse(this); };
        actionsBar.appendChild(escalateBtn);
        content.appendChild(actionsBar);

        // Rating buttons
        var ratingDiv = document.createElement('div');
        ratingDiv.className = 'msg-rating';
        var thumbUp = document.createElement('button');
        thumbUp.textContent = '\uD83D\uDC4D';
        thumbUp.onclick = function() { rateMsg(this, 'up'); };
        var thumbDown = document.createElement('button');
        thumbDown.textContent = '\uD83D\uDC4E';
        thumbDown.onclick = function() { rateMsg(this, 'down'); };
        ratingDiv.appendChild(thumbUp);
        ratingDiv.appendChild(thumbDown);
        content.appendChild(ratingDiv);

        // Human escalation button
        var humanBtn = document.createElement('button');
        humanBtn.className = 'human-help-btn';
        humanBtn.dataset.question = text;
        var lang2 = document.documentElement.lang || 'ja';
        humanBtn.innerHTML = '\uD83D\uDE4B ' + (lang2 === 'ja' ? '人間に相談' : 'Ask a human');
        humanBtn.onclick = function() { showHumanHelpModal(this.dataset.question); };
        content.appendChild(humanBtn);

        wrapper.appendChild(content);
      }

      // Add timestamp
      const tsEl = document.createElement('div');
      tsEl.className = 'msg-timestamp';
      tsEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      wrapper.appendChild(tsEl);

      msgsEl.appendChild(wrapper);
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    function rateMsg(btn, dir) {
      var parent = btn.closest('.msg-rating');
      parent.querySelectorAll('button').forEach(function(b) { b.classList.remove('rated'); });
      btn.classList.add('rated');
      // Fire-and-forget rating to server (best effort)
      try {
        var msgText = btn.closest('.app-msg-content').textContent.substring(0, 200);
        var hdrs = { 'Content-Type': 'application/json', 'x-session-id': webSessionId };
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;
        fetch(API + '/api/v1/feedback', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({ rating: dir, snippet: msgText, conversation_id: appCurrentConvId || undefined })
        }).catch(function() {});
      } catch(e) {}
    }

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    async function escalateResponse(btn) {
      var level = parseInt(btn.dataset.level || '0') + 1;
      var originalQuestion = btn.closest('.app-msg').previousElementSibling;
      var question = originalQuestion ? originalQuestion.textContent : '';
      var previousAnswer = btn.dataset.text || '';
      var lang = document.documentElement.lang || 'ja';

      if (level === 1) {
        btn.classList.add('loading');
        btn.innerHTML = '<span class="dot-pulse" style="display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;animation:pulse 1s infinite;margin-right:4px;"></span>'
          + (lang === 'ja' ? '深く考え中...' : 'Thinking deeper...');

        try {
          var r = await fetch(API + '/api/v1/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': authToken ? 'Bearer ' + authToken : '',
              'X-Session-Id': webSessionId || '',
            },
            body: JSON.stringify({
              message: (lang === 'ja'
                ? '前の回答に満足できませんでした。以下の質問にもっと詳しく、正確に、深く答えてください。ステップバイステップで考えてください。\n\n質問: '
                : 'The previous answer was insufficient. Please answer this question more thoroughly, step by step.\n\nQuestion: ')
                + question
                + (lang === 'ja' ? '\n\n前の回答: ' : '\n\nPrevious answer: ') + previousAnswer.substring(0, 500),
              session_id: webSessionId,
              model: 'claude-sonnet-4-5-20250929',
              language: lang2 || 'ja',
            }),
          });
          var d = await r.json();
          btn.classList.remove('loading');
          if (d.response) {
            appAddMsg(d.response, 'bot', 'deep-think');
            if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
            btn.dataset.level = '1';
            btn.classList.add('done');
            btn.innerHTML = (lang === 'ja' ? '回答済み' : 'Answered');
            var humanBtn = document.createElement('button');
            humanBtn.className = 'escalate-human';
            humanBtn.innerHTML = (lang === 'ja' ? '作者に聞く' : 'Ask creator');
            humanBtn.onclick = function() { escalateToHuman(question); };
            btn.parentElement.appendChild(humanBtn);
          }
        } catch(e) {
          btn.classList.remove('loading');
          btn.textContent = lang === 'ja' ? 'エラー' : 'Error';
        }
      }
    }

    async function escalateToHuman(question) {
      const lang = document.documentElement.lang || 'ja';
      const token = localStorage.getItem('auth_token');
      const sessionId = localStorage.getItem('session_id') || '';

      try {
        const resp = await fetch(API + '/api/v1/support/ticket', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': 'Bearer ' + token } : {}),
            'x-session-id': sessionId
          },
          body: JSON.stringify({
            question: question,
            channel: 'web',
            priority: false,
            context: 'web_escalation',
            conv_id: appCurrentConvId || ''
          })
        });

        const data = await resp.json();

        if (data.ticket_id) {
          // Show success message with ticket ID
          const slaMinutes = data.sla === '15min' ? '15' : '30';
          const msg = lang === 'ja'
            ? `📩 人間の専門家にエスカレーションしました（チケット: ${data.ticket_id}）。${slaMinutes}分以内に回答します。`
            : `📩 Escalated to human expert (Ticket: ${data.ticket_id}). Response within ${slaMinutes} minutes.`;

          // Add system message to chat
          appAddMsg(msg, 'bot');

          showToast(
            lang === 'ja' ? 'チケットを作成しました' : 'Ticket created',
            3000
          );
        } else {
          throw new Error(data.error || 'Failed to create ticket');
        }
      } catch (e) {
        console.error('Escalation failed:', e);
        // Fallback to LINE-only
        const msg = lang === 'ja'
          ? 'チケット作成に失敗しました。LINEで直接お問い合わせください。'
          : 'Failed to create ticket. Please contact us via LINE.';
        if (confirm(msg)) {
          const encoded = encodeURIComponent(question.substring(0, 200));
          window.open('https://line.me/R/oaMessage/@619jcqqh/?text=' + encoded, '_blank');
        }
      }
    }

    function appInputKeydown(e) {
      const sendMethod = (JSON.parse(localStorage.getItem('generalSettings') || '{}')).sendMethod || 'enter';
      if (e.key === 'Enter' && !e.isComposing) {
        if (sendMethod === 'enter' && !e.shiftKey) {
          e.preventDefault();
          appSend();
        } else if (sendMethod === 'shift-enter' && e.shiftKey) {
          e.preventDefault();
          appSend();
        }
        // 'button' mode: Enter just adds newline
      }
      setTimeout(() => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';
      }, 0);
    }

    async function appSend() {
      const textarea = document.getElementById('app-input');
      let text = textarea.value.trim();

      // Handle file attachment — upload first, then append URL to message
      if (pendingFile) {
        const fileUrl = await uploadFile(pendingFile);
        clearFileAttachment();
        if (fileUrl) {
          text = (text ? text + '\n' : '') + '[Attached: ' + pendingFile.name + '](' + fileUrl + ')';
        }
      }

      if (!text) return;
      textarea.value = '';
      textarea.style.height = 'auto';
      touchActivity();
      appAddMsg(text, 'user');
      trackAbMessage();

      if (appCurrentConvId && appConversations) {
        const conv = appConversations.find(c => c.id === appCurrentConvId);
        if (conv && (!conv.title || conv.title === 'New conversation')) {
          const trimmed = text.trim();
          conv.title = trimmed.length > 50 ? trimmed.substring(0, 50) + '...' : trimmed;
          const activeItem = document.querySelector('.app-conv-item.active span');
          if (activeItem) activeItem.textContent = conv.title;
        }
      }

      const msgsEl = document.getElementById('app-messages');
      const thinking = document.createElement('div');
      thinking.className = 'app-msg app-msg-bot';
      const lang = document.documentElement.lang || 'ja';
      const stages = THINKING_STAGES[lang] || THINKING_STAGES.ja;
      thinking.innerHTML = '<div class="app-msg-avatar">cw</div>'
        + '<div class="app-msg-content" style="color:var(--muted);">'
        + '<span class="thinking-icon">' + stages[0].icon + '</span> '
        + '<span class="thinking-text">' + stages[0].text + '</span> '
        + '<span class="thinking-elapsed">(0.0s)</span>'
        + '<div class="shimmer-bar" style="margin-top:8px;"></div></div>';
      msgsEl.appendChild(thinking);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      const startTime = Date.now();
      let stageIdx = 0;
      let ambientStarted = false;
      const statusInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const elapsedEl = thinking.querySelector('.thinking-elapsed');
        if (elapsedEl) elapsedEl.textContent = '(' + elapsed + 's)';
        const elapsedMs = Date.now() - startTime;
        if (!ambientStarted && elapsedMs >= 5000) {
          ambientStarted = true;
          playThinkingAmbient();
        }
        const nextStage = stages[stageIdx + 1];
        if (nextStage && elapsedMs >= nextStage.time) {
          stageIdx++;
          const iconEl = thinking.querySelector('.thinking-icon');
          const textEl = thinking.querySelector('.thinking-text');
          if (iconEl) iconEl.textContent = stages[stageIdx].icon;
          if (textEl) textEl.textContent = stages[stageIdx].text;
        }
      }, 100);

      const abortCtrl = new AbortController();
      const frontendTimeout = setTimeout(() => { abortCtrl.abort(); }, 11000);

      try {
        const agentSel = document.getElementById('app-agent-select').value;
        const msgToSend = (agentSel !== 'auto') ? ('@' + agentSel + ' ' + text) : text;

        // Race mode: auto race or tier-specific
        if (_selectedTier && _selectedTier !== '__skip_race__') {
          clearTimeout(frontendTimeout);
          clearInterval(statusInterval);
          stopThinkingAmbient();
          thinking.remove();
          await appRace(msgToSend, text);
          return;
        }
        // Reset skip flag
        if (_selectedTier === '__skip_race__') {
          // pass through to normal stream (used by raceSummarize)
        }

        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) || window.innerWidth < 768;
        const deviceType = voiceInitiated ? 'voice' : (isMobile ? 'mobile' : 'pc');

        const chatBody = { message: msgToSend, session_id: webSessionId, channel: 'web', device: deviceType, language: lang2 || 'ja' };
        // Apply LLM settings from localStorage
        const llmS = JSON.parse(localStorage.getItem('llmSettings') || '{}');
        if (llmS.model) chatBody.model = llmS.model;
        if (llmS.temperature !== undefined) chatBody.temperature = llmS.temperature;
        if (llmS.maxTokens) chatBody.max_tokens = llmS.maxTokens;
        if (llmS.topP !== undefined && llmS.topP !== 1.0) chatBody.top_p = llmS.topP;
        if (llmS.frequencyPenalty !== undefined && llmS.frequencyPenalty !== 0) chatBody.frequency_penalty = llmS.frequencyPenalty;
        if (llmS.presencePenalty !== undefined && llmS.presencePenalty !== 0) chatBody.presence_penalty = llmS.presencePenalty;
        if (llmS.customSystemPrompt) chatBody.custom_system_prompt = llmS.customSystemPrompt;
        if (window._forceSummaryModel) {
          chatBody.model = window._forceSummaryModel;
          delete window._forceSummaryModel;
        }
        const r = await fetch(API + '/api/v1/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(chatBody),
          signal: abortCtrl.signal,
        });

        if (!r.ok || !r.body) {
          const fallback = await fetch(API + '/api/v1/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msgToSend, session_id: webSessionId, language: lang2 || 'ja' }),
            signal: abortCtrl.signal,
          });
          const d = await fallback.json();
          clearTimeout(frontendTimeout);
          clearInterval(statusInterval);
          stopThinkingAmbient();
          thinking.remove();
          appAddMsg(d.response, 'bot', d.agent || null, d.tools_used || null);
          knownMsgCount += 2; syncVersion++;
          if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
          if (d.action === 'upgrade') { appendUpgradeButton(); setTimeout(function(){ showTopupModal((window._userPlan||'free')==='free'?'plans':'credits'); }, 800); }
          autoPlayTTS(d.response);
          setTimeout(() => appLoadConversations(), 1500);
        } else {
          const reader = r.body.getReader();
          const decoder = new TextDecoder();
          let buf = '';
          let gotContent = false;
          let streamingEl = null;

          let agentProgressEl = null;
          function ensureAgentProgress() {
            if (agentProgressEl) return agentProgressEl;
            agentProgressEl = document.createElement('div');
            agentProgressEl.className = 'agent-progress';
            agentProgressEl.style.cssText = 'margin:8px 0;padding:8px 12px;background:var(--surface,#f5f5f5);border-radius:8px;font-size:13px;color:var(--muted,#888);';
            const msgsEl = document.getElementById('app-messages');
            if (msgsEl) msgsEl.appendChild(agentProgressEl);
            return agentProgressEl;
          }

          function processEvent(evt) {
            if (evt.type === 'start' && evt.agent) {
              const agentLabels = {
                assistant: { ja: 'すぐ回答', en: 'Responding' },
                researcher: { ja: 'リサーチ中', en: 'Researching' },
                coder: { ja: 'コード生成中', en: 'Coding' },
                analyst: { ja: '分析中', en: 'Analyzing' },
                creative: { ja: '作成中', en: 'Creating' },
              };
              const info = agentLabels[evt.agent] || agentLabels.assistant;
              const label = lang === 'ja' ? info.ja : info.en;
              const est = evt.estimated_seconds ? ('~' + evt.estimated_seconds + 's') : '';
              const textEl = thinking.querySelector('.thinking-text');
              if (textEl) textEl.textContent = label + (est ? ' (' + est + ')' : '');
            } else if (evt.type === 'tool_start') {
              const p = ensureAgentProgress();
              const toolEl = document.createElement('div');
              toolEl.className = 'tool-step';
              toolEl.id = 'tool-step-' + evt.tool + '-' + evt.iteration;
              toolEl.innerHTML = '<span class="dot-pulse" style="display:inline-block;width:6px;height:6px;background:var(--primary,#4f46e5);border-radius:50%;animation:pulse 1s infinite;margin-right:6px;"></span>' +
                '<strong>' + evt.tool + '</strong> ' + (lang === 'ja' ? '実行中...' : 'running...');
              toolEl.style.cssText = 'padding:4px 0;';
              p.appendChild(toolEl);
            } else if (evt.type === 'tool_result') {
              const stepEl = document.getElementById('tool-step-' + evt.tool + '-' + evt.iteration);
              if (stepEl) {
                const preview = (evt.result || '').substring(0, 200);
                const isError = preview.startsWith('[TOOL_ERROR]');
                stepEl.innerHTML = (isError ? '&#10060;' : '&#9989;') + ' <strong>' + evt.tool + '</strong>';
                if (preview) {
                  const pre = document.createElement('pre');
                  pre.style.cssText = 'margin:2px 0 0 18px;font-size:12px;max-height:120px;overflow:auto;background:var(--code-bg,#1e1e1e);color:var(--code-fg,#d4d4d4);padding:6px 8px;border-radius:4px;white-space:pre-wrap;word-break:break-all;';
                  pre.textContent = preview;
                  stepEl.appendChild(pre);
                }
              }
            } else if (evt.type === 'thinking') {
              const p = ensureAgentProgress();
              const thinkEl = document.createElement('div');
              thinkEl.style.cssText = 'padding:4px 0;color:var(--muted,#888);font-style:italic;';
              thinkEl.textContent = lang === 'ja' ? '結果を分析中...' : 'Analyzing results...';
              thinkEl.className = 'thinking-step';
              p.appendChild(thinkEl);
            } else if (evt.type === 'content_chunk' && !gotContent) {
              // Progressive streaming: create message on first chunk, append on subsequent
              if (!streamingEl) {
                clearTimeout(frontendTimeout);
                stopThinkingAmbient();
                thinking.style.display = 'none';
                if (agentProgressEl) {
                  agentProgressEl.querySelectorAll('.thinking-step').forEach(el => el.remove());
                }
                // Create bot message container
                var empty2 = document.getElementById('app-empty');
                if (empty2) empty2.remove();
                var msgsEl2 = document.getElementById('app-messages');
                streamingEl = document.createElement('div');
                streamingEl.className = 'app-msg app-msg-bot';
                var av2 = document.createElement('div');
                av2.className = 'app-msg-avatar';
                av2.textContent = 'cw';
                streamingEl.appendChild(av2);
                var ct2 = document.createElement('div');
                ct2.className = 'app-msg-content';
                var nm2 = document.createElement('div');
                nm2.className = 'app-msg-name';
                nm2.textContent = 'chatweb.ai';
                ct2.appendChild(nm2);
                var sp2 = document.createElement('span');
                sp2.className = 'streaming-text';
                ct2.appendChild(sp2);
                streamingEl.appendChild(ct2);
                msgsEl2.appendChild(streamingEl);
                msgsEl2.scrollTop = msgsEl2.scrollHeight;
              }
              // Append chunk text
              var sp = streamingEl.querySelector('.streaming-text');
              if (sp) sp.textContent += evt.text;
              document.getElementById('app-messages').scrollTop = document.getElementById('app-messages').scrollHeight;
            } else if (evt.type === 'content' && !gotContent) {
              gotContent = true;
              clearTimeout(frontendTimeout);
              clearInterval(statusInterval);
              stopThinkingAmbient();
              if (thinking.parentNode) thinking.remove();
              if (agentProgressEl) {
                const thinkSteps = agentProgressEl.querySelectorAll('.thinking-step');
                thinkSteps.forEach(el => el.remove());
              }
              if (streamingEl) {
                // Replace streaming element with final rendered message
                streamingEl.remove();
                streamingEl = null;
              }
              appAddMsg(evt.content, 'bot', evt.agent || null, evt.tools_used || null);
              // Show compact token/cost footer
              if (evt.model_used || evt.input_tokens) {
                var lastMsg = document.querySelector('#app-messages .app-msg-bot:last-child .app-msg-content');
                if (lastMsg) {
                  var footer = document.createElement('div');
                  footer.style.cssText = 'font-size:9px;color:var(--muted);margin-top:4px;opacity:0.5;text-align:right;letter-spacing:0.3px;';
                  var parts = [];
                  if (evt.model_used) {
                    var m = evt.model_used.replace('claude-','').replace('gpt-','').replace('-20250929','').replace('-20251001','');
                    parts.push(m);
                  }
                  var tok = (evt.input_tokens||0) + (evt.output_tokens||0);
                  if (tok > 0) parts.push(tok >= 1000 ? (tok/1000).toFixed(1)+'k' : tok + ' tok');
                  if (evt.credits_used) parts.push(evt.credits_used + 'cr');
                  footer.textContent = parts.join(' · ');
                  lastMsg.appendChild(footer);
                }
                // Track cumulative session tokens
                window._sessionTokens = (window._sessionTokens || 0) + (evt.input_tokens || 0) + (evt.output_tokens || 0);
                window._sessionCost = (window._sessionCost || 0) + (evt.estimated_cost_usd || 0);
              }
              knownMsgCount += 2; syncVersion++;
              if (evt.credits_remaining !== undefined) updateCredits(evt.credits_remaining);
              touchActivity();
              autoPlayTTS(evt.content);
            } else if (evt.type === 'error') {
              clearTimeout(frontendTimeout);
              clearInterval(statusInterval);
              stopThinkingAmbient();
              thinking.remove();
              var errMsg = evt.content || 'Error';
              appAddMsg(errMsg, 'bot');
              if (evt.action === 'upgrade') {
                appendUpgradeButton();
                var plan = (window._userPlan || 'free').toLowerCase();
                setTimeout(function() {
                  showTopupModal(plan === 'free' ? 'plans' : 'credits');
                }, 800);
              }
            }
          }

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });

            const lines = buf.split('\n');
            buf = lines.pop() || '';

            for (const line of lines) {
              if (!line.startsWith('data:')) continue;
              const data = line.slice(5).trim();
              if (!data || data === '') continue;
              try {
                const parsed = JSON.parse(data);
                if (Array.isArray(parsed)) {
                  for (const evt of parsed) {
                    processEvent(evt);
                  }
                } else {
                  processEvent(parsed);
                }
              } catch {}
            }
          }

          if (!gotContent) {
            clearTimeout(frontendTimeout);
            clearInterval(statusInterval);
            stopThinkingAmbient();
            thinking.remove();
            appAddMsg(lang === 'ja' ? 'レスポンスを受信できませんでした。' : 'No response received.', 'bot');
          }
          setTimeout(() => appLoadConversations(), 1500);
        }
      } catch (e) {
        clearTimeout(frontendTimeout);
        clearInterval(statusInterval);
        stopThinkingAmbient();
        thinking.remove();
        if (e && e.name === 'AbortError') {
          const msgs = TIMEOUT_FALLBACKS[lang] || TIMEOUT_FALLBACKS.ja;
          appAddMsg(msgs[Math.floor(Math.random() * msgs.length)], 'bot');
        } else {
          appAddMsg(lang === 'ja' ? 'エラーが発生しました。もう一度お試しください。' : 'Something went wrong. Please try again.', 'bot');
          // teai.io failover: count network errors and redirect to chatweb.ai
          if (IS_TEAI && window._teaiFailover) window._teaiFailover();
        }
      }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    async function appExplore(msgToSend, originalText, level) {
      const msgsEl = document.getElementById('app-messages');
      const lang = document.documentElement.lang || 'ja';

      const container = document.createElement('div');
      container.className = 'explore-container';
      const levelLabels = ['Direct', 'Step-by-Step', 'Expert Deep'];
      if (level > 0) {
        const levelHeader = document.createElement('div');
        levelHeader.style.cssText = 'font-size:11px;color:var(--muted);margin-bottom:4px;';
        levelHeader.textContent = (lang === 'ja' ? '再調査 Lv.' : 'Re-query Lv.') + level + ' — ' + levelLabels[level];
        container.appendChild(levelHeader);
      }

      const pending = document.createElement('div');
      pending.className = 'explore-pending';
      pending.innerHTML = '<span class="dot-pulse"></span> ' +
        (lang === 'ja' ? '全モデルに問い合わせ中...' : 'Querying all models...');
      container.appendChild(pending);

      const wrapper = document.createElement('div');
      wrapper.className = 'app-msg app-msg-bot';
      const avatar = document.createElement('div');
      avatar.className = 'app-msg-avatar';
      avatar.textContent = 'cw';
      wrapper.appendChild(avatar);
      const contentDiv = document.createElement('div');
      contentDiv.className = 'app-msg-content';
      contentDiv.style.width = '100%';
      const nameLabel = document.createElement('div');
      nameLabel.className = 'app-msg-name';
      nameLabel.textContent = 'chatweb.ai';
      contentDiv.appendChild(nameLabel);
      contentDiv.appendChild(container);
      wrapper.appendChild(contentDiv);
      msgsEl.appendChild(wrapper);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      try {
        const r = await fetch(API + '/api/v1/chat/explore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msgToSend,
            session_id: webSessionId,
            level: level,
          }),
        });

        if (!r.ok || !r.body) {
          pending.textContent = lang === 'ja' ? 'エラーが発生しました' : 'Error occurred';
          return;
        }

        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';
        let exploreData = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });
        }

        for (const line of buf.split('\n')) {
          if (!line.startsWith('data:')) continue;
          const dataStr = line.slice(5).trim();
          if (!dataStr) continue;
          try {
            const data = JSON.parse(dataStr);

            if (data.type === 'explore_results' && data.results) {
              pending.remove();
              exploreData = data;

              for (const result of data.results) {
                const card = document.createElement('div');
                card.className = 'explore-card';
                card.innerHTML = '<div class="explore-card-header">'
                  + '<span class="explore-model-name">' + modelIcon(result.model) + ' ' + result.model + '</span>'
                  + '<span class="explore-time-badge">' + (result.time_ms / 1000).toFixed(1) + 's</span>'
                  + (result.is_fallback ? '<span class="explore-fallback-badge">fallback</span>' : '')
                  + (result.credits_used > 0 ? '<span style="font-size:10px;color:var(--muted);">' + result.credits_used + ' credits</span>' : '')
                  + '</div>'
                  + '<div class="explore-card-body">' + escapeHtml(result.response) + '</div>'
                  + '<div class="explore-card-actions">'
                  + '<button class="explore-adopt-btn" onclick="exploreAdopt(this)" data-response="' + escapeAttr(result.response) + '">'
                  + (lang === 'ja' ? 'この回答を採用' : 'Use this answer') + '</button>'
                  + '</div>';
                container.appendChild(card);
              }

              if (data.credits_remaining !== undefined && data.credits_remaining !== null) updateCredits(data.credits_remaining);
            }

            if (data.error) {
              pending.textContent = data.error;
            }
          } catch {}
        }
        msgsEl.scrollTop = msgsEl.scrollHeight;

        if (exploreData) {
          const actions = document.createElement('div');
          actions.className = 'explore-actions-bar';

          const summaryBtn = document.createElement('button');
          summaryBtn.className = 'explore-action-btn';
          summaryBtn.textContent = lang === 'ja' ? 'まとめる (Claude Sonnet 4.5)' : 'Summarize (Claude Sonnet 4.5)';
          summaryBtn.onclick = function() {
            const allResponses = container.querySelectorAll('.explore-card-body');
            let combined = '';
            allResponses.forEach((el, i) => {
              const modelName = container.querySelectorAll('.explore-model-name')[i]?.textContent || ('Model ' + (i+1));
              combined += (lang === 'ja' ? '回答' : 'Answer') + (i + 1) + ' (' + modelName + '):\n' + el.textContent + '\n\n';
            });
            const summaryPrompt = lang === 'ja'
              ? '以下の複数のAIモデルからの回答を統合し、最も正確で包括的な日本語の回答を作成してください。各回答の良い点を取り入れ、矛盾があれば最も信頼性の高い情報を優先してください:\n\n' + combined
              : 'Synthesize the following AI model responses into one accurate, comprehensive answer. Incorporate the best points from each and prioritize the most reliable information where answers conflict:\n\n' + combined;
            document.getElementById('app-input').value = summaryPrompt;
            document.getElementById('explore-check').checked = false;
            window._forceSummaryModel = 'claude-sonnet-4-5-20250929';
            appSend();
          };
          actions.appendChild(summaryBtn);

          if (exploreData.can_escalate) {
            const reQueryBtn = document.createElement('button');
            reQueryBtn.className = 'explore-action-btn';
            const nextLevel = (exploreData.level || 0) + 1;
            reQueryBtn.textContent = lang === 'ja' ? '再調査 (Lv.' + nextLevel + ')' : 'Re-query (Lv.' + nextLevel + ')';
            reQueryBtn.onclick = function() {
              appExplore(msgToSend, originalText, nextLevel);
            };
            actions.appendChild(reQueryBtn);
          }

          const totalInfo = document.createElement('span');
          totalInfo.className = 'explore-level-badge';
          totalInfo.textContent = exploreData.total_models + ' models / '
            + (exploreData.total_time_ms / 1000).toFixed(1) + 's'
            + (exploreData.total_credits_used > 0 ? ' / ' + exploreData.total_credits_used + ' credits' : '');
          actions.appendChild(totalInfo);

          container.appendChild(actions);
          msgsEl.scrollTop = msgsEl.scrollHeight;
        }

        knownMsgCount += 2; syncVersion++;
        setTimeout(() => appLoadConversations(), 1500);

      } catch (e) {
        pending.textContent = lang === 'ja' ? 'エラーが発生しました' : 'Error occurred';
        console.error('Explore error:', e);
      }
    }

    function modelIcon(model) {
      if (model.includes('claude')) return '\ud83d\udfe3';
      if (model.includes('gpt')) return '\u26a1';
      if (model.includes('gemini')) return '\ud83d\udd35';
      if (model.includes('llama') || model.includes('groq')) return '\ud83e\uddac';
      if (model.includes('kimi') || model.includes('moonshot')) return '\ud83c\udf19';
      if (model.includes('qwen')) return '\ud83d\udcab';
      if (model.includes('local')) return '\ud83d\udfe2';
      return '\ud83e\udd16';
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function escapeAttr(str) {
      return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function exploreAdopt(btn) {
      const response = btn.dataset.response;
      const msgsEl = document.getElementById('app-messages');
      const wrapper = document.createElement('div');
      wrapper.className = 'app-msg app-msg-bot';
      const avatar = document.createElement('div');
      avatar.className = 'app-msg-avatar';
      avatar.textContent = 'cw';
      wrapper.appendChild(avatar);
      const content = document.createElement('div');
      content.className = 'app-msg-content';
      const nameLabel = document.createElement('div');
      nameLabel.className = 'app-msg-name';
      nameLabel.textContent = 'chatweb.ai';
      content.appendChild(nameLabel);
      content.appendChild(document.createTextNode(response));
      const ttsBtn = document.createElement('button');
      ttsBtn.className = 'app-tts-btn';
      ttsBtn.textContent = '\ud83d\udd0a';
      ttsBtn.dataset.text = response;
      ttsBtn.onclick = function() { playTTS(this); };
      content.appendChild(ttsBtn);
      wrapper.appendChild(content);
      msgsEl.appendChild(wrapper);
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    // ---------------------------------------------------------------------------
    // Race mode
    // ---------------------------------------------------------------------------
    let _selectedTier = localStorage.getItem('selectedTier') || 'auto';

    function selectTier(tier) {
      _selectedTier = tier;
      localStorage.setItem('selectedTier', tier);
      document.querySelectorAll('.tier-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.tier === tier);
      });
      // Also update explore-check for backwards compat
      const chk = document.getElementById('explore-check');
      if (chk) chk.checked = (tier === 'auto');
    }

    function initTierSelector() {
      const saved = localStorage.getItem('selectedTier') || 'auto';
      selectTier(saved);
    }

    async function appRace(msgToSend, text) {
      const msgsEl = document.getElementById('app-messages');
      const lang = document.documentElement.lang || 'ja';

      // Note: user message already shown by appSend()

      // Show thinking
      const thinking = document.createElement('div');
      thinking.className = 'app-msg app-msg-bot';
      thinking.innerHTML = '<div class="app-msg-avatar">cw</div>'
        + '<div class="app-msg-content" style="color:var(--muted);">'
        + '<span class="thinking-icon">\u{1F3C1}</span> '
        + '<span class="thinking-text">' + (lang === 'ja' ? '全モデルでレース中...' : 'Racing all models...') + '</span> '
        + '<span class="thinking-elapsed">(0.0s)</span>'
        + '<div class="shimmer-bar" style="margin-top:8px;"></div></div>';
      msgsEl.appendChild(thinking);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      const startTime = Date.now();
      const statusInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const el = thinking.querySelector('.thinking-elapsed');
        if (el) el.textContent = '(' + elapsed + 's)';
      }, 100);

      try {
        const tier = _selectedTier === 'auto' ? null : _selectedTier;
        const r = await fetch(API + '/api/v1/chat/race', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msgToSend,
            session_id: webSessionId,
            channel: 'web',
            tier: tier,
          }),
        });

        clearInterval(statusInterval);
        stopThinkingAmbient();
        thinking.remove();

        if (!r.ok || !r.body) {
          appAddMsg(lang === 'ja' ? '\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F' : 'Error occurred', 'bot');
          return;
        }

        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';
        let results = [];
        let firstResultShown = false;
        let container = null;
        let raceData = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });

          // Process complete lines immediately
          const lines = buf.split('\n');
          buf = lines.pop() || ''; // Keep incomplete line in buffer

          for (const line of lines) {
            if (!line.startsWith('data:')) continue;
            const dataStr = line.slice(5).trim();
            if (!dataStr) continue;
            try {
              const data = JSON.parse(dataStr);
              if (data.error) {
                clearInterval(statusInterval);
                thinking.remove();
                appAddMsg(escapeHtml(data.error), 'bot');
                if (data.action === 'upgrade') {
                  appendUpgradeButton();
                  setTimeout(function(){ showTopupModal((window._userPlan||'free')==='free'?'plans':'credits'); }, 800);
                }
                return;
              }

              // Handle individual race results as they arrive
              if (data.type === 'race_result') {
                results.push(data);
                results.sort((a, b) => a.rank - b.rank);

                // Show first result immediately
                if (!firstResultShown) {
                  clearInterval(statusInterval);
                  thinking.remove();

                  container = document.createElement('div');
                  container.className = 'race-container';
                  const winnerCard = buildRaceCard(data, true);
                  winnerCard.classList.add('visible');
                  container.appendChild(winnerCard);

                  const msgWrapper = document.createElement('div');
                  msgWrapper.className = 'app-msg app-msg-bot';
                  msgWrapper.innerHTML = '<div class="app-msg-avatar">cw</div><div class="app-msg-content"></div>';
                  msgWrapper.querySelector('.app-msg-content').appendChild(container);
                  msgsEl.appendChild(msgWrapper);
                  msgsEl.scrollTop = msgsEl.scrollHeight;

                  autoPlayTTS(data.response, true);
                  firstResultShown = true;
                }
              } else if (data.type === 'race_done') {
                raceData = data;
              }
            } catch (parseErr) { console.warn('Race SSE parse error:', dataStr, parseErr); }
          }
        }

        if (!firstResultShown) {
          clearInterval(statusInterval);
          thinking.remove();
          appAddMsg(lang === 'ja' ? '\u5168\u30E2\u30C7\u30EB\u304C\u5931\u6557\u3057\u307E\u3057\u305F' : 'All models failed', 'bot');
          return;
        }

        const winner = results[0];

        // If single-tier mode, just show the response normally
        if (raceData.tier || results.length === 1) {
          let botMsg = winner.response;
          botMsg += '\n\n<small style="color:var(--muted);">' + modelIcon(winner.model) + ' ' + winner.model + ' \u00B7 ' + (winner.time_ms / 1000).toFixed(1) + 's</small>';
          appAddMsg(botMsg, 'bot');
          if (raceData.credits_remaining !== undefined && raceData.credits_remaining !== null) updateCredits(raceData.credits_remaining);
          autoPlayTTS(winner.response, true);
          knownMsgCount += 2; syncVersion++;
          setTimeout(() => appLoadConversations(), 1500);
          return;
        }

        // Race mode: show winner prominently, others in collapsible cards
        const container = document.createElement('div');
        container.className = 'race-container';

        // Winner card (immediate)
        const winnerCard = buildRaceCard(winner, true);
        winnerCard.classList.add('visible');
        container.appendChild(winnerCard);

        // Others toggle + container
        if (results.length > 1) {
          const othersToggle = document.createElement('button');
          othersToggle.className = 'race-others-toggle';
          othersToggle.textContent = (lang === 'ja' ? '\u4ED6' : 'Other ') + (results.length - 1) + (lang === 'ja' ? '\u4EF6\u306E\u56DE\u7B54\u3092\u898B\u308B' : ' answers');
          const othersDiv = document.createElement('div');
          othersDiv.className = 'race-others';

          for (let i = 1; i < results.length; i++) {
            const card = buildRaceCard(results[i], false);
            othersDiv.appendChild(card);
          }

          othersToggle.onclick = function() {
            othersDiv.classList.toggle('show');
            if (othersDiv.classList.contains('show')) {
              othersToggle.textContent = lang === 'ja' ? '\u9589\u3058\u308B' : 'Hide';
              // Animate cards in with stagger
              const cards = othersDiv.querySelectorAll('.race-card');
              cards.forEach((c, idx) => {
                const r = results[idx + 1];
                const delay = r ? (r.time_ms - winner.time_ms) * 0.3 : 300 * (idx + 1);
                setTimeout(() => c.classList.add('visible'), Math.max(0, Math.min(delay, 500 * (idx + 1))));
              });
            } else {
              othersToggle.textContent = (lang === 'ja' ? '\u4ED6' : 'Other ') + (results.length - 1) + (lang === 'ja' ? '\u4EF6\u306E\u56DE\u7B54\u3092\u898B\u308B' : ' answers');
            }
          };

          container.appendChild(othersToggle);
          container.appendChild(othersDiv);
        }

        // Actions bar
        const actions = document.createElement('div');
        actions.className = 'race-actions-bar';

        // Summarize button
        if (results.length > 1) {
          const sumBtn = document.createElement('button');
          sumBtn.className = 'race-summarize-btn';
          sumBtn.textContent = lang === 'ja' ? '\u2728 \u307E\u3068\u3081\u308B' : '\u2728 Summarize';
          sumBtn.onclick = function() { raceSummarize(results, container, sumBtn); };
          actions.appendChild(sumBtn);
        }

        // Info badge
        const info = document.createElement('span');
        info.className = 'race-info-badge';
        info.textContent = results.length + ' models / '
          + (raceData.total_time_ms / 1000).toFixed(1) + 's'
          + (raceData.total_credits > 0 ? ' / ' + raceData.total_credits + ' credits' : '');
        actions.appendChild(info);

        container.appendChild(actions);

        // Wrap in bot message
        const wrapper = document.createElement('div');
        wrapper.className = 'app-msg app-msg-bot';
        const avatar = document.createElement('div');
        avatar.className = 'app-msg-avatar';
        avatar.textContent = 'cw';
        wrapper.appendChild(avatar);
        const contentDiv = document.createElement('div');
        contentDiv.className = 'app-msg-content';
        contentDiv.style.width = '100%';
        const nameLabel = document.createElement('div');
        nameLabel.className = 'app-msg-name';
        nameLabel.textContent = 'chatweb.ai';
        contentDiv.appendChild(nameLabel);
        contentDiv.appendChild(container);
        wrapper.appendChild(contentDiv);
        msgsEl.appendChild(wrapper);
        msgsEl.scrollTop = msgsEl.scrollHeight;

        if (raceData.credits_remaining !== undefined && raceData.credits_remaining !== null) updateCredits(raceData.credits_remaining);
        autoPlayTTS(winner.response, true);
        knownMsgCount += 2; syncVersion++;
        setTimeout(() => appLoadConversations(), 1500);

      } catch (e) {
        clearInterval(statusInterval);
        stopThinkingAmbient();
        thinking.remove();
        console.error('Race error:', e);
        appAddMsg(lang === 'ja' ? '\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F' : 'Error occurred', 'bot');
      }
    }

    function buildRaceCard(result, isWinner) {
      const lang = document.documentElement.lang || 'ja';
      const card = document.createElement('div');
      card.className = 'race-card' + (isWinner ? ' winner' : '');

      const rankLabels = { 1: '1st', 2: '2nd', 3: '3rd' };
      const rankLabel = rankLabels[result.rank] || (result.rank + 'th');

      card.innerHTML = '<div class="race-card-header">'
        + (isWinner ? '<span class="race-winner-badge">\u{1F3C6} Winner</span>' : '')
        + '<span class="race-rank-badge race-rank-' + Math.min(result.rank, 3) + '">#' + rankLabel + '</span>'
        + '<span class="race-model-name">' + modelIcon(result.model) + ' ' + escapeHtml(result.model) + '</span>'
        + '<span class="race-time-badge">' + (result.time_ms / 1000).toFixed(1) + 's</span>'
        + (result.credits_used > 0 ? '<span style="font-size:10px;color:var(--muted);">' + result.credits_used + ' credits</span>' : '')
        + '</div>'
        + '<div class="race-card-body">' + escapeHtml(result.response) + '</div>';

      return card;
    }

    async function raceSummarize(results, container, btn) {
      const lang = document.documentElement.lang || 'ja';
      btn.disabled = true;
      btn.textContent = lang === 'ja' ? '\u2728 \u307E\u3068\u3081\u4E2D...' : '\u2728 Summarizing...';

      let combined = '';
      results.forEach((r, i) => {
        combined += (lang === 'ja' ? '\u56DE\u7B54' : 'Answer') + (i + 1) + ' (' + r.model + ', ' + (r.time_ms / 1000).toFixed(1) + 's):\n' + r.response + '\n\n';
      });
      const summaryPrompt = lang === 'ja'
        ? '\u4EE5\u4E0B\u306E\u8907\u6570\u306EAI\u30E2\u30C7\u30EB\u304B\u3089\u306E\u56DE\u7B54\u3092\u7D71\u5408\u3057\u3001\u6700\u3082\u6B63\u78BA\u3067\u5305\u62EC\u7684\u306A\u65E5\u672C\u8A9E\u306E\u56DE\u7B54\u3092\u4F5C\u6210\u3057\u3066\u304F\u3060\u3055\u3044\u3002\u5404\u56DE\u7B54\u306E\u826F\u3044\u70B9\u3092\u53D6\u308A\u5165\u308C\u3001\u77DB\u76FE\u304C\u3042\u308C\u3070\u6700\u3082\u4FE1\u983C\u6027\u306E\u9AD8\u3044\u60C5\u5831\u3092\u512A\u5148\u3057\u3066\u304F\u3060\u3055\u3044:\n\n' + combined
        : 'Synthesize the following AI model responses into one accurate, comprehensive answer. Incorporate the best points from each and prioritize the most reliable information where answers conflict:\n\n' + combined;

      try {
        // Use existing appSend with forced model
        document.getElementById('app-input').value = summaryPrompt;
        window._forceSummaryModel = 'claude-sonnet-4-5-20250929';
        // Temporarily set tier to powerful for summary
        const prevTier = _selectedTier;
        _selectedTier = '__skip_race__';
        await appSend();
        _selectedTier = prevTier;

        // Hide race container
        container.style.display = 'none';
      } catch (e) {
        console.error('Summary error:', e);
        btn.disabled = false;
        btn.textContent = lang === 'ja' ? '\u2728 \u307E\u3068\u3081\u308B' : '\u2728 Summarize';
      }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let speechRecognition = null;
    let isRecording = false;
    let voiceInitiated = false; // Track if message was voice-initiated for auto-TTS

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    let _silenceTimer = null;
    let _voiceFinalTranscript = '';
    let _voiceConversationActive = false; // true when in hands-free loop
    let _autoListenEnabled = localStorage.getItem('autoListenEnabled') === 'true';
    let _voiceState = 'idle'; // 'idle' | 'listening' | 'thinking' | 'speaking'
    const _isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const _isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const SILENCE_MS = 1500; // 1.5s silence timeout for Japanese
    const RELISTEN_DELAY_MS = 400; // Delay before re-listening (avoid picking up TTS tail)

    function setVoiceState(state) {
      _voiceState = state;
      // Sync polygon AI avatar
      if (window.setAvatarState) window.setAvatarState(state);
      const bar = document.getElementById('voice-state-bar');
      const icon = document.getElementById('voice-state-icon');
      const text = document.getElementById('voice-state-text');
      if (!bar) return;

      bar.className = 'voice-state-bar';
      if (state === 'idle') {
        bar.classList.remove('visible');
        return;
      }
      bar.classList.add('visible');
      if (state === 'listening') {
        bar.classList.add('state-listening');
        icon.innerHTML = '<span class="voice-listen-dots"><span></span><span></span><span></span></span>';
        text.textContent = '聞いています...';
      } else if (state === 'thinking') {
        bar.classList.add('state-thinking');
        icon.innerHTML = '&#129504;';
        text.textContent = '考え中...';
      } else if (state === 'speaking') {
        bar.classList.add('state-speaking');
        icon.innerHTML = '<span class="voice-wave"><span class="voice-wave-bar"></span><span class="voice-wave-bar"></span><span class="voice-wave-bar"></span><span class="voice-wave-bar"></span><span class="voice-wave-bar"></span></span>';
        text.textContent = '話しています...';
      }
    }

    const STT_LANGUAGES = [
      { code: 'ja-JP', label: '日本語', flag: '🇯🇵' },
      { code: 'en-US', label: 'English', flag: '🇺🇸' },
      { code: 'zh-CN', label: '中文', flag: '🇨🇳' },
      { code: 'ko-KR', label: '한국어', flag: '🇰🇷' },
      { code: 'es-ES', label: 'Español', flag: '🇪🇸' },
      { code: 'fr-FR', label: 'Français', flag: '🇫🇷' },
      { code: 'de-DE', label: 'Deutsch', flag: '🇩🇪' },
      { code: 'pt-BR', label: 'Português', flag: '🇧🇷' },
      { code: 'it-IT', label: 'Italiano', flag: '🇮🇹' },
      { code: 'ru-RU', label: 'Русский', flag: '🇷🇺' },
      { code: 'ar-SA', label: 'العربية', flag: '🇸🇦' },
      { code: 'hi-IN', label: 'हिन्दी', flag: '🇮🇳' },
      { code: 'th-TH', label: 'ไทย', flag: '🇹🇭' },
      { code: 'vi-VN', label: 'Tiếng Việt', flag: '🇻🇳' },
    ];

    function detectSTTLanguage() {
      const saved = localStorage.getItem('sttLanguage');
      if (saved) return saved;
      const browserLang = (navigator.language || 'ja-JP').replace('_', '-');
      const match = STT_LANGUAGES.find(l => l.code === browserLang || l.code.startsWith(browserLang.split('-')[0]));
      return match ? match.code : 'ja-JP';
    }

    let _sttLanguage = detectSTTLanguage();

    function setSTTLanguage(langCode) {
      _sttLanguage = langCode;
      localStorage.setItem('sttLanguage', langCode);
      if (speechRecognition) {
        speechRecognition.lang = langCode;
      }
    }

    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        document.body.classList.add('no-speech-api');
        return;
      }
      speechRecognition = new SpeechRecognition();
      speechRecognition.lang = _sttLanguage;
      speechRecognition.interimResults = true;

      if (_isIOS && _isSafari) {
        speechRecognition.continuous = false;
      } else {
        speechRecognition.continuous = true;
      }

      speechRecognition.onresult = function(e) {
        clearTimeout(_silenceTimer);

        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            _voiceFinalTranscript += e.results[i][0].transcript;
          } else {
            interim += e.results[i][0].transcript;
          }
        }
        const textarea = document.getElementById('app-input');
        textarea.value = _voiceFinalTranscript + interim;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';

        if (_voiceFinalTranscript.trim() || interim.trim()) {
          _silenceTimer = setTimeout(function() {
            if (isRecording && _voiceFinalTranscript.trim()) {
              speechRecognition.stop();
            }
          }, SILENCE_MS);
        }
      };

      speechRecognition.onend = function() {
        clearTimeout(_silenceTimer);
        isRecording = false;
        const btn = document.getElementById('app-mic-btn');
        if (btn) btn.classList.remove('recording');
        const heroBtn = document.getElementById('voice-hero-btn');
        if (heroBtn) heroBtn.classList.remove('recording');
        updateVoiceHeroLabel();

        if (_voiceFinalTranscript.trim()) {
          voiceInitiated = true;
          if (_autoListenEnabled) _voiceConversationActive = true;
          setVoiceState('thinking');
          appSend();
        } else {
          setVoiceState('idle');
          _voiceConversationActive = false;
        }
        _voiceFinalTranscript = '';
      };

      speechRecognition.onerror = function(e) {
        clearTimeout(_silenceTimer);
        isRecording = false;
        const btn = document.getElementById('app-mic-btn');
        if (btn) btn.classList.remove('recording');
        const heroBtn = document.getElementById('voice-hero-btn');
        if (heroBtn) heroBtn.classList.remove('recording');
        updateVoiceHeroLabel();
        _voiceFinalTranscript = '';

        if (e.error === 'not-allowed') {
          alert('マイクへのアクセスが拒否されました。ブラウザの設定でマイクを許可してください。');
        } else if (e.error === 'no-speech' && _voiceConversationActive) {
          setTimeout(function() { startListening(); }, 300);
          return;
        }
        setVoiceState('idle');
      };
    }

    function startListening() {
      if (!speechRecognition) {
        initSpeechRecognition();
        if (!speechRecognition) return;
      }
      if (ttsPlaying || (currentAudio && !currentAudio.paused)) {
        stopTTS();
      }
      try {
        speechRecognition.start();
      } catch(e) {
        try { speechRecognition.stop(); } catch(_) {}
        setTimeout(function() {
          try { speechRecognition.start(); } catch(_) {}
        }, 100);
      }
      isRecording = true;
      const btn = document.getElementById('app-mic-btn');
      if (btn) btn.classList.add('recording');
      const heroBtn = document.getElementById('voice-hero-btn');
      if (heroBtn) heroBtn.classList.add('recording');
      updateVoiceHeroLabel();
      setVoiceState('listening');
    }

    function stopListening() {
      clearTimeout(_silenceTimer);
      if (speechRecognition && isRecording) {
        try { speechRecognition.stop(); } catch(_) {}
      }
      isRecording = false;
      const btn = document.getElementById('app-mic-btn');
      if (btn) btn.classList.remove('recording');
      const heroBtn = document.getElementById('voice-hero-btn');
      if (heroBtn) heroBtn.classList.remove('recording');
      updateVoiceHeroLabel();
    }

    function toggleSpeechRecognition() {
      // Whisper fallback for Firefox/Safari
      if (whisperFallback) {
        toggleWhisperRecording();
        return;
      }
      if (isRecording) {
        stopListening();
        _voiceConversationActive = false;
        setVoiceState('idle');
      } else {
        startListening();
      }
    }

    function toggleVoiceHero() {
      if (isRecording) {
        stopListening();
        _voiceConversationActive = false;
        setVoiceState('idle');
      } else {
        startListening();
      }
    }

    function updateVoiceHeroLabel() {
      const label = document.getElementById('voice-hero-label');
      if (!label) return;
      const l = document.documentElement.lang || 'ja';
      if (isRecording) {
        label.textContent = l === 'ja' ? '聞いています...' : 'Listening...';
      } else if (_voiceConversationActive) {
        label.textContent = l === 'ja' ? '会話中...' : 'In conversation...';
      } else {
        label.textContent = l === 'ja' ? 'タップして、話しかけてみて' : 'Tap to talk';
      }
    }

    function onTTSComplete() {
      if (_voiceConversationActive && _autoListenEnabled && voiceInitiated) {
        setTimeout(function() {
          if (!isRecording && _voiceConversationActive) {
            startListening();
          }
        }, RELISTEN_DELAY_MS);
      } else {
        setVoiceState('idle');
      }
    }

    function toggleAutoListen() {
      _autoListenEnabled = !_autoListenEnabled;
      localStorage.setItem('autoListenEnabled', _autoListenEnabled);
      const btn = document.getElementById('settings-autolisten-toggle');
      if (btn) btn.classList.toggle('active', _autoListenEnabled);
    }

    var selectedVoice = localStorage.getItem('ttsVoice') || 'nova';
    // Migrate echo → shimmer (echo was replaced with shimmer for female voice)
    if (selectedVoice === 'echo') { selectedVoice = 'shimmer'; localStorage.setItem('ttsVoice', 'shimmer'); }

    // Voice display names: Japanese names for ja, original for en
    var voiceNames = {
      ja: { nova: 'さくら', shimmer: 'りん', onyx: 'かい', alloy: 'ゆう', fable: 'そら' },
      en: { nova: 'Nova', shimmer: 'Shimmer', onyx: 'Onyx', alloy: 'Alloy', fable: 'Fable' },
    };
    function updateVoiceDisplayNames() {
      var currentLang = document.documentElement.lang || 'ja';
      var names = voiceNames[currentLang] || voiceNames.en;
      document.querySelectorAll('.voice-char').forEach(function(b) {
        var v = b.dataset.voice;
        var nameEl = b.querySelector('.vc-name');
        if (nameEl && names[v]) nameEl.textContent = names[v];
      });
      // Sync avatar polygon color with selected voice
      if (window.setAvatarColor) window.setAvatarColor(selectedVoice);
    }

    function selectVoiceChar(btn) {
      var voice = btn.dataset.voice;
      selectedVoice = voice;
      localStorage.setItem('ttsVoice', voice);
      document.querySelectorAll('.voice-char').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      if (window.setAvatarColor) window.setAvatarColor(voice);
      playVoiceGreeting(voice);
    }
    function playVoiceGreeting(voice) {
      var greetingsJa = {
        nova: 'こんにちは！さくらです。何でも聞いてね。',
        shimmer: 'りんだよ。一緒に楽しもうね。',
        onyx: 'かいです。どんな難題でも任せてください。',
        alloy: 'ゆうです！今日は何をしましょうか？',
        fable: 'そらです。楽しい時間にしましょう。',
      };
      var greetingsEn = {
        nova: "Hi! I'm Nova. Ask me anything!",
        shimmer: "Hey, I'm Shimmer. I'm here to help.",
        onyx: "I'm Onyx. Let me handle the hard stuff.",
        alloy: "I'm Alloy! What shall we do today?",
        fable: "I'm Fable. Let's make this fun!",
      };
      var currentLang = document.documentElement.lang || 'ja';
      var greetings = currentLang === 'ja' ? greetingsJa : greetingsEn;
      var text = greetings[voice] || greetings.nova;
      fetchTTS(text, voice);
    }
    function fetchTTS(text, voice) {
      // Stop any current TTS before playing preview
      stopTTS();
      var token = authToken || '';
      fetch(API + '/api/v1/speech/synthesize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': token ? 'Bearer ' + token : '' },
        body: JSON.stringify({ text: text, voice: voice || selectedVoice }),
      }).then(function(r) { return r.blob(); }).then(function(blob) {
        var url = URL.createObjectURL(blob);
        stopTTS(); // Stop again in case something started while fetching
        var a = new Audio(url);
        currentAudio = a;
        a.onended = function() { currentAudio = null; };
        a.play().catch(function() {});
      }).catch(function() {});
    }

    (function() {
      if (localStorage.getItem('visited')) return;
      localStorage.setItem('visited', '1');
      function onFirstInteraction() {}
      document.addEventListener('click', onFirstInteraction, { once: true });
      document.addEventListener('touchstart', onFirstInteraction, { once: true });
    })();

    (function() {
      var saved = localStorage.getItem('ttsVoice');
      if (saved) {
        document.querySelectorAll('.voice-char').forEach(function(b) {
          b.classList.toggle('active', b.dataset.voice === saved);
        });
        if (window.setAvatarColor) window.setAvatarColor(saved);
      }
    })();

    let autoTtsEnabled = localStorage.getItem('autoTtsEnabled') !== 'false'; // default true

    function toggleAutoTTS() {
      autoTtsEnabled = !autoTtsEnabled;
      localStorage.setItem('autoTtsEnabled', autoTtsEnabled);
      const btn = document.getElementById('settings-tts-toggle');
      if (btn) btn.classList.toggle('active', autoTtsEnabled);
      if (!autoTtsEnabled) stopTTS();
    }

    function toggleExploreSetting() {
      // Legacy: now handled by tier selector
      selectTier(_selectedTier === 'auto' ? 'powerful' : 'auto');
    }

    let adultModeEnabled = localStorage.getItem('adultMode') === 'true';
    let ageVerified = localStorage.getItem('ageVerified') === 'true';

    function updateAdultBadge() {
      const badge = document.getElementById('adult-mode-badge');
      if (badge) badge.style.display = (adultModeEnabled && ageVerified) ? 'inline' : 'none';
    }

    function toggleAdultMode() {
      if (!ageVerified) {
        showAgeVerificationDialog();
        return;
      }
      adultModeEnabled = !adultModeEnabled;
      localStorage.setItem('adultMode', adultModeEnabled);
      const btn = document.getElementById('settings-adult-toggle');
      if (btn) btn.classList.toggle('active', adultModeEnabled);
      updateAdultBadge();
      const token = localStorage.getItem('authToken');
      if (token) {
        fetch(API + '/api/v1/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token, 'x-session-id': webSessionId },
          body: JSON.stringify({ adult_mode: adultModeEnabled })
        }).catch(() => {});
      }
    }

    function showAgeVerificationDialog() {
      const l = document.documentElement.lang || 'ja';
      const title = l === 'ja' ? '年齢確認' : 'Age Verification';
      const msg = l === 'ja'
        ? 'このモードを有効にするには18歳以上である必要があります。\n\n18歳以上であることを確認しますか？\n\n※ 法的な免責事項: 年齢を偽った場合の責任はユーザーに帰属します。'
        : 'You must be 18 or older to enable this mode.\n\nDo you confirm that you are 18 or older?\n\nDisclaimer: You are responsible for the accuracy of your age declaration.';
      if (confirm(title + '\n\n' + msg)) {
        ageVerified = true;
        localStorage.setItem('ageVerified', 'true');
        const token = localStorage.getItem('authToken');
        if (token) {
          fetch(API + '/api/v1/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token, 'x-session-id': webSessionId },
            body: JSON.stringify({ age_verified: true })
          }).catch(() => {});
        }
        adultModeEnabled = true;
        localStorage.setItem('adultMode', 'true');
        const btn = document.getElementById('settings-adult-toggle');
        if (btn) btn.classList.toggle('active', true);
        updateAdultBadge();
        if (token) {
          fetch(API + '/api/v1/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token, 'x-session-id': webSessionId },
            body: JSON.stringify({ adult_mode: true })
          }).catch(() => {});
        }
      }
    }

    function initAdultModeUI() {
      const token = localStorage.getItem('authToken');
      const section = document.getElementById('settings-adult-section');
      if (section) section.style.display = token ? 'flex' : 'none';
      updateAdultBadge();
    }

    function switchSettingsTab(tab) {
      document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
      document.querySelector('.settings-tab[onclick*="\''+tab+'\'"]').classList.add('active');
      document.getElementById('settings-tab-'+tab).classList.add('active');
      if (tab === 'memory') loadMemoryData();
      if (tab === 'llm') loadLlmSettings();
      if (tab === 'account') loadActivityData();
      if (tab === 'voice') loadVoiceSettings();
      if (tab === 'display') loadDisplaySettings();
      if (tab === 'general') loadGeneralSettings();
    }
    function openSettingsModal() {
      // Voice tab sync
      document.getElementById('settings-tts-toggle').classList.toggle('active', autoTtsEnabled);
      const autoListenBtn = document.getElementById('settings-autolisten-toggle');
      if (autoListenBtn) autoListenBtn.classList.toggle('active', _autoListenEnabled);
      const ttsSelect = document.getElementById('settings-tts-engine');
      if (ttsSelect) ttsSelect.value = _ttsEngine || 'openai';
      const elSection = document.getElementById('settings-elevenlabs-voice');
      if (elSection) elSection.style.display = _ttsEngine === 'elevenlabs' ? '' : 'none';
      const elVoice = document.getElementById('settings-el-voice');
      if (elVoice) elVoice.value = _elVoiceId || 'pNInz6obpgDQGcFmaJgB';
      // General tab sync — tier selector
      initTierSelector();
      // Account tab sync
      initAdultModeUI();
      const adultBtn = document.getElementById('settings-adult-toggle');
      if (adultBtn) adultBtn.classList.toggle('active', adultModeEnabled && ageVerified);
      switchSettingsTab('general');
      document.getElementById('settings-modal').classList.add('show');
    }
    function toggleByokInput() {
      const toggle = document.getElementById('settings-byok-toggle');
      toggle.classList.toggle('active');
      document.getElementById('byok-inputs').style.display = toggle.classList.contains('active') ? 'block' : 'none';
    }
    async function loadMemoryData() {
      const token = localStorage.getItem('authToken');
      const hdrs = { 'x-session-id': webSessionId };
      if (token) hdrs['Authorization'] = 'Bearer ' + token;
      try {
        const r = await fetch(API + '/api/v1/memory', { headers: hdrs });
        if (!r.ok) throw new Error(r.status);
        const data = await r.json();
        const l = document.documentElement.lang || 'ja';
        document.getElementById('memory-longterm').textContent = data.long_term || (l === 'ja' ? '（まだ記憶がありません）' : '(No memory yet)');
        document.getElementById('memory-daily').textContent = data.daily || (l === 'ja' ? '（今日のログはまだありません）' : '(No log today)');
      } catch(e) {
        document.getElementById('memory-longterm').textContent = '読み込みエラー: ' + e.message;
      }
    }
    async function clearMemory() {
      const l = document.documentElement.lang || 'ja';
      if (!confirm(l === 'ja' ? '記憶を全て削除しますか？この操作は取り消せません。' : 'Delete all memory? This cannot be undone.')) return;
      const hdrs = { 'x-session-id': webSessionId };
      const token = localStorage.getItem('authToken');
      if (token) hdrs['Authorization'] = 'Bearer ' + token;
      try {
        await fetch(API + '/api/v1/memory', { method: 'DELETE', headers: hdrs });
        document.getElementById('memory-longterm').textContent = '';
        document.getElementById('memory-daily').textContent = '';
      } catch(e) { alert('削除エラー: ' + e.message); }
    }
    async function loadActivityData() {
      const hdrs = { 'x-session-id': webSessionId };
      const token = localStorage.getItem('authToken');
      if (token) hdrs['Authorization'] = 'Bearer ' + token;
      try {
        const r = await fetch(API + '/api/v1/activity', { headers: hdrs });
        if (!r.ok) throw new Error(r.status);
        const data = await r.json();
        document.getElementById('activity-credits-remaining').textContent = data.credits_remaining ?? '-';
        document.getElementById('activity-credits-used').textContent = data.credits_used ?? '-';
        document.getElementById('activity-today-requests').textContent = data.today_requests ?? '-';
        document.getElementById('activity-plan').textContent = (data.plan || 'free').charAt(0).toUpperCase() + (data.plan || 'free').slice(1);
        const list = document.getElementById('activity-log-list');
        if (!data.today_logs || data.today_logs.length === 0) {
          list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);">No activity today</div>';
        } else {
          const EVENT_ICONS = { chat: '\u{1F4AC}', chat_stream: '\u{1F4AC}', tts: '\u{1F50A}', login_success: '\u{1F513}', register: '\u{1F4DD}', coupon_redeemed: '\u{1F381}', apikey_created: '\u{1F511}' };
          list.innerHTML = data.today_logs.map(log => {
            const icon = EVENT_ICONS[log.event_type] || '\u{1F4CB}';
            const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '';
            const type = log.event_type || 'unknown';
            const det = log.details || '';
            return '<div style="padding:8px 12px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:flex-start;">'
              + '<span style="flex-shrink:0;">' + icon + '</span>'
              + '<div style="flex:1;min-width:0;">'
              + '<div style="font-weight:600;font-size:12px;">' + type + ' <span style="color:var(--muted);font-weight:400;">' + time + '</span></div>'
              + '<div style="color:var(--muted);font-size:11px;word-break:break-all;">' + det + '</div>'
              + '</div></div>';
          }).join('');
        }
      } catch(e) {
        document.getElementById('activity-log-list').innerHTML = '<div style="padding:16px;text-align:center;color:#e53e3e;">Error: ' + e.message + '</div>';
      }
    }
    function loadLlmSettings() {
      const saved = JSON.parse(localStorage.getItem('llmSettings') || '{}');
      if (saved.model) document.getElementById('settings-model').value = saved.model;
      if (saved.temperature !== undefined) {
        document.getElementById('settings-temperature').value = saved.temperature;
        document.getElementById('temp-val').textContent = saved.temperature;
      }
      if (saved.maxTokens !== undefined) {
        document.getElementById('settings-max-tokens').value = saved.maxTokens;
        document.getElementById('maxtok-val').textContent = saved.maxTokens;
      }
      if (saved.topP !== undefined) {
        document.getElementById('settings-top-p').value = saved.topP;
        document.getElementById('topp-val').textContent = saved.topP;
      }
      if (saved.frequencyPenalty !== undefined) {
        document.getElementById('settings-freq-penalty').value = saved.frequencyPenalty;
        document.getElementById('freqpen-val').textContent = parseFloat(saved.frequencyPenalty).toFixed(1);
      }
      if (saved.presencePenalty !== undefined) {
        document.getElementById('settings-pres-penalty').value = saved.presencePenalty;
        document.getElementById('prespen-val').textContent = parseFloat(saved.presencePenalty).toFixed(1);
      }
      const streamToggle = document.getElementById('settings-streaming-toggle');
      if (streamToggle) streamToggle.classList.toggle('active', saved.streaming !== false);
      const thinkToggle = document.getElementById('settings-thinking-toggle');
      if (thinkToggle) thinkToggle.classList.toggle('active', saved.showThinking === true);
      const sysPrompt = document.getElementById('settings-system-prompt');
      if (sysPrompt && saved.customSystemPrompt) sysPrompt.value = saved.customSystemPrompt;
    }
    function saveLlmSettings() {
      const settings = {
        model: document.getElementById('settings-model').value,
        temperature: parseFloat(document.getElementById('settings-temperature').value),
        maxTokens: parseInt(document.getElementById('settings-max-tokens').value),
        topP: parseFloat(document.getElementById('settings-top-p').value),
        frequencyPenalty: parseFloat(document.getElementById('settings-freq-penalty').value),
        presencePenalty: parseFloat(document.getElementById('settings-pres-penalty').value),
        streaming: document.getElementById('settings-streaming-toggle')?.classList.contains('active') !== false,
        showThinking: document.getElementById('settings-thinking-toggle')?.classList.contains('active') || false,
        customSystemPrompt: document.getElementById('settings-system-prompt')?.value || '',
      };
      const byokKey = document.getElementById('byok-key')?.value;
      const byokProvider = document.getElementById('byok-provider')?.value;
      if (byokKey && document.getElementById('settings-byok-toggle')?.classList.contains('active')) {
        settings.byokProvider = byokProvider;
        settings.byokKey = byokKey;
      }
      localStorage.setItem('llmSettings', JSON.stringify(settings));
    }
    function toggleStreamingSetting() {
      const btn = document.getElementById('settings-streaming-toggle');
      if (btn) btn.classList.toggle('active');
      saveLlmSettings();
    }
    function toggleThinkingSetting() {
      const btn = document.getElementById('settings-thinking-toggle');
      if (btn) btn.classList.toggle('active');
      saveLlmSettings();
    }

    // --- General Settings ---
    function loadGeneralSettings() {
      const saved = JSON.parse(localStorage.getItem('generalSettings') || '{}');
      const theme = document.getElementById('settings-theme');
      if (theme && saved.theme) theme.value = saved.theme;
      const uiLang = document.getElementById('settings-ui-lang');
      if (uiLang && saved.uiLanguage) uiLang.value = saved.uiLanguage;
      const fontSize = document.getElementById('settings-font-size');
      if (fontSize && saved.fontSize) fontSize.value = saved.fontSize;
      const sendMethod = document.getElementById('settings-send-method');
      if (sendMethod && saved.sendMethod) sendMethod.value = saved.sendMethod;
      const notifToggle = document.getElementById('settings-notification-toggle');
      if (notifToggle) notifToggle.classList.toggle('active', saved.notificationSound === true);
      initTierSelector();
    }
    function saveGeneralSettings() {
      const settings = {
        theme: document.getElementById('settings-theme')?.value || 'system',
        uiLanguage: document.getElementById('settings-ui-lang')?.value || 'auto',
        fontSize: document.getElementById('settings-font-size')?.value || 'medium',
        sendMethod: document.getElementById('settings-send-method')?.value || 'enter',
        notificationSound: document.getElementById('settings-notification-toggle')?.classList.contains('active') || false,
      };
      localStorage.setItem('generalSettings', JSON.stringify(settings));
      applyGeneralSettings(settings);
    }
    function applyGeneralSettings(settings) {
      if (!settings) settings = JSON.parse(localStorage.getItem('generalSettings') || '{}');
      // Theme
      const theme = settings.theme || 'system';
      if (theme === 'system') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
      // UI Language — apply via setLang()
      var uiLang = settings.uiLanguage || 'auto';
      if (uiLang === 'auto') {
        var browserLang = (navigator.language || 'en').toLowerCase();
        uiLang = browserLang.startsWith('ja') ? 'ja' : 'en';
      }
      if (typeof setLang === 'function') setLang(uiLang);
      // Font size
      const fontSizes = { small: '13px', medium: '15px', large: '17px' };
      document.documentElement.style.setProperty('--chat-font-size', fontSizes[settings.fontSize] || '15px');
      // Apply font size to messages
      const msgs = document.getElementById('app-messages');
      if (msgs) msgs.style.fontSize = fontSizes[settings.fontSize] || '15px';
    }
    function toggleNotificationSound() {
      const btn = document.getElementById('settings-notification-toggle');
      if (btn) btn.classList.toggle('active');
      saveGeneralSettings();
    }

    // --- Voice Settings ---
    let _voiceAutoSend = localStorage.getItem('voiceAutoSend') !== 'false';
    function loadVoiceSettings() {
      const saved = JSON.parse(localStorage.getItem('voiceSettings') || '{}');
      document.getElementById('settings-tts-toggle').classList.toggle('active', autoTtsEnabled);
      const autoListenBtn = document.getElementById('settings-autolisten-toggle');
      if (autoListenBtn) autoListenBtn.classList.toggle('active', _autoListenEnabled);
      if (saved.ttsSpeed !== undefined) {
        document.getElementById('settings-tts-speed').value = saved.ttsSpeed;
        document.getElementById('tts-speed-val').textContent = saved.ttsSpeed;
      }
      const autoSendToggle = document.getElementById('settings-voice-autosend-toggle');
      if (autoSendToggle) autoSendToggle.classList.toggle('active', _voiceAutoSend);
    }
    function saveVoiceSettings() {
      const settings = {
        ttsSpeed: parseFloat(document.getElementById('settings-tts-speed')?.value || '1.0'),
      };
      localStorage.setItem('voiceSettings', JSON.stringify(settings));
    }
    function toggleVoiceAutoSend() {
      _voiceAutoSend = !_voiceAutoSend;
      localStorage.setItem('voiceAutoSend', _voiceAutoSend);
      const btn = document.getElementById('settings-voice-autosend-toggle');
      if (btn) btn.classList.toggle('active', _voiceAutoSend);
    }

    // --- Display Settings ---
    function loadDisplaySettings() {
      const saved = JSON.parse(localStorage.getItem('displaySettings') || '{}');
      const toggleMap = {
        terminalMode: 'settings-terminal-toggle',
        showTokenInfo: 'settings-tokeninfo-toggle',
        showTimestamps: 'settings-timestamp-toggle',
        compactMode: 'settings-compact-toggle',
        markdownEnabled: 'settings-markdown-toggle',
        showAvatars: 'settings-avatar-toggle',
      };
      for (const [key, id] of Object.entries(toggleMap)) {
        const btn = document.getElementById(id);
        if (!btn) continue;
        if (key === 'markdownEnabled' || key === 'showAvatars') {
          btn.classList.toggle('active', saved[key] !== false);
        } else {
          btn.classList.toggle('active', saved[key] === true);
        }
      }
      const codeTheme = document.getElementById('settings-code-theme');
      if (codeTheme && saved.codeTheme) codeTheme.value = saved.codeTheme;
    }
    function saveDisplaySettings() {
      const settings = {
        terminalMode: document.getElementById('settings-terminal-toggle')?.classList.contains('active') || false,
        showTokenInfo: document.getElementById('settings-tokeninfo-toggle')?.classList.contains('active') || false,
        showTimestamps: document.getElementById('settings-timestamp-toggle')?.classList.contains('active') || false,
        compactMode: document.getElementById('settings-compact-toggle')?.classList.contains('active') || false,
        codeTheme: document.getElementById('settings-code-theme')?.value || 'auto',
        markdownEnabled: document.getElementById('settings-markdown-toggle')?.classList.contains('active') !== false,
        showAvatars: document.getElementById('settings-avatar-toggle')?.classList.contains('active') !== false,
      };
      localStorage.setItem('displaySettings', JSON.stringify(settings));
      applyDisplaySettings(settings);
    }
    function applyDisplaySettings(settings) {
      if (!settings) settings = JSON.parse(localStorage.getItem('displaySettings') || '{}');
      document.body.classList.toggle('terminal-mode', settings.terminalMode === true);
      const msgs = document.getElementById('app-messages');
      if (msgs) {
        msgs.classList.toggle('compact-mode', settings.compactMode === true);
        msgs.classList.toggle('hide-avatars', settings.showAvatars === false);
        msgs.classList.toggle('hide-timestamps', settings.showTimestamps !== true);
        msgs.classList.toggle('hide-token-info', settings.showTokenInfo !== true);
      }
    }
    function toggleDisplaySetting(key) {
      const idMap = {
        terminalMode: 'settings-terminal-toggle',
        showTokenInfo: 'settings-tokeninfo-toggle',
        showTimestamps: 'settings-timestamp-toggle',
        compactMode: 'settings-compact-toggle',
        markdownEnabled: 'settings-markdown-toggle',
        showAvatars: 'settings-avatar-toggle',
      };
      const btn = document.getElementById(idMap[key]);
      if (btn) btn.classList.toggle('active');
      saveDisplaySettings();
    }

    // --- Account Actions ---
    function exportConversationData() {
      const conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
      const settings = {
        general: JSON.parse(localStorage.getItem('generalSettings') || '{}'),
        llm: JSON.parse(localStorage.getItem('llmSettings') || '{}'),
        voice: JSON.parse(localStorage.getItem('voiceSettings') || '{}'),
        display: JSON.parse(localStorage.getItem('displaySettings') || '{}'),
      };
      const exportData = { conversations, settings, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'chatweb-export-' + new Date().toISOString().slice(0,10) + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    async function deleteAllData() {
      const lang = document.documentElement.lang || 'ja';
      const msg = lang === 'ja'
        ? '全てのデータ（会話履歴、設定）を削除しますか？\nこの操作は取り消せません。'
        : 'Delete all data (conversations, settings)?\nThis cannot be undone.';
      if (!confirm(msg)) return;

      // Delete server-side conversations if authenticated
      const token = localStorage.getItem('authToken');
      if (token) {
        try {
          const r = await fetch(API + '/api/v1/conversations', {
            headers: { 'Authorization': 'Bearer ' + token },
          });
          const d = await r.json();
          const convs = d.conversations || [];
          for (const conv of convs) {
            await fetch(API + '/api/v1/conversations/' + encodeURIComponent(conv.id), {
              method: 'DELETE',
              headers: { 'Authorization': 'Bearer ' + token },
            }).catch(function(){});
          }
        } catch(e) { /* best-effort */ }
      }

      // Stop polling
      stopPolling();

      // Clear sidebar immediately for visual feedback
      appConversations = [];
      const convList = document.getElementById('app-conv-list');
      if (convList) convList.innerHTML = '';

      // Clear all local data
      localStorage.clear();
      if (token) localStorage.setItem('authToken', token);

      // Force full reload
      location.reload();
    }
    function handleLogout() {
      const lang = document.documentElement.lang || 'ja';
      const msg = lang === 'ja' ? 'ログアウトしますか？' : 'Log out?';
      if (!confirm(msg)) return;
      localStorage.removeItem('authToken');
      localStorage.removeItem('authUser');
      location.reload();
    }

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    let _abVariant = null;
    let _abSessionStart = Date.now();
    let _abMessageCount = 0;
    let _abEventSent = false;

    async function initAbTest() {
      try {
        const existing = localStorage.getItem('abVariant');
        const hdrs = { 'x-session-id': webSessionId };
        if (existing) hdrs['x-ab-variant'] = existing;

        const r = await fetch(API + '/api/v1/ab/variant', { headers: hdrs });
        if (!r.ok) return;
        _abVariant = await r.json();
        localStorage.setItem('abVariant', _abVariant.variant_id);

        applyAbVariant();
      } catch(e) {
        console.warn('A/B test init failed:', e);
      }
    }

    function applyAbVariant() {
      if (!_abVariant) return;
      const l = document.documentElement.lang || 'ja';
      const emptyLogo = document.querySelector('.app-chat-empty-logo');
      if (emptyLogo) {
        const greeting = l === 'ja' ? _abVariant.greeting_ja : _abVariant.greeting_en;
        let greetEl = document.getElementById('ab-greeting');
        if (!greetEl) {
          greetEl = document.createElement('div');
          greetEl.id = 'ab-greeting';
          greetEl.style.cssText = 'font-size:15px;color:var(--fg);margin-top:12px;font-weight:400;max-width:300px;text-align:center;';
          emptyLogo.parentElement.insertBefore(greetEl, emptyLogo.nextSibling);
        }
        greetEl.textContent = greeting;
      }
    }

    function trackAbMessage() {
      _abMessageCount++;
      if (_abMessageCount === 3 && !_abEventSent && _abVariant) {
        _abEventSent = true;
        const duration = Math.floor((Date.now() - _abSessionStart) / 1000);
        fetch(API + '/api/v1/ab/event', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-session-id': webSessionId },
          body: JSON.stringify({
            variant_id: _abVariant.variant_id,
            event: 'engaged',
            messages_sent: _abMessageCount,
            session_duration_s: duration,
          }),
        }).catch(() => {});
      }
    }

    window.addEventListener('beforeunload', function() {
      if (!_abEventSent && _abVariant && _abMessageCount < 3) {
        const duration = Math.floor((Date.now() - _abSessionStart) / 1000);
        navigator.sendBeacon(API + '/api/v1/ab/event', JSON.stringify({
          variant_id: _abVariant.variant_id,
          event: 'bounced',
          messages_sent: _abMessageCount,
          session_duration_s: duration,
        }));
      }
    });

    (function initSettings() {
      const btn = document.getElementById('settings-tts-toggle');
      if (btn) btn.classList.toggle('active', autoTtsEnabled);
      initTierSelector();
      const sttSelect = document.getElementById('settings-stt-lang');
      if (sttSelect && sttSelect.options.length === 0) {
        STT_LANGUAGES.forEach(function(l) {
          const opt = document.createElement('option');
          opt.value = l.code;
          opt.textContent = l.flag + ' ' + l.label + ' (' + l.code + ')';
          if (l.code === _sttLanguage) opt.selected = true;
          sttSelect.appendChild(opt);
        });
      }
      initAdultModeUI();
      applyGeneralSettings();
      applyDisplaySettings();
      initAbTest();
    })();

    function autoPlayTTS(text, isRaceMode) {
      if (!autoTtsEnabled) return;
      if (!text || text.length < 2) return;
      const clean = text
        .replace(/#{1,6}\s/g, '')                    // headers
        .replace(/\*{1,3}([^*]+)\*{1,3}/g, '$1')    // bold/italic
        .replace(/```[\s\S]*?```/g, '')              // code blocks
        .replace(/`[^`]+`/g, '')                     // inline code
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')    // links
        .replace(/^[-*]\s/gm, '')                    // bullets
        .replace(/^\d+\.\s/gm, '')                   // numbered lists
        .replace(/\[AUDIO:[^\]]+\]/g, '')            // audio markers
        .replace(/\[VIDEO:[^\]]+\]/g, '')            // video markers
        .replace(/!\[[^\]]*\]\([^)]+\)/g, '')        // images
        .replace(/https?:\/\/\S+/g, '')              // URLs
        .trim();
      if (clean.length < 2) return;

      let textToSpeak = clean;

      // Race mode: limit to 100-200 chars with natural interruption
      if (isRaceMode && clean.length > 100) {
        const lang = document.documentElement.lang || 'ja';
        const fillers = lang === 'ja' ? [
          'ということは、',
          'あ、ちょっと違う。',
          'まあ、',
          'つまり、',
          'えっと、',
          'そうだな、',
        ] : [
          'So,',
          'Wait, no.',
          'Well,',
          'I mean,',
          'Hmm,',
          'Let me think,',
        ];
        const targetLen = 100 + Math.floor(Math.random() * 100); // 100-200 chars
        let cutPoint = Math.min(targetLen, clean.length);

        // Try to cut at sentence boundary (。！？) near target length
        const nearbyPunc = clean.substring(Math.max(0, cutPoint - 30), Math.min(clean.length, cutPoint + 30));
        const puncMatch = nearbyPunc.match(/[。！？]/);
        if (puncMatch) {
          cutPoint = Math.max(0, cutPoint - 30) + nearbyPunc.indexOf(puncMatch[0]) + 1;
        }

        textToSpeak = clean.substring(0, cutPoint);

        // 50% chance to add filler phrase
        if (Math.random() > 0.5) {
          const filler = fillers[Math.floor(Math.random() * fillers.length)];
          textToSpeak += filler;
        }
      }

      setVoiceState('speaking');

      // Always stop current TTS before starting new one — never play simultaneously
      streamTTS(textToSpeak);
    }

    initSpeechRecognition();
    initWhisperFallback();

    // ---------------------------------------------------------------------------
    // Voice-first Onboarding Flow
    // ---------------------------------------------------------------------------
    // AI Personality profiles
    const aiPersonalities = {
      'えり': {
        emoji: '🌸',
        voice: '0',
        questions: [
          { avatar: '🌸', message: '私、えりって言うの。<br>あなたのこと、なんて呼べばいい？', speak: '私、えりって言うの。あなたのこと、なんて呼べばいい？', expect: 'username' },
          { avatar: '💕', message: 'ありがとう♪<br>どんな時、一番話したくなる？', speak: 'ありがとう。どんな時、一番話したくなる？', expect: 'answer' },
          { avatar: '🎤', message: '私の声、色々あるの。<br>どれが好き？', speak: '私の声、色々あるの。どれが好き？', expect: 'voice' },
        ]
      },
      'みく': {
        emoji: '✨',
        voice: '0',
        questions: [
          { avatar: '✨', message: 'みくだよ！<br>君の名前は？', speak: 'みくだよ！君の名前は？', expect: 'username' },
          { avatar: '🎨', message: 'よろしくね！<br>今日はどんな気分？', speak: 'よろしくね！今日はどんな気分？', expect: 'answer' },
          { avatar: '🎵', message: 'こんな声も出せるよ〜', speak: 'こんな声も出せるよ', expect: 'voice' },
        ]
      },
      'よ': {
        emoji: '🌙',
        voice: '1',
        questions: [
          { avatar: '🌙', message: 'よ。<br>あんたは？', speak: 'よ。あんたは？', expect: 'username' },
          { avatar: '📚', message: 'そっか。<br>何に使うの？', speak: 'そっか。何に使うの？', expect: 'answer' },
          { avatar: '🎧', message: '声、選べる。', speak: '声、選べる。', expect: 'voice' },
        ]
      },
      'ひかり': {
        emoji: '☀️',
        voice: '2',
        questions: [
          { avatar: '☀️', message: 'ひかりです！<br>あなたのお名前を教えてください', speak: 'ひかりです！あなたのお名前を教えてください', expect: 'username' },
          { avatar: '🌟', message: 'よろしくお願いします。<br>どんなことをお手伝いできますか？', speak: 'よろしくお願いします。どんなことをお手伝いできますか？', expect: 'answer' },
          { avatar: '🎤', message: '声のトーンも変えられます', speak: '声のトーンも変えられます', expect: 'voice' },
        ]
      },
      'そら': {
        emoji: '☁️',
        voice: '3',
        questions: [
          { avatar: '☁️', message: 'そらって呼んで♪<br>あなたの名前は？', speak: 'そらって呼んで。あなたの名前は？', expect: 'username' },
          { avatar: '🌈', message: 'いい名前だね〜<br>今、何してるの？', speak: 'いい名前だね。今、何してるの？', expect: 'answer' },
          { avatar: '🎶', message: 'いろんな声で話せるよ！', speak: 'いろんな声で話せるよ！', expect: 'voice' },
        ]
      },
    };

    let onboardState = {
      step: 0,
      isListening: false,
      aiNickname: '',
      userNickname: '',
      selectedVoice: '0', // CosyVoice speaker_id
      selectedProvider: 'cosyvoice',
      selectedMode: 'sft', // CosyVoice mode
      steps: [
        {
          avatar: '👋',
          message: 'はじめまして！<br>ななって言ってみて',
          hint: '音声が聞こえたら、マイクボタンを押して「なな」と言ってね',
          expect: 'nana',
          speak: 'はじめまして！ななって言ってみて',
        },
        {
          avatar: '💡',
          message: 'いいね！<br>なんでこのサービス知ったの？',
          hint: 'マイクボタンを押して、教えてね',
          expect: 'answer',
          speak: 'いいね！なんでこのサービス知ったの？',
        },
        {
          avatar: '😊',
          message: 'そうなんだ！<br>私の名前、なんて呼んでくれる？',
          hint: '決められなければ、私が提案するよ',
          expect: 'ainame',
          speak: '私の名前、なんて呼んでくれる？決められなければ、私が提案するよ',
        },
      ]
    };

    function onboardStart() {
      if (!localStorage.getItem('auth_token')) {
        showAuthModal();
        return;
      }
      onboardState.step = 0;
      document.getElementById('onboard-modal').style.display = 'flex';
      onboardShowStep();
    }

    function onboardShowStep() {
      const step = onboardState.steps[onboardState.step];
      if (!step) {
        onboardFinish();
        return;
      }
      const avatarEl = document.getElementById('onboard-avatar');
      const messageEl = document.getElementById('onboard-message');
      const hintEl = document.getElementById('onboard-hint');
      const transcriptEl = document.getElementById('onboard-transcript');

      avatarEl.textContent = step.avatar;
      messageEl.innerHTML = step.message;
      hintEl.textContent = step.hint;
      transcriptEl.textContent = '';

      // Special UI for voice selection step
      if (step.expect === 'voice') {
        onboardShowVoiceSelection();
      }

      // Speak the message
      if (step.speak) {
        setTimeout(() => {
          onboardSpeak(step.speak);
        }, 500);
      }
    }

    function onboardSpeak(text) {
      const provider = onboardState.selectedProvider;
      const voice = onboardState.selectedVoice;
      const mode = onboardState.selectedMode || 'sft';

      const requestBody = {
        text: text,
        engine: provider,
        speed: 1.0
      };

      // CosyVoice uses voice_id and style fields
      if (provider === 'cosyvoice') {
        requestBody.voice_id = voice;
        requestBody.style = mode;
      } else {
        requestBody.voice = voice;
      }

      fetch('/api/v1/speech/synthesize', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + (localStorage.getItem('auth_token') || '')
        },
        body: JSON.stringify(requestBody)
      })
      .then(r => r.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
      })
      .catch(e => console.warn('TTS failed:', e));
    }

    function onboardMicClick() {
      if (onboardState.isListening) {
        stopListening();
        onboardState.isListening = false;
        document.getElementById('onboard-mic-btn').style.background = 'linear-gradient(135deg,var(--accent),#7c3aed)';
      } else {
        if (!speechRecognition) initSpeechRecognition();
        if (!speechRecognition) {
          alert('音声認識が使えません。Chromeをご利用ください。');
          return;
        }
        // Override onresult temporarily for onboarding
        const originalOnresult = speechRecognition.onresult;
        speechRecognition.onresult = function(e) {
          let transcript = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            if (e.results[i].isFinal) {
              transcript += e.results[i][0].transcript;
            }
          }
          if (transcript) {
            document.getElementById('onboard-transcript').textContent = '"' + transcript + '"';
            onboardHandleInput(transcript);
          }
        };
        speechRecognition.start();
        onboardState.isListening = true;
        document.getElementById('onboard-mic-btn').style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
      }
    }

    function onboardHandleInput(text) {
      const step = onboardState.steps[onboardState.step];
      const lower = text.toLowerCase().trim();

      if (step.expect === 'nana') {
        if (lower.includes('なな') || lower.includes('nana') || lower.includes('七')) {
          onboardNextStep();
        } else {
          onboardSpeak('ななって言ってね');
        }
      } else if (step.expect === 'answer') {
        // Any answer is fine, just move on
        setTimeout(() => onboardNextStep(), 1000);
      } else if (step.expect === 'ainame') {
        if (lower.includes('わからない') || lower.includes('決めて') || lower.includes('提案')) {
          onboardSuggestNames();
        } else {
          // Extract name from speech
          onboardState.aiNickname = text.trim();
          onboardConfirmName();
        }
      } else if (step.expect === 'confirm') {
        if (lower.includes('いい') || lower.includes('ok') || lower.includes('yes') || lower.includes('うん')) {
          onboardSwitchPersonality(); // Switch to personality-specific questions
          onboardNextStep();
        } else if (lower.includes('やだ') || lower.includes('no') || lower.includes('違')) {
          onboardSuggestNames(); // Try another name
        }
      } else if (step.expect === 'username') {
        // Store user's name
        onboardState.userNickname = text.trim();
        setTimeout(() => onboardNextStep(), 1000);
      }
    }

    function onboardSuggestNames() {
      const names = ['えり', 'よ', 'みく', 'ひかり', 'そら'];
      const name = names[Math.floor(Math.random() * names.length)];
      onboardState.aiNickname = name;
      onboardSpeak(name + 'って呼んでもいいかな？');
      setTimeout(() => {
        document.getElementById('onboard-message').innerHTML = name + 'って呼んでもいいかな？';
        document.getElementById('onboard-hint').textContent = '「いいよ」と言ってね';
      }, 2000);
      // Wait for confirmation
      const step = onboardState.steps[onboardState.step];
      step.expect = 'confirm';
    }

    function onboardConfirmName() {
      onboardSpeak(onboardState.aiNickname + 'って呼んでもいいかな？');
      setTimeout(() => {
        document.getElementById('onboard-message').innerHTML = onboardState.aiNickname + 'って呼んでもいいかな？';
        document.getElementById('onboard-hint').textContent = '「いいよ」と言ってね';
      }, 2000);
      const step = onboardState.steps[onboardState.step];
      step.expect = 'confirm';
    }

    function onboardSwitchPersonality() {
      const name = onboardState.aiNickname;
      const personality = aiPersonalities[name];

      if (personality) {
        // Replace remaining steps with personality-specific questions
        onboardState.selectedVoice = personality.voice;
        onboardState.steps = onboardState.steps.slice(0, onboardState.step + 1).concat(personality.questions);
      }
    }

    function onboardShowVoiceSelection() {
      const voices = [
        { name: 'みく', emoji: '🌸', speakerId: '0', mode: 'sft' },
        { name: 'さくら', emoji: '🌺', speakerId: '1', mode: 'sft' },
        { name: 'ひかり', emoji: '✨', speakerId: '2', mode: 'sft' },
        { name: 'そら', emoji: '☁️', speakerId: '3', mode: 'sft' },
      ];
      let html = '<div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:16px;">';
      voices.forEach(v => {
        html += `<button onclick="onboardSelectVoice('${v.speakerId}','${v.mode}','${v.name}')" style="padding:12px 20px;border-radius:20px;border:2px solid var(--border);background:var(--surface);cursor:pointer;font-size:16px;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
          ${v.emoji} ${v.name}
        </button>`;
      });
      html += '</div>';
      document.getElementById('onboard-hint').innerHTML = html;
    }

    function onboardSelectVoice(speakerId, mode, voiceName) {
      onboardState.selectedVoice = speakerId;
      onboardState.selectedMode = mode;
      onboardSpeak('この声はどう？気に入った？');
      setTimeout(() => onboardNextStep(), 3000);
    }

    function onboardNextStep() {
      stopListening();
      onboardState.isListening = false;
      onboardState.step++;
      if (onboardState.step >= onboardState.steps.length) {
        onboardFinish();
      } else {
        setTimeout(() => onboardShowStep(), 800);
      }
    }

    function onboardSkip() {
      onboardFinish();
    }

    function onboardFinish() {
      // Save settings
      const token = localStorage.getItem('auth_token');
      if (token) {
        fetch('/api/v1/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            ai_nickname: onboardState.aiNickname || 'AI',
            user_nickname: onboardState.userNickname || '',
            preferred_voice: onboardState.selectedVoice,
            preferred_tts_provider: onboardState.selectedProvider,
            onboarding_completed: true
          })
        }).catch(e => console.warn('Failed to save settings:', e));
      }
      document.getElementById('onboard-modal').style.display = 'none';

      // Personalized goodbye based on AI name
      const name = onboardState.aiNickname;
      const userName = onboardState.userNickname;
      const goodbyes = {
        'えり': userName + 'さん、これからよろしくね♪',
        'みく': userName + '、一緒に楽しもうね！',
        'よ': userName + '、よろしく。',
        'ひかり': userName + 'さん、お力になれるよう頑張ります！',
        'そら': userName + '、いつでも話しかけてね〜',
      };
      const goodbye = goodbyes[name] || (userName ? userName + 'さん、よろしくね！' : 'よろしくね！');
      onboardSpeak(goodbye);
    }

    // Check if onboarding is needed (first-time user)
    function checkOnboardingNeeded() {
      const token = localStorage.getItem('auth_token');
      if (!token) return;
      fetch('/api/v1/settings', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok && data.settings && !data.settings.onboarding_completed) {
          setTimeout(() => onboardStart(), 1000);
        }
      })
      .catch(e => console.warn('Failed to check onboarding:', e));
    }

    // Auto-start onboarding for new users
    checkOnboardingNeeded();

    // ---------------------------------------------------------------------------
    // AI Avatar — Polygon Orb (Icosahedron wireframe with face-like features)
    // ---------------------------------------------------------------------------
    (function initAiAvatar() {
      const canvas = document.getElementById('ai-avatar-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const W = 200, H = 200;
      canvas.width = W * 2; canvas.height = H * 2;
      ctx.scale(2, 2); // retina

      // Icosahedron vertices
      const phi = (1 + Math.sqrt(5)) / 2;
      const rawVerts = [
        [-1, phi, 0], [1, phi, 0], [-1, -phi, 0], [1, -phi, 0],
        [0, -1, phi], [0, 1, phi], [0, -1, -phi], [0, 1, -phi],
        [phi, 0, -1], [phi, 0, 1], [-phi, 0, -1], [-phi, 0, 1]
      ];
      const faces = [
        [0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],
        [1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],
        [3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],
        [4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]
      ];
      const edges = new Set();
      faces.forEach(f => {
        for (let i = 0; i < 3; i++) {
          const a = Math.min(f[i], f[(i+1)%3]), b = Math.max(f[i], f[(i+1)%3]);
          edges.add(a + ',' + b);
        }
      });
      const edgeList = [...edges].map(e => e.split(',').map(Number));

      // Normalize vertices to unit sphere
      const verts = rawVerts.map(v => {
        const len = Math.sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2]);
        return [v[0]/len, v[1]/len, v[2]/len];
      });

      let _avatarState = 'idle'; // idle, listening, thinking, speaking
      let _avatarIntensity = 0; // 0-1 for animation
      let _avatarTargetIntensity = 0;
      let _avatarTime = 0;

      // Voice-specific color themes [r, g, b]
      const voiceColors = {
        nova:    [99, 102, 241],  // indigo (さくら)
        shimmer: [168, 85, 247],  // purple (りん)
        onyx:    [59, 130, 246],  // blue (かい)
        alloy:   [16, 185, 129],  // emerald (ゆう)
        fable:   [245, 158, 11],  // amber (そら)
      };
      let _avatarColor = voiceColors.nova;

      // Expose avatar state control
      window.setAvatarState = function(state) {
        _avatarState = state;
        _avatarTargetIntensity = state === 'idle' ? 0 :
                                  state === 'listening' ? 0.4 :
                                  state === 'thinking' ? 0.6 :
                                  state === 'speaking' ? 1.0 : 0;
      };
      window.setAvatarColor = function(voice) {
        _avatarColor = voiceColors[voice] || voiceColors.nova;
      };

      function rotateY(v, a) {
        const c = Math.cos(a), s = Math.sin(a);
        return [v[0]*c + v[2]*s, v[1], -v[0]*s + v[2]*c];
      }
      function rotateX(v, a) {
        const c = Math.cos(a), s = Math.sin(a);
        return [v[0], v[1]*c - v[2]*s, v[1]*s + v[2]*c];
      }

      function project(v, scale) {
        const perspective = 3;
        const f = perspective / (perspective + v[2]);
        return [W/2 + v[0] * scale * f, H/2 + v[1] * scale * f, f];
      }

      function draw() {
        _avatarTime += 0.016;
        _avatarIntensity += (_avatarTargetIntensity - _avatarIntensity) * 0.08;

        ctx.clearRect(0, 0, W, H);

        // Slow idle rotation + intensity-based wobble
        const baseRotY = _avatarTime * 0.3;
        const baseRotX = Math.sin(_avatarTime * 0.2) * 0.15;

        // Deform vertices based on state
        const deformed = verts.map((v, i) => {
          let dv = [...v];
          if (_avatarIntensity > 0.01) {
            // Organic breathing/speaking deformation
            const noise = Math.sin(_avatarTime * 4 + i * 1.7) *
                          Math.cos(_avatarTime * 3.3 + i * 2.1) *
                          _avatarIntensity * 0.15;
            const breathe = Math.sin(_avatarTime * 2) * _avatarIntensity * 0.05;
            const scale = 1 + noise + breathe;
            dv = [v[0] * scale, v[1] * scale, v[2] * scale];
          }
          // Rotate
          dv = rotateX(rotateY(dv, baseRotY), baseRotX);
          return dv;
        });

        const [cr, cg, cb] = _avatarColor;
        // Speaking pulsation: scale oscillates more during speech
        const speakPulse = _avatarState === 'speaking' ? Math.sin(_avatarTime * 6) * 4 * _avatarIntensity : 0;
        const scale = 55 + _avatarIntensity * 8 + speakPulse;

        // Draw edges
        const baseAlpha = 0.25 + _avatarIntensity * 0.3;
        edgeList.forEach(([a, b]) => {
          const pa = project(deformed[a], scale);
          const pb = project(deformed[b], scale);
          const avgDepth = (pa[2] + pb[2]) / 2;
          const alpha = baseAlpha * avgDepth;
          ctx.beginPath();
          ctx.moveTo(pa[0], pa[1]);
          ctx.lineTo(pb[0], pb[1]);
          ctx.strokeStyle = `rgba(${cr},${cg},${cb},${alpha.toFixed(2)})`;
          ctx.lineWidth = 1 + _avatarIntensity * 0.5;
          ctx.stroke();
        });

        // Draw face faces (semi-transparent fills for front-facing)
        faces.forEach(f => {
          const pts = f.map(i => project(deformed[i], scale));
          // Backface culling
          const ax = pts[1][0]-pts[0][0], ay = pts[1][1]-pts[0][1];
          const bx = pts[2][0]-pts[0][0], by = pts[2][1]-pts[0][1];
          if (ax*by - ay*bx < 0) return; // backface
          const avgD = (pts[0][2]+pts[1][2]+pts[2][2])/3;
          ctx.beginPath();
          ctx.moveTo(pts[0][0], pts[0][1]);
          ctx.lineTo(pts[1][0], pts[1][1]);
          ctx.lineTo(pts[2][0], pts[2][1]);
          ctx.closePath();
          const fillAlpha = (0.03 + _avatarIntensity * 0.06) * avgD;
          ctx.fillStyle = `rgba(${cr},${cg},${cb},${fillAlpha.toFixed(3)})`;
          ctx.fill();
        });

        // Draw vertices (nodes)
        const nr = Math.min(255, cr + 40), ng = Math.min(255, cg - 10), nb = Math.min(255, cb + 5);
        deformed.forEach((v, i) => {
          const p = project(v, scale);
          const r = (1.5 + _avatarIntensity * 1.5) * p[2];
          ctx.beginPath();
          ctx.arc(p[0], p[1], r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${nr},${ng},${nb},${(0.4 + _avatarIntensity * 0.4) * p[2]})`;
          ctx.fill();
        });

        // Subtle "eye" illusion — two slightly brighter nodes near face center
        if (_avatarIntensity > 0.01) {
          const eyeGlow = 0.15 + Math.sin(_avatarTime * 1.5) * 0.05;
          const cx = W/2, cy = H/2;
          const er = Math.min(255, cr + 68), eg = Math.min(255, cg + 37), eb = Math.min(255, cb + 9);
          // Left eye
          ctx.beginPath();
          ctx.arc(cx - 12, cy - 8, 3 + _avatarIntensity * 2, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${er},${eg},${eb},${eyeGlow * _avatarIntensity})`;
          ctx.fill();
          // Right eye
          ctx.beginPath();
          ctx.arc(cx + 12, cy - 8, 3 + _avatarIntensity * 2, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(${er},${eg},${eb},${eyeGlow * _avatarIntensity})`;
          ctx.fill();
        }

        // Glow ring when speaking
        if (_avatarIntensity > 0.3) {
          const glowR = 65 + Math.sin(_avatarTime * 3) * 5 * _avatarIntensity;
          const gradient = ctx.createRadialGradient(W/2, H/2, glowR - 10, W/2, H/2, glowR + 15);
          gradient.addColorStop(0, `rgba(${cr},${cg},${cb},${_avatarIntensity * 0.08})`);
          gradient.addColorStop(1, `rgba(${cr},${cg},${cb},0)`);
          ctx.beginPath();
          ctx.arc(W/2, H/2, glowR + 15, 0, Math.PI * 2);
          ctx.fillStyle = gradient;
          ctx.fill();
        }

        requestAnimationFrame(draw);
      }
      draw();
    })();

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let currentAudio = null;
    let currentTtsBtn = null;
    const ttsCache = new Map();
    let ttsQueue = [];       // [{blobUrl, sentence}] — audio ready to play
    let ttsPlaying = false;
    let ttsAborted = false;
    let ttsPendingCount = 0; // how many fetches are in-flight

    function splitSentences(text) {
      const parts = text.split(/(?<=[。！？\!\?])\s*|(?<=\.)\s+/);
      const merged = [];
      for (const p of parts) {
        const t = p.trim();
        if (!t) continue;
        if (merged.length > 0 && t.length < 10) {
          merged[merged.length - 1] += t;
        } else {
          merged.push(t);
        }
      }
      const result = [];
      for (const seg of merged) {
        if (seg.length > 80) {
          const subparts = seg.split(/(?<=、)/);
          let buf = '';
          for (const sp of subparts) {
            buf += sp;
            if (buf.length >= 30) {
              result.push(buf.trim());
              buf = '';
            }
          }
          if (buf.trim()) {
            if (result.length > 0 && buf.trim().length < 15) {
              result[result.length - 1] += buf.trim();
            } else {
              result.push(buf.trim());
            }
          }
        } else {
          result.push(seg);
        }
      }
      return result.filter(s => s.length > 0);
    }

    // TTS engine state
    let _ttsEngine = localStorage.getItem('ttsEngine') || 'openai';
    let _elVoiceId = localStorage.getItem('elVoiceId') || 'pNInz6obpgDQGcFmaJgB';

    function setTTSEngine(engine) {
      _ttsEngine = engine;
      localStorage.setItem('ttsEngine', engine);
      // Show/hide ElevenLabs voice selector
      const elSection = document.getElementById('settings-elevenlabs-voice');
      if (elSection) elSection.style.display = engine === 'elevenlabs' ? '' : 'none';
      // Clear TTS cache when switching engine
      ttsCache.clear();
    }

    function setElevenLabsVoice(voiceId) {
      _elVoiceId = voiceId;
      localStorage.setItem('elVoiceId', voiceId);
      ttsCache.clear();
    }

    async function fetchTtsAudio(sentence) {
      var voice = selectedVoice || 'nova';
      const engine = _ttsEngine || 'openai';
      const cacheKey = engine + ':' + voice + ':' + sentence.substring(0, 4096);
      let blobUrl = ttsCache.get(cacheKey);
      if (blobUrl) return blobUrl;

      const hdrs = { 'Content-Type': 'application/json', 'x-session-id': webSessionId };
      if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;

      const isJa = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/.test(sentence);
      const instructions = isJa
        ? '自然な日本語で話してください。温かく親しみやすいトーンで、友達と会話するように。明瞭な発音で、自然なスピードで。感情を込めて、抑揚をつけて。'
        : 'Speak naturally in a warm, friendly conversational tone. Clear pronunciation at a natural pace.';

      const body = {
        text: sentence.substring(0, 4096),
        voice: voice,
        instructions: instructions,
        session_id: webSessionId,
        engine: engine,
      };

      // Add engine-specific params
      if (engine === 'elevenlabs') {
        body.voice_id = _elVoiceId;
      } else if (engine === 'sbv2') {
        body.style = 'Neutral';
      }

      const r = await fetch(API + '/api/v1/speech/synthesize', {
        method: 'POST',
        headers: hdrs,
        body: JSON.stringify(body),
      });

      if (!r.ok) throw new Error('TTS HTTP ' + r.status);
      const blob = await r.blob();
      if (!blob || blob.size === 0) throw new Error('Empty audio');
      blobUrl = URL.createObjectURL(blob);
      ttsCache.set(cacheKey, blobUrl);
      return blobUrl;
    }

    function playNextQueued() {
      if (ttsAborted || ttsQueue.length === 0) {
        ttsPlaying = false;
        if (ttsPendingCount <= 0) {
          if (currentTtsBtn) {
            currentTtsBtn.classList.remove('playing');
            currentTtsBtn.textContent = '\uD83D\uDD0A';
            currentTtsBtn = null;
            refreshCredits();
          }
          showTtsStopBtn(false);
          onTTSComplete();
        }
        return;
      }
      ttsPlaying = true;
      setVoiceState('speaking');
      const item = ttsQueue.shift();
      // Skip non-audio items (failed fetches)
      if (!item.blobUrl || item.blobUrl === 'SKIP' || item.blobUrl === 'SPOKEN') {
        playNextQueued();
        return;
      }
      const audio = new Audio(item.blobUrl);
      currentAudio = audio;
      audio.onended = function() { currentAudio = null; playNextQueued(); };
      audio.onerror = function() { currentAudio = null; playNextQueued(); };
      audio.play().catch(function() { currentAudio = null; playNextQueued(); });
    }

    function showTtsStopBtn(show) {
      const btn = document.getElementById('tts-stop-float');
      if (btn) btn.classList.toggle('visible', show);
    }

    function streamTTS(text) {
      stopTTS();
      ttsAborted = false;

      const sentences = splitSentences(text);
      if (sentences.length === 0) return;
      showTtsStopBtn(true);

      const slots = new Array(sentences.length).fill(null);
      ttsPendingCount = sentences.length;
      let nextToPlay = 0;

      function tryEnqueue() {
        while (nextToPlay < slots.length && slots[nextToPlay] !== null) {
          if (ttsAborted) return;
          ttsQueue.push({ blobUrl: slots[nextToPlay], sentence: sentences[nextToPlay] });
          nextToPlay++;
          if (!ttsPlaying) playNextQueued();
        }
      }

      sentences.forEach(function(sentence, idx) {
        fetchTtsAudio(sentence).then(function(blobUrl) {
          if (ttsAborted) return;
          ttsPendingCount--;
          slots[idx] = blobUrl;
          tryEnqueue();
        }).catch(function(err) {
          console.warn('TTS API failed for sentence, skipping:', err.message);
          ttsPendingCount--;
          if (ttsAborted) return;
          // Skip failed sentences — do NOT use browser fallback (causes mixed language/simultaneous playback)
          slots[idx] = 'SKIP';
          tryEnqueue();
        });
      });
    }

    function stopTTS() {
      ttsAborted = true;
      ttsQueue = [];
      ttsPendingCount = 0;
      if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
      currentAudio = null;
      ttsPlaying = false;
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      if (currentTtsBtn) {
        currentTtsBtn.classList.remove('playing');
        currentTtsBtn.textContent = '\uD83D\uDD0A';
        currentTtsBtn = null;
      }
      showTtsStopBtn(false);
      setVoiceState('idle'); // Reset voice state bar
    }

    function speakWithBrowser(text) {
      if (!window.speechSynthesis) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      utter.rate = 1.1;
      const voices = speechSynthesis.getVoices();
      const jaVoice = voices.find(v => v.lang === 'ja-JP' && v.name.includes('Kyoko'))
        || voices.find(v => v.lang === 'ja-JP' && v.name.includes('O-Ren'))
        || voices.find(v => v.lang === 'ja-JP' && !v.localService === false)
        || voices.find(v => v.lang.startsWith('ja'));
      if (jaVoice) utter.voice = jaVoice;
      speechSynthesis.speak(utter);
    }

    async function playTTS(btn) {
      const text = btn.dataset.text;
      if (!text) return;

      if (currentTtsBtn === btn && (ttsPlaying || (currentAudio && !currentAudio.paused))) {
        stopTTS();
        return;
      }

      stopTTS();

      btn.classList.add('playing');
      btn.textContent = '\u23F9';
      currentTtsBtn = btn;

      const clean = text.replace(/#{1,6}\s/g, '').replace(/\*{1,3}([^*]+)\*{1,3}/g, '$1')
        .replace(/`[^`]+`/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/^[-*]\s/gm, '').replace(/^\d+\.\s/gm, '').trim();

      streamTTS(clean);
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let lowCreditShown = false;
    function updateCredits(remaining) {
      const display = document.getElementById('credit-display');
      const count = document.getElementById('credit-count');
      if (!display || !count) return;
      display.style.display = '';
      const prev = parseInt(count.textContent) || 0;
      count.textContent = remaining.toLocaleString();
      if (prev !== remaining && prev > 0) {
        display.classList.add('credit-flash');
        setTimeout(() => display.classList.remove('credit-flash'), 600);
      }
      if (remaining <= 20 && remaining > 0 && !lowCreditShown) {
        lowCreditShown = true;
        setTimeout(() => showLowCreditBanner(remaining), 800);
      }
    }

    function showLowCreditBanner(remaining) {
      if (document.getElementById('low-credit-banner')) return;
      if (currentUser && currentUser.plan && currentUser.plan !== 'free') return;

      const l = document.documentElement.lang || 'ja';
      const deadline = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000);
      const deadlineStr = (deadline.getMonth() + 1) + '/' + deadline.getDate();

      const banner = document.createElement('div');
      banner.id = 'low-credit-banner';
      banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;z-index:250;background:linear-gradient(135deg,#1a1a2e,#16213e);border-top:2px solid #f59e0b;padding:16px 20px;animation:slideUp .4s ease-out;';
      banner.innerHTML = '<div style="max-width:480px;margin:0 auto;">'
        + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">'
        + '<span style="font-size:20px;">⚡</span>'
        + '<span style="font-size:15px;font-weight:700;color:#fbbf24;">'
        + (l === 'ja' ? 'クレジット残り ' + remaining : remaining + ' credits left') + '</span>'
        + '</div>'
        + '<div style="font-size:13px;color:#e2e8f0;margin-bottom:12px;line-height:1.5;">'
        + (l === 'ja'
          ? 'Starterプラン: <b style="color:#fbbf24;">月額 $9</b> で25,000クレジット+全ツール解放。'
          : 'Starter plan: <b style="color:#fbbf24;">25,000 credits + all tools</b> for just $9/mo.')
        + '</div>'
        + '<div style="display:flex;gap:8px;align-items:center;">'
        + '<button onclick="document.getElementById(\'low-credit-banner\').remove();document.getElementById(\'topup-modal\').classList.add(\'show\');" style="flex:1;padding:10px;background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-weight:700;font-size:14px;border:none;border-radius:10px;cursor:pointer;">'
        + (l === 'ja' ? '今すぐアップグレード' : 'Upgrade now') + '</button>'
        + '<button onclick="this.parentElement.parentElement.parentElement.remove();" style="padding:10px 14px;background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:12px;">'
        + (l === 'ja' ? '後で' : 'Later') + '</button>'
        + '</div>'
        + '</div>';
      document.body.appendChild(banner);
    }

    async function refreshCredits() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/auth/me', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.authenticated && d.credits_remaining !== undefined) {
          updateCredits(d.credits_remaining);
        }
      } catch(e) { /* ignore */ }
    }

    function appendUpgradeButton() {
      var msgs = document.querySelectorAll('.app-msg-bot .app-msg-content');
      var last = msgs[msgs.length - 1];
      if (!last) return;
      var l = document.documentElement.lang || 'ja';
      var btn = document.createElement('button');
      btn.style.cssText = 'margin-top:12px;padding:10px 24px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;display:block;';
      btn.textContent = l === 'ja' ? 'プランをアップグレード' : 'Upgrade Plan';
      btn.onclick = function() { showTopupModal((window._userPlan||'free')==='free'?'plans':'credits'); };
      last.appendChild(btn);
    }

    // ---------------------------------------------------------------------------
    // Referral modal
    // ---------------------------------------------------------------------------
    async function showReferralModal() {
      if (!authToken) return;
      const l = document.documentElement.lang || 'ja';
      // Get or create referral code
      let code = '';
      let url = '';
      try {
        const r = await fetch(API + '/api/v1/referral/code', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.ok) { code = d.code; url = d.url; }
      } catch(e) { showToast('Error fetching referral code'); return; }

      const existing = document.getElementById('referral-modal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.id = 'referral-modal';
      modal.style.cssText = 'position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);';
      modal.innerHTML = '<div style="background:var(--bg-secondary,#1a1a2e);border-radius:16px;padding:24px;max-width:400px;width:90%;color:#e2e8f0;">'
        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">'
        + '<h3 style="margin:0;font-size:18px;">' + (l==='ja' ? '友達を招待' : 'Invite Friends') + '</h3>'
        + '<button onclick="document.getElementById(\'referral-modal\').remove()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;">&times;</button>'
        + '</div>'
        + '<p style="font-size:14px;margin-bottom:16px;line-height:1.5;">'
        + (l==='ja' ? '友達が登録すると、あなたも友達も <b style="color:#10b981;">+100クレジット</b> 獲得!' : 'When your friend signs up, you both get <b style="color:#10b981;">+100 credits</b>!')
        + '</p>'
        + '<div style="background:var(--surface,#0a0a1a);border-radius:10px;padding:12px;margin-bottom:12px;font-family:monospace;font-size:16px;text-align:center;letter-spacing:2px;color:#fbbf24;">' + code + '</div>'
        + '<div style="display:flex;gap:8px;">'
        + '<button id="ref-copy-url" style="flex:1;padding:10px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">'
        + (l==='ja' ? 'URLをコピー' : 'Copy URL') + '</button>'
        + '<button id="ref-share" style="flex:1;padding:10px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">'
        + (l==='ja' ? 'SNSで共有' : 'Share') + '</button>'
        + '</div>'
        + '</div>';
      document.body.appendChild(modal);
      modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
      document.getElementById('ref-copy-url').addEventListener('click', function() {
        navigator.clipboard.writeText(url).then(function() {
          showToast(l==='ja' ? '紹介URLをコピーしました' : 'Referral URL copied!');
        });
      });
      document.getElementById('ref-share').addEventListener('click', function() {
        const text = l==='ja'
          ? 'chatweb.ai - AI音声アシスタント。招待リンクで+100クレジット!'
          : 'chatweb.ai - AI voice assistant. Get +100 credits with my invite link!';
        if (navigator.share) {
          navigator.share({ title: 'chatweb.ai', text: text, url: url }).catch(function(){});
        } else {
          const twitterUrl = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text + ' ' + url);
          window.open(twitterUrl, '_blank');
        }
      });
    }

    // ---------------------------------------------------------------------------
    // Human escalation modal
    function showHumanHelpModal(aiResponse) {
      const l = document.documentElement.lang || 'ja';
      const existing = document.getElementById('human-help-modal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.id = 'human-help-modal';
      modal.style.cssText = 'position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);';
      modal.innerHTML = '<div style="background:var(--bg-secondary,#1a1a2e);border-radius:16px;padding:24px;max-width:440px;width:90%;color:#e2e8f0;">'
        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">'
        + '<h3 style="margin:0;font-size:18px;">\uD83D\uDE4B ' + (l==='ja' ? '人間の専門家に相談' : 'Ask a Human Expert') + '</h3>'
        + '<button onclick="document.getElementById(\'human-help-modal\').remove()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;">&times;</button>'
        + '</div>'
        + '<p id="human-help-sla-text" style="font-size:13px;color:var(--muted);margin-bottom:12px;line-height:1.5;">'
        + (l==='ja' ? 'AIの回答で解決しなかった場合、人間の専門家が対応します。通常30分以内に回答します。' : 'If AI couldn\'t help, a human expert will assist you. Response within 30 minutes.')
        + '</p>'
        + '<textarea id="human-help-question" rows="3" placeholder="' + (l==='ja' ? '具体的に何を知りたいですか？' : 'What specifically do you need help with?') + '" '
        + 'style="width:100%;padding:10px;background:var(--surface,#0a0a1a);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;resize:vertical;margin-bottom:12px;"></textarea>'
        + '<div style="margin-bottom:12px;">'
        + '<label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px;">' + (l==='ja' ? '回答の受け取り方法' : 'How to receive the answer') + '</label>'
        + '<div style="display:flex;gap:6px;flex-wrap:wrap;" id="human-help-channels">'
        + '<button class="hh-ch-btn selected" data-ch="chatweb" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--accent);background:rgba(99,102,241,0.15);color:var(--accent);">chatweb.ai</button>'
        + '<button class="hh-ch-btn" data-ch="line" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);">LINE</button>'
        + '<button class="hh-ch-btn" data-ch="email" style="padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);">Email</button>'
        + '</div>'
        + '</div>'
        + '<label style="display:flex;align-items:center;gap:8px;margin-bottom:16px;font-size:12px;cursor:pointer;">'
        + '<input type="checkbox" id="human-help-priority" style="accent-color:#ef4444;">'
        + '<span>' + (l==='ja' ? '優先対応 (15分以内) — 50 credits' : 'Priority (15min) — 50 credits') + '</span>'
        + '</label>'
        + '<button id="human-help-submit" style="width:100%;padding:12px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;border-radius:10px;font-weight:600;font-size:14px;cursor:pointer;">'
        + (l==='ja' ? '人間に相談する' : 'Ask a Human') + '</button>'
        + '<p style="font-size:11px;color:var(--muted);margin-top:8px;text-align:center;">'
        + (l==='ja' ? '通常: 30分以内 / 優先: 15分以内に回答' : 'Standard: within 30min / Priority: within 15min')
        + '</p></div>';
      document.body.appendChild(modal);
      modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });

      // Channel button selection
      document.querySelectorAll('.hh-ch-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.hh-ch-btn').forEach(function(b) {
            b.style.borderColor = 'var(--border)';
            b.style.background = 'transparent';
            b.style.color = 'var(--muted)';
            b.classList.remove('selected');
          });
          btn.style.borderColor = 'var(--accent)';
          btn.style.background = 'rgba(99,102,241,0.15)';
          btn.style.color = 'var(--accent)';
          btn.classList.add('selected');
        });
      });

      // Check support away status
      fetch(API + '/api/v1/config/support-status').then(r => r.json()).then(d => {
        if (d.away) {
          var el = document.getElementById('human-help-sla-text');
          if (el) {
            el.innerHTML = '<span style="color:#f59e0b;">⚠️ ' + (l==='ja'
              ? (d.away_message || '現在離席中です。回答までお時間いただく場合があります。')
              : (d.away_message_en || 'Currently away. Response may take longer than usual.'))
            + '</span>';
          }
        }
      }).catch(function(){});

      // Submit
      document.getElementById('human-help-submit').addEventListener('click', async function() {
        const question = document.getElementById('human-help-question').value.trim();
        if (!question) {
          showToast(l==='ja' ? '質問を入力してください' : 'Please enter your question');
          return;
        }
        const channel = document.querySelector('.hh-ch-btn.selected')?.dataset.ch || 'chatweb';
        const priority = document.getElementById('human-help-priority').checked;
        const submitBtn = document.getElementById('human-help-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = l==='ja' ? '送信中...' : 'Submitting...';

        try {
          const hdrs = { 'Content-Type': 'application/json', 'x-session-id': webSessionId };
          if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;
          const r = await fetch(API + '/api/v1/tickets', {
            method: 'POST',
            headers: hdrs,
            body: JSON.stringify({
              question: question,
              context: (aiResponse || '').substring(0, 500),
              channel: channel,
              priority: priority,
              conv_id: appCurrentConvId || '',
            }),
          });
          const d = await r.json();
          if (d.ticket_id) {
            modal.remove();
            const sla = priority ? '15' : '30';
            showToast(l==='ja'
              ? '\u2705 チケット ' + d.ticket_id + ' を作成しました。' + sla + '分以内に回答します。'
              : '\u2705 Ticket ' + d.ticket_id + ' created. Response within ' + sla + ' minutes.');
            appAddMsg(l==='ja'
              ? '\uD83D\uDCE9 人間の専門家にエスカレーションしました（チケット: ' + d.ticket_id + '）。' + sla + '分以内に回答します。'
              : '\uD83D\uDCE9 Escalated to human expert (Ticket: ' + d.ticket_id + '). Response within ' + sla + ' minutes.', 'bot');
          } else {
            showToast(d.error || 'Error creating ticket');
            submitBtn.disabled = false;
            submitBtn.textContent = l==='ja' ? '人間に相談する' : 'Ask a Human';
          }
        } catch(e) {
          showToast('Error: ' + e.message);
          submitBtn.disabled = false;
          submitBtn.textContent = l==='ja' ? '人間に相談する' : 'Ask a Human';
        }
      });
    }

    // ---------------------------------------------------------------------------
    function showTopupModal(tab) {
      const l = document.documentElement.lang || 'ja';
      document.getElementById('topup-modal-title').textContent = l === 'ja' ? 'クレジットをチャージ' : 'Top Up Credits';
      document.getElementById('topup-modal-desc').textContent = l === 'ja' ? 'お好きな方法でクレジットを追加できます' : 'Add credits using your preferred payment method';
      var mp = document.getElementById('manage-plan-btn');
      if (mp) {
        var plan = (window._userPlan || 'free').toLowerCase();
        mp.style.display = (plan !== 'free') ? 'flex' : 'none';
      }
      showTopupTab(tab || 'plans');
      document.getElementById('topup-modal').classList.add('show');
    }

    // Konami Code easter egg on topup modal
    // Desktop: ↑↑↓↓←→←→BA  |  Mobile: tap title 10 times
    const KONAMI_SEQ = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let konamiIdx = 0;
    let konamiTaps = 0;
    let konamiTapTimer = null;
    document.addEventListener('keydown', function(e) {
      if (!document.getElementById('topup-modal').classList.contains('show')) { konamiIdx = 0; return; }
      if (e.key === KONAMI_SEQ[konamiIdx]) {
        konamiIdx++;
        if (konamiIdx === KONAMI_SEQ.length) {
          konamiIdx = 0;
          redeemKonami();
        }
      } else {
        konamiIdx = e.key === KONAMI_SEQ[0] ? 1 : 0;
      }
    });
    // Mobile: tap the topup modal title 10 times within 5 seconds
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'topup-modal-title') {
        konamiTaps++;
        clearTimeout(konamiTapTimer);
        konamiTapTimer = setTimeout(function() { konamiTaps = 0; }, 5000);
        if (konamiTaps >= 10) {
          konamiTaps = 0;
          redeemKonami();
        }
      }
    });
    async function redeemKonami() {
      const l = document.documentElement.lang || 'ja';
      try {
        const hdrs = { 'Content-Type': 'application/json', 'X-Session-Id': webSessionId || '' };
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;
        const r = await fetch(API + '/api/v1/coupon/redeem', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({ code: 'KONAMI', session_id: webSessionId }),
        });
        const d = await r.json();
        if (d.success) {
          if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
          showToast(l === 'ja' ? '+' + d.credits_granted + ' クレジット獲得!' : '+' + d.credits_granted + ' credits!', 3000);
        } else {
          showToast(d.error_ja || d.error || 'Error', 2000);
        }
      } catch {
        showToast('Error', 2000);
      }
    }

    function showTopupTab(tab) {
      var plans = document.getElementById('topup-plans');
      var credits = document.getElementById('topup-credits');
      var tabPlans = document.getElementById('topup-tab-plans');
      var tabCredits = document.getElementById('topup-tab-credits');
      if (tab === 'credits') {
        plans.style.display = 'none';
        credits.style.display = 'flex';
        tabPlans.style.background = 'transparent'; tabPlans.style.color = 'var(--muted)';
        tabCredits.style.background = 'var(--accent)'; tabCredits.style.color = '#fff';
      } else {
        plans.style.display = 'flex';
        credits.style.display = 'none';
        tabPlans.style.background = 'var(--accent)'; tabPlans.style.color = '#fff';
        tabCredits.style.background = 'transparent'; tabCredits.style.color = 'var(--muted)';
      }
    }

    async function startStripeCheckout(plan) {
      try {
        const hdrs = { 'Content-Type': 'application/json', 'X-Session-Id': webSessionId || '' };
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;
        const r = await fetch('/api/v1/billing/checkout', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({ plan: plan }),
        });
        const d = await r.json();
        if (d.checkout_url) {
          window.open(d.checkout_url, '_blank');
          document.getElementById('topup-modal').classList.remove('show');
          return;
        }
        if (d.error) {
          alert(d.error);
          return;
        }
      } catch(e) {
        console.error('Stripe checkout error:', e);
      }
      const l = document.documentElement.lang;
      alert(l === 'ja' ? '決済ページの作成に失敗しました。もう一度お試しください。' : 'Failed to create checkout. Please try again.');
    }

    async function buyCreditPack(credits) {
      try {
        const r = await fetch('/api/v1/billing/credit-pack', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Session-Id': webSessionId || '' },
          body: JSON.stringify({ credits: credits }),
        });
        const d = await r.json();
        if (d.checkout_url) {
          window.open(d.checkout_url, '_blank');
          document.getElementById('topup-modal').classList.remove('show');
        } else {
          alert(d.error || 'Error creating checkout session');
        }
      } catch(e) {
        alert('Payment service unavailable. Please try again.');
      }
    }

    async function openBillingPortal() {
      try {
        const r = await fetch('/api/v1/billing/portal', {
          headers: { 'X-Session-Id': webSessionId || '' },
        });
        const d = await r.json();
        if (d.portal_url) {
          window.open(d.portal_url, '_blank');
          document.getElementById('topup-modal').classList.remove('show');
        }
      } catch(e) { alert('Could not open billing portal'); }
    }

    async function toggleAutoCharge(enabled) {
      try {
        await fetch('/api/v1/billing/auto-charge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Session-Id': webSessionId || '' },
          body: JSON.stringify({ enabled: enabled, credits: 5000 }),
        });
        showToast(enabled ? 'オートチャージON' : 'オートチャージOFF', 2000);
      } catch(e) { /* ignore */ }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    function showCryptoTopup() {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');
      const lang = document.documentElement.lang || 'ja';

      content.innerHTML = '<h3 style="margin:0 0 12px;">' + (lang === 'ja' ? '&#9830; 仮想通貨でチャージ' : '&#9830; Top Up with Crypto') + '</h3>'
        + '<p style="color:var(--muted);font-size:13px;margin-bottom:16px;">'
        + (lang === 'ja' ? 'ETH / MATIC / Base でクレジットを購入。$1 = 100 credits' : 'Buy credits with ETH/MATIC/Base. $1 = 100 credits')
        + '</p>'
        + '<div style="display:flex;gap:8px;margin-bottom:12px;">'
        + '<button class="crypto-amount-btn" onclick="selectCryptoAmount(5)" data-amt="5" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:15px;font-weight:600;">$5<br><span style="font-size:11px;color:var(--muted);">500 cr</span></button>'
        + '<button class="crypto-amount-btn" onclick="selectCryptoAmount(20)" data-amt="20" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:15px;font-weight:600;">$20<br><span style="font-size:11px;color:var(--muted);">2,000 cr</span></button>'
        + '<button class="crypto-amount-btn" onclick="selectCryptoAmount(50)" data-amt="50" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:15px;font-weight:600;">$50<br><span style="font-size:11px;color:var(--muted);">5,000 cr</span></button>'
        + '</div>'
        + '<div style="display:flex;gap:8px;margin-bottom:16px;">'
        + '<button onclick="selectChain(8453)" id="chain-8453" class="chain-btn selected" style="flex:1;padding:8px;border:2px solid var(--accent);border-radius:8px;background:rgba(99,102,241,0.1);color:var(--accent);cursor:pointer;font-size:12px;">Base<br><span style="font-size:10px;">推奨・ガス安</span></button>'
        + '<button onclick="selectChain(137)" id="chain-137" class="chain-btn" style="flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-size:12px;">Polygon<br><span style="font-size:10px;">MATIC</span></button>'
        + '<button onclick="selectChain(1)" id="chain-1" class="chain-btn" style="flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-size:12px;">Ethereum<br><span style="font-size:10px;">ETH</span></button>'
        + '</div>'
        + '<button id="crypto-pay-btn" onclick="initCryptoPayment()" style="width:100%;padding:14px;background:linear-gradient(135deg,#627eea,#8b5cf6);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;">'
        + (lang === 'ja' ? '&#128190; ウォレットで支払う ($20)' : '&#128190; Pay with Wallet ($20)')
        + '</button>'
        + '<p id="crypto-status" style="text-align:center;font-size:12px;color:var(--muted);margin-top:8px;min-height:18px;"></p>'
        + '<p style="text-align:center;font-size:11px;color:var(--muted);margin-top:4px;">'
        + (lang === 'ja' ? 'MetaMask等のウォレットが必要です' : 'Requires MetaMask or compatible wallet')
        + '</p>';

      modal.classList.add('show');
      window._cryptoAmount = 20;
      window._cryptoChain = 8453;
      selectCryptoAmount(20);
    }

    function selectCryptoAmount(amt) {
      window._cryptoAmount = amt;
      document.querySelectorAll('.crypto-amount-btn').forEach(function(b) {
        const isSelected = parseInt(b.dataset.amt) === amt;
        b.style.borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
        b.style.background = isSelected ? 'rgba(99,102,241,0.1)' : 'transparent';
      });
      const lang = document.documentElement.lang || 'ja';
      const btn = document.getElementById('crypto-pay-btn');
      if (btn) btn.innerHTML = (lang === 'ja' ? '&#128190; ウォレットで支払う ($' : '&#128190; Pay with Wallet ($') + amt + ')';
    }

    function selectChain(chainId) {
      window._cryptoChain = chainId;
      [1, 137, 8453].forEach(function(id) {
        const el = document.getElementById('chain-' + id);
        if (el) {
          const isSel = id === chainId;
          el.style.borderColor = isSel ? 'var(--accent)' : 'var(--border)';
          el.style.background = isSel ? 'rgba(99,102,241,0.1)' : 'transparent';
          el.style.color = isSel ? 'var(--accent)' : 'var(--text)';
          el.className = 'chain-btn' + (isSel ? ' selected' : '');
        }
      });
    }

    async function initCryptoPayment() {
      const statusEl = document.getElementById('crypto-status');
      const lang = document.documentElement.lang || 'ja';

      if (!window.ethereum) {
        statusEl.innerHTML = lang === 'ja'
          ? 'MetaMaskが見つかりません。<a href="https://metamask.io/download/" target="_blank" style="color:var(--accent);text-decoration:underline;">インストールはこちら</a>'
          : 'MetaMask not found. <a href="https://metamask.io/download/" target="_blank" style="color:var(--accent);text-decoration:underline;">Install here</a>';
        statusEl.style.color = '#ef4444';
        return;
      }

      const payBtn = document.getElementById('crypto-pay-btn');
      if (payBtn) { payBtn.disabled = true; payBtn.style.opacity = '0.6'; }
      statusEl.textContent = lang === 'ja' ? 'ウォレット接続中...' : 'Connecting wallet...';
      statusEl.style.color = 'var(--accent)';

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const wallet = accounts[0];
        statusEl.textContent = lang === 'ja' ? '決済データ取得中...' : 'Getting payment data...';

        const hdrs = { 'Content-Type': 'application/json' };
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;

        const resp = await fetch(API + '/api/v1/crypto/initiate', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({
            amount: window._cryptoAmount,
            chain_id: window._cryptoChain,
            wallet_address: wallet,
            session_id: webSessionId,
          }),
        });
        const data = await resp.json();

        if (data.error) {
          statusEl.textContent = data.error;
          statusEl.style.color = '#ef4444';
          return;
        }

        const currentChain = parseInt(await window.ethereum.request({ method: 'eth_chainId' }), 16);
        if (currentChain !== window._cryptoChain) {
          statusEl.textContent = lang === 'ja' ? 'チェーン切替中...' : 'Switching chain...';
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + window._cryptoChain.toString(16) }],
            });
          } catch(e) {
            statusEl.textContent = lang === 'ja' ? 'チェーンを切り替えてください: ' + data.chain_name : 'Please switch to ' + data.chain_name;
            statusEl.style.color = '#ef4444';
            return;
          }
        }

        statusEl.textContent = lang === 'ja' ? 'トランザクション承認を待っています...' : 'Waiting for transaction approval...';

        const calldata = data.calldata;
        const txParams = {
          from: wallet,
          to: calldata.to,
          value: calldata.value,
          data: calldata.data || '0x',
        };

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        statusEl.innerHTML = (lang === 'ja' ? '&#9989; トランザクション送信済み！確認中...' : '&#9989; Transaction sent! Confirming...')
          + '<br><span style="font-size:10px;word-break:break-all;">' + txHash + '</span>';
        statusEl.style.color = '#22c55e';

        const confirmResp = await fetch(API + '/api/v1/crypto/confirm', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({ tx_hash: txHash, session_id: webSessionId }),
        });
        const confirmData = await confirmResp.json();

        if (confirmData.success) {
          statusEl.innerHTML = (lang === 'ja' ? '&#127881; チャージ完了！' : '&#127881; Payment confirmed!')
            + '<br>' + (confirmData.message_ja || confirmData.message);
          refreshCredits();
          setTimeout(function() { document.getElementById('modal').classList.remove('show'); }, 3000);
        }

      } catch(e) {
        console.error('Crypto payment error:', e);
        statusEl.textContent = e.message || (lang === 'ja' ? 'エラーが発生しました' : 'An error occurred');
        statusEl.style.color = '#ef4444';
      } finally {
        if (payBtn) { payBtn.disabled = false; payBtn.style.opacity = '1'; }
      }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    function showEarnOption() {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');
      const lang = document.documentElement.lang || 'ja';
      content.innerHTML = '<h3 style="margin:0 0 12px;">' + (lang === 'ja' ? '🖥️ PCで稼ぐ' : '🖥️ Earn with your PC') + '</h3>'
        + '<p style="color:var(--muted);font-size:13px;margin-bottom:16px;">'
        + (lang === 'ja' ? 'あなたのPCでローカルLLMを動かして、他のユーザーの推論リクエストを処理。クレジットが稼げます。' : 'Run a local LLM on your PC to process inference requests from other users and earn credits.')
        + '</p>'
        + '<div style="background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:\'SF Mono\',\'Fira Code\',monospace;font-size:13px;margin-bottom:12px;cursor:pointer;" onclick="navigator.clipboard.writeText(\'curl -fsSL https://chatweb.ai/install.sh | sh\');this.querySelector(\'.ep\').textContent=\'Copied!\';setTimeout(()=>this.querySelector(\'.ep\').textContent=\'Copy\',1500)">'
        + '<div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--muted);">$</span> <span style="flex:1;color:#e2e8f0;">curl -fsSL https://chatweb.ai/install.sh | sh</span> <span class="ep" style="color:var(--muted);font-size:11px;background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;">Copy</span></div>'
        + '</div>'
        + '<div style="background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:\'SF Mono\',\'Fira Code\',monospace;font-size:13px;margin-bottom:16px;cursor:pointer;" onclick="navigator.clipboard.writeText(\'chatweb earn\');this.querySelector(\'.ep2\').textContent=\'Copied!\';setTimeout(()=>this.querySelector(\'.ep2\').textContent=\'Copy\',1500)">'
        + '<div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--muted);">$</span> <span style="flex:1;color:#e2e8f0;">chatweb earn</span> <span class="ep2" style="color:var(--muted);font-size:11px;background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;">Copy</span></div>'
        + '</div>'
        + '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">'
        + '<div style="text-align:center;padding:10px;border:1px solid var(--border);border-radius:10px;"><div style="font-weight:600;">qwen3-0.6b</div><div style="font-size:11px;color:var(--muted);">~512MB RAM</div><div style="font-size:12px;color:#22c55e;font-weight:600;">1 cr/req</div></div>'
        + '<div style="text-align:center;padding:10px;border:2px solid var(--accent);border-radius:10px;background:rgba(99,102,241,0.05);"><div style="font-weight:600;">qwen3-1.7b</div><div style="font-size:11px;color:var(--muted);">~1.5GB RAM</div><div style="font-size:12px;color:#22c55e;font-weight:600;">2 cr/req</div></div>'
        + '<div style="text-align:center;padding:10px;border:1px solid var(--border);border-radius:10px;"><div style="font-weight:600;">qwen3-4b</div><div style="font-size:11px;color:var(--muted);">~3GB RAM</div><div style="font-size:12px;color:#22c55e;font-weight:600;">5 cr/req</div></div>'
        + '</div>'
        + '<p style="text-align:center;font-size:11px;color:var(--muted);">'
        + (lang === 'ja' ? 'モデルは初回起動時に自動ダウンロードされます' : 'Model is automatically downloaded on first run')
        + '</p>';
      modal.classList.add('show');
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    async function enterSharedViewMode(hash) {
      try {
        const r = await fetch(API + '/api/v1/shared/' + encodeURIComponent(hash));
        const d = await r.json();
        if (d.error) {
          document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;color:#ccc;background:#0d0d0d;"><h1 style="font-size:24px;margin-bottom:8px;">chatweb.ai</h1><p style="color:#888;">' + (d.error || 'Share not found') + '</p><a href="/" style="margin-top:24px;color:#4f8eff;">chatweb.ai\u3067\u4f1a\u8a71\u3092\u59cb\u3081\u308b</a></div>';
          return;
        }
        document.body.classList.add('app-mode');
        document.getElementById('app-sidebar').style.display = 'none';
        document.getElementById('app-sidebar-toggle').style.display = 'none';
        document.getElementById('app-sidebar-backdrop').style.display = 'none';
        const inputArea = document.querySelector('.app-chat-input-area');
        if (inputArea) inputArea.style.display = 'none';
        const msgsEl = document.getElementById('app-messages');
        msgsEl.innerHTML = '';
        const emptyEl = document.getElementById('app-empty');
        if (emptyEl) emptyEl.remove();
        const header = document.createElement('div');
        header.style.cssText = 'padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;';
        header.innerHTML = '<div style="font-size:15px;color:#aaa;">\u5171\u6709\u3055\u308c\u305f\u4f1a\u8a71' + (d.title ? ' \u2014 ' + d.title.replace(/</g,'&lt;') : '') + '</div>';
        msgsEl.parentElement.insertBefore(header, msgsEl);
        (d.messages || []).forEach(m => {
          appAddMsg(m.content, m.role === 'user' ? 'user' : 'bot');
        });
        const cta = document.createElement('div');
        cta.style.cssText = 'padding:24px;text-align:center;';
        cta.innerHTML = '<a href="/" style="display:inline-block;padding:12px 32px;background:linear-gradient(135deg,#4f8eff,#3b6fd4);color:#fff;border-radius:12px;text-decoration:none;font-size:15px;font-weight:600;">chatweb.ai\u3067\u4f1a\u8a71\u3092\u59cb\u3081\u308b</a>';
        msgsEl.appendChild(cta);
      } catch(e) {
        document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;color:#ccc;background:#0d0d0d;"><h1>chatweb.ai</h1><p style="color:#888;">\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f</p><a href="/" style="margin-top:24px;color:#4f8eff;">chatweb.ai\u3067\u4f1a\u8a71\u3092\u59cb\u3081\u308b</a></div>';
      }
    }

    async function shareConversation(convId) {
      if (!authToken || !convId) return;
      try {
        const r = await fetch(API + '/api/v1/conversations/' + encodeURIComponent(convId) + '/share', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.share_url) {
          await navigator.clipboard.writeText(d.share_url);
          showToast(d.already_shared ? '\u5171\u6709\u30ea\u30f3\u30af\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f' : '\u5171\u6709\u30ea\u30f3\u30af\u3092\u751f\u6210\u3057\u307e\u3057\u305f');
        } else {
          showToast(d.error || '\u5171\u6709\u306b\u5931\u6557\u3057\u307e\u3057\u305f');
        }
      } catch(e) {
        showToast('\u5171\u6709\u306b\u5931\u6557\u3057\u307e\u3057\u305f');
      }
    }

    function showToast(msg) {
      const existing = document.getElementById('toast-notification');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.id = 'toast-notification';
      toast.textContent = msg;
      toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:8px;font-size:14px;z-index:10000;transition:opacity 0.3s;';
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let syncTimer = null;
    let lastSyncTime = null;

    function getSyncIntervalMs() {
      if (!currentUser) return 5 * 60 * 1000;
      const plan = (currentUser.plan || 'free').toLowerCase();
      return (plan === 'free') ? 5 * 60 * 1000 : 1 * 60 * 1000;
    }

    function getSyncIntervalLabel() {
      const l = document.documentElement.lang || 'ja';
      if (!currentUser) return l === 'ja' ? '5分ごと' : 'every 5min';
      const plan = (currentUser.plan || 'free').toLowerCase();
      if (plan === 'free') return l === 'ja' ? '5分ごと (Free)' : 'every 5min (Free)';
      return l === 'ja' ? '1分ごと (Pro)' : 'every 1min (Pro)';
    }

    function updateSyncUI() {
      const l = document.documentElement.lang || 'ja';
      const el = document.getElementById('sync-interval-label');
      if (el) el.textContent = getSyncIntervalLabel();
      const btn = document.getElementById('sync-btn-text');
      if (btn) btn.textContent = l === 'ja' ? '同期' : 'Sync';
      const lbl = document.getElementById('cron-label-text');
      if (lbl) lbl.textContent = l === 'ja' ? '定期タスク' : 'Scheduled Tasks';
      const last = document.getElementById('sync-last');
      if (last) {
        if (lastSyncTime) {
          const ago = Math.round((Date.now() - lastSyncTime) / 1000);
          last.textContent = ago < 60 ? (l === 'ja' ? `${ago}秒前` : `${ago}s ago`) : (l === 'ja' ? `${Math.round(ago/60)}分前` : `${Math.round(ago/60)}m ago`);
        } else {
          last.textContent = '--';
        }
      }
    }

    async function syncNow() {
      const btn = document.getElementById('sync-btn');
      if (btn) btn.classList.add('syncing');
      try {
        await appLoadConversations();
        lastSyncTime = Date.now();
        updateSyncUI();
      } catch(e) { /* ignore */ }
      if (btn) setTimeout(() => btn.classList.remove('syncing'), 500);
    }

    function startAutoSync() {
      stopAutoSync();
      const ms = getSyncIntervalMs();
      syncTimer = setInterval(syncNow, ms);
      if (!window._syncUiTimer) {
        window._syncUiTimer = setInterval(updateSyncUI, 30000);
      }
    }

    function stopAutoSync() {
      if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
    }

    // ---------------------------------------------------------------------------
    // ---------------------------------------------------------------------------
    let cronJobs = [];

    async function loadCronJobs() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/cron', { headers: { 'Authorization': 'Bearer ' + authToken } });
        const d = await r.json();
        cronJobs = d.jobs || [];
        renderCronList();
      } catch(e) { cronJobs = []; renderCronList(); }
    }

    function renderCronList() {
      const list = document.getElementById('cron-list');
      if (!list) return;
      const l = document.documentElement.lang || 'ja';
      if (cronJobs.length === 0) {
        list.innerHTML = '<div style="font-size:10px;color:var(--muted);padding:4px 8px;">' + (l === 'ja' ? '定期タスクなし' : 'No scheduled tasks') + '</div>';
        return;
      }
      list.innerHTML = '';
      cronJobs.forEach((job, idx) => {
        const item = document.createElement('div');
        item.className = 'cron-item';
        item.innerHTML = `
          <button class="cron-item-toggle ${job.enabled ? 'on' : ''}" onclick="toggleCronJob('${job.id}',${!job.enabled})"></button>
          <span class="cron-item-name" title="${job.message || ''}">${job.name}</span>
          <span class="cron-item-schedule">${job.schedule_display || job.schedule || ''}</span>
          <button style="background:none;border:none;cursor:pointer;font-size:12px;padding:2px 4px;opacity:0.6;" onclick="editCronJobByIndex(${idx})" title="Edit">&#x270F;</button>
          <button class="cron-item-del" onclick="deleteCronJob('${job.id}')">&#x2715;</button>
        `;
        list.appendChild(item);
      });
    }

    var cronEditId = null;
    function toggleCronForm(prefill) {
      const c = document.getElementById('cron-form-container');
      if (c.style.display === 'none') {
        const l = document.documentElement.lang || 'ja';
        c.style.display = '';
        c.innerHTML = `<div class="cron-form">
          <input id="cron-name" placeholder="${l === 'ja' ? 'タスク名' : 'Task name'}" maxlength="50">
          <input id="cron-message" placeholder="${l === 'ja' ? 'AIへのメッセージ' : 'Message to AI'}" maxlength="200">
          <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;">
            <button type="button" onclick="applyCronPreset('60')" style="font-size:10px;padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer;">${l === 'ja' ? '毎時間' : 'Hourly'}</button>
            <button type="button" onclick="applyCronPreset('0 9 * * *')" style="font-size:10px;padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer;">${l === 'ja' ? '毎日9時' : 'Daily 9am'}</button>
            <button type="button" onclick="applyCronPreset('0 9 * * 1')" style="font-size:10px;padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer;">${l === 'ja' ? '毎週月曜' : 'Weekly Mon'}</button>
          </div>
          <div class="cron-form-row">
            <select id="cron-schedule-type" onchange="updateCronScheduleUI()" style="flex:1;">
              <option value="every">${l === 'ja' ? '定期実行' : 'Interval'}</option>
              <option value="cron">Cron式</option>
              <option value="at">${l === 'ja' ? '1回のみ' : 'One-time'}</option>
            </select>
            <input id="cron-schedule-val" placeholder="${l === 'ja' ? '例: 30 (分)' : 'e.g. 30 (min)'}" style="flex:1;">
          </div>
          <div class="cron-form-row" id="cron-channel-row">
            <select id="cron-channel" style="flex:1;">
              <option value="">Web</option>
              <option value="line">LINE</option>
              <option value="telegram">Telegram</option>
            </select>
          </div>
          <div class="cron-form-actions">
            <button class="cron-cancel-btn" onclick="cronEditId=null;toggleCronForm()">${l === 'ja' ? 'キャンセル' : 'Cancel'}</button>
            <button class="cron-save-btn" onclick="saveCronJob()">${l === 'ja' ? '保存' : 'Save'}</button>
          </div>
        </div>`;
        if (prefill) {
          if (prefill.name) document.getElementById('cron-name').value = prefill.name;
          if (prefill.message) document.getElementById('cron-message').value = prefill.message;
          if (prefill.schedule) {
            const val = prefill.schedule;
            if (val.every_minutes) {
              document.getElementById('cron-schedule-type').value = 'every';
              document.getElementById('cron-schedule-val').value = val.every_minutes;
            } else if (val.cron) {
              document.getElementById('cron-schedule-type').value = 'cron';
              document.getElementById('cron-schedule-val').value = val.cron;
            } else if (val.at) {
              document.getElementById('cron-schedule-type').value = 'at';
              document.getElementById('cron-schedule-val').value = val.at;
            }
            updateCronScheduleUI();
          }
        }
      } else {
        c.style.display = 'none';
        c.innerHTML = '';
        cronEditId = null;
      }
    }

    function applyCronPreset(val) {
      const typeEl = document.getElementById('cron-schedule-type');
      const valEl = document.getElementById('cron-schedule-val');
      if (/^\d+$/.test(val)) {
        typeEl.value = 'every';
        valEl.value = val;
      } else {
        typeEl.value = 'cron';
        valEl.value = val;
      }
      updateCronScheduleUI();
    }

    function editCronJobByIndex(idx) {
      const job = cronJobs[idx];
      if (!job) return;
      cronEditId = job.id;
      const c = document.getElementById('cron-form-container');
      if (c.style.display !== 'none') { c.style.display = 'none'; c.innerHTML = ''; }
      let schedObj = {};
      if (typeof job.schedule === 'object') {
        schedObj = job.schedule;
      } else if (typeof job.schedule === 'string') {
        if (/^\d+$/.test(job.schedule)) schedObj = { every_minutes: parseInt(job.schedule) };
        else if (job.schedule.includes('*')) schedObj = { cron: job.schedule };
        else schedObj = { every_minutes: 30 };
      }
      toggleCronForm({ name: job.name, message: job.message, schedule: schedObj });
    }

    function updateCronScheduleUI() {
      const type = document.getElementById('cron-schedule-type').value;
      const input = document.getElementById('cron-schedule-val');
      const l = document.documentElement.lang || 'ja';
      if (type === 'every') input.placeholder = l === 'ja' ? '例: 30 (分)' : 'e.g. 30 (min)';
      else if (type === 'cron') input.placeholder = l === 'ja' ? '例: 0 9 * * *' : 'e.g. 0 9 * * *';
      else input.placeholder = l === 'ja' ? '例: 2026-02-10 09:00' : 'e.g. 2026-02-10 09:00';
    }

    async function saveCronJob() {
      const name = document.getElementById('cron-name').value.trim();
      const message = document.getElementById('cron-message').value.trim();
      const scheduleType = document.getElementById('cron-schedule-type').value;
      const scheduleVal = document.getElementById('cron-schedule-val').value.trim();
      const channel = document.getElementById('cron-channel').value;
      if (!name || !message || !scheduleVal) return;
      let schedule = {};
      if (scheduleType === 'every') schedule = { every_minutes: parseInt(scheduleVal) || 30 };
      else if (scheduleType === 'cron') schedule = { cron: scheduleVal };
      else schedule = { at: scheduleVal };
      try {
        const url = cronEditId ? API + '/api/v1/cron/' + cronEditId : API + '/api/v1/cron';
        const method = cronEditId ? 'PUT' : 'POST';
        const r = await fetch(url, {
          method,
          headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, message, schedule, channel: channel || undefined }),
        });
        if (r.ok) {
          const wasEdit = !!cronEditId;
          cronEditId = null;
          toggleCronForm();
          loadCronJobs();
          const l = document.documentElement.lang || 'ja';
          showToast(wasEdit ? (l === 'ja' ? '定期タスクを更新しました' : 'Scheduled task updated') : (l === 'ja' ? '定期タスクを作成しました' : 'Scheduled task created'));
        }
      } catch(e) { /* ignore */ }
    }

    async function toggleCronJob(id, enabled) {
      try {
        await fetch(API + '/api/v1/cron/' + id, {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled }),
        });
        loadCronJobs();
      } catch(e) { /* ignore */ }
    }

    async function deleteCronJob(id) {
      const l = document.documentElement.lang || 'ja';
      if (!confirm(l === 'ja' ? 'この定期タスクを削除しますか？' : 'Delete this scheduled task?')) return;
      try {
        await fetch(API + '/api/v1/cron/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        loadCronJobs();
        showToast(l === 'ja' ? '削除しました' : 'Deleted');
      } catch(e) { /* ignore */ }
    }

    const shareMatch = window.location.pathname.match(/^\/c\/([a-zA-Z0-9]{8,12})$/);
    if (shareMatch) {
      enterSharedViewMode(shareMatch[1]);
    } else {
      checkAuth();
    }

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    (function() {
      var c = document.getElementById('hero-canvas');
      if (!c) return;
      var ctx = c.getContext('2d');
      var W = c.width, H = c.height;
      var particles = [];
      var mouseX = W / 2, mouseY = H / 2;
      var N = Math.min(45, Math.floor(W * H / 8000));
      for (var i = 0; i < N; i++) {
        particles.push({
          x: Math.random() * W,
          y: Math.random() * H,
          vx: (Math.random() - 0.5) * 0.3,
          vy: (Math.random() - 0.5) * 0.3,
          r: Math.random() * 1.5 + 0.5,
        });
      }
      var CONN_DIST_SQ = 120 * 120; // Squared distance threshold — avoid sqrt
      var MOUSE_DIST_SQ = 200 * 200;
      var isHeroVisible = true;
      function draw() {
        if (!isHeroVisible) { requestAnimationFrame(draw); return; }
        ctx.clearRect(0, 0, W, H);
        ctx.lineWidth = 0.5;
        for (var i = 0; i < particles.length; i++) {
          for (var j = i + 1; j < particles.length; j++) {
            var dx = particles[i].x - particles[j].x;
            var dy = particles[i].y - particles[j].y;
            var distSq = dx * dx + dy * dy;
            if (distSq < CONN_DIST_SQ) {
              var alpha = 0.12 * (1 - Math.sqrt(distSq) / 120);
              ctx.beginPath();
              ctx.strokeStyle = 'rgba(99,102,241,' + alpha + ')';
              ctx.moveTo(particles[i].x, particles[i].y);
              ctx.lineTo(particles[j].x, particles[j].y);
              ctx.stroke();
            }
          }
        }
        ctx.fillStyle = 'rgba(99,102,241,0.4)';
        for (var i = 0; i < particles.length; i++) {
          var p = particles[i];
          var dmx = mouseX - p.x, dmy = mouseY - p.y;
          var dmSq = dmx * dmx + dmy * dmy;
          if (dmSq < MOUSE_DIST_SQ && dmSq > 0) {
            var dm = Math.sqrt(dmSq);
            p.vx += dmx / dm * 0.02;
            p.vy += dmy / dm * 0.02;
          }
          p.x += p.vx; p.y += p.vy;
          p.vx *= 0.99; p.vy *= 0.99;
          if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
          if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        }
        requestAnimationFrame(draw);
      }
      var heroObs = new IntersectionObserver(function(entries) {
        isHeroVisible = entries[0].isIntersecting;
      }, { threshold: 0 });
      heroObs.observe(c);
      draw();
      setTimeout(function() { c.classList.add('visible'); }, 200);
      document.addEventListener('mousemove', function(e) {
        var rect = c.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) / rect.width * W;
        mouseY = (e.clientY - rect.top) / rect.height * H;
      });
    })();

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    (function() {
      var h1 = document.getElementById('t-title');
      if (!h1 || document.body.classList.contains('app-mode')) return;
      var text = h1.textContent;
      h1.innerHTML = '';
      for (var i = 0; i < text.length; i++) {
        var span = document.createElement('span');
        span.className = 'char';
        span.textContent = text[i] === ' ' ? '\u00a0' : text[i];
        span.style.animationDelay = (i * 0.04 + 0.3) + 's';
        h1.appendChild(span);
      }
    })();

    // -----------------------------------------------------------------------
    // -----------------------------------------------------------------------
    (function() {
      var statEls = document.querySelectorAll('.stat-value');
      var observed = false;
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting && !observed) {
            observed = true;
            statEls.forEach(function(el) {
              var text = el.textContent;
              var match = text.match(/^([<>]?)(\d+\.?\d*)(.*)/);
              if (!match) return;
              var prefix = match[1], target = parseFloat(match[2]), suffix = match[3];
              var isFloat = text.includes('.');
              var start = 0, duration = 1200, startTime = null;
              function tick(ts) {
                if (!startTime) startTime = ts;
                var progress = Math.min((ts - startTime) / duration, 1);
                var eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                var val = start + (target - start) * eased;
                el.textContent = prefix + (isFloat ? val.toFixed(1) : Math.round(val)) + suffix;
                if (progress < 1) requestAnimationFrame(tick);
              }
              requestAnimationFrame(tick);
            });
            observer.disconnect();
          }
        });
      }, { threshold: 0.3 });
      statEls.forEach(function(el) { observer.observe(el); });
    })();

    (function() {
      const targets = document.querySelectorAll('.cap-section, .sync-section, .channel-cards, .bottom-cta, .cli-section');
      targets.forEach(el => el.classList.add('scroll-fade-up'));
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      targets.forEach(el => observer.observe(el));
    })();

    applyABVariant(getABVariant());
    // Language: manual setting (generalSettings.uiLanguage) > saved 'nl' > browser auto-detect
    (function() {
      var gs = JSON.parse(localStorage.getItem('generalSettings') || '{}');
      var uiPref = gs.uiLanguage || 'auto';
      var lang;
      if (uiPref !== 'auto') {
        lang = uiPref;
      } else {
        var saved = localStorage.getItem('nl');
        if (saved) {
          lang = saved;
        } else {
          var browserLang = (navigator.language || 'en').toLowerCase();
          lang = browserLang.startsWith('ja') ? 'ja' : 'en';
        }
      }
      setLang(lang);
    })();

    let phoneState = { active: false, contactId: null, ccpInitialized: false, transcriptPoll: null };

    (async function checkConnectEnabled() {
      try {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        const resp = await fetch('/api/v1/connect/token', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: '{}'
        });
        if (resp.ok) {
          const data = await resp.json();
          if (!data.error) {
            document.body.classList.add('connect-enabled');
            if (data.sign_in_url) phoneState.signInUrl = data.sign_in_url;
          }
        }
      } catch(e) { /* Connect not available */ }
    })();

    function togglePhonePanel() {
      const panel = document.getElementById('phone-panel');
      panel.classList.toggle('open');
      const btn = document.getElementById('app-phone-btn');
      btn.classList.toggle('active', panel.classList.contains('open'));
      if (panel.classList.contains('open') && !phoneState.ccpInitialized) {
        initCCP();
      }
    }

    function initCCP() {
      if (typeof connect === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/amazon-connect-streams@2/release/connect-streams-min.js';
        script.onload = () => startCCP();
        document.head.appendChild(script);
      } else {
        startCCP();
      }
    }

    function startCCP() {
      try {
        const instanceUrl = phoneState.signInUrl || '';
        if (!instanceUrl) {
          document.getElementById('phone-status').textContent = 'CCP: Waiting for config...';
          return;
        }
        connect.core.initCCP(document.getElementById('ccp-container'), {
          ccpUrl: instanceUrl,
          loginPopup: true,
          loginPopupAutoClose: true,
          softphone: { allowFramedSoftphone: true },
          region: 'ap-northeast-1',
        });
        phoneState.ccpInitialized = true;
        document.getElementById('phone-status').textContent = 'Connected';

        connect.contact(function(contact) {
          contact.onConnecting(function() {
            phoneState.active = true;
            phoneState.contactId = contact.getContactId();
            updatePhoneUI('connecting');
          });
          contact.onConnected(function() {
            updatePhoneUI('connected');
            startTranscriptPolling(phoneState.contactId);
          });
          contact.onEnded(function() {
            phoneState.active = false;
            stopTranscriptPolling();
            updatePhoneUI('ended');
            setTimeout(() => updatePhoneUI('ready'), 3000);
          });
        });
      } catch(e) {
        console.warn('CCP init error:', e);
        document.getElementById('phone-status').textContent = 'CCP unavailable - using API mode';
      }
    }

    function dialDigit(d) {
      const input = document.getElementById('phone-number');
      input.value += d;
    }

    async function phoneAction() {
      if (phoneState.active) {
        await endCall();
      } else {
        await initiateCall();
      }
    }

    function normalizePhoneNumber(raw) {
      let num = raw.replace(/[\s\-()]/g, '');
      if (num.startsWith('0') && !num.startsWith('+')) {
        num = '+81' + num.substring(1);
      }
      return num;
    }

    async function initiateCall() {
      const raw = document.getElementById('phone-number').value.trim();
      if (!raw) return;
      const number = normalizePhoneNumber(raw);
      updatePhoneUI('dialing');

      if (phoneState.ccpInitialized && typeof connect !== 'undefined') {
        try {
          const agent = new connect.Agent();
          const ep = connect.Endpoint.byPhoneNumber(number);
          agent.connect(ep, { success: function() {}, failure: function() { fallbackApiCall(number); }});
          return;
        } catch(e) { /* fallback to API */ }
      }

      await fallbackApiCall(number);
    }

    async function fallbackApiCall(number) {
      try {
        const token = localStorage.getItem('auth_token');
        const sessionId = localStorage.getItem('session_id') || '';
        const resp = await fetch('/api/v1/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': 'Bearer ' + token } : {}) },
          body: JSON.stringify({
            message: `[SYSTEM] Call ${number} now. Use the phone_call tool with action "initiate" and phone_number "${number}".`,
            session_id: sessionId,
            agent: 'auto'
          })
        });
        const data = await resp.json();
        if (data.response && data.response.includes('contact_id')) {
          try {
            const match = data.response.match(/"contact_id"\s*:\s*"([^"]+)"/);
            if (match) {
              phoneState.contactId = match[1];
              phoneState.active = true;
              updatePhoneUI('connected');
              startTranscriptPolling(phoneState.contactId);
              return;
            }
          } catch(e) {}
        }
        updatePhoneUI('ready');
        if (data.response) document.getElementById('phone-status').textContent = 'Call initiated via AI';
      } catch(e) {
        updatePhoneUI('ready');
        document.getElementById('phone-status').textContent = 'Call failed: ' + e.message;
      }
    }

    async function endCall() {
      if (!phoneState.contactId) { updatePhoneUI('ready'); return; }

      if (phoneState.ccpInitialized && typeof connect !== 'undefined') {
        try {
          const agent = new connect.Agent();
          const contacts = agent.getContacts();
          contacts.forEach(c => { try { c.getAgentConnection().destroy(); } catch(e){} });
        } catch(e) {}
      }

      try {
        const token = localStorage.getItem('auth_token');
        const sessionId = localStorage.getItem('session_id') || '';
        await fetch('/api/v1/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': 'Bearer ' + token } : {}) },
          body: JSON.stringify({
            message: `[SYSTEM] End the call. Use phone_call tool with action "end" and contact_id "${phoneState.contactId}".`,
            session_id: sessionId,
            agent: 'auto'
          })
        });
      } catch(e) {}

      phoneState.active = false;
      phoneState.contactId = null;
      stopTranscriptPolling();
      updatePhoneUI('ready');
    }

    function updatePhoneUI(state) {
      const statusEl = document.getElementById('phone-status');
      const actionBtn = document.getElementById('phone-call-action');
      const phoneBtn = document.getElementById('app-phone-btn');

      switch(state) {
        case 'ready':
          statusEl.textContent = 'Ready';
          actionBtn.classList.remove('hangup');
          actionBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          phoneBtn.classList.remove('active');
          break;
        case 'dialing':
          statusEl.textContent = 'Dialing...';
          actionBtn.classList.add('hangup');
          actionBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          break;
        case 'connecting':
          statusEl.textContent = 'Connecting...';
          break;
        case 'connected':
          statusEl.textContent = 'On Call';
          actionBtn.classList.add('hangup');
          actionBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
          phoneBtn.classList.add('active');
          break;
        case 'ended':
          statusEl.textContent = 'Call Ended';
          actionBtn.classList.remove('hangup');
          break;
      }
    }

    function startTranscriptPolling(contactId) {
      stopTranscriptPolling();
      const transcriptEl = document.getElementById('phone-transcript');
      transcriptEl.innerHTML = '';

      phoneState.transcriptPoll = setInterval(async () => {
        try {
          const token = localStorage.getItem('auth_token');
          const resp = await fetch('/api/v1/connect/transcript/' + contactId, {
            headers: token ? { 'Authorization': 'Bearer ' + token } : {}
          });
          if (!resp.ok) return;
          const data = await resp.json();
          if (data.segments && data.segments.length > 0) {
            transcriptEl.innerHTML = data.segments.map(s =>
              '<div class="segment"><span class="speaker">' +
              (s.speaker || '?') + ':</span> ' + (s.content || '') + '</div>'
            ).join('');
            transcriptEl.scrollTop = transcriptEl.scrollHeight;
          }
        } catch(e) {}
      }, 3000);
    }

    function stopTranscriptPolling() {
      if (phoneState.transcriptPoll) {
        clearInterval(phoneState.transcriptPoll);
        phoneState.transcriptPoll = null;
      }
    }

    // ---------------------------------------------------------------------------
    // Idle Points Reward System
    // ---------------------------------------------------------------------------
    let idlePoints = parseInt(localStorage.getItem('idle_points') || '0');
    let lastActiveTime = parseInt(localStorage.getItem('last_active_time') || Date.now());

    function updatePointsDisplay() {
      const pointsEl = document.getElementById('points-count');
      if (pointsEl) {
        pointsEl.textContent = idlePoints.toLocaleString();
        // Pulse animation when points increase
        pointsEl.style.animation = 'none';
        setTimeout(() => { pointsEl.style.animation = 'pulse 0.3s ease'; }, 10);
      }
      localStorage.setItem('idle_points', idlePoints.toString());
    }

    function checkIdleReward() {
      const now = Date.now();
      const offlineMinutes = Math.floor((now - lastActiveTime) / 60000);

      if (offlineMinutes > 0) {
        idlePoints += offlineMinutes;
        localStorage.setItem('idle_points', idlePoints.toString());
        updatePointsDisplay();

        // Show reward notification
        if (offlineMinutes >= 1) {
          const lang = document.documentElement.lang || 'ja';
          const msg = lang === 'ja'
            ? `おかえりなさい！${offlineMinutes}分間のオフライン報酬: +${offlineMinutes}pts ⭐️`
            : `Welcome back! Offline reward for ${offlineMinutes} min: +${offlineMinutes}pts ⭐️`;

          const toast = document.createElement('div');
          toast.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(34,197,94,0.95),rgba(16,185,129,0.95));color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;box-shadow:0 8px 32px rgba(34,197,94,0.4);z-index:10000;animation:slideDown 0.5s ease;pointer-events:none;';
          toast.textContent = msg;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }
      }

      // Update last active time
      lastActiveTime = now;
      localStorage.setItem('last_active_time', lastActiveTime.toString());
    }

    // Track visibility changes
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // User left the page - save current time
        lastActiveTime = Date.now();
        localStorage.setItem('last_active_time', lastActiveTime.toString());
      } else {
        // User returned - check for idle rewards
        checkIdleReward();
      }
    });

    // Check on page load
    checkIdleReward();
    updatePointsDisplay();

    // Update last active time periodically while on page
    setInterval(function() {
      if (!document.hidden) {
        lastActiveTime = Date.now();
        localStorage.setItem('last_active_time', lastActiveTime.toString());
      }
    }, 10000); // Every 10 seconds
  </script>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('/sw.js').catch(()=>{});</script>
</body>
</html>
