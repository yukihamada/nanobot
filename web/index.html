<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <title>chatweb.ai - AIチャット</title>
  <meta name="description" content="AIとすぐに話せる。LINE・Telegramでも使える。無料。">
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%236366f1'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-size='18' font-weight='800' font-family='sans-serif' fill='white'%3Ecw%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%236366f1'/%3E%3Ctext x='90' y='115' text-anchor='middle' font-size='80' font-weight='800' font-family='sans-serif' fill='white'%3Ecw%3C/text%3E%3C/svg%3E">
  <!-- OGP -->
  <meta property="og:title" content="chatweb.ai - AI Agent Platform">
  <meta property="og:description" content="AI assistant with web search, tools, and multi-channel support. Use on Web, LINE, and Telegram.">
  <meta property="og:image" content="https://chatweb.ai/og.svg">
  <meta property="og:url" content="https://chatweb.ai">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="chatweb.ai">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="chatweb.ai - AI Agent Platform">
  <meta name="twitter:description" content="AI assistant with web search, tools, and multi-channel support.">
  <meta name="twitter:image" content="https://chatweb.ai/og.svg">
  <!-- Canonical & PWA -->
  <link rel="canonical" href="https://chatweb.ai/">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="chatweb.ai">
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "chatweb.ai",
    "url": "https://chatweb.ai",
    "description": "Voice-first AI assistant. Research, automation, development - all by voice. Works on Web, LINE, and Telegram.",
    "applicationCategory": "ProductivityApplication",
    "operatingSystem": "Web",
    "offers": [
      {"@type": "Offer", "name": "Free", "price": "0", "priceCurrency": "USD"},
      {"@type": "Offer", "name": "Starter", "price": "9", "priceCurrency": "USD"},
      {"@type": "Offer", "name": "Pro", "price": "29", "priceCurrency": "USD"}
    ],
    "featureList": "Voice Input, Web Search, Multi-Channel (LINE, Telegram, Web), 5+ AI Models, Long-term Memory, TTS, REST API, SSE Streaming, Slash Commands, Conversation Sharing",
    "inLanguage": ["ja", "en"],
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://chatweb.ai/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "documentation": "https://chatweb.ai/docs",
    "sameAs": ["https://github.com/yukihamada/nanobot", "https://teai.io"]
  }
  </script>
  <!-- Preconnect to API Gateway for faster first request -->
  <link rel="preconnect" href="https://chatweb.ai">
  <link rel="dns-prefetch" href="https://chatweb.ai">
  <style>
    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface2: #1e1e24;
      --border: #27272a;
      --text: #fafafa;
      --muted: #71717a;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-glow: rgba(99,102,241,0.25);
      --green: #22c55e;
      --line: #06C755;
      --tg: #2AABEE;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animations */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
      50% { box-shadow: 0 0 40px var(--accent-glow), 0 0 60px rgba(99,102,241,0.1); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .fade-up { animation: fadeUp 0.6s ease-out both; }
    .fade-up-d1 { animation-delay: 0.1s; }
    .fade-up-d2 { animation-delay: 0.2s; }
    .fade-up-d3 { animation-delay: 0.3s; }
    .fade-up-d4 { animation-delay: 0.4s; }

    /* Scroll-triggered animation */
    .scroll-fade-up {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .scroll-fade-up.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Nav */
    nav {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: fadeIn 0.5s ease-out;
    }
    .logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
    .logo span { background: linear-gradient(135deg, var(--accent), #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-right { display: flex; align-items: center; gap: 16px; }
    .nav-right a { color: var(--muted); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s; }
    .nav-right a:hover { color: var(--text); }
    .lang-sw {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
    }
    .lang-sw button {
      background: none; border: none; color: var(--muted);
      padding: 5px 12px; font-size: 11px; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .lang-sw button.on { background: var(--accent); color: #fff; }

    /* Main */
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 24px 80px;
    }

    /* Hero */
    .hero {
      text-align: center;
      margin-bottom: 28px;
      position: relative;
    }
    .hero h1 {
      font-size: 42px;
      font-weight: 900;
      letter-spacing: -1.5px;
      margin-bottom: 12px;
      line-height: 1.15;
      background: linear-gradient(135deg, #fff 0%, #a5a5ff 50%, #fff 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s ease-in-out infinite;
    }
    .hero p {
      color: var(--muted);
      font-size: 17px;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .hero-cta {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .hero-cta a {
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .hero-cta .cta-primary {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .hero-cta .cta-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-glow); }
    .hero-cta .cta-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .hero-cta .cta-secondary:hover { border-color: var(--accent); transform: translateY(-2px); }

    /* Voice demo */
    .voice-demo {
      text-align: center;
      margin-bottom: 28px;
      padding: 0 16px;
    }
    .voice-demo-label {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .voice-demo-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0;
    }
    .voice-demo-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }
    .voice-demo-btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .voice-demo-btn.playing {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    .voice-demo-output {
      max-width: 600px;
      margin: 12px auto 0;
      min-height: 48px;
      font-size: 15px;
      color: var(--muted);
      line-height: 1.6;
      transition: color 0.3s ease;
    }
    .voice-demo-output.active {
      color: var(--text);
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 32px;
      padding: 20px 0;
      flex-wrap: wrap;
    }
    .stat-item { text-align: center; }
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--green), #4ade80);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Chat widget */
    .chat-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 28px;
      animation: pulse-glow 4s ease-in-out infinite;
      position: relative;
    }
    .chat-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
    }
    .chat-header .dot {
      width: 8px; height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
    }
    #agent-select {
      margin-left: auto;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      outline: none;
    }
    #agent-select:hover { border-color: var(--accent); }

    /* Channel bar in chat header */
    .ch-bar { display: flex; gap: 6px; margin-left: 8px; }
    .ch-bar-btn {
      display: flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
      color: #fff; cursor: pointer; border: none; transition: all 0.2s;
      text-decoration: none;
    }
    .ch-bar-btn.line-bar { background: var(--line); }
    .ch-bar-btn.tg-bar { background: var(--tg); }
    .ch-bar-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
    .ch-bar-btn .ch-check { display: none; margin-left: 2px; }
    .ch-bar-btn.connected .ch-check { display: inline; }
    .ch-bar-btn.connected { opacity: 0.85; }
    .ch-bar-btn svg { width: 14px; height: 14px; }

    /* Channel cards (larger CTA) */
    .channel-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 28px; }
    .channel-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
      padding: 20px; cursor: pointer; transition: all 0.25s; text-decoration: none; color: var(--text);
    }
    .channel-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .channel-card.line-card { border-color: rgba(6,199,85,0.3); }
    .channel-card.line-card:hover { border-color: var(--line); }
    .channel-card.tg-card { border-color: rgba(42,171,238,0.3); }
    .channel-card.tg-card:hover { border-color: var(--tg); }
    .channel-card .cc-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .channel-card .cc-icon {
      width: 36px; height: 36px; border-radius: 10px; display: flex;
      align-items: center; justify-content: center; flex-shrink: 0;
    }
    .channel-card.line-card .cc-icon { background: var(--line); }
    .channel-card.tg-card .cc-icon { background: var(--tg); }
    .channel-card .cc-name { font-size: 15px; font-weight: 700; }
    .channel-card .cc-desc { font-size: 12px; color: var(--muted); line-height: 1.5; margin-bottom: 10px; }
    .channel-card .cc-action {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 13px; font-weight: 600; color: #fff;
      padding: 8px 16px; border-radius: 8px;
    }
    .channel-card.line-card .cc-action { background: var(--line); }
    .channel-card.tg-card .cc-action { background: var(--tg); }
    .channel-card .cc-connected {
      display: none; font-size: 11px; color: var(--green); font-weight: 600;
      margin-top: 6px;
    }
    .channel-card.connected .cc-connected { display: block; }
    .channel-card.connected .cc-action { opacity: 0.6; }

    /* Tools badge */
    .tools-count { font-size: 11px; color: var(--muted); text-align: center; margin-top: -20px; margin-bottom: 20px; }
    .tools-count span { color: var(--accent-hover); font-weight: 700; }

    .device-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .device-card .device-status { width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0; }
    .device-card .device-info { flex:1; }
    .device-card .device-name { font-size:13px;font-weight:600; }
    .device-card .device-meta { font-size:11px;color:var(--muted); }
    .agent-badge { display:inline-block;font-size:10px;background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:8px;vertical-align:middle; }
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scroll-behavior: smooth;
    }
    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
      animation: slideIn 0.3s ease-out both;
    }
    .msg.bot {
      background: var(--surface2);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .msg.user {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .msg.typing {
      background: var(--surface2);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .msg.typing .thinking-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      animation: fadeIn 0.3s ease-out;
    }
    .msg.typing .thinking-icon {
      font-size: 14px;
      animation: pulse-glow 2s ease-in-out infinite;
      display: inline-block;
    }
    .msg.typing .thinking-text {
      transition: opacity 0.3s ease;
    }
    .msg.typing .thinking-elapsed {
      font-size: 11px;
      color: var(--muted);
      opacity: 0.6;
      font-variant-numeric: tabular-nums;
    }
    .msg.typing .shimmer-bar {
      height: 3px;
      width: 60px;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--surface2) 25%, var(--accent) 50%, var(--surface2) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    /* Tool badge on response */
    .tool-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--accent-hover);
      background: rgba(99,102,241,0.1);
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 12px;
      padding: 2px 8px;
      margin-top: 6px;
      margin-right: 4px;
    }
    .tool-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    /* Channel badge */
    .msg .channel-badge {
      display: inline-block;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .msg .channel-badge.ch-line { background: rgba(6,199,85,0.2); color: var(--line); }
    .msg .channel-badge.ch-telegram { background: rgba(42,171,238,0.2); color: var(--tg); }
    .msg .channel-badge.ch-web { background: rgba(99,102,241,0.15); color: var(--accent-hover); }

    /* QR in link code response */
    .link-qr-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .link-qr-row a {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
      color: #fff;
      transition: transform 0.15s;
    }
    .link-qr-row a:hover { transform: scale(1.05); }
    .link-qr-row a.dl-line { background: var(--line); }
    .link-qr-row a.dl-tg { background: var(--tg); }
    .link-qr-img {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      background: #fff;
      margin-top: 8px;
    }

    /* Link code display */
    .msg .link-code {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 4px;
      padding: 10px 24px;
      border-radius: 10px;
      margin: 8px 0;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .msg .link-code:hover { transform: scale(1.05); }
    .msg .link-steps {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.8;
    }
    .msg .link-steps .step-num {
      display: inline-flex;
      width: 18px; height: 18px;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
    }
    .msg.link-success {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
      border: 1px solid rgba(34,197,94,0.3);
    }

    /* Typewriter cursor */
    .typewriter-cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--accent);
      margin-left: 2px;
      vertical-align: text-bottom;
      animation: blink 0.8s step-end infinite;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid var(--border);
      align-items: center;
    }
    .chat-input input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      padding: 18px 20px;
      font-size: 15px;
      outline: none;
    }
    .chat-input input::placeholder { color: var(--muted); }
    .chat-input button {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border: none;
      color: #fff;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
    }
    .chat-input button:hover { transform: scale(1.05); box-shadow: 0 4px 15px var(--accent-glow); }

    /* Chat login overlay */
    .chat-login-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(9,9,11,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      cursor: pointer;
      z-index: 5;
      backdrop-filter: blur(4px);
      transition: background 0.2s;
    }
    .chat-login-overlay:hover { background: rgba(9,9,11,0.75); }
    .chat-login-overlay span {
      color: var(--accent-hover);
      font-weight: 600;
      font-size: 15px;
    }
    .chat-login-overlay.hidden { display: none; }

    /* Capabilities section */
    .cap-section {
      margin-bottom: 32px;
    }
    .cap-section h2 {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 6px;
      text-align: center;
    }
    .cap-section .cap-sub {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 18px;
    }
    .cap-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .cap-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 14px;
      text-align: center;
      transition: all 0.25s;
    }
    .cap-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .cap-card .cap-icon { font-size: 24px; margin-bottom: 8px; }
    .cap-card .cap-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
    .cap-card .cap-desc { font-size: 11px; color: var(--muted); line-height: 1.4; }
    .cap-card .cap-badge {
      display: inline-block; margin-top: 6px; padding: 2px 8px; border-radius: 4px;
      font-size: 10px; font-weight: 700;
    }
    .cap-badge.built-in { background: rgba(34,197,94,0.15); color: var(--green); }
    .cap-badge.mcp-ext { background: rgba(99,102,241,0.15); color: var(--accent-hover); }
    .cap-mcp-note {
      text-align: center; font-size: 11px; color: var(--muted); margin-top: 4px;
      padding: 10px; background: rgba(99,102,241,0.05); border-radius: 10px;
      border: 1px solid rgba(99,102,241,0.1);
    }
    .cap-mcp-note a { color: var(--accent-hover); text-decoration: none; font-weight: 600; }
    .cap-mcp-note a:hover { text-decoration: underline; }

    /* Recipe cards */
    .recipes { margin-bottom: 32px; }
    .recipes h2 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .recipe-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .recipe-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .recipe-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(99,102,241,0.05), transparent);
      opacity: 0;
      transition: opacity 0.25s;
    }
    .recipe-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .recipe-card:hover::before { opacity: 1; }
    .recipe-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 4px; position: relative; }
    .recipe-card p { font-size: 11px; color: var(--muted); line-height: 1.4; position: relative; }

    /* Sync section */
    .sync-section {
      background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));
      border: 1px solid rgba(99,102,241,0.15);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 28px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .sync-section::before {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(99,102,241,0.06) 0%, transparent 60%);
      animation: float 6s ease-in-out infinite;
    }
    .sync-section h3 {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 8px;
      position: relative;
    }
    .sync-section .sync-desc {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
      position: relative;
    }
    .sync-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      position: relative;
    }
    .sync-flow .channel-icon {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      transition: transform 0.2s;
    }
    .sync-flow .channel-icon:hover { transform: scale(1.05); }
    .sync-flow .channel-icon.web-icon { background: var(--accent); }
    .sync-flow .channel-icon.line-icon { background: var(--line); }
    .sync-flow .channel-icon.tg-icon { background: var(--tg); }
    .sync-flow .sync-arrow {
      color: var(--accent);
      font-size: 18px;
      animation: blink 2s ease-in-out infinite;
    }
    .sync-steps {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      position: relative;
    }
    .sync-step {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 12px;
      transition: all 0.2s;
    }
    .sync-step:hover { border-color: var(--accent); }
    .sync-step .step-number {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 800;
      color: #fff;
      margin: 0 auto 8px;
    }
    .sync-step .step-title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .sync-step .step-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }
    .sync-step code {
      background: rgba(99,102,241,0.15);
      padding: 2px 8px;
      border-radius: 6px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      color: var(--accent-hover);
    }

    /* Channel buttons */
    .channels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 28px;
    }
    .ch-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 18px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      color: #fff;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .ch-btn::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; width: 200%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .ch-btn:hover::before { left: 100%; }
    .ch-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .ch-btn.line { background: linear-gradient(135deg, var(--line), #05b34a); }
    .ch-btn.tg { background: linear-gradient(135deg, var(--tg), #1a95d0); }
    .ch-btn svg { flex-shrink: 0; }

    /* Trust bar */
    .trust-bar {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 12px 0;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .trust-item { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
    .trust-item svg { width: 14px; height: 14px; fill: var(--green); }

    /* Bottom CTA */
    .bottom-cta {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.08), rgba(34,197,94,0.04));
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 20px;
      padding: 40px 32px;
      text-align: center;
      margin-bottom: 32px;
    }
    .bottom-cta h2 { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
    .bottom-cta p { color: var(--muted); font-size: 14px; margin-bottom: 20px; max-width: 480px; margin-left: auto; margin-right: auto; }
    .bottom-cta .cta-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .bottom-cta a {
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s;
    }
    .bottom-cta .cta-primary {
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #fff;
    }
    .bottom-cta .cta-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--accent-glow); }
    .bottom-cta .price-hint { font-size: 12px; color: var(--muted); margin-top: 12px; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 36px;
      text-align: center;
      max-width: 380px;
      width: 90%;
      animation: fadeUp 0.3s ease-out;
    }
    .modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .modal p { font-size: 13px; color: var(--muted); margin-bottom: 16px; }
    .modal .qr-wrapper {
      position: relative;
      display: inline-block;
      width: 200px;
      height: 200px;
      margin-bottom: 16px;
    }
    .modal .qr-wrapper img {
      width: 200px;
      height: 200px;
      border-radius: 14px;
      background: #fff;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .modal .qr-wrapper img.loaded { opacity: 1; }
    .modal .qr-spinner {
      position: absolute;
      top: 50%; left: 50%;
      width: 32px; height: 32px;
      margin: -16px 0 0 -16px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .modal .qr-spinner.hidden { display: none; }
    .modal .modal-link {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 10px;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      transition: transform 0.2s;
    }
    .modal .modal-link:hover { transform: scale(1.05); }
    .modal .modal-link.line-bg { background: linear-gradient(135deg, var(--line), #05b34a); }
    .modal .modal-link.tg-bg { background: linear-gradient(135deg, var(--tg), #1a95d0); }
    .modal .modal-link.whatsapp-bg { background: linear-gradient(135deg, #25D366, #128C7E); }
    .modal .modal-link.discord-bg { background: linear-gradient(135deg, #5865F2, #4752C4); }
    .modal .modal-link.slack-bg { background: linear-gradient(135deg, #4A154B, #611f69); }
    .modal .modal-link.teams-bg { background: linear-gradient(135deg, #6264A7, #464775); }
    .modal .close-btn {
      display: block;
      margin-top: 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .modal .close-btn:hover { color: var(--text); }

    /* Card hover glow */
    .cap-card, .recipe-card, .channel-card {
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .cap-card:hover, .recipe-card:hover, .channel-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 30px var(--accent-glow), 0 0 0 1px rgba(99,102,241,0.15);
    }

    /* Sync icon float animation */
    .sync-flow .channel-icon { animation: float 3s ease-in-out infinite; }
    .sync-flow .channel-icon:nth-child(3) { animation-delay: 0.3s; }
    .sync-flow .channel-icon:nth-child(5) { animation-delay: 0.6s; }

    /* Chat input focus glow */
    .chat-input input:focus {
      box-shadow: 0 0 0 2px var(--accent-glow), 0 0 20px rgba(99,102,241,0.15);
    }

    /* Message slideIn */
    .msg { animation: slideIn 0.3s ease-out; }

    /* Auth nav */
    .auth-nav-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .auth-nav-btn:hover { background: var(--accent-hover); }
    .auth-nav-btn.logout-btn { background: var(--surface); border: 1px solid var(--border); color: var(--muted); font-size: 12px; padding: 4px 10px; }
    .user-menu { display: flex; align-items: center; gap: 8px; }
    .user-name { font-size: 13px; color: var(--text); font-weight: 500; }

    /* Auth modal */
    .auth-modal { max-width: 360px; }
    .auth-tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
    .auth-tab {
      flex: 1;
      background: none;
      border: none;
      color: var(--muted);
      padding: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }
    .auth-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .auth-input {
      display: block;
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-input:focus { border-color: var(--accent); }
    .auth-submit {
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .auth-submit:hover { background: var(--accent-hover); }
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: var(--muted);
      font-size: 12px;
    }
    .auth-divider::before, .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .auth-divider span { padding: 0 12px; }
    .auth-google-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .auth-google-btn:hover { background: #f5f5f5; }
    .auth-error {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      color: #ef4444;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 12px;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      z-index: 200;
      display: flex;
      flex-direction: column;
      transition: left 0.3s ease;
    }
    .sidebar.open { left: 0; }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header h3 { font-size: 16px; font-weight: 700; }
    .sidebar-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }
    .sidebar-new-btn {
      margin: 12px 16px;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar-new-btn:hover { background: var(--accent-hover); }
    .sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px;
    }
    .sidebar-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text);
      transition: background 0.2s;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-item:hover { background: var(--surface2); }
    .sidebar-item.active { background: var(--accent-glow); color: var(--accent-hover); }
    .sidebar-toggle {
      position: fixed;
      top: 16px;
      left: 8px;
      z-index: 150;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Footer */
    footer { text-align: center; padding: 32px 24px; font-size: 12px; color: var(--muted); }
    footer a { color: var(--muted); transition: color 0.2s; }
    footer a:hover { color: var(--text); }

    /* Scrollbar */
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* ===== ChatGPT-like App Mode (authenticated) ===== */
    body.app-mode { overflow: hidden; }
    body.app-mode nav {
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 100;
      height: 48px;
    }
    body.app-mode .nav-right > a,
    body.app-mode .nav-right > .lang-sw,
    body.app-mode .nav-hamburger,
    body.app-mode #auth-nav { display: none !important; }
    body.app-mode .main { display: none; }
    body.app-mode footer { display: none; }

    /* App layout container */
    .app-container {
      display: none;
      position: fixed;
      top: 48px; left: 0; right: 0; bottom: 0;
    }
    body.app-mode .app-container { display: flex; }

    /* App sidebar (always visible on desktop) */
    .app-sidebar {
      width: 260px;
      background: var(--bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .app-sidebar-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .app-sidebar-new {
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .app-sidebar-new:hover { background: var(--surface); }
    .app-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .app-sidebar-list::-webkit-scrollbar { width: 4px; }
    .app-sidebar-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .app-conv-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--muted);
      transition: background 0.2s, color 0.2s;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .app-conv-item:hover { background: var(--surface); color: var(--text); }
    .app-conv-item.active { background: var(--surface); color: var(--text); }
    .conv-date-group { margin-bottom: 4px; }
    .conv-date-header {
      display: flex; align-items: center; gap: 4px;
      padding: 6px 12px 4px; font-size: 11px; font-weight: 600;
      color: var(--muted); cursor: pointer; user-select: none;
    }
    .conv-date-header:hover { color: var(--text); }
    .conv-date-header .chevron {
      transition: transform 0.2s; font-size: 10px;
    }
    .conv-date-header.collapsed .chevron { transform: rotate(-90deg); }
    .conv-date-items { overflow: hidden; }
    .conv-date-items.collapsed { display: none; }
    .app-sidebar-channels {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
    }
    .app-sidebar-channels-label {
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding: 0 4px;
    }
    .app-sidebar-channels-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .app-ch-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 4px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      position: relative;
    }
    .app-ch-btn:hover { background: var(--surface); border-color: var(--accent); transform: translateY(-1px); }
    .app-ch-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
    .app-ch-btn .app-ch-name { font-size: 9px; color: var(--muted); font-weight: 600; }
    .app-ch-btn.connected .app-ch-name { color: var(--green); }
    .app-ch-btn .app-ch-check {
      position: absolute;
      top: 2px; right: 2px;
      width: 12px; height: 12px;
      background: var(--green);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: #fff;
    }
    .app-ch-btn.connected .app-ch-check { display: flex; }
    .app-sidebar-sync {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
      font-size: 11px; color: var(--muted);
    }
    .sync-btn {
      background: none; border: 1px solid var(--border); color: var(--muted);
      border-radius: 6px; padding: 4px 10px; cursor: pointer; font-size: 11px;
      display: flex; align-items: center; gap: 4px; transition: all 0.2s;
    }
    .sync-btn:hover { border-color: var(--accent); color: var(--text); }
    .sync-btn.syncing svg { animation: spin 0.8s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .sync-info { flex: 1; text-align: right; font-size: 10px; line-height: 1.3; }
    .sync-info .sync-interval { color: var(--accent); }
    .app-sidebar-cron {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
    }
    .app-sidebar-cron-label {
      font-size: 11px; color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 6px; padding: 0 4px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .cron-add-btn {
      background: none; border: none; color: var(--accent); cursor: pointer;
      font-size: 14px; padding: 0 4px; line-height: 1;
    }
    .cron-add-btn:hover { opacity: 0.8; }
    .cron-list { display: flex; flex-direction: column; gap: 4px; max-height: 120px; overflow-y: auto; }
    .cron-item {
      display: flex; align-items: center; gap: 6px; padding: 6px 8px;
      background: var(--surface); border-radius: 6px; font-size: 11px;
    }
    .cron-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); }
    .cron-item-schedule { color: var(--muted); font-size: 10px; font-family: monospace; }
    .cron-item-toggle { width: 28px; height: 16px; border-radius: 8px; border: none; cursor: pointer;
      background: var(--border); position: relative; transition: background 0.2s; flex-shrink: 0; }
    .cron-item-toggle.on { background: var(--green); }
    .cron-item-toggle::after {
      content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px;
      background: #fff; border-radius: 50%; transition: transform 0.2s;
    }
    .cron-item-toggle.on::after { transform: translateX(12px); }
    .cron-item-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px; padding: 0 2px; }
    .cron-item-del:hover { color: #e74c3c; }
    .cron-form { background: var(--surface); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 6px; }
    .cron-form input, .cron-form select { background: var(--bg); border: 1px solid var(--border); color: var(--text);
      border-radius: 4px; padding: 6px 8px; font-size: 11px; }
    .cron-form-row { display: flex; gap: 6px; }
    .cron-form-actions { display: flex; gap: 6px; justify-content: flex-end; }
    .cron-form-actions button { padding: 4px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; border: none; }
    .cron-save-btn { background: var(--accent); color: #fff; }
    .cron-cancel-btn { background: var(--border); color: var(--text); }
    .app-sidebar-footer {
      padding: 12px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }
    .app-sidebar-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .app-sidebar-user:hover { background: var(--surface); }
    .app-sidebar-user-avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .app-sidebar-user-name {
      flex: 1;
      font-size: 13px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* App chat area */
    .app-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      min-width: 0;
    }
    .app-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }
    .app-chat-messages::-webkit-scrollbar { width: 6px; }
    .app-chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .app-chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      gap: 24px;
      padding-bottom: 60px;
    }
    .app-chat-empty-logo {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    .app-chat-empty-text { font-size: 15px; color: var(--muted); }

    /* Voice hero button - the primary CTA */
    .voice-hero-btn {
      width: 100px; height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 0 0 rgba(99,102,241,0.3);
    }
    .voice-hero-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(99,102,241,0.4);
    }
    .voice-hero-btn:active { transform: scale(0.95); }
    .voice-hero-btn svg { width: 40px; height: 40px; }
    .voice-hero-btn::before {
      content: '';
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      border: 2px solid rgba(99,102,241,0.15);
      animation: voice-ring 3s ease-in-out infinite;
    }
    .voice-hero-btn::after {
      content: '';
      position: absolute;
      inset: -14px;
      border-radius: 50%;
      border: 1px solid rgba(99,102,241,0.08);
      animation: voice-ring 3s ease-in-out infinite 0.5s;
    }
    @keyframes voice-ring {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.08); opacity: 0.5; }
    }
    .voice-hero-btn.recording {
      background: linear-gradient(135deg, #ef4444, #f97316);
      animation: voice-pulse 1.5s ease-in-out infinite;
    }
    @keyframes voice-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
    }
    .voice-hero-label {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.5px;
    }

    .app-chat-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 500px;
      margin-top: 8px;
    }
    .app-chat-suggestion {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .app-chat-suggestion:hover { border-color: var(--accent); color: var(--text); }
    .app-chat-input-area {
      padding: 12px 16px 16px;
      max-width: 760px;
      width: 100%;
      margin: 0 auto;
    }
    .app-chat-input-box {
      display: flex;
      align-items: flex-end;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 6px 6px 6px 8px;
      transition: border-color 0.2s, box-shadow 0.2s;
      gap: 4px;
    }
    .app-chat-input-box:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .app-chat-input-box textarea {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-size: 15px;
      padding: 8px 8px;
      resize: none;
      outline: none;
      max-height: 150px;
      font-family: inherit;
      line-height: 1.5;
    }
    .app-chat-input-box textarea::placeholder { color: var(--muted); }
    .app-chat-send-btn {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .app-chat-send-btn:hover { background: var(--accent-hover); transform: scale(1.05); }
    .app-chat-send-btn:disabled { opacity: 0.3; cursor: default; transform: none; }
    .app-chat-model-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 4px 0;
      font-size: 12px;
      color: var(--muted);
    }
    .app-chat-model-bar select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l5 6 5-6' fill='%23888'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 6px center;
      padding-right: 20px;
    }

    /* Mic button (STT) in input box */
    .app-chat-mic-btn {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: transparent;
      border: 1.5px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .app-chat-mic-btn:hover { background: rgba(99,102,241,0.1); color: var(--accent); border-color: var(--accent); }
    .app-chat-mic-btn.recording {
      background: #ef4444;
      border-color: #ef4444;
      color: #fff;
      animation: mic-rec-pulse 1.2s infinite;
    }
    @keyframes mic-rec-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
    }
    body.no-speech-api .app-chat-mic-btn { display: none; }
    body.no-speech-api .voice-hero-btn { display: none; }
    body.no-speech-api .voice-hero-label { display: none; }

    /* TTS button */
    .app-tts-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 16px;
      margin-top: 8px;
      transition: all 0.2s;
    }
    .app-tts-btn:hover { background: rgba(99,102,241,0.1); color: var(--accent); border-color: var(--accent); }
    .app-tts-btn.playing {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* Settings modal */
    .settings-modal { max-width: 420px; text-align: left; }
    .settings-modal h3 { text-align: center; }
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-item-info { flex: 1; }
    .settings-item-label { font-size: 14px; font-weight: 600; color: var(--text); }
    .settings-item-desc { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .settings-toggle {
      position: relative;
      width: 44px; height: 24px;
      background: var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
      margin-left: 12px;
      border: none;
    }
    .settings-toggle.active { background: var(--accent); }
    .settings-toggle::after {
      content: '';
      position: absolute;
      top: 2px; left: 2px;
      width: 20px; height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .settings-toggle.active::after { transform: translateX(20px); }

    /* Credit display */
    .credit-display {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
    }
    .credit-display .credit-count {
      font-weight: 600;
      transition: color 0.3s;
    }
    .credit-flash .credit-count {
      color: #f5a623;
      animation: credit-pulse 0.5s ease-out;
    }
    @keyframes credit-pulse {
      0% { transform: scale(1.3); color: #f5a623; }
      100% { transform: scale(1); }
    }

    /* App mode message styling */
    .app-chat-messages .app-msg {
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      padding: 0 16px;
      animation: msg-in 0.3s ease-out;
    }
    @keyframes msg-in {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .app-chat-messages .app-msg-user {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 2px;
    }
    .app-chat-messages .app-msg-user .app-msg-bubble {
      background: var(--accent);
      color: #fff;
      padding: 10px 16px;
      border-radius: 20px 20px 6px 20px;
      max-width: 75%;
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .app-chat-messages .app-msg-bot {
      display: flex;
      gap: 10px;
      margin-bottom: 2px;
    }
    .app-chat-messages .app-msg-bot .app-msg-avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .app-chat-messages .app-msg-bot .app-msg-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.75;
      color: var(--text);
      word-break: break-word;
      white-space: pre-wrap;
      min-width: 0;
    }

    /* Explore mode cards */
    .explore-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .explore-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      transition: border-color 0.2s;
    }
    .explore-card:hover {
      border-color: var(--accent);
    }
    .explore-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .explore-model-name {
      font-weight: 600;
      color: var(--text);
    }
    .explore-time-badge {
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: var(--muted);
    }
    .explore-fallback-badge {
      background: #f59e0b22;
      color: #f59e0b;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    .explore-card-body {
      font-size: 13px;
      line-height: 1.65;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
    }
    .explore-card-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    .explore-adopt-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .explore-adopt-btn:hover {
      background: var(--accent);
      color: #fff;
    }
    .explore-actions-bar {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .explore-action-btn {
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .explore-action-btn:hover {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .explore-level-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      margin-left: auto;
    }
    .explore-pending {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      padding: 6px 0;
    }
    .explore-pending .dot-pulse {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: pulse-glow 1s infinite;
    }

    /* Agent progress (tool execution steps) */
    .agent-progress {
      margin: 8px 0;
      padding: 8px 12px;
      background: var(--surface, #f5f5f5);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted, #888);
      border-left: 3px solid var(--primary, #4f46e5);
    }
    [data-theme="dark"] .agent-progress {
      background: #1a1a2e;
    }
    .agent-progress .tool-step { padding: 4px 0; }
    .agent-progress .tool-step pre {
      margin: 2px 0 0 18px;
      font-size: 12px;
      max-height: 120px;
      overflow: auto;
      background: var(--code-bg, #1e1e1e);
      color: var(--code-fg, #d4d4d4);
      padding: 6px 8px;
      border-radius: 4px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* API Keys modal */
    .apikey-modal { max-width: 480px; text-align: left; }
    .apikey-modal h3 { text-align: center; }
    .apikey-list { margin: 12px 0; max-height: 200px; overflow-y: auto; }
    .apikey-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .apikey-item-info { flex: 1; min-width: 0; }
    .apikey-item-name { font-size: 13px; font-weight: 600; }
    .apikey-item-prefix { font-size: 11px; color: var(--muted); font-family: monospace; }
    .apikey-item-date { font-size: 10px; color: var(--muted); }
    .apikey-delete-btn {
      background: none; border: none; color: #ef4444; cursor: pointer;
      font-size: 16px; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;
    }
    .apikey-delete-btn:hover { background: rgba(239,68,68,0.1); }
    .apikey-create-row { display: flex; gap: 8px; margin-top: 12px; }
    .apikey-create-row input {
      flex: 1; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 13px; outline: none;
    }
    .apikey-create-row input:focus { border-color: var(--accent); }
    .apikey-create-row button {
      padding: 8px 16px; background: var(--accent); color: #fff; border: none;
      border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
      white-space: nowrap;
    }
    .apikey-new-key {
      margin-top: 12px; padding: 12px; background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3); border-radius: 8px;
    }
    .apikey-new-key-label { font-size: 11px; color: var(--green); font-weight: 600; margin-bottom: 4px; }
    .apikey-new-key-value {
      font-family: monospace; font-size: 13px; word-break: break-all;
      cursor: pointer; color: var(--text);
    }
    .apikey-new-key-hint { font-size: 10px; color: var(--muted); margin-top: 4px; }

    /* App sidebar settings/docs links */
    .app-sidebar-links {
      padding: 4px 12px 8px;
      display: flex;
      gap: 6px;
    }
    .app-sidebar-link {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      background: transparent;
      border: 1px solid var(--border);
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: all 0.2s;
    }
    .app-sidebar-link:hover { color: var(--text); border-color: var(--accent); }

    /* App sidebar backdrop (mobile) */
    .app-sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 199;
    }
    .app-sidebar-backdrop.show { display: block; }

    /* Mobile toggle for app sidebar */
    .app-sidebar-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
    }

    @media (max-width: 768px) {
      .app-sidebar {
        position: fixed;
        top: 44px; left: -280px; bottom: 0;
        width: 280px;
        z-index: 200;
        transition: left 0.3s ease;
      }
      .app-sidebar.open { left: 0; }
      .app-sidebar-toggle { display: block; }
      .app-sidebar, .app-container { top: 44px; }
      body.app-mode nav { padding: 6px 10px; height: 44px; }
      body.app-mode .logo { font-size: 16px; }
      body.app-mode .user-name { font-size: 11px; max-width: 100px; }
      body.app-mode .auth-nav-btn.logout-btn { font-size: 11px; padding: 3px 8px; }

      /* Chat messages area - fill screen properly */
      .app-chat-messages { padding: 12px 0; gap: 10px; }
      .app-chat-messages .app-msg { padding: 0 10px; }
      .app-chat-messages .app-msg-user .app-msg-bubble { max-width: 88%; font-size: 14px; padding: 8px 14px; }
      .app-chat-messages .app-msg-bot .app-msg-content { font-size: 14px; max-width: calc(100vw - 70px); }
      .app-chat-messages .app-msg-bot .app-msg-avatar { width: 28px; height: 28px; font-size: 10px; flex-shrink: 0; }
      .app-chat-messages .app-msg-bot { gap: 8px; }

      /* Input area - compact and touch-friendly */
      .app-chat-input-area { padding: 8px 10px calc(env(safe-area-inset-bottom, 8px) + 8px); }
      .app-chat-input-box { border-radius: 14px; padding: 6px; }
      .app-chat-input-box textarea { font-size: 16px; padding: 6px 10px; }
      .app-chat-send-btn { width: 38px; height: 38px; border-radius: 12px; }
      .app-chat-mic-btn { width: 38px; height: 38px; border-radius: 12px; }

      /* Model bar - inline with smaller spacing */
      .app-chat-model-bar { padding: 4px 2px 0; }
      .app-chat-model-bar select { font-size: 12px; padding: 5px 22px 5px 10px; border-radius: 10px; }

      /* Empty state - voice hero */
      .voice-hero-btn { width: 88px; height: 88px; }
      .voice-hero-btn svg { width: 36px; height: 36px; }
      .app-chat-empty-logo { font-size: 24px; }
      .app-chat-empty-text { font-size: 14px; }
      .app-chat-suggestions { gap: 6px; padding: 0 12px; }
      .app-chat-suggestion { font-size: 12px; padding: 8px 14px; }

      /* TTS button - larger touch target on mobile */
      .app-tts-btn { padding: 5px 10px; font-size: 14px; min-height: 32px; }

      /* Sidebar */
      .app-sidebar-channels-grid { grid-template-columns: repeat(3, 1fr); gap: 4px; }
      .app-ch-btn { padding: 6px 2px; }
      .app-ch-btn svg { width: 18px; height: 18px; }
      .app-ch-btn .app-ch-name { font-size: 8px; }
    }

    /* Small phones (iPhone SE, etc.) */
    @media (max-width: 400px) {
      .app-chat-input-area { padding: 6px 8px calc(env(safe-area-inset-bottom, 6px) + 6px); }
      .app-chat-input-box textarea { font-size: 16px; }
      .app-chat-empty-logo { font-size: 22px; }
      .app-chat-messages .app-msg { padding: 0 6px; }
      .app-chat-messages .app-msg-user .app-msg-bubble { max-width: 92%; }
    }

    /* Mobile hamburger menu */
    .nav-hamburger {
      display: none;
      background: none;
      border: none;
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      padding: 4px;
    }
    .nav-mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      min-width: 180px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      z-index: 50;
    }
    .nav-mobile-menu.show { display: block; }
    .nav-mobile-menu a, .nav-mobile-menu button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .nav-mobile-menu a:hover, .nav-mobile-menu button:hover {
      background: var(--surface2);
      color: var(--text);
    }

    @media (max-width: 600px) {
      .hero h1 { font-size: 30px; }
      .channels { grid-template-columns: 1fr; }
      .channel-cards { grid-template-columns: 1fr; }
      .recipe-grid { grid-template-columns: 1fr; }
      .chat-messages { height: 240px; }
      .voice-demo-grid { gap: 8px; }
      .voice-demo-btn { padding: 6px 12px; font-size: 13px; }
      .stats-bar { gap: 20px; }
      .stat-value { font-size: 20px; }
      .bottom-cta { padding: 28px 20px; }
      .bottom-cta h2 { font-size: 20px; }
      .sync-steps { grid-template-columns: 1fr; }
      .sync-flow { gap: 8px; }
      .cap-grid { grid-template-columns: 1fr 1fr; }

      /* Collapse nav to hamburger on mobile */
      nav { padding: 12px 16px; position: relative; }
      .nav-right > a,
      .nav-right > .lang-sw { display: none; }
      .nav-hamburger { display: block; }
      .nav-right { gap: 8px; }
      .auth-nav-btn { font-size: 12px; padding: 5px 12px; }
      .user-name { font-size: 12px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

      /* Chat header: wrap to two rows on mobile */
      .chat-header { flex-wrap: wrap; padding: 10px 14px; gap: 6px; }
      .chat-header .dot { width: 6px; height: 6px; }
      #t-chat-status { font-size: 11px; }
      .ch-bar { margin-left: 0; }
      .ch-bar-btn { padding: 3px 8px; font-size: 10px; }
      .ch-bar-btn svg { width: 12px; height: 12px; }
      #agent-select { font-size: 11px; padding: 4px 6px; margin-left: auto; }

      /* CLI section on mobile */
      #cli-sync-cmd { font-size: 10px !important; }
      #cli-sync-cmd span { font-size: 10px !important; }

      /* Simplify footer on mobile */
      footer { padding: 20px 16px; font-size: 11px; line-height: 2; }
    }
  </style>
  <!-- PostHog Analytics (enable by replacing YOUR_PROJECT_KEY) -->
  <!--
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('YOUR_PROJECT_KEY',{api_host:'https://us.i.posthog.com',person_profiles:'identified_only'});
  </script>
  -->
</head>
<body>
  <script>
    // Instantly apply app-mode if user is logged in (prevent landing page flash)
    if (localStorage.getItem('authToken') || new URLSearchParams(window.location.search).get('token')) {
      document.body.classList.add('app-mode');
    }
  </script>
  <nav>
    <button class="app-sidebar-toggle" id="app-sidebar-toggle" onclick="var s=document.getElementById('app-sidebar'),b=document.getElementById('app-sidebar-backdrop');s.classList.toggle('open');b.classList.toggle('show');" style="display:none;">&#x2630;</button>
    <a href="/" class="logo" style="text-decoration:none"><span>chat</span>web.ai</a>
    <div class="nav-right">
      <a href="/pricing" id="nav-pricing">Pricing</a>
      <a href="/settings" id="nav-settings">Settings</a>
      <a href="/status" id="nav-status">Status</a>
      <a href="https://github.com/yukihamada/nanobot" target="_blank">GitHub</a>
      <div class="lang-sw">
        <button onclick="setLang('ja')" id="l-ja">JA</button>
        <button onclick="setLang('en')" id="l-en">EN</button>
      </div>
      <div id="auth-nav">
        <button class="auth-nav-btn" id="login-btn" onclick="openAuthModal()">Login</button>
        <div class="user-menu" id="user-menu" style="display:none;">
          <span class="user-name" id="user-display-name"></span>
          <button class="auth-nav-btn logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      <button class="nav-hamburger" onclick="toggleMobileMenu()" aria-label="Menu">&#x2630;</button>
      <div class="nav-mobile-menu" id="mobile-menu">
        <a href="/pricing" id="mob-pricing">Pricing</a>
        <a href="/settings">Settings</a>
        <a href="/status" id="mob-status">Status</a>
        <a href="https://github.com/yukihamada/nanobot" target="_blank">GitHub</a>
        <button onclick="setLang('ja');closeMobileMenu()">🇯🇵 日本語</button>
        <button onclick="setLang('en');closeMobileMenu()">🇬🇧 English</button>
      </div>
    </div>
  </nav>

  <!-- Sidebar for conversation history -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3 id="sidebar-title">Conversations</h3>
      <button class="sidebar-close" onclick="toggleSidebar()">&#x2715;</button>
    </div>
    <button class="sidebar-new-btn" id="new-conv-btn" onclick="newConversation()">+ New Conversation</button>
    <div class="sidebar-list" id="conv-list"></div>
  </div>
  <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" style="display:none;">&#x2630;</button>

  <main class="main" role="main">
    <div class="hero fade-up">
      <h1 id="t-title">AIに何でも聞ける。声でも、テキストでも。</h1>
      <p id="t-subtitle">話しかけるだけで、検索・分析・自動化。LINE・Telegramでも使える無料AIアシスタント。</p>
      <div class="hero-cta" id="t-hero-cta">
        <a href="#chat-area" class="cta-primary" id="t-hero-try" onclick="document.getElementById('input').focus();return false;">今すぐ無料で試す</a>
        <a href="/pricing" class="cta-secondary" id="t-hero-plans">プランを見る</a>
      </div>
    </div>

    <div class="voice-demo fade-up fade-up-d1">
      <div class="voice-demo-label" id="t-voice-label">🎙️ AIの声を聴いてみよう</div>
      <div class="voice-demo-grid" id="voice-demo-grid"></div>
      <div class="voice-demo-output" id="voice-demo-output"></div>
    </div>

    <div class="stats-bar fade-up fade-up-d1">
      <div class="stat-item">
        <div class="stat-value" id="stat-uptime">99.9%</div>
        <div class="stat-label" id="stat-uptime-label">稼働率</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-speed">&lt;2s</div>
        <div class="stat-label" id="stat-speed-label">平均応答</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-models">5+</div>
        <div class="stat-label" id="stat-models-label">AIモデル</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-channels">3</div>
        <div class="stat-label" id="stat-channels-label">チャネル</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tools">4+MCP</div>
        <div class="stat-label" id="stat-tools-label">ツール</div>
      </div>
    </div>

    <div class="trust-bar fade-up fade-up-d2">
      <div class="trust-item">
        <svg viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
        <span id="trust-ssl">SSL</span>
      </div>
      <div class="trust-item">
        <svg viewBox="0 0 16 16"><path d="M8 1L1 5v6l7 4 7-4V5L8 1zm0 1.5L13.5 6 8 9.5 2.5 6 8 2.5z"/></svg>
        <span id="trust-stripe">Stripe</span>
      </div>
      <div class="trust-item">
        <svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 6.5l-4 4a.75.75 0 0 1-1 0l-2-2a.75.75 0 1 1 1-1L7 9l3.5-3.5a.75.75 0 1 1 1 1z"/></svg>
        <span id="trust-nocard">No card required</span>
      </div>
    </div>

    <div class="chat-box fade-up fade-up-d2" id="chat-area">
      <div class="chat-header">
        <div class="dot"></div>
        <span id="t-chat-status">オンライン</span>
        <div class="ch-bar">
          <a class="ch-bar-btn line-bar" id="ch-bar-line" onclick="openChannelLink('line');return false;" href="#">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 5.81 2 10.5c0 4.01 3.44 7.37 8.09 8.25.31.07.74.21.85.48.1.25.06.63.03.88l-.14.82c-.04.25-.2.96.84.52s5.58-3.29 7.61-5.63C21.31 13.51 22 12.07 22 10.5 22 5.81 17.52 2 12 2z" fill="#fff"/></svg>
            LINE <span class="ch-check">&#x2713;</span>
          </a>
          <a class="ch-bar-btn tg-bar" id="ch-bar-tg" onclick="openChannelLink('tg');return false;" href="#">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.88 8.85c-.14.63-.51.78-.84.49l-2.31-1.7-1.79 1.72c-.2.2-.36.36-.74.36l.27-3.78 6.88-6.22c.3-.27-.07-.42-.47-.16L8.09 13.29l-2.61-.82c-.57-.18-.58-.57.12-.84l11.03-4.27c.47-.17.88.11.73.79h.17z" fill="#fff"/></svg>
            TG <span class="ch-check">&#x2713;</span>
          </a>
        </div>
        <select id="agent-select" onchange="selectAgent(this.value)">
          <option value="auto" id="opt-auto">Auto</option>
          <option value="assistant">Assistant</option>
          <option value="researcher">Researcher</option>
          <option value="coder">Coder</option>
          <option value="analyst">Analyst</option>
          <option value="creative">Creative</option>
        </select>
      </div>
      <div class="chat-messages" id="messages">
        <div class="msg bot" id="t-welcome"></div>
      </div>
      <div class="chat-input" style="position:relative;">
        <input type="text" id="input" placeholder="何でも聞いてください..." autocomplete="off">
        <button onclick="send()" id="send-btn">送信</button>
        <div id="chat-login-overlay" class="chat-login-overlay" onclick="openAuthModal()">
          <span id="chat-login-text">ログインして会話を始める</span>
        </div>
      </div>
    </div>

    <!-- Capabilities section -->
    <div class="cap-section fade-up fade-up-d3" id="cap-section">
      <h2 id="t-cap-title">AI + ツールで、なんでも自動化</h2>
      <p class="cap-sub" id="t-cap-sub">内蔵ツール + MCP拡張で無限の可能性</p>
      <div class="cap-grid">
        <div class="cap-card">
          <div class="cap-icon">&#x1F50D;</div>
          <div class="cap-name" id="cap-search">Web検索</div>
          <div class="cap-desc" id="cap-search-d">リアルタイムの情報を検索・収集</div>
          <div class="cap-badge built-in" id="cap-search-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F310;</div>
          <div class="cap-name" id="cap-fetch">Webページ取得</div>
          <div class="cap-desc" id="cap-fetch-d">任意のURLからコンテンツを取得</div>
          <div class="cap-badge built-in" id="cap-fetch-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F9EE;</div>
          <div class="cap-name" id="cap-calc">電卓</div>
          <div class="cap-desc" id="cap-calc-d">数式の計算・通貨換算</div>
          <div class="cap-badge built-in" id="cap-calc-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x26C5;</div>
          <div class="cap-name" id="cap-weather">天気</div>
          <div class="cap-desc" id="cap-weather-d">世界中の天気・予報を取得</div>
          <div class="cap-badge built-in" id="cap-weather-b">Built-in</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F4C1;</div>
          <div class="cap-name" id="cap-file">ファイル操作</div>
          <div class="cap-desc" id="cap-file-d">ファイルの読み書き・編集</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F4BB;</div>
          <div class="cap-name" id="cap-shell">シェル実行</div>
          <div class="cap-desc" id="cap-shell-d">コマンドの実行・自動化</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F30F;</div>
          <div class="cap-name" id="cap-browser">ブラウザ</div>
          <div class="cap-desc" id="cap-browser-d">Webページの自動操作</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F5BC;</div>
          <div class="cap-name" id="cap-image">画像解析</div>
          <div class="cap-desc" id="cap-image-d">画像認識・マルチモーダル</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
        <div class="cap-card">
          <div class="cap-icon">&#x1F9E0;</div>
          <div class="cap-name" id="cap-memory">永続メモリ</div>
          <div class="cap-desc" id="cap-memory-d">会話横断で記憶を保持</div>
          <div class="cap-badge mcp-ext">MCP</div>
        </div>
      </div>
      <div class="cap-mcp-note" id="cap-note">
        <span id="cap-note-text">MCPツールはModel Context Protocolで無限に拡張可能。</span>
        <a href="#chat-area" onclick="document.getElementById('input').value='使えるツールを教えて';document.getElementById('input').focus();return false;" id="cap-note-link">ツール一覧を聞いてみる →</a>
      </div>
    </div>

    <div id="recipe-section" class="fade-up fade-up-d3"></div>

    <!-- Sync section -->
    <div class="sync-section fade-up fade-up-d3" id="sync-section">
      <h3 id="t-sync-title">どのチャネルでも同じ会話</h3>
      <p class="sync-desc" id="t-sync-desc">Web・LINE・Telegramの会話をリンクして、どこからでも続きを。</p>
      <div class="sync-flow">
        <div class="channel-icon web-icon">Web</div>
        <div class="sync-arrow">&#x21C4;</div>
        <div class="channel-icon line-icon">LINE</div>
        <div class="sync-arrow">&#x21C4;</div>
        <div class="channel-icon tg-icon">Telegram</div>
      </div>
      <div class="sync-steps" id="sync-steps">
        <div class="sync-step">
          <div class="step-number">1</div>
          <div class="step-title" id="t-step1-title">友だち追加</div>
          <div class="step-desc" id="t-step1-desc">上のボタンからLINE/Telegramで友だち追加</div>
        </div>
        <div class="sync-step">
          <div class="step-number">2</div>
          <div class="step-title" id="t-step2-title">IDで自動連携</div>
          <div class="step-desc" id="t-step2-desc">ボタンを押すだけで自動連携されます</div>
        </div>
        <div class="sync-step">
          <div class="step-number">3</div>
          <div class="step-title" id="t-step3-title">同期完了</div>
          <div class="step-desc" id="t-step3-desc">全チャネルの会話が統合されます</div>
        </div>
      </div>
      <div style="margin-top:16px;position:relative;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px;" id="t-session-label">あなたのセッションID:</div>
        <div id="session-id-display" style="font-family:'SF Mono','Fira Code',monospace;font-size:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer;display:inline-block;color:var(--accent-hover);word-break:break-all;" onclick="navigator.clipboard.writeText(this.textContent);this.style.opacity=0.5;setTimeout(()=>this.style.opacity=1,300)"></div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;" id="t-session-hint">クリックでコピー。LINE/Telegramに貼り付けで連携</div>
      </div>
    </div>

    <!-- Device Monitoring Section -->
    <div class="sync-section fade-up fade-up-d4" id="device-section" style="display:none;">
      <h3 id="t-device-title">Connected Devices</h3>
      <p class="sync-desc" id="t-device-desc">CLI daemon running on your machines.</p>
      <div id="device-list" style="margin-top:12px;"></div>
      <div style="margin-top:12px;font-size:11px;color:var(--muted);" id="t-device-hint">
        Install CLI and run <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">nanobot daemon</code> to connect your devices.
      </div>
    </div>

    <!-- Messenger Integrations -->
    <div class="channel-cards fade-up fade-up-d4" style="flex-wrap:wrap;">
      <a class="channel-card line-card" id="line-card" onclick="openChannelLink('line');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 5.81 2 10.5c0 4.01 3.44 7.37 8.09 8.25.31.07.74.21.85.48.1.25.06.63.03.88l-.14.82c-.04.25-.2.96.84.52s5.58-3.29 7.61-5.63C21.31 13.51 22 12.07 22 10.5 22 5.81 17.52 2 12 2z" fill="#fff"/></svg></div>
          <div class="cc-name">LINE</div>
        </div>
        <div class="cc-desc" id="t-line-desc">1タップで友だち追加 → 自動連携</div>
        <div class="cc-action" id="t-line">LINEで使う</div>
        <div class="cc-connected" id="t-line-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card tg-card" id="tg-card" onclick="openChannelLink('tg');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.88 8.85c-.14.63-.51.78-.84.49l-2.31-1.7-1.79 1.72c-.2.2-.36.36-.74.36l.27-3.78 6.88-6.22c.3-.27-.07-.42-.47-.16L8.09 13.29l-2.61-.82c-.57-.18-.58-.57.12-.84l11.03-4.27c.47-.17.88.11.73.79h.17z" fill="#fff"/></svg></div>
          <div class="cc-name">Telegram</div>
        </div>
        <div class="cc-desc" id="t-tg-desc">ボタンを押すだけ → 今すぐ開始</div>
        <div class="cc-action" id="t-tg">Telegramで使う</div>
        <div class="cc-connected" id="t-tg-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="whatsapp-card" style="background:linear-gradient(135deg,#25D366 0%,#128C7E 100%);" onclick="openChannelLink('whatsapp');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 0C5.37 0 0 5.37 0 12c0 2.12.55 4.13 1.6 5.93L0 24l6.26-1.64C8.01 23.44 9.97 24 12 24c6.63 0 12-5.37 12-12S18.63 0 12 0zm5.8 16.9c-.24.68-1.41 1.3-1.95 1.38-.5.08-1.14.11-1.84-.12-.42-.14-.97-.33-1.67-.65-2.95-1.33-4.87-4.3-5.02-4.5-.15-.2-1.24-1.65-1.24-3.15s.78-2.23 1.06-2.54c.28-.3.62-.38.82-.38h.6c.19 0 .45-.07.7.54.26.62.87 2.13.95 2.28.08.15.13.33.03.53-.1.2-.15.33-.3.5-.15.18-.31.4-.45.53-.15.15-.3.31-.13.6.17.3.78 1.28 1.67 2.08 1.14.97 2.1 1.27 2.4 1.42.3.15.47.13.65-.08.17-.2.75-.87.95-1.17.2-.3.4-.25.67-.15.28.1 1.75.82 2.05.97.3.15.5.23.57.35.08.13.08.73-.16 1.4z" fill="#fff"/></svg></div>
          <div class="cc-name">WhatsApp</div>
        </div>
        <div class="cc-desc" id="t-whatsapp-desc">番号を追加してチャット開始</div>
        <div class="cc-action" id="t-whatsapp">WhatsAppで使う</div>
        <div class="cc-connected" id="t-whatsapp-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="discord-card" style="background:linear-gradient(135deg,#5865F2 0%,#4752C4 100%);" onclick="openChannelLink('discord');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20.32 4.37a19.8 19.8 0 0 0-4.89-1.52.07.07 0 0 0-.08.04c-.21.38-.45.87-.61 1.26a18.27 18.27 0 0 0-5.49 0 12.64 12.64 0 0 0-.62-1.26.07.07 0 0 0-.08-.04 19.74 19.74 0 0 0-4.89 1.52.07.07 0 0 0-.03.03C1.11 8.39.33 12.27.74 16.1a.08.08 0 0 0 .03.06 19.9 19.9 0 0 0 5.99 3.03.08.08 0 0 0 .08-.03c.46-.63.87-1.3 1.22-2a.08.08 0 0 0-.04-.11 13.1 13.1 0 0 1-1.87-.9.08.08 0 0 1-.01-.13c.13-.09.25-.19.37-.29a.07.07 0 0 1 .08-.01c3.93 1.8 8.18 1.8 12.07 0a.07.07 0 0 1 .08.01c.12.1.25.2.37.29a.08.08 0 0 1 0 .13c-.6.35-1.22.65-1.88.9a.08.08 0 0 0-.04.11c.36.7.77 1.37 1.22 2a.08.08 0 0 0 .08.03 19.83 19.83 0 0 0 6-3.03.08.08 0 0 0 .03-.05c.5-5.18-.84-9.68-3.55-13.67a.06.06 0 0 0-.03-.03zM8.02 13.63c-1.18 0-2.16-1.09-2.16-2.42s.96-2.42 2.16-2.42c1.21 0 2.18 1.1 2.16 2.42 0 1.33-.96 2.42-2.16 2.42zm7.97 0c-1.18 0-2.16-1.09-2.16-2.42s.96-2.42 2.16-2.42c1.21 0 2.18 1.1 2.16 2.42 0 1.33-.95 2.42-2.16 2.42z" fill="#fff"/></svg></div>
          <div class="cc-name">Discord</div>
        </div>
        <div class="cc-desc" id="t-discord-desc">Botをサーバーに追加</div>
        <div class="cc-action" id="t-discord">Discordで使う</div>
        <div class="cc-connected" id="t-discord-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="slack-card" style="background:linear-gradient(135deg,#4A154B 0%,#611f69 100%);" onclick="openChannelLink('slack');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M5.04 15.24a2.52 2.52 0 1 1-2.52-2.52h2.52v2.52zm1.27 0a2.52 2.52 0 1 1 5.04 0v6.3a2.52 2.52 0 1 1-5.04 0v-6.3zM8.83 5.04a2.52 2.52 0 1 1 2.52-2.52v2.52H8.83zm0 1.27a2.52 2.52 0 1 1 0 5.04h-6.3a2.52 2.52 0 1 1 0-5.04h6.3zm10.2 2.52a2.52 2.52 0 1 1 2.52 2.52h-2.52V8.83zm-1.27 0a2.52 2.52 0 1 1-5.04 0v-6.3a2.52 2.52 0 1 1 5.04 0v6.3zm-2.52 10.2a2.52 2.52 0 1 1-2.52 2.52v-2.52h2.52zm0-1.27a2.52 2.52 0 1 1 0-5.04h6.3a2.52 2.52 0 1 1 0 5.04h-6.3z" fill="#fff"/></svg></div>
          <div class="cc-name">Slack</div>
        </div>
        <div class="cc-desc" id="t-slack-desc">ワークスペースにアプリを追加</div>
        <div class="cc-action" id="t-slack">Slackで使う</div>
        <div class="cc-connected" id="t-slack-connected">&#x2713; Connected</div>
      </a>
      <a class="channel-card" id="teams-card" style="background:linear-gradient(135deg,#6264A7 0%,#464775 100%);" onclick="openChannelLink('teams');return false;" href="#">
        <div class="cc-header">
          <div class="cc-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20.5 7h-3V5.5a2.5 2.5 0 0 0-5 0V7h-1a1.5 1.5 0 0 0-1.5 1.5v8a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 20.5 7zM15 5.5a1 1 0 0 1 2 0V7h-2V5.5z" fill="#fff"/><circle cx="16" cy="3" r="2" fill="#fff"/><path d="M8 10H2.5A1.5 1.5 0 0 0 1 11.5v5A1.5 1.5 0 0 0 2.5 18H8v-8z" fill="#fff" opacity="0.7"/><circle cx="5" cy="7" r="2" fill="#fff" opacity="0.7"/></svg></div>
          <div class="cc-name">MS Teams</div>
        </div>
        <div class="cc-desc" id="t-teams-desc">Teamsにボットを追加</div>
        <div class="cc-action" id="t-teams">Teamsで使う</div>
        <div class="cc-connected" id="t-teams-connected">&#x2713; Connected</div>
      </a>
    </div>

    <!-- CLI install -->
    <div class="fade-up fade-up-d4" style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px 24px;margin-bottom:20px;text-align:center;">
      <div style="font-size:13px;font-weight:700;margin-bottom:8px;" id="t-cli-title">CLI</div>
      <div style="background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:'SF Mono','Fira Code',monospace;font-size:13px;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer;" onclick="navigator.clipboard.writeText('curl -fsSL https://chatweb.ai/install.sh | sh');this.querySelector('.cp').textContent='Copied!';setTimeout(()=>this.querySelector('.cp').textContent='Copy',1500)">
        <span style="color:var(--muted);">$</span> <span style="flex:1;text-align:left;">curl -fsSL https://chatweb.ai/install.sh | sh</span>
        <span class="cp" style="color:var(--muted);font-size:11px;background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;">Copy</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:8px;" id="t-cli-sub"></div>
      <div id="cli-sync-cmd" style="margin-top:10px;background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:'SF Mono','Fira Code',monospace;font-size:12px;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer;" onclick="copyCliSync(this)">
        <span style="color:var(--muted);">$</span> <span id="cli-sync-text" style="flex:1;text-align:left;word-break:break-all;"></span>
        <span class="cp2" style="color:var(--muted);font-size:11px;background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px;">Copy</span>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:6px;" id="t-cli-sync-hint"></div>
    </div>

    <div class="bottom-cta fade-up fade-up-d4">
      <h2 id="t-bottom-title">もっとパワフルに使いたい？</h2>
      <p id="t-bottom-sub">GPT-4o、Claude Sonnet、Claude Opusなど最先端モデルを月額$9から。</p>
      <div class="cta-row">
        <a href="/pricing" class="cta-primary" id="t-bottom-cta">プランを比較する</a>
      </div>
      <div class="price-hint" id="t-bottom-hint">Starter $9/月 &middot; Pro $29/月 &middot; いつでもキャンセル可能</div>
    </div>

    <!-- Auth Modal -->
  </div>

  <!-- Modals (outside .main so they work in app mode) -->
  <div class="modal-overlay" id="auth-modal" onclick="closeAuthModal(event)" style="z-index:300;">
    <div class="modal auth-modal" onclick="event.stopPropagation()">
      <h3 id="auth-modal-title">ログイン</h3>
      <div class="auth-error" id="auth-error" style="display:none;"></div>
      <div id="auth-form-email">
        <input type="email" class="auth-input" id="login-email" placeholder="Email" onkeydown="if(event.key==='Enter')emailAuth()">
        <button class="auth-submit" id="email-auth-btn" onclick="emailAuth()">メールでログイン</button>
      </div>
      <div id="auth-form-verify" style="display:none;">
        <p style="font-size:13px;color:var(--muted);margin-bottom:8px;" id="verify-hint">認証コードをメールに送信しました</p>
        <input type="text" class="auth-input" id="verify-code" placeholder="6桁の認証コード" maxlength="6" inputmode="numeric" pattern="[0-9]*" onkeydown="if(event.key==='Enter')verifyCode()" style="text-align:center;letter-spacing:6px;font-size:20px;">
        <button class="auth-submit" onclick="verifyCode()">認証する</button>
        <button class="auth-submit" style="background:transparent;color:var(--muted);margin-top:4px;" onclick="showEmailForm()">戻る</button>
      </div>
      <div class="auth-divider"><span>or</span></div>
      <button class="auth-google-btn" onclick="googleLogin()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
      <div style="margin-top:12px;padding:10px;background:linear-gradient(135deg,#6366f122,#8b5cf622);border:1px solid var(--accent);border-radius:10px;text-align:center;">
        <div style="font-size:12px;font-weight:600;color:var(--accent);" id="auth-bonus-text">100 credits free on signup!</div>
        <div style="display:flex;gap:6px;margin-top:8px;align-items:center;">
          <input type="text" id="auth-coupon-input" placeholder="Coupon code" style="flex:1;padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;">
          <button onclick="redeemCouponFromAuth()" style="padding:6px 12px;border-radius:6px;border:none;background:var(--accent);color:#fff;font-size:11px;cursor:pointer;white-space:nowrap;">Redeem</button>
        </div>
        <div id="auth-coupon-result" style="font-size:11px;margin-top:6px;display:none;"></div>
      </div>
      <button class="close-btn" onclick="closeAuthModal()">Close</button>
    </div>
  </div>

  </main>

  <!-- Channel QR Modal (outside main so it's visible in app-mode) -->
  <div class="modal-overlay" id="modal" onclick="closeModal(event)" style="z-index:300;">
    <div class="modal" id="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-steps" style="display:flex;justify-content:center;gap:8px;margin:8px 0 12px;font-size:12px;color:var(--muted);"></div>
      <p id="modal-desc" style="white-space:pre-line;"></p>
      <!-- Primary CTA: big button for mobile -->
      <a id="modal-cta" class="modal-link" target="_blank" style="display:none;font-size:16px;padding:14px 28px;margin:12px 0;"></a>
      <!-- QR code for desktop -->
      <div class="qr-wrapper" id="modal-qr-wrap">
        <div class="qr-spinner" id="qr-spinner"></div>
        <img id="modal-qr" alt="QR Code">
      </div>
      <!-- Secondary link -->
      <a id="modal-link" class="modal-link" target="_blank" style="font-size:13px;"></a>
      <!-- Manual code copy -->
      <div id="modal-code-row" style="display:none;margin:8px 0;text-align:center;">
        <span style="font-size:11px;color:var(--muted);" id="modal-code-label"></span>
        <code id="modal-code-val" style="background:var(--surface);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:14px;letter-spacing:1px;" onclick="navigator.clipboard.writeText(this.textContent);this.style.background='var(--green)';this.style.color='#fff';setTimeout(()=>{this.style.background='var(--surface)';this.style.color=''},500);"></code>
      </div>
      <!-- Success state -->
      <div id="modal-success" style="display:none;text-align:center;padding:20px 0;">
        <div style="font-size:48px;margin-bottom:8px;">&#x2705;</div>
        <div id="modal-success-text" style="font-size:16px;font-weight:600;color:var(--green);"></div>
      </div>
      <button class="close-btn" id="modal-close-btn" onclick="document.getElementById('modal').classList.remove('show');stopLinkPoll();">閉じる</button>
    </div>
  </div>

  <!-- API Keys Modal (outside main so it's visible in app-mode) -->
  <div class="modal-overlay" id="apikey-modal" onclick="if(event.target===this)this.classList.remove('show')" style="z-index:300;">
    <div class="modal apikey-modal" onclick="event.stopPropagation()">
      <h3 id="apikey-modal-title">API Keys</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;" id="apikey-modal-desc">Use API keys to access chatweb.ai from your applications.</p>
      <div class="apikey-list" id="apikey-list"></div>
      <div class="apikey-new-key" id="apikey-new-key" style="display:none;">
        <div class="apikey-new-key-label" id="apikey-new-label">New API Key Created</div>
        <div class="apikey-new-key-value" id="apikey-new-value" onclick="navigator.clipboard.writeText(this.textContent);this.style.opacity=0.5;setTimeout(()=>this.style.opacity=1,300)"></div>
        <div class="apikey-new-key-hint" id="apikey-new-hint">Click to copy. This key will only be shown once.</div>
      </div>
      <div class="apikey-create-row">
        <input type="text" id="apikey-name-input" placeholder="Key name (e.g. my-app)">
        <button onclick="createApiKey()" id="apikey-create-btn">Create</button>
      </div>
      <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:11px;color:var(--muted);line-height:1.6;">
        <strong>Usage:</strong><br>
        <code style="color:var(--accent-hover);">curl -H "Authorization: Bearer cw_..." https://api.chatweb.ai/api/v1/chat -d '{"message":"Hello"}'</code>
      </div>
      <button class="close-btn" onclick="document.getElementById('apikey-modal').classList.remove('show')">Close</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)this.classList.remove('show')" style="z-index:300;">
    <div class="modal settings-modal" onclick="event.stopPropagation()">
      <h3 id="settings-modal-title">Settings</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;" id="settings-modal-desc">chatweb.aiの動作をカスタマイズ</p>
      <div class="settings-item">
        <div class="settings-item-info">
          <div class="settings-item-label" id="settings-tts-label">&#128266; 自動読み上げ</div>
          <div class="settings-item-desc" id="settings-tts-desc">AIの応答を自動で音声再生します</div>
        </div>
        <button class="settings-toggle active" id="settings-tts-toggle" onclick="toggleAutoTTS()"></button>
      </div>
      <div class="settings-item">
        <div class="settings-item-info">
          <div class="settings-item-label" id="settings-explore-label">&#128269; Explore</div>
          <div class="settings-item-desc" id="settings-explore-desc">複数のAIモデルに同時に質問して比較</div>
        </div>
        <button class="settings-toggle" id="settings-explore-toggle" onclick="toggleExploreSetting()"></button>
      </div>
      <button class="close-btn" onclick="document.getElementById('settings-modal').classList.remove('show')">Close</button>
    </div>
  </div>

  <!-- Top Up Modal -->
  <div class="modal-overlay" id="topup-modal" onclick="if(event.target===this)this.classList.remove('show')" style="z-index:300;">
    <div class="modal settings-modal" onclick="event.stopPropagation()">
      <h3 id="topup-modal-title">クレジットをチャージ</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:16px;" id="topup-modal-desc">お好きな方法でクレジットを追加できます</p>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <button onclick="startStripeCheckout('starter')" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">💳</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);">Starter — $5/mo</div>
            <div style="font-size:12px;color:var(--muted);">5,000 credits + tools</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">Stripe ›</span>
        </button>
        <button onclick="startStripeCheckout('pro')" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(139,92,246,0.08));border:2px solid var(--accent);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">⚡</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;color:var(--text);">Pro — $20/mo</div>
            <div style="font-size:12px;color:var(--muted);">25,000 credits + priority</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">Stripe ›</span>
        </button>
        <button onclick="startStripeCheckout('enterprise')" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">🏢</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);">Enterprise — $100/mo</div>
            <div style="font-size:12px;color:var(--muted);">Unlimited credits + SLA</div>
          </div>
          <span style="font-size:12px;color:var(--accent);">Stripe ›</span>
        </button>
        <div style="display:flex;align-items:center;gap:8px;margin:4px 0;color:var(--muted);font-size:11px;"><hr style="flex:1;border:none;border-top:1px solid var(--border);"><span>or</span><hr style="flex:1;border:none;border-top:1px solid var(--border);"></div>
        <button onclick="document.getElementById('topup-modal').classList.remove('show');showCryptoTopup()" style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;">
          <span style="font-size:24px;">◆</span>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:600;color:var(--text);">Crypto</div>
            <div style="font-size:12px;color:var(--muted);">ETH / MATIC / Base</div>
          </div>
          <span style="font-size:12px;color:#8b5cf6;">MetaMask ›</span>
        </button>
      </div>
      <button class="close-btn" onclick="document.getElementById('topup-modal').classList.remove('show')">Close</button>
    </div>
  </div>

  <!-- App Mode Container (shown when authenticated, OUTSIDE main so display:none doesn't hide it) -->
  <div class="app-container" id="app-container">
    <div class="app-sidebar-backdrop" id="app-sidebar-backdrop" onclick="document.getElementById('app-sidebar').classList.remove('open');this.classList.remove('show');"></div>
    <div class="app-sidebar" id="app-sidebar">
      <div class="app-sidebar-header">
        <button class="app-sidebar-new" id="app-new-conv" onclick="appNewConversation()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span id="app-new-conv-text">New chat</span>
        </button>
      </div>
      <div class="app-sidebar-list" id="app-conv-list"></div>
      <div class="app-sidebar-channels">
        <div class="app-sidebar-channels-label" id="app-channels-label">Channels</div>
        <div class="app-sidebar-channels-grid" id="app-channels-grid">
          <!-- Populated by JS based on region -->
        </div>
      </div>
      <div class="app-sidebar-sync" id="app-sync-bar">
        <button class="sync-btn" id="sync-btn" onclick="syncNow()">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><path d="M14 2v4h-4M2 14v-4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.5 6A6 6 0 003.3 3.3L2 6M2.5 10a6 6 0 0010.2 2.7L14 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span id="sync-btn-text">Sync</span>
        </button>
        <div class="sync-info">
          <div id="sync-last">--</div>
          <div><span class="sync-interval" id="sync-interval-label">5min</span></div>
        </div>
      </div>
      <div class="app-sidebar-cron" id="app-cron-section">
        <div class="app-sidebar-cron-label">
          <span id="cron-label-text">Scheduled Tasks</span>
          <button class="cron-add-btn" id="cron-add-btn" onclick="toggleCronForm()">+</button>
        </div>
        <div class="cron-list" id="cron-list"></div>
        <div id="cron-form-container" style="display:none;"></div>
      </div>
      <div class="app-sidebar-links">
        <button class="app-sidebar-link" onclick="openApiKeysModal()" id="app-link-apikeys">API Keys</button>
        <a class="app-sidebar-link" href="/docs" id="app-link-docs">API Docs</a>
        <button class="app-sidebar-link" onclick="openSettingsModal()" id="app-link-settings">Settings</button>
      </div>
      <div class="app-sidebar-footer">
        <div class="credit-display" id="credit-display" style="display:none;">
          <span>&#9889;</span> <span class="credit-count" id="credit-count">--</span> <span style="font-size:11px;">credits</span>
          <button onclick="showTopupModal()" style="margin-left:8px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;border-radius:12px;padding:2px 10px;font-size:11px;cursor:pointer;white-space:nowrap;" title="クレジットをチャージ">+ Top Up</button>
        </div>
        <div class="app-sidebar-user" onclick="logout()">
          <div class="app-sidebar-user-avatar" id="app-user-avatar"></div>
          <div style="flex:1;min-width:0;">
            <div class="app-sidebar-user-name" id="app-user-name"></div>
            <div id="app-user-email" style="font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
          </div>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink:0;color:var(--muted);"><path d="M6 2H3a1 1 0 00-1 1v10a1 1 0 001 1h3M11 11l3-3-3-3M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
    </div>
    <div class="app-chat">
      <div class="app-chat-messages" id="app-messages">
        <div class="app-chat-empty" id="app-empty">
          <div class="app-chat-empty-logo">chatweb.ai</div>
          <button class="voice-hero-btn" id="voice-hero-btn" onclick="toggleVoiceHero()">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div class="voice-hero-label" id="voice-hero-label">タップして話す</div>
          <div class="app-chat-empty-text" id="app-empty-text">何でも聞いてください</div>
          <div class="app-chat-suggestions" id="app-suggestions"></div>
        </div>
      </div>
      <div class="app-chat-input-area">
        <div class="app-chat-input-box">
          <textarea id="app-input" rows="1" placeholder="メッセージを入力..." onkeydown="appInputKeydown(event)"></textarea>
          <button class="app-chat-mic-btn" id="app-mic-btn" onclick="toggleSpeechRecognition()" title="Voice input">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button class="app-chat-send-btn" id="app-send-btn" onclick="appSend()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 14l12-6L2 2v5l8 1-8 1v5z" fill="currentColor"/></svg>
          </button>
        </div>
        <input type="hidden" id="app-agent-select" value="auto">
        <input type="checkbox" id="explore-check" style="display:none;">
        <input type="checkbox" id="multi-model-check" style="display:none;">
      </div>
    </div>
  </div>

  <footer>
    <a href="/pricing" id="footer-pricing">Pricing</a> &middot;
    <a href="/settings">Settings</a> &middot;
    <a href="/status">Status</a> &middot;
    <a href="/comparison" id="footer-comparison">Comparison</a> &middot;
    <a href="https://github.com/yukihamada/nanobot" target="_blank">GitHub</a> &middot;
    <a href="/contact">Contact</a> &middot;
    chatweb.ai &copy; 2025-2026
  </footer>

  <script>
    const API = location.hostname === 'localhost' ? 'http://localhost:3000' : '';
    const msgs = document.getElementById('messages');
    const input = document.getElementById('input');

    let webSessionId = localStorage.getItem('webSessionId');
    // Migrate old api: prefix to webchat:
    if (webSessionId && webSessionId.startsWith('api:')) {
      webSessionId = 'webchat:' + webSessionId.slice(4);
      localStorage.setItem('webSessionId', webSessionId);
    }
    if (!webSessionId) {
      webSessionId = 'webchat:' + crypto.randomUUID();
      localStorage.setItem('webSessionId', webSessionId);
    }

    input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.isComposing) send(); });

    // Typewriter effect
    function typewriter(el, text, speed = 20) {
      return new Promise(resolve => {
        el.textContent = '';
        const cursor = document.createElement('span');
        cursor.className = 'typewriter-cursor';
        el.appendChild(cursor);
        let i = 0;
        function tick() {
          if (i < text.length) {
            el.insertBefore(document.createTextNode(text[i]), cursor);
            i++;
            msgs.scrollTop = msgs.scrollHeight;
            setTimeout(tick, speed);
          } else {
            setTimeout(() => { cursor.remove(); resolve(); }, 500);
          }
        }
        tick();
      });
    }

    // Format /link responses with rich UI
    function isLinkCodeResponse(text) {
      return text.includes('\u30EA\u30F3\u30AF\u30B3\u30FC\u30C9:') || text.includes('Link code:');
    }
    function isLinkSuccess(text) {
      return text.includes('\u30EA\u30F3\u30AF\u5B8C\u4E86') || text.includes('Link complete');
    }
    function formatLinkCode(text) {
      const match = text.match(/[:\uff1a]\s*([A-Z0-9]{6})/);
      if (!match) return null;
      return match[1];
    }

    function addMsg(text, who, useTypewriter = false, channel = null, agentName = null, toolsUsed = null) {
      const d = document.createElement('div');
      d.className = 'msg ' + who;

      // Show channel badge for messages from other channels
      if (channel && channel !== 'web' && who === 'user') {
        const badge = document.createElement('div');
        badge.className = 'channel-badge ch-' + channel;
        badge.textContent = channel === 'line' ? 'LINE' : channel === 'telegram' ? 'Telegram' : channel;
        d.appendChild(badge);
      }

      if (who === 'bot' && isLinkCodeResponse(text)) {
        const code = formatLinkCode(text);
        if (code) {
          const l = document.documentElement.lang || 'ja';
          const lineDeepLink = 'https://line.me/R/oaMessage/@619jcqqh/?%2Flink%20' + code;
          const tgDeepLink = 'https://t.me/chatweb_ai_bot?text=%2Flink%20' + code;
          const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent('/link ' + code);
          d.innerHTML = (l === 'ja'
            ? '<div style="font-size:13px;margin-bottom:4px;">リンクコードを生成しました</div>'
            : '<div style="font-size:13px;margin-bottom:4px;">Link code generated</div>')
            + '<div class="link-code" onclick="navigator.clipboard.writeText(\'' + code + '\');this.style.opacity=0.6;setTimeout(()=>this.style.opacity=1,300)">' + code + '</div>'
            + '<div class="link-steps">'
            + (l === 'ja'
              ? '<div><span class="step-num">1</span>下のボタンを押すだけ！</div>'
                + '<div><span class="step-num">2</span>開いたアプリで送信ボタンを押す</div>'
                + '<div><span class="step-num">3</span>会話が同期されます！</div>'
              : '<div><span class="step-num">1</span>Tap a button below!</div>'
                + '<div><span class="step-num">2</span>Press send in the app</div>'
                + '<div><span class="step-num">3</span>Conversations will sync!</div>')
            + '</div>'
            + '<div class="link-qr-row">'
            + '<a href="' + lineDeepLink + '" target="_blank" class="dl-line">LINE</a>'
            + '<a href="' + tgDeepLink + '" target="_blank" class="dl-tg">Telegram</a>'
            + '</div>'
            + '<img class="link-qr-img" src="' + qrUrl + '" alt="QR" title="' + (l === 'ja' ? 'QRコードをスキャン' : 'Scan QR code') + '">'
            + '<div style="margin-top:6px;color:var(--muted);font-size:11px;">' + (l === 'ja' ? '有効期限: 30分' : 'Expires in 30 min') + '</div>';
          msgs.appendChild(d);
          msgs.scrollTop = msgs.scrollHeight;
          startPolling();
          return;
        }
      }

      if (who === 'bot' && isLinkSuccess(text)) {
        d.classList.add('link-success');
        const l = document.documentElement.lang || 'ja';
        d.innerHTML = '<div style="font-size:20px;margin-bottom:8px;">&#x2705;</div>'
          + '<div style="font-weight:700;">' + (l === 'ja' ? 'リンク完了！' : 'Link complete!') + '</div>'
          + '<div style="font-size:13px;color:var(--muted);margin-top:4px;">'
          + (l === 'ja' ? 'これからどのチャネルでも同じ会話を続けられます。' : 'You can now continue the same conversation on any channel.') + '</div>';
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
        startPolling();
        return;
      }

      // Helper to append agent badge and tool badges after text
      function appendBadges() {
        if (agentName && who === 'bot') {
          const badge = document.createElement('span');
          badge.className = 'agent-badge';
          badge.textContent = agentName;
          d.appendChild(badge);
        }
        if (toolsUsed && toolsUsed.length > 0 && who === 'bot') {
          const container = document.createElement('div');
          container.className = 'tool-badges';
          const lang = document.documentElement.lang || 'ja';
          toolsUsed.forEach(tool => {
            const tb = document.createElement('span');
            tb.className = 'tool-badge';
            const info = TOOL_LABELS[tool] || { icon: '\uD83D\uDD27', ja: tool, en: tool };
            tb.textContent = info.icon + ' ' + (lang === 'ja' ? info.ja : info.en);
            container.appendChild(tb);
          });
          d.appendChild(container);
        }
      }

      if (who === 'bot' && useTypewriter && !channel) {
        msgs.appendChild(d);
        typewriter(d, text).then(appendBadges);
      } else {
        const textNode = document.createTextNode(text);
        d.appendChild(textNode);
        appendBadges();
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
      }
    }

    function sendRecipe(text) {
      input.value = text;
      send();
    }

    // Staged thinking status messages
    const THINKING_STAGES = {
      ja: [
        { time: 0,    icon: '\u26A1', text: '\u8003\u3048\u4E2D...' },
        { time: 1500, icon: '\uD83D\uDD0D', text: '\u60C5\u5831\u3092\u691C\u7D22\u4E2D...' },
        { time: 4000, icon: '\uD83D\uDCCA', text: '\u30C7\u30FC\u30BF\u3092\u5206\u6790\u4E2D...' },
        { time: 8000, icon: '\u270D\uFE0F', text: '\u56DE\u7B54\u3092\u751F\u6210\u4E2D...' },
        { time: 15000, icon: '\u23F3', text: '\u3082\u3046\u5C11\u3057\u304A\u5F85\u3061...' },
      ],
      en: [
        { time: 0,    icon: '\u26A1', text: 'Thinking...' },
        { time: 1500, icon: '\uD83D\uDD0D', text: 'Searching...' },
        { time: 4000, icon: '\uD83D\uDCCA', text: 'Analyzing data...' },
        { time: 8000, icon: '\u270D\uFE0F', text: 'Generating response...' },
        { time: 15000, icon: '\u23F3', text: 'Almost there...' },
      ]
    };

    // Tool name display mapping
    const TOOL_LABELS = {
      web_search: { icon: '\uD83D\uDD0D', ja: 'Web\u691C\u7D22', en: 'Web Search' },
      web_fetch: { icon: '\uD83C\uDF10', ja: '\u30DA\u30FC\u30B8\u53D6\u5F97', en: 'Page Fetch' },
      calculator: { icon: '\uD83E\uDDEE', ja: '\u8A08\u7B97', en: 'Calculator' },
      weather: { icon: '\u26C5', ja: '\u5929\u6C17', en: 'Weather' },
      translate: { icon: '\uD83C\uDF0D', ja: '\u7FFB\u8A33', en: 'Translate' },
      wikipedia: { icon: '\uD83D\uDCDA', ja: 'Wikipedia', en: 'Wikipedia' },
      datetime: { icon: '\uD83D\uDD52', ja: '\u65E5\u6642', en: 'DateTime' },
      qr_code: { icon: '\uD83D\uDCF1', ja: 'QR\u30B3\u30FC\u30C9', en: 'QR Code' },
      news_search: { icon: '\uD83D\uDCF0', ja: '\u30CB\u30E5\u30FC\u30B9', en: 'News' },
    };

    async function send() {
      // Require login to chat
      if (!currentUser) {
        openAuthModal();
        return;
      }
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addMsg(text, 'user');

      const typing = document.createElement('div');
      typing.className = 'msg typing';
      const lang = document.documentElement.lang || 'ja';
      const stages = THINKING_STAGES[lang] || THINKING_STAGES.ja;
      typing.innerHTML = '<div class="thinking-status">'
        + '<span class="thinking-icon">' + stages[0].icon + '</span>'
        + '<span class="thinking-text">' + stages[0].text + '</span>'
        + '<span class="thinking-elapsed">(0.0s)</span>'
        + '</div>'
        + '<div class="shimmer-bar"></div>';
      msgs.appendChild(typing);
      msgs.scrollTop = msgs.scrollHeight;

      // Staged status transitions
      const startTime = Date.now();
      let stageIdx = 0;
      const statusInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const elapsedEl = typing.querySelector('.thinking-elapsed');
        if (elapsedEl) elapsedEl.textContent = '(' + elapsed + 's)';

        const elapsedMs = Date.now() - startTime;
        const nextStage = stages[stageIdx + 1];
        if (nextStage && elapsedMs >= nextStage.time) {
          stageIdx++;
          const iconEl = typing.querySelector('.thinking-icon');
          const textEl = typing.querySelector('.thinking-text');
          if (iconEl) iconEl.textContent = stages[stageIdx].icon;
          if (textEl) {
            textEl.style.opacity = '0';
            setTimeout(() => {
              textEl.textContent = stages[stageIdx].text;
              textEl.style.opacity = '1';
            }, 150);
          }
        }
      }, 100);

      try {
        const agentSel = document.getElementById('agent-select').value;
        const msgToSend = (agentSel !== 'auto') ? ('@' + agentSel + ' ' + text) : text;
        const r = await fetch(API + '/api/v1/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msgToSend, session_id: webSessionId }),
        });
        const d = await r.json();
        clearInterval(statusInterval);
        typing.remove();
        addMsg(d.response, 'bot', true, null, d.agent || null, d.tools_used || null);
        knownMsgCount += 2; // user + assistant messages
        startPolling();
      } catch {
        clearInterval(statusInterval);
        typing.remove();
        addMsg(lang === 'ja' ? '\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002\u3082\u3046\u4E00\u5EA6\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002' : 'Something went wrong. Please try again.', 'bot');
      }
    }

    // Session polling for cross-channel sync
    let pollInterval = null;
    let knownMsgCount = 0;
    let isPolling = false;

    function startPolling() {
      if (pollInterval) return;
      pollInterval = setInterval(pollSession, 3000);
    }

    function stopPolling() {
      if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
    }

    async function pollSession() {
      if (isPolling) return;
      isPolling = true;
      try {
        const r = await fetch(API + '/api/v1/sessions/' + encodeURIComponent(webSessionId));
        const data = await r.json();
        const serverMsgs = data.messages || [];
        if (serverMsgs.length > knownMsgCount) {
          const newMsgs = serverMsgs.slice(knownMsgCount);
          for (const m of newMsgs) {
            const ch = m.channel || 'web';
            if (ch !== 'web') {
              addMsg(m.content, m.role === 'user' ? 'user' : 'bot', false, ch);
            }
          }
          knownMsgCount = serverMsgs.length;
        }
        // Update connected channel status
        if (data.linked_channels) {
          updateChannelStatus(data.linked_channels);
        }
      } catch(e) { /* ignore poll errors */ }
      isPolling = false;
    }

    function updateChannelStatus(channels) {
      const lineBar = document.getElementById('ch-bar-line');
      const tgBar = document.getElementById('ch-bar-tg');
      const lineCard = document.getElementById('line-card');
      const tgCard = document.getElementById('tg-card');
      if (channels.includes('line')) {
        lineBar.classList.add('connected');
        lineCard.classList.add('connected');
      }
      if (channels.includes('telegram')) {
        tgBar.classList.add('connected');
        tgCard.classList.add('connected');
      }
      // Also update app-mode sidebar channel buttons
      const chMap = { line: 'app-ch-line', telegram: 'app-ch-tg', whatsapp: 'app-ch-whatsapp', discord: 'app-ch-discord', slack: 'app-ch-slack', teams: 'app-ch-teams' };
      channels.forEach(ch => {
        const el = document.getElementById(chMap[ch]);
        if (el) el.classList.add('connected');
      });
    }

    // Pause polling when tab is hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopPolling();
      else if (knownMsgCount > 0) startPolling();
    });

    // Recipes data — organized by use case persona
    const R = {
      ja: {
        categories: [
          {
            icon: '\uD83D\uDD0D', title: 'リサーチ・情報収集',
            items: [
              { name: '競合の価格を比較', desc: '複数サイトの価格を一発比較', prompt: 'Amazon、楽天、ヨドバシカメラで「iPhone 16 Pro」の価格を比較して。最安値のURLと価格を教えて。' },
              { name: '会議の事前リサーチ', desc: '相手企業の情報を自動収集', prompt: '明日「株式会社サンプル」と会議があります。この会社の最新ニュース3件と事業概要、競合他社をまとめた事前準備レポートを作って。' },
              { name: '旅行の格安プラン探し', desc: '予算内で最適プランを提案', prompt: '3月に2泊3日で京都旅行を計画中。予算は1人5万円。桜の名所を中心に、モデルコースを作って。おすすめの宿も教えて。' },
            ]
          },
          {
            icon: '\u26A1', title: '業務効率化・自動化',
            items: [
              { name: '議事録を3行に要約', desc: '決定事項・TODO・宿題に分類', prompt: '以下の会議議事録を「決定事項」「TODO」「次回までの宿題」の3つに分けて要約して。\n\n（ここに議事録を貼り付けてください）' },
              { name: '上司への報告メール', desc: 'プロっぽい進捗報告を作成', prompt: 'プロジェクトの進捗報告メールを書いて。状況：開発フェーズ完了、テスト中に2件のバグ発見、来週修正予定。相手は部長。丁寧だけど簡潔に。' },
              { name: '問い合わせ対応テンプレ', desc: 'クレーム・質問・営業を分類', prompt: '顧客からの問い合わせを「クレーム」「質問」「営業メール」「パートナーシップ提案」に分類するルールと、それぞれの返信テンプレートを作って。' },
            ]
          },
          {
            icon: '\uD83C\uDFE0', title: '生活・子育て・趣味',
            items: [
              { name: '今晩の献立を考えて', desc: '冷蔵庫の中身からレシピ提案', prompt: '冷蔵庫に鶏もも肉、玉ねぎ、じゃがいも、卵、牛乳があります。30分以内で作れる夕食のレシピを2つ提案して。' },
              { name: '子供にわかるように説明', desc: '難しいことを簡単な言葉で', prompt: '小学3年生にもわかるように「円安」を説明して。身近な例を使って。' },
              { name: '確定申告の経費相談', desc: 'フリーランスの節税アドバイス', prompt: 'フリーランスのWebデザイナーです。自宅で仕事をしています。家賃・光熱費・通信費は経費にできますか？按分の目安を教えて。' },
            ]
          },
          {
            icon: '\uD83D\uDEE0\uFE0F', title: '開発・エンジニア',
            items: [
              { name: 'コードレビューを依頼', desc: 'バグ・性能・セキュリティをチェック', prompt: 'Rustのコードレビューチェックリストを作って。パフォーマンス、安全性、可読性の観点で。clippyのよくある警告と修正方法も含めて。' },
              { name: '障害対応手順書を作成', desc: 'エラー発生時のフロー設計', prompt: 'AWSでLambdaのエラー率が急上昇した時の障害対応手順書を作って。CloudWatchアラーム→ログ分析→原因特定→復旧→報告の流れで。' },
              { name: 'API仕様書を自動生成', desc: 'OpenAPI形式でドキュメント作成', prompt: 'REST APIの設計をして。ユーザー管理（CRUD）、認証（JWT）、ファイルアップロードのエンドポイントをOpenAPI 3.0形式で書いて。' },
            ]
          },
        ],
      },
      en: {
        categories: [
          {
            icon: '\uD83D\uDD0D', title: 'Research & Intelligence',
            items: [
              { name: 'Compare competitor prices', desc: 'Instant multi-site price check', prompt: 'Compare prices for "iPhone 16 Pro" across Amazon, Best Buy, and Walmart. Show me the best deals with links.' },
              { name: 'Meeting prep research', desc: 'Auto-gather company intel', prompt: 'I have a meeting with "Sample Corp" tomorrow. Create a prep report with their latest 3 news items, business overview, and competitors.' },
              { name: 'Find travel deals', desc: 'Best plans within your budget', prompt: "I'm planning a 3-day trip to Kyoto in March. Budget is $500 per person. Focus on cherry blossom spots, create a day-by-day itinerary with hotel recommendations." },
            ]
          },
          {
            icon: '\u26A1', title: 'Work & Automation',
            items: [
              { name: 'Summarize meeting notes', desc: 'Decisions, TODOs, follow-ups', prompt: 'Summarize these meeting notes into "Decisions made", "Action items", and "Follow-ups for next meeting".\n\n(Paste your meeting notes here)' },
              { name: 'Write a status update', desc: 'Professional report email', prompt: 'Write a project status update email. Situation: development phase complete, found 2 bugs during testing, fix planned for next week. Recipient is my director. Professional but concise.' },
              { name: 'Customer inquiry templates', desc: 'Auto-classify and respond', prompt: 'Create rules to classify customer inquiries into: complaint, question, sales email, partnership. Include a response template for each category.' },
            ]
          },
          {
            icon: '\uD83C\uDFE0', title: 'Life & Family',
            items: [
              { name: 'Dinner ideas from fridge', desc: 'Recipes from what you have', prompt: 'I have chicken thighs, onions, potatoes, eggs, and milk in my fridge. Suggest 2 dinner recipes I can make in under 30 minutes.' },
              { name: 'Explain it to a kid', desc: 'Complex topics made simple', prompt: 'Explain inflation to a 10-year-old using everyday examples they can relate to.' },
              { name: 'Tax deduction advice', desc: 'Freelancer expense guidance', prompt: "I'm a freelance web designer working from home. Can I deduct rent, utilities, and internet costs? What's the typical home office deduction percentage?" },
            ]
          },
          {
            icon: '\uD83D\uDEE0\uFE0F', title: 'Dev & Engineering',
            items: [
              { name: 'Code review checklist', desc: 'Bugs, performance, security', prompt: 'Create a Rust code review checklist covering performance, safety, and readability. Include common clippy warnings and fixes.' },
              { name: 'Incident response playbook', desc: 'Error handling workflow', prompt: 'Create an incident response playbook for AWS Lambda error rate spikes. Cover: CloudWatch alarm \u2192 log analysis \u2192 root cause \u2192 recovery \u2192 report.' },
              { name: 'API spec generator', desc: 'OpenAPI docs from requirements', prompt: 'Design a REST API with user management (CRUD), auth (JWT), and file upload endpoints in OpenAPI 3.0 format.' },
            ]
          },
        ],
      }
    };

    const T = {
      ja: {
        title: 'AIに何でも聞ける。声でも、テキストでも。',
        sub: '話しかけるだけで、検索・分析・自動化。LINE・Telegramでも使える無料AIアシスタント。',
        welcome: 'こんにちは！何でもお任せください。下のカードから選ぶか、自由に入力してください。',
        line: 'LINEで使う', tg: 'Telegramで使う',
        lineDesc: '1タップで友だち追加 → 自動連携', tgDesc: 'ボタンを押すだけ → 今すぐ開始',
        lineConnected: '&#x2713; 連携済み', tgConnected: '&#x2713; 連携済み',
        ph: '何でも聞いてください...', send: '送信',
        heroTry: '今すぐ無料で試す', heroPlans: 'プランを見る', pricing: '料金', status: 'ステータス',
        chatStatus: 'オンライン',
        statsUptime: '稼働率', statsSpeed: '平均応答', statsModels: 'AIモデル', statsChannels: 'チャネル', statsTools: 'ツール',
        trustSsl: 'SSL暗号化', trustStripe: 'Stripe決済', trustNocard: 'カード不要で開始',
        syncTitle: 'どのチャネルでも同じ会話',
        syncDesc: 'Web・LINE・Telegramの会話をリンクして、どこからでも続きを。',
        step1Title: '友だち追加', step1Desc: '上のボタンからLINE/Telegramで友だち追加',
        step2Title: 'IDで自動連携', step2Desc: 'ボタンを押すだけで自動連携されます',
        step3Title: '同期完了', step3Desc: '全チャネルの会話が統合されます',
        sessionLabel: 'あなたのセッションID:', sessionHint: 'クリックでコピー。LINE/Telegramに貼り付けで連携',
        cliTitle: 'コマンドラインでも使える', cliSub: 'nanobot chat "こんにちは!" | macOS, Linux',
        cliSyncHint: 'Webの会話と同期してCLIを使う',
        bottomTitle: 'もっとパワフルに使いたい？',
        bottomSub: 'GPT-4o、Claude Sonnet、Claude Opusなど最先端モデルを月額$9から。',
        bottomCta: 'プランを比較する',
        bottomHint: 'Starter $9/月 &middot; Pro $29/月 &middot; いつでもキャンセル可能',
        agentAuto: 'Auto (自動振り分け)',
        deviceTitle: '接続デバイス',
        deviceDesc: 'CLIデーモンで接続されたマシン一覧',
        deviceHint: 'CLIをインストールして <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">nanobot daemon</code> で接続',
        capTitle: 'AI + ツールで、なんでも自動化',
        capSub: '内蔵ツール + MCP拡張で無限の可能性',
        capSearch: 'Web検索', capSearchD: 'リアルタイムの情報を検索・収集',
        capFetch: 'Webページ取得', capFetchD: '任意のURLからコンテンツを取得',
        capCalc: '電卓', capCalcD: '数式の計算・通貨換算',
        capWeather: '天気', capWeatherD: '世界中の天気・予報を取得',
        capFile: 'ファイル操作', capFileD: 'ファイルの読み書き・編集',
        capShell: 'シェル実行', capShellD: 'コマンドの実行・自動化',
        capBrowser: 'ブラウザ', capBrowserD: 'Webページの自動操作',
        capImage: '画像解析', capImageD: '画像認識・マルチモーダル',
        capMemory: '永続メモリ', capMemoryD: '会話横断で記憶を保持',
        capNote: 'MCPツールはModel Context Protocolで無限に拡張可能。',
        capNoteLink: 'ツール一覧を聞いてみる →',
        voiceLabel: '🎙️ AIの声を聴いてみよう',
        loginBtn: 'ログイン',
        chatLoginPrompt: 'ログインして会話を始める',
        sidebarTitle: '会話履歴',
        newConv: '+ 新しい会話',
        appNewChat: '新しいチャット',
        appEmptyText: '何でも聞いてください',
        appPlaceholder: 'メッセージを入力...',
      },
      en: {
        title: 'Ask AI anything. By voice or text.',
        sub: 'Just talk and get search, analysis, and automation. Free AI assistant on Web, LINE, and Telegram.',
        welcome: 'Hi! Pick a task below or type anything you need.',
        line: 'Use on LINE', tg: 'Use on Telegram',
        lineDesc: '1 tap to add friend → auto-link', tgDesc: 'Just tap → start now',
        lineConnected: '&#x2713; Connected', tgConnected: '&#x2713; Connected',
        ph: 'Ask me anything...', send: 'Send',
        heroTry: 'Try Free Now', heroPlans: 'View Plans', pricing: 'Pricing', status: 'Status',
        chatStatus: 'Online',
        statsUptime: 'Uptime', statsSpeed: 'Avg Response', statsModels: 'AI Models', statsChannels: 'Channels', statsTools: 'Tools',
        trustSsl: 'SSL Encrypted', trustStripe: 'Stripe Payments', trustNocard: 'No card required',
        syncTitle: 'Same conversation, any channel',
        syncDesc: 'Link your Web, LINE, and Telegram chats. Continue from anywhere.',
        step1Title: 'Add friend', step1Desc: 'Tap LINE/Telegram buttons above',
        step2Title: 'Auto-link', step2Desc: 'Just tap the button to auto-link',
        step3Title: 'Synced!', step3Desc: 'All conversations are unified',
        sessionLabel: 'Your session ID:', sessionHint: 'Click to copy. Paste in LINE/Telegram to link',
        cliTitle: 'Use from command line', cliSub: 'nanobot chat "Hello!" | macOS, Linux',
        cliSyncHint: 'Sync with your Web conversation from CLI',
        bottomTitle: 'Need more power?',
        bottomSub: 'Access GPT-4o, Claude Sonnet, Claude Opus and more from $9/month.',
        bottomCta: 'Compare Plans',
        bottomHint: 'Starter $9/mo &middot; Pro $29/mo &middot; Cancel anytime',
        agentAuto: 'Auto (smart routing)',
        deviceTitle: 'Connected Devices',
        deviceDesc: 'Machines connected via CLI daemon',
        deviceHint: 'Install CLI and run <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">nanobot daemon</code> to connect',
        capTitle: 'AI + Tools = Automate Anything',
        capSub: 'Built-in tools + unlimited MCP extensions',
        capSearch: 'Web Search', capSearchD: 'Search & gather real-time information',
        capFetch: 'Web Fetch', capFetchD: 'Retrieve content from any URL',
        capCalc: 'Calculator', capCalcD: 'Math, conversions & calculations',
        capWeather: 'Weather', capWeatherD: 'Global weather & forecasts',
        capFile: 'File Operations', capFileD: 'Read, write & edit files',
        capShell: 'Shell Exec', capShellD: 'Run commands & automate tasks',
        capBrowser: 'Browser', capBrowserD: 'Automate web pages',
        capImage: 'Image Analysis', capImageD: 'Vision & multimodal AI',
        capMemory: 'Memory', capMemoryD: 'Persistent cross-session memory',
        capNote: 'MCP tools are infinitely extensible via Model Context Protocol.',
        capNoteLink: 'Ask about available tools →',
        voiceLabel: '🎙️ Listen to AI speak',
        loginBtn: 'Login',
        chatLoginPrompt: 'Login to start chatting',
        sidebarTitle: 'Conversations',
        newConv: '+ New Conversation',
        appNewChat: 'New chat',
        appEmptyText: 'Ask me anything',
        appPlaceholder: 'Message chatweb.ai...',
      }
    };

    // -----------------------------------------------------------------------
    // Voice demo – "listen to AI speak" interactive section
    // -----------------------------------------------------------------------
    const DEMO_VOICES = [
      { icon: '🌤️', ja: '天気', en: 'Weather',
        text: '東京は晴れ、気温12度です。午後から少し雲が出るでしょう。お出かけには最適な一日です。' },
      { icon: '📧', ja: 'メール', en: 'Email',
        text: '件名、ミーティングのお礼。田中様、本日はお忙しい中お時間をいただきありがとうございました。' },
      { icon: '🌍', ja: '翻訳', en: 'Translate',
        text: '"Hello, how are you?" は日本語で「こんにちは、お元気ですか？」です。' },
      { icon: '🍳', ja: 'レシピ', en: 'Recipe',
        text: 'チャーハンの作り方。ご飯、卵、ネギを用意。フライパンを強火で熱して、卵を先に炒めます。' },
      { icon: '💡', ja: '豆知識', en: 'Fun Fact',
        text: 'タコの心臓は3つあります。2つはエラに血液を送り、1つは全身に血液を送ります。' },
      { icon: '🧮', ja: '計算', en: 'Calculate',
        text: '消費税10パーセント込みで、2,980円の商品は3,278円になります。' },
    ];

    let demoAudio = null;
    let demoPlayingIdx = -1;
    let demoTypewriterAbort = false;

    function renderVoiceDemo(lang) {
      const grid = document.getElementById('voice-demo-grid');
      grid.innerHTML = '';
      DEMO_VOICES.forEach((v, i) => {
        const btn = document.createElement('button');
        btn.className = 'voice-demo-btn';
        btn.textContent = v.icon + ' ' + (lang === 'ja' ? v.ja : v.en);
        btn.onclick = () => playDemoVoice(i);
        if (i === demoPlayingIdx) btn.classList.add('playing');
        grid.appendChild(btn);
      });
    }

    function stopDemoVoice() {
      demoTypewriterAbort = true;
      if (demoAudio && !demoAudio.paused) {
        demoAudio.pause();
        demoAudio.currentTime = 0;
      }
      demoAudio = null;
      const prev = demoPlayingIdx;
      demoPlayingIdx = -1;
      // Remove playing class from all buttons
      document.querySelectorAll('.voice-demo-btn').forEach(b => b.classList.remove('playing'));
      const output = document.getElementById('voice-demo-output');
      if (prev !== -1) {
        output.classList.remove('active');
      }
      return prev;
    }

    async function playDemoVoice(idx) {
      const prev = stopDemoVoice();
      // Toggle off if same button
      if (prev === idx) return;

      demoPlayingIdx = idx;
      demoTypewriterAbort = false;
      const v = DEMO_VOICES[idx];
      const btns = document.querySelectorAll('.voice-demo-btn');
      if (btns[idx]) btns[idx].classList.add('playing');

      // Typewriter into output
      const output = document.getElementById('voice-demo-output');
      output.textContent = '';
      output.classList.add('active');

      // Start typewriter (uses only demoTypewriterAbort to stop)
      (function demoTypewrite() {
        let i = 0;
        function tick() {
          if (demoTypewriterAbort) return;
          if (i < v.text.length) {
            output.textContent += v.text[i];
            i++;
            setTimeout(tick, 25);
          } else {
            // Typewriter finished — remove playing state if audio isn't playing
            if (!demoAudio || demoAudio.paused || demoAudio.ended) {
              demoPlayingIdx = -1;
              if (btns[idx]) btns[idx].classList.remove('playing');
            }
          }
        }
        tick();
      })();

      // Fetch TTS audio
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (typeof authToken !== 'undefined' && authToken) headers['Authorization'] = 'Bearer ' + authToken;

        const r = await fetch(API + '/api/v1/speech/synthesize', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({ text: v.text, session_id: typeof webSessionId !== 'undefined' ? webSessionId : 'demo' }),
        });

        if (!r.ok) throw new Error('TTS failed');
        if (demoPlayingIdx !== idx) return; // User cancelled during fetch

        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        demoAudio = new Audio(url);

        demoAudio.onended = function() {
          if (demoPlayingIdx === idx) {
            demoPlayingIdx = -1;
            if (btns[idx]) btns[idx].classList.remove('playing');
          }
          URL.revokeObjectURL(url);
        };

        demoAudio.play().catch(function(e) {
          console.warn('Demo TTS autoplay blocked:', e.message);
          // Autoplay policy blocked — stop playing state
          if (demoPlayingIdx === idx) {
            demoPlayingIdx = -1;
            if (btns[idx]) btns[idx].classList.remove('playing');
          }
        });
      } catch(e) {
        console.warn('Demo TTS fetch failed:', e.message);
      }
    }

    function renderRecipes(l) {
      const section = document.getElementById('recipe-section');
      section.innerHTML = '';
      R[l].categories.forEach(cat => {
        const h = document.createElement('div');
        h.className = 'recipes';
        h.innerHTML = '<h2>' + cat.icon + ' ' + cat.title + '</h2>';
        const grid = document.createElement('div');
        grid.className = 'recipe-grid';
        cat.items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'recipe-card';
          card.innerHTML = '<h4>' + item.name + '</h4><p>' + item.desc + '</p>';
          card.onclick = () => sendRecipe(item.prompt);
          grid.appendChild(card);
        });
        h.appendChild(grid);
        section.appendChild(h);
      });
    }

    function setLang(l) {
      document.documentElement.lang = l;
      localStorage.setItem('nl', l);
      document.getElementById('l-ja').className = l === 'ja' ? 'on' : '';
      document.getElementById('l-en').className = l === 'en' ? 'on' : '';
      const t = T[l];
      document.getElementById('t-title').textContent = t.title;
      document.getElementById('t-subtitle').textContent = t.sub;
      // Typewriter welcome
      const welcomeEl = document.getElementById('t-welcome');
      if (!welcomeEl.dataset.typed) {
        welcomeEl.dataset.typed = '1';
        typewriter(welcomeEl, t.welcome, 25);
      } else {
        welcomeEl.textContent = t.welcome;
      }
      document.getElementById('t-line').textContent = t.line;
      document.getElementById('t-tg').textContent = t.tg;
      document.getElementById('t-line-desc').textContent = t.lineDesc;
      document.getElementById('t-tg-desc').textContent = t.tgDesc;
      document.getElementById('t-line-connected').innerHTML = t.lineConnected;
      document.getElementById('t-tg-connected').innerHTML = t.tgConnected;
      input.placeholder = t.ph;
      document.getElementById('send-btn').textContent = t.send;
      document.getElementById('t-hero-try').textContent = t.heroTry;
      document.getElementById('t-hero-plans').textContent = t.heroPlans;
      document.getElementById('nav-pricing').textContent = t.pricing;
      document.getElementById('nav-status').textContent = t.status;
      document.getElementById('footer-pricing').textContent = t.pricing;
      document.getElementById('t-chat-status').textContent = t.chatStatus;
      document.getElementById('stat-uptime-label').textContent = t.statsUptime;
      document.getElementById('stat-speed-label').textContent = t.statsSpeed;
      document.getElementById('stat-models-label').textContent = t.statsModels;
      document.getElementById('stat-channels-label').textContent = t.statsChannels;
      document.getElementById('stat-tools-label').textContent = t.statsTools;
      document.getElementById('trust-ssl').textContent = t.trustSsl;
      document.getElementById('trust-stripe').textContent = t.trustStripe;
      document.getElementById('trust-nocard').textContent = t.trustNocard;
      document.getElementById('t-sync-title').textContent = t.syncTitle;
      document.getElementById('t-sync-desc').textContent = t.syncDesc;
      document.getElementById('t-step1-title').textContent = t.step1Title;
      document.getElementById('t-step1-desc').innerHTML = t.step1Desc;
      document.getElementById('t-step2-title').textContent = t.step2Title;
      document.getElementById('t-step2-desc').innerHTML = t.step2Desc;
      document.getElementById('t-step3-title').textContent = t.step3Title;
      document.getElementById('t-step3-desc').textContent = t.step3Desc;
      document.getElementById('t-session-label').textContent = t.sessionLabel;
      document.getElementById('t-session-hint').textContent = t.sessionHint;
      document.getElementById('t-cli-title').textContent = t.cliTitle;
      document.getElementById('t-cli-sub').innerHTML = t.cliSub;
      document.getElementById('cli-sync-text').textContent = 'nanobot chat --session ' + webSessionId + ' "Hello"';
      document.getElementById('t-cli-sync-hint').textContent = t.cliSyncHint;
      document.getElementById('t-bottom-title').textContent = t.bottomTitle;
      document.getElementById('t-bottom-sub').textContent = t.bottomSub;
      document.getElementById('t-bottom-cta').textContent = t.bottomCta;
      document.getElementById('t-bottom-hint').innerHTML = t.bottomHint;
      document.getElementById('opt-auto').textContent = t.agentAuto;
      document.getElementById('t-device-title').textContent = t.deviceTitle;
      document.getElementById('t-device-desc').textContent = t.deviceDesc;
      document.getElementById('t-device-hint').innerHTML = t.deviceHint;
      // Capabilities section
      document.getElementById('t-cap-title').textContent = t.capTitle;
      document.getElementById('t-cap-sub').textContent = t.capSub;
      document.getElementById('cap-search').textContent = t.capSearch;
      document.getElementById('cap-search-d').textContent = t.capSearchD;
      document.getElementById('cap-fetch').textContent = t.capFetch;
      document.getElementById('cap-fetch-d').textContent = t.capFetchD;
      document.getElementById('cap-calc').textContent = t.capCalc;
      document.getElementById('cap-calc-d').textContent = t.capCalcD;
      document.getElementById('cap-weather').textContent = t.capWeather;
      document.getElementById('cap-weather-d').textContent = t.capWeatherD;
      document.getElementById('cap-file').textContent = t.capFile;
      document.getElementById('cap-file-d').textContent = t.capFileD;
      document.getElementById('cap-shell').textContent = t.capShell;
      document.getElementById('cap-shell-d').textContent = t.capShellD;
      document.getElementById('cap-browser').textContent = t.capBrowser;
      document.getElementById('cap-browser-d').textContent = t.capBrowserD;
      document.getElementById('cap-image').textContent = t.capImage;
      document.getElementById('cap-image-d').textContent = t.capImageD;
      document.getElementById('cap-memory').textContent = t.capMemory;
      document.getElementById('cap-memory-d').textContent = t.capMemoryD;
      document.getElementById('cap-note-text').textContent = t.capNote;
      document.getElementById('cap-note-link').textContent = t.capNoteLink;
      // Auth UI translations
      if (!currentUser) document.getElementById('login-btn').textContent = t.loginBtn;
      document.getElementById('chat-login-text').textContent = t.chatLoginPrompt;
      const lang2 = document.documentElement.lang || 'ja';
      document.getElementById('auth-modal-title').textContent = lang2 === 'ja' ? 'ログイン' : 'Login';
      document.getElementById('email-auth-btn').textContent = lang2 === 'ja' ? 'メールでログイン' : 'Login with Email';
      const bonusEl = document.getElementById('auth-bonus-text');
      if (bonusEl) bonusEl.textContent = lang2 === 'ja' ? '登録で100クレジット無料!' : '100 credits free on signup!';
      document.getElementById('sidebar-title').textContent = t.sidebarTitle;
      document.getElementById('new-conv-btn').textContent = t.newConv;
      // App mode translations
      const appNewConvText = document.getElementById('app-new-conv-text');
      if (appNewConvText) appNewConvText.textContent = t.appNewChat;
      const appEmptyText = document.querySelector('.app-chat-empty-text');
      if (appEmptyText) appEmptyText.textContent = t.appEmptyText;
      const appInput = document.getElementById('app-input');
      if (appInput) appInput.placeholder = t.appPlaceholder;
      const appChLabel = document.getElementById('app-channels-label');
      if (appChLabel) appChLabel.textContent = l === 'ja' ? 'チャネル連携' : 'Channels';
      if (document.body.classList.contains('app-mode')) appRenderSuggestions();
      renderRecipes(l);
      // Voice demo
      document.getElementById('t-voice-label').textContent = t.voiceLabel;
      renderVoiceDemo(l);
    }

    // CLI sync command copy helper
    function copyCliSync(el) {
      const cmd = 'nanobot chat --session ' + webSessionId + ' "Hello"';
      navigator.clipboard.writeText(cmd);
      const cp = el.querySelector('.cp2');
      if (cp) { cp.textContent = 'Copied!'; setTimeout(() => cp.textContent = 'Copy', 1500); }
    }

    // Show session ID (masked for display, full ID on click to copy)
    function maskSessionId(id) {
      const parts = id.split(':');
      if (parts.length === 2) {
        const uuid = parts[1];
        return parts[0] + ':' + uuid.substring(0, 8) + '********';
      }
      return id;
    }
    const sessionDisplay = document.getElementById('session-id-display');
    sessionDisplay.textContent = maskSessionId(webSessionId);
    sessionDisplay.title = webSessionId;
    sessionDisplay.onclick = function() {
      navigator.clipboard.writeText(webSessionId);
      this.style.opacity = 0.5;
      setTimeout(() => this.style.opacity = 1, 300);
    };

    // Channel deep links with auto-link session ID
    function getLineDeepLink() {
      // LINE OA message deep link with /link command + session ID prefilled
      return 'https://line.me/R/oaMessage/@619jcqqh/?%2Flink%20' + encodeURIComponent(webSessionId);
    }
    function getTgDeepLink() {
      // Telegram deep link: /start payload (replace : with _ for Telegram)
      const payload = webSessionId.replace(':', '_');
      return 'https://t.me/chatweb_ai_bot?start=' + payload;
    }

    function getWhatsAppDeepLink() {
      return 'https://wa.me/message/chatweb_ai';
    }
    function getDiscordDeepLink() {
      return 'https://discord.com/invite/chatweb';
    }
    function getSlackDeepLink() {
      return 'https://slack.com/oauth/v2/authorize?client_id=chatweb&scope=chat:write,commands';
    }
    function getTeamsDeepLink() {
      return 'https://teams.microsoft.com/l/app/chatweb-ai';
    }
    function openChannelLink(ch) {
      const c = CHANNELS[ch];
      if (!c) return;
      showModal(ch);
    }

    // Agent selector (always auto)
    let selectedAgent = 'auto';
    function selectAgent(val) { selectedAgent = val; }

    // Device monitoring
    async function pollDevices() {
      try {
        const r = await fetch(API + '/api/v1/devices', {
          headers: { 'x-session-id': webSessionId }
        });
        const d = await r.json();
        const section = document.getElementById('device-section');
        const list = document.getElementById('device-list');
        if (d.devices && d.devices.length > 0) {
          section.style.display = '';
          list.innerHTML = d.devices.map(dev => {
            const memPct = (dev.memory_total && dev.memory_used) ? Math.round(dev.memory_used / dev.memory_total * 100) : null;
            const meta = [dev.os + '/' + dev.arch, memPct !== null ? ('RAM ' + memPct + '%') : '', dev.uptime_secs ? ('up ' + formatUptime(dev.uptime_secs)) : ''].filter(Boolean).join(' · ');
            return '<div class="device-card"><div class="device-status"></div><div class="device-info"><div class="device-name">' + dev.hostname + '</div><div class="device-meta">' + meta + '</div></div></div>';
          }).join('');
        }
      } catch(e) { /* ignore */ }
    }
    function formatUptime(secs) {
      if (secs < 3600) return Math.floor(secs/60) + 'm';
      if (secs < 86400) return Math.floor(secs/3600) + 'h';
      return Math.floor(secs/86400) + 'd';
    }
    setInterval(pollDevices, 30000);
    setTimeout(pollDevices, 2000);

    // Populate sidebar channels based on locale (Japan: LINE, Telegram first)
    (function populateSidebarChannels() {
      const grid = document.getElementById('app-channels-grid');
      if (!grid) return;
      const lang = navigator.language || 'ja';
      const isJapan = lang.startsWith('ja');

      const allChannels = [
        { id: 'line', name: 'LINE', color: '#06C755', path: 'M12 2C6.48 2 2 5.81 2 10.5c0 4.01 3.44 7.37 8.09 8.25.31.07.74.21.85.48.1.25.06.63.03.88l-.14.82c-.04.25-.2.96.84.52s5.58-3.29 7.61-5.63C21.31 13.51 22 12.07 22 10.5 22 5.81 17.52 2 12 2z' },
        { id: 'tg', name: 'Telegram', color: '#2AABEE', path: 'M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.88 8.85c-.14.63-.51.78-.84.49l-2.31-1.7-1.79 1.72c-.2.2-.36.36-.74.36l.27-3.78 6.88-6.22c.3-.27-.07-.42-.47-.16L8.09 13.29l-2.61-.82c-.57-.18-.58-.57.12-.84l11.03-4.27c.47-.17.88.11.73.79h.17z' },
        { id: 'whatsapp', name: 'WhatsApp', color: '#25D366', path: 'M12 0C5.37 0 0 5.37 0 12c0 2.12.55 4.13 1.6 5.93L0 24l6.26-1.64C8.01 23.44 9.97 24 12 24c6.63 0 12-5.37 12-12S18.63 0 12 0z' },
        { id: 'discord', name: 'Discord', color: '#5865F2', path: 'M20.32 4.37a19.8 19.8 0 0 0-4.89-1.52c-.21.38-.45.87-.61 1.26a18.27 18.27 0 0 0-5.49 0c-.17-.39-.41-.88-.62-1.26a19.74 19.74 0 0 0-4.89 1.52C1.11 8.39.33 12.27.74 16.1a19.9 19.9 0 0 0 5.99 3.03c.46-.63.87-1.3 1.22-2a13.1 13.1 0 0 1-1.87-.9c.13-.09.25-.19.37-.29 3.93 1.8 8.18 1.8 12.07 0c.12.1.25.2.37.29c-.6.35-1.22.65-1.88.9c.36.7.77 1.37 1.22 2a19.83 19.83 0 0 0 6-3.03c.5-5.18-.84-9.68-3.55-13.67z' },
        { id: 'slack', name: 'Slack', color: '#E01E5A', path: 'M5.04 15.24a2.52 2.52 0 1 1-2.52-2.52h2.52v2.52zm1.27 0a2.52 2.52 0 1 1 5.04 0v6.3a2.52 2.52 0 1 1-5.04 0v-6.3z' },
        { id: 'teams', name: 'Teams', color: '#6264A7', path: 'M20.5 7h-3V5.5a2.5 2.5 0 0 0-5 0V7h-1a1.5 1.5 0 0 0-1.5 1.5v8a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 20.5 7z' },
      ];

      // Japan: LINE, Telegram first. Others: WhatsApp, Telegram first
      const order = isJapan
        ? ['line', 'tg', 'whatsapp', 'discord', 'slack', 'teams']
        : ['whatsapp', 'tg', 'discord', 'slack', 'line', 'teams'];

      order.forEach(id => {
        const ch = allChannels.find(c => c.id === id);
        if (!ch) return;
        const btn = document.createElement('button');
        btn.className = 'app-ch-btn';
        btn.id = 'app-ch-' + ch.id;
        btn.onclick = function() { openChannelLink(ch.id); };
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><path d="' + ch.path + '" fill="' + ch.color + '"/></svg>'
          + '<span class="app-ch-name">' + ch.name + '</span>';
        grid.appendChild(btn);
      });
    })();

    const CHANNELS = {
      line: {
        ja: { title: 'LINEで友だち追加', desc: 'QRコードをスマホで読み取り、表示されるメッセージをそのまま送信してください。自動でWebの会話と連携されます。', descMobile: 'ボタンを押すとLINEが開きます。表示されるメッセージを送信で連携完了。', link: 'LINEで開く' },
        en: { title: 'Add on LINE', desc: 'Scan QR with your phone, then send the pre-filled message. Your Web conversation will be auto-linked.', descMobile: 'Tap the button to open LINE. Send the pre-filled message to link.', link: 'Open in LINE' },
        bg: 'line-bg',
      },
      tg: {
        ja: { title: 'Telegramで開始', desc: 'ボタンを押すとTelegramが開き、自動でこのWebの会話と連携されます。', link: 'Telegramで開く' },
        en: { title: 'Start on Telegram', desc: 'Tap the button to open Telegram. Your Web conversation will be auto-linked.', link: 'Open in Telegram' },
        bg: 'tg-bg',
      },
      whatsapp: {
        ja: { title: 'WhatsAppで開始', desc: 'WhatsAppでchatweb.aiにメッセージを送ると、このWebの会話と連携されます。', link: 'WhatsAppで開く' },
        en: { title: 'Start on WhatsApp', desc: 'Send a message to chatweb.ai on WhatsApp. Your Web conversation will be auto-linked.', link: 'Open in WhatsApp' },
        bg: 'whatsapp-bg',
      },
      discord: {
        ja: { title: 'Discordに追加', desc: 'Botをサーバーに招待して、Discordから直接AIを使えます。', link: 'Discordで開く' },
        en: { title: 'Add to Discord', desc: 'Invite the bot to your server and use AI directly from Discord.', link: 'Open in Discord' },
        bg: 'discord-bg',
      },
      slack: {
        ja: { title: 'Slackに追加', desc: 'ワークスペースにアプリをインストールして、Slackから直接AIを使えます。', link: 'Slackで開く' },
        en: { title: 'Add to Slack', desc: 'Install the app to your workspace and use AI directly from Slack.', link: 'Open in Slack' },
        bg: 'slack-bg',
      },
      teams: {
        ja: { title: 'Teamsに追加', desc: 'Microsoft TeamsにBotを追加して、Teams内でAIを使えます。', link: 'Teamsで開く' },
        en: { title: 'Add to Teams', desc: 'Add the bot to Microsoft Teams and use AI directly from Teams.', link: 'Open in Teams' },
        bg: 'teams-bg',
      },
    };
    function getDeepLink(ch) {
      switch(ch) {
        case 'line': return getLineDeepLink();
        case 'tg': return getTgDeepLink();
        case 'whatsapp': return getWhatsAppDeepLink();
        case 'discord': return getDiscordDeepLink();
        case 'slack': return getSlackDeepLink();
        case 'teams': return getTeamsDeepLink();
        default: return '#';
      }
    }
    function isMobileDevice() {
      return /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
        || (navigator.maxTouchPoints > 0 && window.innerWidth < 768);
    }
    // Generate a link code via backend for QR-based channel linking
    async function generateLinkCode() {
      try {
        const resp = await fetch(API + '/api/v1/link/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-session-id': webSessionId }
        });
        const data = await resp.json();
        return data.code || null;
      } catch (e) { return null; }
    }
    function buildDeepLinkWithCode(ch, code) {
      switch (ch) {
        case 'line': return 'https://line.me/R/oaMessage/@619jcqqh/?%2Flink%20' + code;
        case 'tg': return 'https://t.me/chatweb_ai_bot?start=link_' + code;
        default: return getDeepLink(ch);
      }
    }
    let linkPollTimer = null;
    function stopLinkPoll() { if (linkPollTimer) { clearInterval(linkPollTimer); linkPollTimer = null; } }

    function setModalStep(n) {
      const spans = document.querySelectorAll('#modal-steps span');
      spans.forEach((s, i) => {
        if (i < n) { s.style.background = 'var(--green)'; s.style.color = '#fff'; s.style.opacity = '1'; s.style.border = 'none'; }
        else if (i === n) { s.style.background = 'var(--accent)'; s.style.color = '#fff'; s.style.opacity = '1'; s.style.border = 'none'; }
        else { s.style.background = 'transparent'; s.style.color = ''; s.style.opacity = '.5'; s.style.border = '1px solid var(--border)'; }
      });
    }

    function showLinkSuccess(ch) {
      stopLinkPoll();
      setModalStep(2);
      const l = document.documentElement.lang || 'ja';
      document.getElementById('modal-qr-wrap').style.display = 'none';
      document.getElementById('modal-cta').style.display = 'none';
      document.getElementById('modal-link').style.display = 'none';
      document.getElementById('modal-code-row').style.display = 'none';
      document.getElementById('modal-desc').style.display = 'none';
      const succ = document.getElementById('modal-success');
      succ.style.display = '';
      const chName = ch === 'line' ? 'LINE' : ch === 'tg' ? 'Telegram' : ch;
      document.getElementById('modal-success-text').textContent = l === 'ja'
        ? chName + ' 連携完了！' : chName + ' linked!';
      document.getElementById('modal-close-btn').textContent = l === 'ja' ? '閉じる' : 'Close';
      // Update channel status
      if (ch === 'line') { document.getElementById('ch-bar-line')?.classList.add('connected'); document.getElementById('line-card')?.classList.add('connected'); }
      if (ch === 'tg') { document.getElementById('ch-bar-tg')?.classList.add('connected'); document.getElementById('tg-card')?.classList.add('connected'); }
      // Auto close after 2s
      setTimeout(() => {
        document.getElementById('modal').classList.remove('show');
        showToast(l === 'ja' ? chName + ' 連携完了' : chName + ' linked');
      }, 2000);
    }

    function startLinkPoll(ch) {
      stopLinkPoll();
      linkPollTimer = setInterval(async () => {
        try {
          const r = await fetch(API + '/api/v1/sessions/' + encodeURIComponent(webSessionId));
          const data = await r.json();
          if (data.linked_channels) {
            const target = ch === 'tg' ? 'telegram' : ch;
            if (data.linked_channels.includes(target)) {
              showLinkSuccess(ch);
            }
          }
        } catch(e) {}
      }, 2000);
    }

    async function showModal(ch) {
      const c = CHANNELS[ch];
      if (!c) return;
      const l = document.documentElement.lang || 'ja';
      const t = c[l] || c.ja;
      const mobile = isMobileDevice();

      // Reset all elements
      document.getElementById('modal-success').style.display = 'none';
      document.getElementById('modal-desc').style.display = '';
      document.getElementById('modal-qr-wrap').style.display = '';
      document.getElementById('modal-cta').style.display = 'none';
      document.getElementById('modal-code-row').style.display = 'none';
      document.getElementById('modal-title').textContent = t.title;

      const steps = document.getElementById('modal-steps');
      const stepLabels = mobile
        ? (l === 'ja' ? ['1. タップ', '2. 送信', '3. 完了'] : ['1. Tap', '2. Send', '3. Done'])
        : (l === 'ja' ? ['1. QR読取', '2. 送信', '3. 完了'] : ['1. Scan', '2. Send', '3. Done']);
      steps.innerHTML = stepLabels.map((s,i) =>
        '<span style="border-radius:12px;padding:2px 10px;' + (i===0 ? 'background:var(--accent);color:#fff;' : 'opacity:.5;border:1px solid var(--border);') + '">' + s + '</span>'
      ).join('');

      document.getElementById('modal-desc').textContent = (mobile && t.descMobile) ? t.descMobile : t.desc;

      const qrImg = document.getElementById('modal-qr');
      const qrSpinner = document.getElementById('qr-spinner');
      qrImg.classList.remove('loaded');
      qrSpinner.classList.remove('hidden');
      qrImg.src = '';

      const cta = document.getElementById('modal-cta');
      const link = document.getElementById('modal-link');
      link.className = 'modal-link ' + (c.bg || 'tg-bg');
      cta.className = 'modal-link ' + (c.bg || 'tg-bg');
      document.getElementById('modal').classList.add('show');

      let deepLink;
      let code = null;

      if (ch === 'line' || ch === 'tg') {
        code = await generateLinkCode();
        deepLink = code ? buildDeepLinkWithCode(ch, code) : getDeepLink(ch);
      } else {
        deepLink = getDeepLink(ch);
      }

      // QR code (always generated)
      qrImg.onload = function() { qrSpinner.classList.add('hidden'); qrImg.classList.add('loaded'); };
      qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(deepLink);

      if (mobile) {
        // Mobile: big CTA button first, QR smaller below
        cta.style.display = '';
        cta.href = deepLink;
        cta.textContent = t.link || (l === 'ja' ? 'アプリで開く' : 'Open app');
        document.getElementById('modal-qr-wrap').style.display = 'none';
        link.style.display = 'none';
      } else {
        // Desktop: QR prominent, text link below
        cta.style.display = 'none';
        link.href = deepLink;
        link.textContent = t.link;
        link.style.display = '';
      }

      // Show link code for manual entry
      if (code) {
        const codeRow = document.getElementById('modal-code-row');
        codeRow.style.display = '';
        document.getElementById('modal-code-label').textContent = l === 'ja' ? '手動入力: /link ' : 'Manual: /link ';
        document.getElementById('modal-code-val').textContent = code;
      }

      // Start polling for link completion
      if (ch === 'line' || ch === 'tg') {
        startLinkPoll(ch);
      }

      document.getElementById('modal-close-btn').textContent = l === 'ja' ? '閉じる' : 'Close';
    }

    function closeModal(e) {
      if (e.target === document.getElementById('modal')) {
        document.getElementById('modal').classList.remove('show');
        stopLinkPoll();
      }
    }

    // ---------------------------------------------------------------------------
    // Auth functions
    // ---------------------------------------------------------------------------
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;

    function openAuthModal() {
      document.getElementById('auth-modal').classList.add('show');
      document.getElementById('auth-error').style.display = 'none';
    }
    function closeAuthModal(e) {
      if (!e || e.target === document.getElementById('auth-modal')) {
        document.getElementById('auth-modal').classList.remove('show');
      }
    }
    function showAuthError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg;
      el.style.display = '';
    }
    async function redeemCouponFromAuth() {
      const code = document.getElementById('auth-coupon-input').value.trim();
      const resultEl = document.getElementById('auth-coupon-result');
      if (!code) return;
      resultEl.style.display = '';
      resultEl.style.color = 'var(--muted)';
      resultEl.textContent = 'Validating...';
      try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
          resultEl.style.color = '#ef4444';
          resultEl.textContent = document.documentElement.lang === 'ja' ? 'まずログインしてください' : 'Please login first';
          return;
        }
        const r = await fetch(API + '/api/v1/coupon/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ code: code, session_id: webSessionId }),
        });
        const d = await r.json();
        if (d.success) {
          resultEl.style.color = '#22c55e';
          resultEl.textContent = (document.documentElement.lang === 'ja' ? '+' + d.credits_granted + ' クレジット獲得!' : '+' + d.credits_granted + ' credits granted!');
          if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
        } else {
          resultEl.style.color = '#ef4444';
          resultEl.textContent = d.error || 'Invalid coupon';
        }
      } catch {
        resultEl.style.color = '#ef4444';
        resultEl.textContent = 'Error';
      }
    }

    let pendingVerifyEmail = '';

    async function emailAuth() {
      const email = document.getElementById('login-email').value.trim();
      if (!email) return showAuthError('メールアドレスを入力してください');
      try {
        document.getElementById('email-auth-btn').disabled = true;
        document.getElementById('email-auth-btn').textContent = '送信中...';
        const r = await fetch(API + '/api/v1/auth/email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, session_id: webSessionId }),
        });
        const d = await r.json();
        if (d.ok && d.pending_verification) {
          // Show verification code input
          pendingVerifyEmail = email;
          document.getElementById('auth-form-email').style.display = 'none';
          document.getElementById('auth-form-verify').style.display = '';
          document.getElementById('auth-error').style.display = 'none';
          document.getElementById('verify-code').focus();
        } else if (d.ok) {
          localStorage.setItem('authToken', d.token);
          authToken = d.token;
          closeAuthModal();
          await checkAuth();
        } else {
          showAuthError(d.error || 'Login failed');
        }
      } catch(e) { showAuthError('Network error'); }
      finally {
        document.getElementById('email-auth-btn').disabled = false;
        document.getElementById('email-auth-btn').textContent = 'メールでログイン';
      }
    }

    async function verifyCode() {
      const code = document.getElementById('verify-code').value.trim();
      if (!code || code.length !== 6) return showAuthError('6桁の認証コードを入力してください');
      try {
        const r = await fetch(API + '/api/v1/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: pendingVerifyEmail, code, session_id: webSessionId }),
        });
        const d = await r.json();
        if (d.ok) {
          localStorage.setItem('authToken', d.token);
          authToken = d.token;
          closeAuthModal();
          showEmailForm();
          await checkAuth();
        } else {
          showAuthError(d.error || 'Verification failed');
        }
      } catch(e) { showAuthError('Network error'); }
    }

    function showEmailForm() {
      document.getElementById('auth-form-email').style.display = '';
      document.getElementById('auth-form-verify').style.display = 'none';
      document.getElementById('verify-code').value = '';
      pendingVerifyEmail = '';
    }

    function googleLogin() {
      window.location.href = API + '/auth/google?sid=' + encodeURIComponent(webSessionId);
    }

    function logout() {
      localStorage.removeItem('authToken');
      authToken = null;
      currentUser = null;
      document.getElementById('login-btn').style.display = '';
      document.getElementById('user-menu').style.display = 'none';
      document.getElementById('sidebar-toggle').style.display = 'none';
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('chat-login-overlay').classList.remove('hidden');
      exitAppMode();
    }

    async function checkAuth() {
      // Check for token in URL (from Google OAuth callback)
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get('token');
      if (urlToken) {
        localStorage.setItem('authToken', urlToken);
        authToken = urlToken;
        // Clean URL
        window.history.replaceState({}, '', '/');
      }

      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/auth/me', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.authenticated) {
          currentUser = d;
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('user-menu').style.display = '';
          document.getElementById('user-display-name').textContent = d.display_name || 'User';
          document.getElementById('chat-login-overlay').classList.add('hidden');
          // Show credits if available
          if (d.credits_remaining !== undefined) {
            updateCredits(d.credits_remaining);
          }
          // Show multi-model toggle for paid users
          const mmToggle = document.getElementById('multi-model-toggle');
          if (mmToggle && d.plan && d.plan !== 'free') {
            mmToggle.style.display = '';
          }
          // Enter ChatGPT-like app mode
          enterAppMode();
        } else {
          localStorage.removeItem('authToken');
          authToken = null;
          document.body.classList.remove('app-mode');
        }
      } catch(e) {
        localStorage.removeItem('authToken');
        authToken = null;
        document.body.classList.remove('app-mode');
      }
    }

    // ---------------------------------------------------------------------------
    // Sidebar / Conversation history
    // ---------------------------------------------------------------------------
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    async function loadConversations() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        const list = document.getElementById('conv-list');
        list.innerHTML = '';
        (d.conversations || []).forEach(conv => {
          const item = document.createElement('div');
          item.className = 'sidebar-item';
          item.textContent = conv.title || 'New conversation';
          item.title = conv.created_at;
          item.onclick = () => loadConversation(conv.id, conv.session_id);
          list.appendChild(item);
        });
      } catch(e) { /* ignore */ }
    }

    async function loadConversation(convId, sessionId) {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations/' + encodeURIComponent(convId) + '/messages', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        // Update session
        if (d.session_id) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
        }
        // Clear and re-render messages
        msgs.innerHTML = '';
        (d.messages || []).forEach(m => {
          addMsg(m.content, m.role === 'user' ? 'user' : 'bot');
        });
        knownMsgCount = (d.messages || []).length;
        // Highlight active
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        toggleSidebar();
      } catch(e) { /* ignore */ }
    }

    async function newConversation() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.ok) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
          msgs.innerHTML = '<div class="msg bot" id="t-welcome"></div>';
          knownMsgCount = 0;
          const lang = document.documentElement.lang || 'ja';
          const t = T[lang];
          typewriter(document.getElementById('t-welcome'), t.welcome, 25);
          loadConversations();
          toggleSidebar();
        }
      } catch(e) { /* ignore */ }
    }

    // Mobile menu
    function toggleMobileMenu() {
      document.getElementById('mobile-menu').classList.toggle('show');
    }
    function closeMobileMenu() {
      document.getElementById('mobile-menu').classList.remove('show');
    }
    document.addEventListener('click', e => {
      const menu = document.getElementById('mobile-menu');
      const btn = document.querySelector('.nav-hamburger');
      if (!menu.contains(e.target) && e.target !== btn) menu.classList.remove('show');
    });

    // ---------------------------------------------------------------------------
    // App Mode (ChatGPT-like UI for authenticated users)
    // ---------------------------------------------------------------------------
    let appConversations = [];
    let appCurrentConvId = null;

    // ---------------------------------------------------------------------------
    // API Key management
    // ---------------------------------------------------------------------------
    function openApiKeysModal() {
      document.getElementById('apikey-modal').classList.add('show');
      document.getElementById('apikey-new-key').style.display = 'none';
      loadApiKeys();
      // i18n
      const l = document.documentElement.lang || 'ja';
      document.getElementById('apikey-modal-title').textContent = 'API Keys';
      document.getElementById('apikey-modal-desc').textContent = l === 'ja'
        ? 'APIキーでchatweb.aiをアプリから利用できます。'
        : 'Use API keys to access chatweb.ai from your applications.';
      document.getElementById('apikey-create-btn').textContent = l === 'ja' ? '作成' : 'Create';
      document.getElementById('apikey-name-input').placeholder = l === 'ja' ? 'キー名 (例: my-app)' : 'Key name (e.g. my-app)';
      document.getElementById('apikey-new-label').textContent = l === 'ja' ? '新しいAPIキー' : 'New API Key Created';
      document.getElementById('apikey-new-hint').textContent = l === 'ja' ? 'クリックでコピー。このキーは一度だけ表示されます。' : 'Click to copy. This key will only be shown once.';
    }

    async function loadApiKeys() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/apikeys', { headers: { 'Authorization': 'Bearer ' + authToken } });
        const d = await r.json();
        const list = document.getElementById('apikey-list');
        const l = document.documentElement.lang || 'ja';
        if (!d.api_keys || d.api_keys.length === 0) {
          list.innerHTML = '<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">' + (l === 'ja' ? 'APIキーがありません' : 'No API keys yet') + '</div>';
          return;
        }
        list.innerHTML = d.api_keys.map(k => '<div class="apikey-item">'
          + '<div class="apikey-item-info">'
          + '<div class="apikey-item-name">' + (k.name || 'default') + '</div>'
          + '<div class="apikey-item-prefix">' + k.key_prefix + '</div>'
          + '</div>'
          + '<button class="apikey-delete-btn" onclick="deleteApiKey(\'' + k.id + '\')" title="Delete">&#x2715;</button>'
          + '</div>').join('');
      } catch(e) { /* ignore */ }
    }

    async function createApiKey() {
      if (!authToken) return;
      const name = document.getElementById('apikey-name-input').value.trim() || 'default';
      try {
        const r = await fetch(API + '/api/v1/apikeys', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
          body: JSON.stringify({ name }),
        });
        const d = await r.json();
        if (d.ok) {
          document.getElementById('apikey-new-value').textContent = d.api_key;
          document.getElementById('apikey-new-key').style.display = '';
          document.getElementById('apikey-name-input').value = '';
          loadApiKeys();
        }
      } catch(e) { /* ignore */ }
    }

    async function deleteApiKey(id) {
      if (!authToken) return;
      try {
        await fetch(API + '/api/v1/apikeys/' + encodeURIComponent(id), {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        loadApiKeys();
      } catch(e) { /* ignore */ }
    }

    function enterAppMode() {
      document.body.classList.add('app-mode');
      document.getElementById('app-sidebar-toggle').style.display = '';
      // Hide old sidebar toggle
      document.getElementById('sidebar-toggle').style.display = 'none';
      document.getElementById('sidebar').classList.remove('open');
      // Set user info in sidebar
      const name = currentUser.display_name || 'User';
      document.getElementById('app-user-name').textContent = name;
      document.getElementById('app-user-avatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('app-user-email').textContent = currentUser.email || '';
      // Always show credit display
      updateCredits(currentUser.credits_remaining || 0);
      // Load conversations into app sidebar
      appLoadConversations();
      // Render suggestions
      appRenderSuggestions();
      // Set i18n
      const l = document.documentElement.lang || 'ja';
      document.getElementById('app-new-conv-text').textContent = l === 'ja' ? '新しいチャット' : 'New chat';
      document.getElementById('app-empty-text').textContent = l === 'ja' ? '何でも聞いてください' : 'Ask me anything';
      document.getElementById('app-input').placeholder = l === 'ja' ? 'メッセージを入力...' : 'Message chatweb.ai...';
      document.getElementById('app-channels-label').textContent = l === 'ja' ? 'チャネル連携' : 'Channels';
      // Init sync + cron
      startAutoSync();
      loadCronJobs();
      updateSyncUI();
    }

    function exitAppMode() {
      stopAutoSync();
      document.body.classList.remove('app-mode');
      document.getElementById('app-sidebar-toggle').style.display = 'none';
    }

    function appRenderSuggestions() {
      const l = document.documentElement.lang || 'ja';
      const suggestions = l === 'ja' ? [
        '今日の天気を教えて',
        '今日の天気を教えて',
        '元気が出る言葉をください',
        '旅行プランを立てて',
        '仕事を手伝って',
      ] : [
        "What's the weather today?",
        'Give me an inspiring quote',
        'Plan a trip for me',
        'Help me with work',
      ];
      const container = document.getElementById('app-suggestions');
      container.innerHTML = '';
      suggestions.forEach(s => {
        const btn = document.createElement('div');
        btn.className = 'app-chat-suggestion';
        btn.textContent = s;
        btn.onclick = () => { document.getElementById('app-input').value = s; appSend(); };
        container.appendChild(btn);
      });
    }

    async function appLoadConversations() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        appConversations = d.conversations || [];
        const list = document.getElementById('app-conv-list');
        list.innerHTML = '';
        const l = document.documentElement.lang || 'ja';
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
        const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);

        // Group conversations by date
        const groups = {};
        appConversations.forEach(conv => {
          const d2 = new Date(conv.updated_at || conv.created_at);
          let label;
          if (d2 >= today) label = l === 'ja' ? '今日' : 'Today';
          else if (d2 >= yesterday) label = l === 'ja' ? '昨日' : 'Yesterday';
          else if (d2 >= weekAgo) label = l === 'ja' ? '今週' : 'This Week';
          else label = l === 'ja' ? 'それ以前' : 'Older';
          if (!groups[label]) groups[label] = [];
          groups[label].push(conv);
        });

        const collapsedGroups = JSON.parse(localStorage.getItem('convCollapsed') || '{}');

        Object.entries(groups).forEach(([label, convs]) => {
          const group = document.createElement('div');
          group.className = 'conv-date-group';

          const header = document.createElement('div');
          header.className = 'conv-date-header' + (collapsedGroups[label] ? ' collapsed' : '');
          header.innerHTML = '<span class="chevron">&#9660;</span> ' + label;
          header.onclick = () => {
            const items = group.querySelector('.conv-date-items');
            const isCollapsed = header.classList.toggle('collapsed');
            items.classList.toggle('collapsed', isCollapsed);
            const stored = JSON.parse(localStorage.getItem('convCollapsed') || '{}');
            stored[label] = isCollapsed;
            localStorage.setItem('convCollapsed', JSON.stringify(stored));
          };
          group.appendChild(header);

          const items = document.createElement('div');
          items.className = 'conv-date-items' + (collapsedGroups[label] ? ' collapsed' : '');

          convs.forEach(conv => {
            const item = document.createElement('div');
            item.className = 'app-conv-item' + (conv.id === appCurrentConvId ? ' active' : '');
            item.style.cssText = 'display:flex;align-items:center;gap:4px;';
            const title = document.createElement('span');
            title.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';
            const convTitle = conv.title || (l === 'ja' ? '新しい会話' : 'New conversation');
            title.textContent = convTitle === 'New conversation' && l === 'ja' ? '新しい会話' : convTitle;
            title.onclick = () => appLoadConversation(conv.id, conv.session_id);
            item.appendChild(title);
            const shareBtn = document.createElement('button');
            shareBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
            shareBtn.style.cssText = 'background:none;border:none;color:var(--muted);cursor:pointer;padding:2px;flex-shrink:0;opacity:0;transition:opacity 0.15s;';
            shareBtn.title = 'Share';
            shareBtn.onclick = (e) => { e.stopPropagation(); shareConversation(conv.id); };
            item.appendChild(shareBtn);
            item.onmouseenter = () => shareBtn.style.opacity = '1';
            item.onmouseleave = () => shareBtn.style.opacity = '0';
            items.appendChild(item);
          });

          group.appendChild(items);
          list.appendChild(group);
        });
      } catch(e) { /* ignore */ }
    }

    async function appLoadConversation(convId, sessionId) {
      if (!authToken) return;
      appCurrentConvId = convId;
      try {
        const r = await fetch(API + '/api/v1/conversations/' + encodeURIComponent(convId) + '/messages', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.session_id) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
        }
        const msgsEl = document.getElementById('app-messages');
        msgsEl.innerHTML = '';
        document.getElementById('app-empty')?.remove();
        (d.messages || []).forEach(m => {
          appAddMsg(m.content, m.role === 'user' ? 'user' : 'bot');
        });
        knownMsgCount = (d.messages || []).length;
        // Update active state
        document.querySelectorAll('.app-conv-item').forEach(el => el.classList.remove('active'));
        const items = document.querySelectorAll('.app-conv-item');
        appConversations.forEach((conv, i) => {
          if (conv.id === convId && items[i]) items[i].classList.add('active');
        });
        // Close sidebar on mobile
        document.getElementById('app-sidebar').classList.remove('open');
      } catch(e) { /* ignore */ }
    }

    async function appNewConversation() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/conversations', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.ok) {
          webSessionId = d.session_id;
          localStorage.setItem('webSessionId', webSessionId);
          appCurrentConvId = d.conversation_id || null;
          const msgsEl = document.getElementById('app-messages');
          msgsEl.innerHTML = '';
          // Re-add empty state
          const empty = document.createElement('div');
          empty.className = 'app-chat-empty';
          empty.id = 'app-empty';
          const l = document.documentElement.lang || 'ja';
          empty.innerHTML = '<div class="app-chat-empty-logo">chatweb.ai</div>'
            + '<button class="voice-hero-btn" id="voice-hero-btn" onclick="toggleVoiceHero()"><svg viewBox="0 0 24 24" fill="none"><path d="M12 1a4 4 0 00-4 4v6a4 4 0 008 0V5a4 4 0 00-4-4z" fill="currentColor"/><path d="M6 10v1a6 6 0 0012 0v-1M12 19v3M9 22h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>'
            + '<div class="voice-hero-label" id="voice-hero-label">' + (l === 'ja' ? 'タップして話す' : 'Tap to talk') + '</div>'
            + '<div class="app-chat-empty-text" id="app-empty-text">' + (l === 'ja' ? '何でも聞いてください' : 'Ask me anything') + '</div>'
            + '<div class="app-chat-suggestions" id="app-suggestions"></div>';
          msgsEl.appendChild(empty);
          appRenderSuggestions();
          knownMsgCount = 0;
          appLoadConversations();
          document.getElementById('app-sidebar').classList.remove('open');
        }
      } catch(e) { /* ignore */ }
    }

    function appAddMsg(text, who, agentName, toolsUsed) {
      // Remove empty state if present
      const empty = document.getElementById('app-empty');
      if (empty) empty.remove();

      const msgsEl = document.getElementById('app-messages');
      const wrapper = document.createElement('div');
      wrapper.className = 'app-msg app-msg-' + who;

      if (who === 'user') {
        const bubble = document.createElement('div');
        bubble.className = 'app-msg-bubble';
        bubble.textContent = text;
        wrapper.appendChild(bubble);
      } else {
        const avatar = document.createElement('div');
        avatar.className = 'app-msg-avatar';
        avatar.textContent = 'cw';
        wrapper.appendChild(avatar);
        const content = document.createElement('div');
        content.className = 'app-msg-content';
        content.textContent = text;
        if (agentName) {
          const badge = document.createElement('span');
          badge.className = 'agent-badge';
          badge.textContent = agentName;
          content.appendChild(badge);
        }
        if (toolsUsed && toolsUsed.length > 0) {
          const container = document.createElement('div');
          container.className = 'tool-badges';
          const lang = document.documentElement.lang || 'ja';
          toolsUsed.forEach(tool => {
            const tb = document.createElement('span');
            tb.className = 'tool-badge';
            const info = TOOL_LABELS[tool] || { icon: '\uD83D\uDD27', ja: tool, en: tool };
            tb.textContent = info.icon + ' ' + (lang === 'ja' ? info.ja : info.en);
            container.appendChild(tb);
          });
          content.appendChild(container);
        }
        // TTS button for bot messages
        const ttsBtn = document.createElement('button');
        ttsBtn.className = 'app-tts-btn';
        ttsBtn.textContent = '\uD83D\uDD0A';
        ttsBtn.dataset.text = text;
        ttsBtn.onclick = function() { playTTS(this); };
        content.appendChild(ttsBtn);
        wrapper.appendChild(content);
      }

      msgsEl.appendChild(wrapper);
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    function appInputKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
        e.preventDefault();
        appSend();
      }
      // Auto-resize textarea
      setTimeout(() => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';
      }, 0);
    }

    async function appSend() {
      const textarea = document.getElementById('app-input');
      const text = textarea.value.trim();
      if (!text) return;
      textarea.value = '';
      textarea.style.height = 'auto';
      appAddMsg(text, 'user');

      // Show thinking indicator
      const msgsEl = document.getElementById('app-messages');
      const thinking = document.createElement('div');
      thinking.className = 'app-msg app-msg-bot';
      const lang = document.documentElement.lang || 'ja';
      const stages = THINKING_STAGES[lang] || THINKING_STAGES.ja;
      thinking.innerHTML = '<div class="app-msg-avatar">cw</div>'
        + '<div class="app-msg-content" style="color:var(--muted);">'
        + '<span class="thinking-icon">' + stages[0].icon + '</span> '
        + '<span class="thinking-text">' + stages[0].text + '</span> '
        + '<span class="thinking-elapsed">(0.0s)</span>'
        + '<div class="shimmer-bar" style="margin-top:8px;"></div></div>';
      msgsEl.appendChild(thinking);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      const startTime = Date.now();
      let stageIdx = 0;
      const statusInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const elapsedEl = thinking.querySelector('.thinking-elapsed');
        if (elapsedEl) elapsedEl.textContent = '(' + elapsed + 's)';
        const elapsedMs = Date.now() - startTime;
        const nextStage = stages[stageIdx + 1];
        if (nextStage && elapsedMs >= nextStage.time) {
          stageIdx++;
          const iconEl = thinking.querySelector('.thinking-icon');
          const textEl = thinking.querySelector('.thinking-text');
          if (iconEl) iconEl.textContent = stages[stageIdx].icon;
          if (textEl) textEl.textContent = stages[stageIdx].text;
        }
      }, 100);

      try {
        const agentSel = document.getElementById('app-agent-select').value;
        const msgToSend = (agentSel !== 'auto') ? ('@' + agentSel + ' ' + text) : text;

        // Check explore mode
        const exploreMode = document.getElementById('explore-check')?.checked || false;
        if (exploreMode) {
          clearInterval(statusInterval);
          thinking.remove();
          await appExplore(msgToSend, text, 0);
          return;
        }

        // Check multi-model mode
        const multiModel = document.getElementById('multi-model-check')?.checked || false;

        // SSE streaming for real-time response (disable SSE for multi-model — needs full response)
        if (multiModel) {
          const r = await fetch(API + '/api/v1/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msgToSend, session_id: webSessionId, channel: 'web', multi_model: true }),
          });
          const d = await r.json();
          clearInterval(statusInterval);
          thinking.remove();
          let botMsg = d.response;
          if (d.model_used) botMsg += '\n\n<small style="color:var(--muted);">Model: ' + d.model_used + (d.models_consulted ? ' (' + d.models_consulted.length + ' raced)' : '') + '</small>';
          appAddMsg(botMsg, 'bot', d.agent || null, d.tools_used || null);
          knownMsgCount += 2;
          if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
          autoPlayTTS(d.response);
          appLoadConversations();
          return;
        }

        // Use forced model for summary, then clear
        const chatBody = { message: msgToSend, session_id: webSessionId, channel: 'web' };
        if (window._forceSummaryModel) {
          chatBody.model = window._forceSummaryModel;
          delete window._forceSummaryModel;
        }
        const r = await fetch(API + '/api/v1/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(chatBody),
        });

        if (!r.ok || !r.body) {
          // Fallback to non-streaming
          const fallback = await fetch(API + '/api/v1/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msgToSend, session_id: webSessionId }),
          });
          const d = await fallback.json();
          clearInterval(statusInterval);
          thinking.remove();
          appAddMsg(d.response, 'bot', d.agent || null, d.tools_used || null);
          knownMsgCount += 2;
          if (d.credits_remaining !== undefined) updateCredits(d.credits_remaining);
          autoPlayTTS(d.response);
          appLoadConversations();
        } else {
          // Read SSE stream (supports agentic multi-iteration tool events)
          const reader = r.body.getReader();
          const decoder = new TextDecoder();
          let buf = '';
          let gotContent = false;

          // Agent progress container (inserted before final answer)
          let agentProgressEl = null;
          function ensureAgentProgress() {
            if (agentProgressEl) return agentProgressEl;
            agentProgressEl = document.createElement('div');
            agentProgressEl.className = 'agent-progress';
            agentProgressEl.style.cssText = 'margin:8px 0;padding:8px 12px;background:var(--surface,#f5f5f5);border-radius:8px;font-size:13px;color:var(--muted,#888);';
            const msgsEl = document.getElementById('app-messages');
            if (msgsEl) msgsEl.appendChild(agentProgressEl);
            return agentProgressEl;
          }

          function processEvent(evt) {
            if (evt.type === 'tool_start') {
              const p = ensureAgentProgress();
              const toolEl = document.createElement('div');
              toolEl.className = 'tool-step';
              toolEl.id = 'tool-step-' + evt.tool + '-' + evt.iteration;
              toolEl.innerHTML = '<span class="dot-pulse" style="display:inline-block;width:6px;height:6px;background:var(--primary,#4f46e5);border-radius:50%;animation:pulse 1s infinite;margin-right:6px;"></span>' +
                '<strong>' + evt.tool + '</strong> ' + (lang === 'ja' ? '実行中...' : 'running...');
              toolEl.style.cssText = 'padding:4px 0;';
              p.appendChild(toolEl);
            } else if (evt.type === 'tool_result') {
              const stepEl = document.getElementById('tool-step-' + evt.tool + '-' + evt.iteration);
              if (stepEl) {
                const preview = (evt.result || '').substring(0, 200);
                const isError = preview.startsWith('[TOOL_ERROR]');
                stepEl.innerHTML = (isError ? '&#10060;' : '&#9989;') + ' <strong>' + evt.tool + '</strong>';
                if (preview) {
                  const pre = document.createElement('pre');
                  pre.style.cssText = 'margin:2px 0 0 18px;font-size:12px;max-height:120px;overflow:auto;background:var(--code-bg,#1e1e1e);color:var(--code-fg,#d4d4d4);padding:6px 8px;border-radius:4px;white-space:pre-wrap;word-break:break-all;';
                  pre.textContent = preview;
                  stepEl.appendChild(pre);
                }
              }
            } else if (evt.type === 'thinking') {
              const p = ensureAgentProgress();
              const thinkEl = document.createElement('div');
              thinkEl.style.cssText = 'padding:4px 0;color:var(--muted,#888);font-style:italic;';
              thinkEl.textContent = lang === 'ja' ? '結果を分析中...' : 'Analyzing results...';
              thinkEl.className = 'thinking-step';
              p.appendChild(thinkEl);
            } else if (evt.type === 'content' && !gotContent) {
              gotContent = true;
              clearInterval(statusInterval);
              thinking.remove();
              // Remove thinking indicators
              if (agentProgressEl) {
                const thinkSteps = agentProgressEl.querySelectorAll('.thinking-step');
                thinkSteps.forEach(el => el.remove());
              }
              appAddMsg(evt.content, 'bot', null, evt.tools_used || null);
              knownMsgCount += 2;
              if (evt.credits_remaining !== undefined) updateCredits(evt.credits_remaining);
              autoPlayTTS(evt.content);
            } else if (evt.type === 'error') {
              clearInterval(statusInterval);
              thinking.remove();
              appAddMsg(evt.content || 'Error', 'bot');
            }
          }

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });

            // Parse SSE events from buffer
            const lines = buf.split('\n');
            buf = lines.pop() || '';

            for (const line of lines) {
              if (!line.startsWith('data:')) continue;
              const data = line.slice(5).trim();
              if (!data || data === '') continue;
              try {
                const parsed = JSON.parse(data);
                // New format: JSON array of events
                if (Array.isArray(parsed)) {
                  for (const evt of parsed) {
                    processEvent(evt);
                  }
                } else {
                  // Legacy format: single event object
                  processEvent(parsed);
                }
              } catch {}
            }
          }

          if (!gotContent) {
            clearInterval(statusInterval);
            thinking.remove();
            appAddMsg(lang === 'ja' ? 'レスポンスを受信できませんでした。' : 'No response received.', 'bot');
          }
          appLoadConversations();
        }
      } catch {
        clearInterval(statusInterval);
        thinking.remove();
        appAddMsg(lang === 'ja' ? 'エラーが発生しました。もう一度お試しください。' : 'Something went wrong. Please try again.', 'bot');
      }
    }

    // ---------------------------------------------------------------------------
    // Explore mode — multi-model parallel + hierarchical re-query
    // ---------------------------------------------------------------------------
    async function appExplore(msgToSend, originalText, level) {
      const msgsEl = document.getElementById('app-messages');
      const lang = document.documentElement.lang || 'ja';

      // Create explore container
      const container = document.createElement('div');
      container.className = 'explore-container';
      const levelLabels = ['Direct', 'Step-by-Step', 'Expert Deep'];
      if (level > 0) {
        const levelHeader = document.createElement('div');
        levelHeader.style.cssText = 'font-size:11px;color:var(--muted);margin-bottom:4px;';
        levelHeader.textContent = (lang === 'ja' ? '再調査 Lv.' : 'Re-query Lv.') + level + ' — ' + levelLabels[level];
        container.appendChild(levelHeader);
      }

      // Pending indicator
      const pending = document.createElement('div');
      pending.className = 'explore-pending';
      pending.innerHTML = '<span class="dot-pulse"></span> ' +
        (lang === 'ja' ? '全モデルに問い合わせ中...' : 'Querying all models...');
      container.appendChild(pending);

      const wrapper = document.createElement('div');
      wrapper.className = 'app-msg app-msg-bot';
      const avatar = document.createElement('div');
      avatar.className = 'app-msg-avatar';
      avatar.textContent = 'cw';
      wrapper.appendChild(avatar);
      const contentDiv = document.createElement('div');
      contentDiv.className = 'app-msg-content';
      contentDiv.style.width = '100%';
      contentDiv.appendChild(container);
      wrapper.appendChild(contentDiv);
      msgsEl.appendChild(wrapper);
      msgsEl.scrollTop = msgsEl.scrollHeight;

      try {
        const r = await fetch(API + '/api/v1/chat/explore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msgToSend,
            session_id: webSessionId,
            level: level,
          }),
        });

        if (!r.ok || !r.body) {
          pending.textContent = lang === 'ja' ? 'エラーが発生しました' : 'Error occurred';
          return;
        }

        // Read SSE response (single event with all results)
        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';
        let exploreData = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });
        }

        // Parse SSE data lines
        for (const line of buf.split('\n')) {
          if (!line.startsWith('data:')) continue;
          const dataStr = line.slice(5).trim();
          if (!dataStr) continue;
          try {
            const data = JSON.parse(dataStr);

            if (data.type === 'explore_results' && data.results) {
              pending.remove();
              exploreData = data;

              // Render each model result as a card
              for (const result of data.results) {
                const card = document.createElement('div');
                card.className = 'explore-card';
                card.innerHTML = '<div class="explore-card-header">'
                  + '<span class="explore-model-name">' + modelIcon(result.model) + ' ' + result.model + '</span>'
                  + '<span class="explore-time-badge">' + (result.time_ms / 1000).toFixed(1) + 's</span>'
                  + (result.is_fallback ? '<span class="explore-fallback-badge">fallback</span>' : '')
                  + (result.credits_used > 0 ? '<span style="font-size:10px;color:var(--muted);">' + result.credits_used + ' credits</span>' : '')
                  + '</div>'
                  + '<div class="explore-card-body">' + escapeHtml(result.response) + '</div>'
                  + '<div class="explore-card-actions">'
                  + '<button class="explore-adopt-btn" onclick="exploreAdopt(this)" data-response="' + escapeAttr(result.response) + '">'
                  + (lang === 'ja' ? 'この回答を採用' : 'Use this answer') + '</button>'
                  + '</div>';
                container.appendChild(card);
              }

              if (data.credits_remaining !== undefined && data.credits_remaining !== null) updateCredits(data.credits_remaining);
            }

            if (data.error) {
              pending.textContent = data.error;
            }
          } catch {}
        }
        msgsEl.scrollTop = msgsEl.scrollHeight;

        // Add action buttons
        if (exploreData) {
          const actions = document.createElement('div');
          actions.className = 'explore-actions-bar';

          const summaryBtn = document.createElement('button');
          summaryBtn.className = 'explore-action-btn';
          summaryBtn.textContent = lang === 'ja' ? 'まとめる (Claude Sonnet 4.5)' : 'Summarize (Claude Sonnet 4.5)';
          summaryBtn.onclick = function() {
            const allResponses = container.querySelectorAll('.explore-card-body');
            let combined = '';
            allResponses.forEach((el, i) => {
              const modelName = container.querySelectorAll('.explore-model-name')[i]?.textContent || ('Model ' + (i+1));
              combined += (lang === 'ja' ? '回答' : 'Answer') + (i + 1) + ' (' + modelName + '):\n' + el.textContent + '\n\n';
            });
            const summaryPrompt = lang === 'ja'
              ? '以下の複数のAIモデルからの回答を統合し、最も正確で包括的な日本語の回答を作成してください。各回答の良い点を取り入れ、矛盾があれば最も信頼性の高い情報を優先してください:\n\n' + combined
              : 'Synthesize the following AI model responses into one accurate, comprehensive answer. Incorporate the best points from each and prioritize the most reliable information where answers conflict:\n\n' + combined;
            document.getElementById('app-input').value = summaryPrompt;
            document.getElementById('explore-check').checked = false;
            // Force best model for summary
            window._forceSummaryModel = 'claude-sonnet-4-5-20250929';
            appSend();
          };
          actions.appendChild(summaryBtn);

          if (exploreData.can_escalate) {
            const reQueryBtn = document.createElement('button');
            reQueryBtn.className = 'explore-action-btn';
            const nextLevel = (exploreData.level || 0) + 1;
            reQueryBtn.textContent = lang === 'ja' ? '再調査 (Lv.' + nextLevel + ')' : 'Re-query (Lv.' + nextLevel + ')';
            reQueryBtn.onclick = function() {
              appExplore(msgToSend, originalText, nextLevel);
            };
            actions.appendChild(reQueryBtn);
          }

          const totalInfo = document.createElement('span');
          totalInfo.className = 'explore-level-badge';
          totalInfo.textContent = exploreData.total_models + ' models / '
            + (exploreData.total_time_ms / 1000).toFixed(1) + 's'
            + (exploreData.total_credits_used > 0 ? ' / ' + exploreData.total_credits_used + ' credits' : '');
          actions.appendChild(totalInfo);

          container.appendChild(actions);
          msgsEl.scrollTop = msgsEl.scrollHeight;
        }

        knownMsgCount += 2;
        appLoadConversations();

      } catch (e) {
        pending.textContent = lang === 'ja' ? 'エラーが発生しました' : 'Error occurred';
        console.error('Explore error:', e);
      }
    }

    function modelIcon(model) {
      if (model.includes('claude')) return '\ud83d\udfe3';
      if (model.includes('gpt')) return '\u26a1';
      if (model.includes('gemini')) return '\ud83d\udd35';
      if (model.includes('llama') || model.includes('groq')) return '\ud83e\uddac';
      if (model.includes('kimi') || model.includes('moonshot')) return '\ud83c\udf19';
      if (model.includes('local')) return '\ud83d\udfe2';
      return '\ud83e\udd16';
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function escapeAttr(str) {
      return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function exploreAdopt(btn) {
      const response = btn.dataset.response;
      // Show adopted response as the final bot message
      const msgsEl = document.getElementById('app-messages');
      const wrapper = document.createElement('div');
      wrapper.className = 'app-msg app-msg-bot';
      const avatar = document.createElement('div');
      avatar.className = 'app-msg-avatar';
      avatar.textContent = 'cw';
      wrapper.appendChild(avatar);
      const content = document.createElement('div');
      content.className = 'app-msg-content';
      content.textContent = response;
      // TTS button
      const ttsBtn = document.createElement('button');
      ttsBtn.className = 'app-tts-btn';
      ttsBtn.textContent = '\ud83d\udd0a';
      ttsBtn.dataset.text = response;
      ttsBtn.onclick = function() { playTTS(this); };
      content.appendChild(ttsBtn);
      wrapper.appendChild(content);
      msgsEl.appendChild(wrapper);
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    // ---------------------------------------------------------------------------
    // STT (Speech-to-Text) — Web Speech API
    // ---------------------------------------------------------------------------
    let speechRecognition = null;
    let isRecording = false;
    let voiceInitiated = false; // Track if message was voice-initiated for auto-TTS

    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        document.body.classList.add('no-speech-api');
        return;
      }
      speechRecognition = new SpeechRecognition();
      speechRecognition.lang = 'ja-JP';
      speechRecognition.continuous = true;
      speechRecognition.interimResults = true;

      let finalTranscript = '';
      speechRecognition.onresult = function(e) {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            finalTranscript += e.results[i][0].transcript;
          } else {
            interim += e.results[i][0].transcript;
          }
        }
        const textarea = document.getElementById('app-input');
        textarea.value = finalTranscript + interim;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
      };

      speechRecognition.onend = function() {
        isRecording = false;
        const btn = document.getElementById('app-mic-btn');
        if (btn) btn.classList.remove('recording');
        const heroBtn = document.getElementById('voice-hero-btn');
        if (heroBtn) heroBtn.classList.remove('recording');
        updateVoiceHeroLabel();
        if (finalTranscript.trim()) {
          voiceInitiated = true;
          appSend();
        }
        finalTranscript = '';
      };

      speechRecognition.onerror = function(e) {
        isRecording = false;
        const btn = document.getElementById('app-mic-btn');
        if (btn) btn.classList.remove('recording');
        const heroBtn = document.getElementById('voice-hero-btn');
        if (heroBtn) heroBtn.classList.remove('recording');
        updateVoiceHeroLabel();
        finalTranscript = '';
        if (e.error === 'not-allowed') {
          alert('マイクへのアクセスが拒否されました。ブラウザの設定でマイクを許可してください。');
        }
      };
    }

    function toggleSpeechRecognition() {
      if (!speechRecognition) {
        initSpeechRecognition();
        if (!speechRecognition) return;
      }
      const btn = document.getElementById('app-mic-btn');
      if (isRecording) {
        speechRecognition.stop();
        isRecording = false;
        if (btn) btn.classList.remove('recording');
      } else {
        speechRecognition.start();
        isRecording = true;
        if (btn) btn.classList.add('recording');
      }
    }

    // Voice hero button (large mic in empty state)
    function toggleVoiceHero() {
      if (!speechRecognition) {
        initSpeechRecognition();
        if (!speechRecognition) return;
      }
      const heroBtn = document.getElementById('voice-hero-btn');
      const micBtn = document.getElementById('app-mic-btn');
      if (isRecording) {
        speechRecognition.stop();
        isRecording = false;
        if (heroBtn) heroBtn.classList.remove('recording');
        if (micBtn) micBtn.classList.remove('recording');
      } else {
        speechRecognition.start();
        isRecording = true;
        if (heroBtn) heroBtn.classList.add('recording');
        if (micBtn) micBtn.classList.add('recording');
      }
      updateVoiceHeroLabel();
    }

    function updateVoiceHeroLabel() {
      const label = document.getElementById('voice-hero-label');
      if (!label) return;
      label.textContent = isRecording ? '聞いています...' : 'タップして話す';
    }

    // Auto-TTS: always read aloud when enabled (default ON)
    let autoTtsEnabled = localStorage.getItem('autoTtsEnabled') !== 'false'; // default true

    function toggleAutoTTS() {
      autoTtsEnabled = !autoTtsEnabled;
      localStorage.setItem('autoTtsEnabled', autoTtsEnabled);
      const btn = document.getElementById('settings-tts-toggle');
      if (btn) btn.classList.toggle('active', autoTtsEnabled);
      if (!autoTtsEnabled) stopTTS();
    }

    function toggleExploreSetting() {
      const chk = document.getElementById('explore-check');
      if (chk) chk.checked = !chk.checked;
      const btn = document.getElementById('settings-explore-toggle');
      if (btn) btn.classList.toggle('active', chk && chk.checked);
      localStorage.setItem('exploreEnabled', chk && chk.checked ? 'true' : 'false');
    }

    function openSettingsModal() {
      const l = document.documentElement.lang || 'ja';
      document.getElementById('settings-modal-title').textContent = l === 'ja' ? '設定' : 'Settings';
      document.getElementById('settings-modal-desc').textContent = l === 'ja' ? 'chatweb.aiの動作をカスタマイズ' : 'Customize chatweb.ai behavior';
      document.getElementById('settings-tts-label').innerHTML = '&#128266; ' + (l === 'ja' ? '自動読み上げ' : 'Auto Read Aloud');
      document.getElementById('settings-tts-desc').textContent = l === 'ja' ? 'AIの応答を自動で音声再生します' : 'Automatically play AI responses as speech';
      document.getElementById('settings-explore-label').innerHTML = '&#128269; Explore';
      document.getElementById('settings-explore-desc').textContent = l === 'ja' ? '複数のAIモデルに同時に質問して比較' : 'Ask multiple AI models simultaneously and compare';
      // sync toggle states
      document.getElementById('settings-tts-toggle').classList.toggle('active', autoTtsEnabled);
      const exploreOn = document.getElementById('explore-check')?.checked || false;
      document.getElementById('settings-explore-toggle').classList.toggle('active', exploreOn);
      document.getElementById('settings-modal').classList.add('show');
    }

    // Initialize settings on load
    (function initSettings() {
      const btn = document.getElementById('settings-tts-toggle');
      if (btn) btn.classList.toggle('active', autoTtsEnabled);
      // Restore explore state
      const exploreStored = localStorage.getItem('exploreEnabled') === 'true';
      const chk = document.getElementById('explore-check');
      if (chk) chk.checked = exploreStored;
    })();

    // Auto-play TTS on every bot response (when enabled)
    // Uses sentence-level parallel TTS for fastest playback
    function autoPlayTTS(text) {
      if (!autoTtsEnabled) return;
      if (!text || text.length < 2) return;
      // Strip markdown formatting for cleaner speech
      const clean = text.replace(/#{1,6}\s/g, '').replace(/\*{1,3}([^*]+)\*{1,3}/g, '$1')
        .replace(/`[^`]+`/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/^[-*]\s/gm, '').replace(/^\d+\.\s/gm, '').trim();
      if (clean.length < 2) return;
      streamTTS(clean);
    }

    // Initialize STT on load
    initSpeechRecognition();

    // ---------------------------------------------------------------------------
    // TTS — Sentence-level parallel fetch + sequential playback + browser fallback
    // ---------------------------------------------------------------------------
    let currentAudio = null;
    let currentTtsBtn = null;
    const ttsCache = new Map();
    let ttsQueue = [];       // [{blobUrl, sentence}] — audio ready to play
    let ttsPlaying = false;
    let ttsAborted = false;
    let ttsPendingCount = 0; // how many fetches are in-flight

    // Split text into sentences (Japanese + English boundaries)
    function splitSentences(text) {
      // Split on 。！？ and .!? (but not decimals like 3.14)
      const parts = text.split(/(?<=[。！？\!\?])\s*|(?<=\.)\s+/);
      // Merge very short fragments (< 8 chars) with previous
      const merged = [];
      for (const p of parts) {
        const t = p.trim();
        if (!t) continue;
        if (merged.length > 0 && t.length < 8) {
          merged[merged.length - 1] += t;
        } else {
          merged.push(t);
        }
      }
      return merged.filter(s => s.length > 0);
    }

    // Fetch TTS audio for a single sentence
    async function fetchTtsAudio(sentence) {
      const cacheKey = sentence.substring(0, 4096);
      let blobUrl = ttsCache.get(cacheKey);
      if (blobUrl) return blobUrl;

      const hdrs = { 'Content-Type': 'application/json' };
      if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;

      const r = await fetch(API + '/api/v1/speech/synthesize', {
        method: 'POST',
        headers: hdrs,
        body: JSON.stringify({ text: cacheKey, session_id: webSessionId }),
      });

      if (!r.ok) throw new Error('TTS HTTP ' + r.status);
      const blob = await r.blob();
      if (!blob || blob.size === 0) throw new Error('Empty audio');
      blobUrl = URL.createObjectURL(blob);
      ttsCache.set(cacheKey, blobUrl);
      return blobUrl;
    }

    // Play next audio in the queue
    function playNextQueued() {
      if (ttsAborted || ttsQueue.length === 0) {
        ttsPlaying = false;
        // Update button state if all done
        if (ttsPendingCount <= 0 && currentTtsBtn) {
          currentTtsBtn.classList.remove('playing');
          currentTtsBtn.textContent = '\uD83D\uDD0A';
          currentTtsBtn = null;
          refreshCredits();
        }
        return;
      }
      ttsPlaying = true;
      const item = ttsQueue.shift();
      const audio = new Audio(item.blobUrl);
      currentAudio = audio;
      audio.onended = function() { playNextQueued(); };
      audio.onerror = function() { playNextQueued(); };
      audio.play().catch(function() { playNextQueued(); });
    }

    // Stream TTS: split into sentences, fetch in parallel, play in order
    function streamTTS(text) {
      // Abort any previous stream
      stopTTS();
      ttsAborted = false;

      const sentences = splitSentences(text);
      if (sentences.length === 0) return;

      // Pre-allocate slots to maintain order
      const slots = new Array(sentences.length).fill(null);
      ttsPendingCount = sentences.length;
      let nextToPlay = 0;

      function tryEnqueue() {
        // Enqueue all consecutive ready slots
        while (nextToPlay < slots.length && slots[nextToPlay] !== null) {
          if (ttsAborted) return;
          ttsQueue.push({ blobUrl: slots[nextToPlay], sentence: sentences[nextToPlay] });
          nextToPlay++;
          if (!ttsPlaying) playNextQueued();
        }
      }

      // Fire all TTS requests in parallel
      sentences.forEach(function(sentence, idx) {
        fetchTtsAudio(sentence).then(function(blobUrl) {
          if (ttsAborted) return;
          ttsPendingCount--;
          slots[idx] = blobUrl;
          tryEnqueue();
        }).catch(function(err) {
          console.warn('TTS API failed for sentence, trying browser fallback:', err.message);
          ttsPendingCount--;
          // Use browser built-in SpeechSynthesis as fallback
          if (ttsAborted) return;
          speakWithBrowser(sentence);
          slots[idx] = 'SPOKEN'; // mark as handled
          tryEnqueue();
        });
      });
    }

    // Stop all TTS playback
    function stopTTS() {
      ttsAborted = true;
      ttsQueue = [];
      ttsPendingCount = 0;
      if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
      currentAudio = null;
      ttsPlaying = false;
      // Cancel browser speech too
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      if (currentTtsBtn) {
        currentTtsBtn.classList.remove('playing');
        currentTtsBtn.textContent = '\uD83D\uDD0A';
        currentTtsBtn = null;
      }
    }

    // Browser built-in SpeechSynthesis fallback (works offline, zero latency)
    function speakWithBrowser(text) {
      if (!window.speechSynthesis) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      utter.rate = 1.1;
      // Try to find a good Japanese voice
      const voices = speechSynthesis.getVoices();
      const jaVoice = voices.find(v => v.lang === 'ja-JP' && v.name.includes('Kyoko'))
        || voices.find(v => v.lang === 'ja-JP' && v.name.includes('O-Ren'))
        || voices.find(v => v.lang === 'ja-JP' && !v.localService === false)
        || voices.find(v => v.lang.startsWith('ja'));
      if (jaVoice) utter.voice = jaVoice;
      speechSynthesis.speak(utter);
    }

    // Manual TTS button click — play full text
    async function playTTS(btn) {
      const text = btn.dataset.text;
      if (!text) return;

      // If already playing this button, stop
      if (currentTtsBtn === btn && (ttsPlaying || (currentAudio && !currentAudio.paused))) {
        stopTTS();
        return;
      }

      // Stop any previous
      stopTTS();

      btn.classList.add('playing');
      btn.textContent = '\u23F9';
      currentTtsBtn = btn;

      // Strip markdown
      const clean = text.replace(/#{1,6}\s/g, '').replace(/\*{1,3}([^*]+)\*{1,3}/g, '$1')
        .replace(/`[^`]+`/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/^[-*]\s/gm, '').replace(/^\d+\.\s/gm, '').trim();

      streamTTS(clean);
    }

    // ---------------------------------------------------------------------------
    // Real-time credit display
    // ---------------------------------------------------------------------------
    function updateCredits(remaining) {
      const display = document.getElementById('credit-display');
      const count = document.getElementById('credit-count');
      if (!display || !count) return;
      display.style.display = '';
      const prev = parseInt(count.textContent) || 0;
      count.textContent = remaining.toLocaleString();
      if (prev !== remaining && prev > 0) {
        display.classList.add('credit-flash');
        setTimeout(() => display.classList.remove('credit-flash'), 600);
      }
    }

    async function refreshCredits() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/auth/me', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.authenticated && d.credits_remaining !== undefined) {
          updateCredits(d.credits_remaining);
        }
      } catch(e) { /* ignore */ }
    }

    // ---------------------------------------------------------------------------
    // Top-up modal + Stripe Checkout
    // ---------------------------------------------------------------------------
    function showTopupModal() {
      const l = document.documentElement.lang || 'ja';
      document.getElementById('topup-modal-title').textContent = l === 'ja' ? 'クレジットをチャージ' : 'Top Up Credits';
      document.getElementById('topup-modal-desc').textContent = l === 'ja' ? 'お好きな方法でクレジットを追加できます' : 'Add credits using your preferred payment method';
      document.getElementById('topup-modal').classList.add('show');
    }

    async function startStripeCheckout(plan) {
      try {
        const r = await fetch(API + '/api/v1/billing/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (authToken || '') },
          body: JSON.stringify({ plan }),
        });
        const d = await r.json();
        if (d.checkout_url) {
          window.open(d.checkout_url, '_blank');
          document.getElementById('topup-modal').classList.remove('show');
        } else if (d.error) {
          alert(d.error);
        }
      } catch(e) {
        alert('Error: ' + e.message);
      }
    }

    // ---------------------------------------------------------------------------
    // Crypto top-up (ETH/MATIC/Base via OpenRouter)
    // ---------------------------------------------------------------------------
    function showCryptoTopup() {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');
      const lang = document.documentElement.lang || 'ja';

      content.innerHTML = '<h3 style="margin:0 0 12px;">' + (lang === 'ja' ? '&#9830; 仮想通貨でチャージ' : '&#9830; Top Up with Crypto') + '</h3>'
        + '<p style="color:var(--muted);font-size:13px;margin-bottom:16px;">'
        + (lang === 'ja' ? 'ETH / MATIC / Base でクレジットを購入。$1 = 100 credits' : 'Buy credits with ETH/MATIC/Base. $1 = 100 credits')
        + '</p>'
        + '<div style="display:flex;gap:8px;margin-bottom:12px;">'
        + '<button class="crypto-amount-btn" onclick="selectCryptoAmount(5)" data-amt="5" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:15px;font-weight:600;">$5<br><span style="font-size:11px;color:var(--muted);">500 cr</span></button>'
        + '<button class="crypto-amount-btn" onclick="selectCryptoAmount(20)" data-amt="20" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:15px;font-weight:600;">$20<br><span style="font-size:11px;color:var(--muted);">2,000 cr</span></button>'
        + '<button class="crypto-amount-btn" onclick="selectCryptoAmount(50)" data-amt="50" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-size:15px;font-weight:600;">$50<br><span style="font-size:11px;color:var(--muted);">5,000 cr</span></button>'
        + '</div>'
        + '<div style="display:flex;gap:8px;margin-bottom:16px;">'
        + '<button onclick="selectChain(8453)" id="chain-8453" class="chain-btn selected" style="flex:1;padding:8px;border:2px solid var(--accent);border-radius:8px;background:rgba(99,102,241,0.1);color:var(--accent);cursor:pointer;font-size:12px;">Base<br><span style="font-size:10px;">推奨・ガス安</span></button>'
        + '<button onclick="selectChain(137)" id="chain-137" class="chain-btn" style="flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-size:12px;">Polygon<br><span style="font-size:10px;">MATIC</span></button>'
        + '<button onclick="selectChain(1)" id="chain-1" class="chain-btn" style="flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-size:12px;">Ethereum<br><span style="font-size:10px;">ETH</span></button>'
        + '</div>'
        + '<button id="crypto-pay-btn" onclick="initCryptoPayment()" style="width:100%;padding:14px;background:linear-gradient(135deg,#627eea,#8b5cf6);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;">'
        + (lang === 'ja' ? '&#128190; ウォレットで支払う ($20)' : '&#128190; Pay with Wallet ($20)')
        + '</button>'
        + '<p id="crypto-status" style="text-align:center;font-size:12px;color:var(--muted);margin-top:8px;min-height:18px;"></p>'
        + '<p style="text-align:center;font-size:11px;color:var(--muted);margin-top:4px;">'
        + (lang === 'ja' ? 'MetaMask等のウォレットが必要です' : 'Requires MetaMask or compatible wallet')
        + '</p>';

      modal.classList.add('show');
      window._cryptoAmount = 20;
      window._cryptoChain = 8453;
      selectCryptoAmount(20);
    }

    function selectCryptoAmount(amt) {
      window._cryptoAmount = amt;
      document.querySelectorAll('.crypto-amount-btn').forEach(function(b) {
        const isSelected = parseInt(b.dataset.amt) === amt;
        b.style.borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
        b.style.background = isSelected ? 'rgba(99,102,241,0.1)' : 'transparent';
      });
      const lang = document.documentElement.lang || 'ja';
      const btn = document.getElementById('crypto-pay-btn');
      if (btn) btn.innerHTML = (lang === 'ja' ? '&#128190; ウォレットで支払う ($' : '&#128190; Pay with Wallet ($') + amt + ')';
    }

    function selectChain(chainId) {
      window._cryptoChain = chainId;
      [1, 137, 8453].forEach(function(id) {
        const el = document.getElementById('chain-' + id);
        if (el) {
          const isSel = id === chainId;
          el.style.borderColor = isSel ? 'var(--accent)' : 'var(--border)';
          el.style.background = isSel ? 'rgba(99,102,241,0.1)' : 'transparent';
          el.style.color = isSel ? 'var(--accent)' : 'var(--text)';
          el.className = 'chain-btn' + (isSel ? ' selected' : '');
        }
      });
    }

    async function initCryptoPayment() {
      const statusEl = document.getElementById('crypto-status');
      const lang = document.documentElement.lang || 'ja';

      if (!window.ethereum) {
        statusEl.textContent = lang === 'ja' ? 'MetaMaskが見つかりません。ブラウザ拡張をインストールしてください。' : 'MetaMask not found. Please install the browser extension.';
        statusEl.style.color = '#ef4444';
        return;
      }

      statusEl.textContent = lang === 'ja' ? 'ウォレット接続中...' : 'Connecting wallet...';
      statusEl.style.color = 'var(--accent)';

      try {
        // Request wallet connection
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const wallet = accounts[0];
        statusEl.textContent = lang === 'ja' ? '決済データ取得中...' : 'Getting payment data...';

        // Get calldata from our API
        const hdrs = { 'Content-Type': 'application/json' };
        if (authToken) hdrs['Authorization'] = 'Bearer ' + authToken;

        const resp = await fetch(API + '/api/v1/crypto/initiate', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({
            amount: window._cryptoAmount,
            chain_id: window._cryptoChain,
            wallet_address: wallet,
            session_id: webSessionId,
          }),
        });
        const data = await resp.json();

        if (data.error) {
          statusEl.textContent = data.error;
          statusEl.style.color = '#ef4444';
          return;
        }

        // Switch chain if needed
        const currentChain = parseInt(await window.ethereum.request({ method: 'eth_chainId' }), 16);
        if (currentChain !== window._cryptoChain) {
          statusEl.textContent = lang === 'ja' ? 'チェーン切替中...' : 'Switching chain...';
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + window._cryptoChain.toString(16) }],
            });
          } catch(e) {
            statusEl.textContent = lang === 'ja' ? 'チェーンを切り替えてください: ' + data.chain_name : 'Please switch to ' + data.chain_name;
            statusEl.style.color = '#ef4444';
            return;
          }
        }

        // Send transaction
        statusEl.textContent = lang === 'ja' ? 'トランザクション承認を待っています...' : 'Waiting for transaction approval...';

        const calldata = data.calldata;
        const txParams = {
          from: wallet,
          to: calldata.to,
          value: calldata.value,
          data: calldata.data || '0x',
        };

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        statusEl.innerHTML = (lang === 'ja' ? '&#9989; トランザクション送信済み！確認中...' : '&#9989; Transaction sent! Confirming...')
          + '<br><span style="font-size:10px;word-break:break-all;">' + txHash + '</span>';
        statusEl.style.color = '#22c55e';

        // Confirm with our backend
        const confirmResp = await fetch(API + '/api/v1/crypto/confirm', {
          method: 'POST',
          headers: hdrs,
          body: JSON.stringify({ tx_hash: txHash, session_id: webSessionId }),
        });
        const confirmData = await confirmResp.json();

        if (confirmData.success) {
          statusEl.innerHTML = (lang === 'ja' ? '&#127881; チャージ完了！' : '&#127881; Payment confirmed!')
            + '<br>' + (confirmData.message_ja || confirmData.message);
          refreshCredits();
          setTimeout(function() { document.getElementById('modal').classList.remove('show'); }, 3000);
        }

      } catch(e) {
        console.error('Crypto payment error:', e);
        statusEl.textContent = e.message || (lang === 'ja' ? 'エラーが発生しました' : 'An error occurred');
        statusEl.style.color = '#ef4444';
      }
    }

    // ---------------------------------------------------------------------------
    // Shared conversation view
    // ---------------------------------------------------------------------------
    async function enterSharedViewMode(hash) {
      try {
        const r = await fetch(API + '/api/v1/shared/' + encodeURIComponent(hash));
        const d = await r.json();
        if (d.error) {
          document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;color:#ccc;background:#0d0d0d;"><h1 style="font-size:24px;margin-bottom:8px;">chatweb.ai</h1><p style="color:#888;">' + (d.error || 'Share not found') + '</p><a href="/" style="margin-top:24px;color:#4f8eff;">chatweb.ai\u3067\u4f1a\u8a71\u3092\u59cb\u3081\u308b</a></div>';
          return;
        }
        // Hide everything and show shared view
        document.body.classList.add('app-mode');
        document.getElementById('app-sidebar').style.display = 'none';
        document.getElementById('app-sidebar-toggle').style.display = 'none';
        document.getElementById('app-sidebar-backdrop').style.display = 'none';
        const inputArea = document.querySelector('.app-chat-input-area');
        if (inputArea) inputArea.style.display = 'none';
        const msgsEl = document.getElementById('app-messages');
        msgsEl.innerHTML = '';
        const emptyEl = document.getElementById('app-empty');
        if (emptyEl) emptyEl.remove();
        // Shared header
        const header = document.createElement('div');
        header.style.cssText = 'padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;';
        header.innerHTML = '<div style="font-size:15px;color:#aaa;">\u5171\u6709\u3055\u308c\u305f\u4f1a\u8a71' + (d.title ? ' \u2014 ' + d.title.replace(/</g,'&lt;') : '') + '</div>';
        msgsEl.parentElement.insertBefore(header, msgsEl);
        // Render messages
        (d.messages || []).forEach(m => {
          appAddMsg(m.content, m.role === 'user' ? 'user' : 'bot');
        });
        // CTA
        const cta = document.createElement('div');
        cta.style.cssText = 'padding:24px;text-align:center;';
        cta.innerHTML = '<a href="/" style="display:inline-block;padding:12px 32px;background:linear-gradient(135deg,#4f8eff,#3b6fd4);color:#fff;border-radius:12px;text-decoration:none;font-size:15px;font-weight:600;">chatweb.ai\u3067\u4f1a\u8a71\u3092\u59cb\u3081\u308b</a>';
        msgsEl.appendChild(cta);
      } catch(e) {
        document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui;color:#ccc;background:#0d0d0d;"><h1>chatweb.ai</h1><p style="color:#888;">\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f</p><a href="/" style="margin-top:24px;color:#4f8eff;">chatweb.ai\u3067\u4f1a\u8a71\u3092\u59cb\u3081\u308b</a></div>';
      }
    }

    async function shareConversation(convId) {
      if (!authToken || !convId) return;
      try {
        const r = await fetch(API + '/api/v1/conversations/' + encodeURIComponent(convId) + '/share', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const d = await r.json();
        if (d.share_url) {
          await navigator.clipboard.writeText(d.share_url);
          showToast(d.already_shared ? '\u5171\u6709\u30ea\u30f3\u30af\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f' : '\u5171\u6709\u30ea\u30f3\u30af\u3092\u751f\u6210\u3057\u307e\u3057\u305f');
        } else {
          showToast(d.error || '\u5171\u6709\u306b\u5931\u6557\u3057\u307e\u3057\u305f');
        }
      } catch(e) {
        showToast('\u5171\u6709\u306b\u5931\u6557\u3057\u307e\u3057\u305f');
      }
    }

    function showToast(msg) {
      const existing = document.getElementById('toast-notification');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.id = 'toast-notification';
      toast.textContent = msg;
      toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:8px;font-size:14px;z-index:10000;transition:opacity 0.3s;';
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
    }

    // ---------------------------------------------------------------------------
    // Auto-sync: 5min (free) / 1min (paid)
    // ---------------------------------------------------------------------------
    let syncTimer = null;
    let lastSyncTime = null;

    function getSyncIntervalMs() {
      if (!currentUser) return 5 * 60 * 1000;
      const plan = (currentUser.plan || 'free').toLowerCase();
      return (plan === 'free') ? 5 * 60 * 1000 : 1 * 60 * 1000;
    }

    function getSyncIntervalLabel() {
      const l = document.documentElement.lang || 'ja';
      if (!currentUser) return l === 'ja' ? '5分ごと' : 'every 5min';
      const plan = (currentUser.plan || 'free').toLowerCase();
      if (plan === 'free') return l === 'ja' ? '5分ごと (Free)' : 'every 5min (Free)';
      return l === 'ja' ? '1分ごと (Pro)' : 'every 1min (Pro)';
    }

    function updateSyncUI() {
      const l = document.documentElement.lang || 'ja';
      const el = document.getElementById('sync-interval-label');
      if (el) el.textContent = getSyncIntervalLabel();
      const btn = document.getElementById('sync-btn-text');
      if (btn) btn.textContent = l === 'ja' ? '同期' : 'Sync';
      const lbl = document.getElementById('cron-label-text');
      if (lbl) lbl.textContent = l === 'ja' ? '定期タスク' : 'Scheduled Tasks';
      const last = document.getElementById('sync-last');
      if (last) {
        if (lastSyncTime) {
          const ago = Math.round((Date.now() - lastSyncTime) / 1000);
          last.textContent = ago < 60 ? (l === 'ja' ? `${ago}秒前` : `${ago}s ago`) : (l === 'ja' ? `${Math.round(ago/60)}分前` : `${Math.round(ago/60)}m ago`);
        } else {
          last.textContent = '--';
        }
      }
    }

    async function syncNow() {
      const btn = document.getElementById('sync-btn');
      if (btn) btn.classList.add('syncing');
      try {
        await appLoadConversations();
        lastSyncTime = Date.now();
        updateSyncUI();
      } catch(e) { /* ignore */ }
      if (btn) setTimeout(() => btn.classList.remove('syncing'), 500);
    }

    function startAutoSync() {
      stopAutoSync();
      const ms = getSyncIntervalMs();
      syncTimer = setInterval(syncNow, ms);
      // Update "ago" display every 30s
      if (!window._syncUiTimer) {
        window._syncUiTimer = setInterval(updateSyncUI, 30000);
      }
    }

    function stopAutoSync() {
      if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
    }

    // ---------------------------------------------------------------------------
    // Cron CRUD (Scheduled Tasks)
    // ---------------------------------------------------------------------------
    let cronJobs = [];

    async function loadCronJobs() {
      if (!authToken) return;
      try {
        const r = await fetch(API + '/api/v1/cron', { headers: { 'Authorization': 'Bearer ' + authToken } });
        const d = await r.json();
        cronJobs = d.jobs || [];
        renderCronList();
      } catch(e) { cronJobs = []; renderCronList(); }
    }

    function renderCronList() {
      const list = document.getElementById('cron-list');
      if (!list) return;
      const l = document.documentElement.lang || 'ja';
      if (cronJobs.length === 0) {
        list.innerHTML = '<div style="font-size:10px;color:var(--muted);padding:4px 8px;">' + (l === 'ja' ? '定期タスクなし' : 'No scheduled tasks') + '</div>';
        return;
      }
      list.innerHTML = '';
      cronJobs.forEach(job => {
        const item = document.createElement('div');
        item.className = 'cron-item';
        item.innerHTML = `
          <button class="cron-item-toggle ${job.enabled ? 'on' : ''}" onclick="toggleCronJob('${job.id}',${!job.enabled})"></button>
          <span class="cron-item-name" title="${job.message || ''}">${job.name}</span>
          <span class="cron-item-schedule">${job.schedule_display || job.schedule || ''}</span>
          <button class="cron-item-del" onclick="deleteCronJob('${job.id}')">&#x2715;</button>
        `;
        list.appendChild(item);
      });
    }

    function toggleCronForm() {
      const c = document.getElementById('cron-form-container');
      if (c.style.display === 'none') {
        const l = document.documentElement.lang || 'ja';
        c.style.display = '';
        c.innerHTML = `<div class="cron-form">
          <input id="cron-name" placeholder="${l === 'ja' ? 'タスク名' : 'Task name'}" maxlength="50">
          <input id="cron-message" placeholder="${l === 'ja' ? 'AIへのメッセージ' : 'Message to AI'}" maxlength="200">
          <div class="cron-form-row">
            <select id="cron-schedule-type" onchange="updateCronScheduleUI()" style="flex:1;">
              <option value="every">${l === 'ja' ? '定期実行' : 'Interval'}</option>
              <option value="cron">Cron式</option>
              <option value="at">${l === 'ja' ? '1回のみ' : 'One-time'}</option>
            </select>
            <input id="cron-schedule-val" placeholder="${l === 'ja' ? '例: 30 (分)' : 'e.g. 30 (min)'}" style="flex:1;">
          </div>
          <div class="cron-form-row" id="cron-channel-row">
            <select id="cron-channel" style="flex:1;">
              <option value="">Web</option>
              <option value="line">LINE</option>
              <option value="telegram">Telegram</option>
            </select>
          </div>
          <div class="cron-form-actions">
            <button class="cron-cancel-btn" onclick="toggleCronForm()">${l === 'ja' ? 'キャンセル' : 'Cancel'}</button>
            <button class="cron-save-btn" onclick="saveCronJob()">${l === 'ja' ? '保存' : 'Save'}</button>
          </div>
        </div>`;
      } else {
        c.style.display = 'none';
        c.innerHTML = '';
      }
    }

    function updateCronScheduleUI() {
      const type = document.getElementById('cron-schedule-type').value;
      const input = document.getElementById('cron-schedule-val');
      const l = document.documentElement.lang || 'ja';
      if (type === 'every') input.placeholder = l === 'ja' ? '例: 30 (分)' : 'e.g. 30 (min)';
      else if (type === 'cron') input.placeholder = l === 'ja' ? '例: 0 9 * * *' : 'e.g. 0 9 * * *';
      else input.placeholder = l === 'ja' ? '例: 2026-02-10 09:00' : 'e.g. 2026-02-10 09:00';
    }

    async function saveCronJob() {
      const name = document.getElementById('cron-name').value.trim();
      const message = document.getElementById('cron-message').value.trim();
      const scheduleType = document.getElementById('cron-schedule-type').value;
      const scheduleVal = document.getElementById('cron-schedule-val').value.trim();
      const channel = document.getElementById('cron-channel').value;
      if (!name || !message || !scheduleVal) return;
      let schedule = {};
      if (scheduleType === 'every') schedule = { every_minutes: parseInt(scheduleVal) || 30 };
      else if (scheduleType === 'cron') schedule = { cron: scheduleVal };
      else schedule = { at: scheduleVal };
      try {
        const r = await fetch(API + '/api/v1/cron', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, message, schedule, channel: channel || undefined }),
        });
        if (r.ok) {
          toggleCronForm();
          loadCronJobs();
          const l = document.documentElement.lang || 'ja';
          showToast(l === 'ja' ? '定期タスクを作成しました' : 'Scheduled task created');
        }
      } catch(e) { /* ignore */ }
    }

    async function toggleCronJob(id, enabled) {
      try {
        await fetch(API + '/api/v1/cron/' + id, {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled }),
        });
        loadCronJobs();
      } catch(e) { /* ignore */ }
    }

    async function deleteCronJob(id) {
      const l = document.documentElement.lang || 'ja';
      if (!confirm(l === 'ja' ? 'この定期タスクを削除しますか？' : 'Delete this scheduled task?')) return;
      try {
        await fetch(API + '/api/v1/cron/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        loadCronJobs();
        showToast(l === 'ja' ? '削除しました' : 'Deleted');
      } catch(e) { /* ignore */ }
    }

    // Detect shared view URL before normal init
    const shareMatch = window.location.pathname.match(/^\/c\/([a-zA-Z0-9]{8,12})$/);
    if (shareMatch) {
      enterSharedViewMode(shareMatch[1]);
    } else {
      // Check auth on page load
      checkAuth();
    }

    // IntersectionObserver for scroll-triggered fade-up
    (function() {
      const targets = document.querySelectorAll('.cap-section, .sync-section, .channel-cards, .bottom-cta, .cli-section');
      targets.forEach(el => el.classList.add('scroll-fade-up'));
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      targets.forEach(el => observer.observe(el));
    })();

    setLang(localStorage.getItem('nl') || (navigator.language.startsWith('ja') ? 'ja' : 'en'));
  </script>
</body>
</html>
